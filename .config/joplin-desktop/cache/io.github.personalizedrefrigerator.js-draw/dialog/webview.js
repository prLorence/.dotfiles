(()=>{var e={518:()=>{(()=>{"use strict";var e={786:(t,e,n)=>{n.d(e,{Z:()=>a});var i=n(81),r=n.n(i),o=n(645),s=n.n(o)()(r());s.push([t.id,'.clr-picker {\r\n  display: none;\r\n  flex-wrap: wrap;\r\n  position: absolute;\r\n  width: 200px;\r\n  z-index: 1000;\r\n  border-radius: 10px;\r\n  background-color: #fff;\r\n  justify-content: space-between;\r\n  box-shadow: 0 0 5px rgba(0,0,0,.05), 0 5px 20px rgba(0,0,0,.1);\r\n  -moz-user-select: none;\r\n  -webkit-user-select: none;\r\n  user-select: none;\r\n}\r\n\r\n.clr-picker.clr-open,\r\n.clr-picker[data-inline="true"] {\r\n  display: flex;\r\n}\r\n\r\n.clr-picker[data-inline="true"] {\r\n  position: relative;\r\n}\r\n\r\n.clr-gradient {\r\n  position: relative;\r\n  width: 100%;\r\n  height: 100px;\r\n  margin-bottom: 15px;\r\n  border-radius: 3px 3px 0 0;\r\n  background-image: linear-gradient(rgba(0,0,0,0), #000), linear-gradient(90deg, #fff, currentColor);\r\n  cursor: pointer;\r\n}\r\n\r\n.clr-marker {\r\n  position: absolute;\r\n  width: 12px;\r\n  height: 12px;\r\n  margin: -6px 0 0 -6px;\r\n  border: 1px solid #fff;\r\n  border-radius: 50%;\r\n  background-color: currentColor;\r\n  cursor: pointer;\r\n}\r\n\r\n.clr-picker input[type="range"]::-webkit-slider-runnable-track {\r\n  width: 100%;\r\n  height: 8px;\r\n}\r\n\r\n.clr-picker input[type="range"]::-webkit-slider-thumb {\r\n  width: 8px;\r\n  height: 8px;\r\n  -webkit-appearance: none;\r\n}\r\n\r\n.clr-picker input[type="range"]::-moz-range-track {\r\n  width: 100%;\r\n  height: 8px;\r\n  border: 0;\r\n}\r\n\r\n.clr-picker input[type="range"]::-moz-range-thumb {\r\n  width: 8px;\r\n  height: 8px;\r\n  border: 0;\r\n}\r\n\r\n.clr-hue {\r\n  background-image: linear-gradient(to right, #f00 0%, #ff0 16.66%, #0f0 33.33%, #0ff 50%, #00f 66.66%, #f0f 83.33%, #f00 100%);\r\n}\r\n\r\n.clr-hue,\r\n.clr-alpha {\r\n  position: relative;\r\n  width: calc(100% - 40px);\r\n  height: 8px;\r\n  margin: 5px 20px;\r\n  border-radius: 4px;\r\n}\r\n\r\n.clr-alpha span {\r\n  display: block;\r\n  height: 100%;\r\n  width: 100%;\r\n  border-radius: inherit;\r\n  background-image: linear-gradient(90deg, rgba(0,0,0,0), currentColor);\r\n}\r\n\r\n.clr-hue input,\r\n.clr-alpha input {\r\n  position: absolute;\r\n  width: calc(100% + 16px);\r\n  height: 16px;\r\n  left: -8px;\r\n  top: -4px;\r\n  margin: 0;\r\n  background-color: transparent;\r\n  opacity: 0;\r\n  cursor: pointer;\r\n  appearance: none;\r\n  -webkit-appearance: none;\r\n}\r\n\r\n.clr-hue div,\r\n.clr-alpha div {\r\n  position: absolute;\r\n  width: 16px;\r\n  height: 16px;\r\n  left: 0;\r\n  top: 50%;\r\n  margin-left: -8px;\r\n  transform: translateY(-50%);\r\n  border: 2px solid #fff;\r\n  border-radius: 50%;\r\n  background-color: currentColor;\r\n  box-shadow: 0 0 1px #888;\r\n  pointer-events: none;\r\n}\r\n\r\n.clr-alpha div:before {\r\n  content: \'\';\r\n  position: absolute;\r\n  height: 100%;\r\n  width: 100%;\r\n  left: 0;\r\n  top: 0;\r\n  border-radius: 50%;\r\n  background-color: currentColor;\r\n}\r\n\r\n.clr-format {\r\n  display: none;\r\n  order: 1;\r\n  width: calc(100% - 40px);\r\n  margin: 0 20px 20px;\r\n}\r\n\r\n.clr-segmented {\r\n  display: flex;\r\n  position: relative;\r\n  width: 100%;\r\n  margin: 0;\r\n  padding: 0;\r\n  border: 1px solid #ddd;\r\n  border-radius: 15px;\r\n  box-sizing: border-box;\r\n  color: #999;\r\n  font-size: 12px;\r\n}\r\n\r\n.clr-segmented input,\r\n.clr-segmented legend {\r\n  position: absolute;\r\n  width: 100%;\r\n  height: 100%;\r\n  margin: 0;\r\n  padding: 0;\r\n  border: 0;\r\n  left: 0;\r\n  top: 0;\r\n  opacity: 0;\r\n  pointer-events: none;\r\n}\r\n\r\n.clr-segmented label {\r\n  flex-grow: 1;\r\n  padding: 4px 0;\r\n  text-align: center;\r\n  cursor: pointer;\r\n}\r\n\r\n.clr-segmented label:first-of-type {\r\n  border-radius: 10px 0 0 10px;\r\n}\r\n\r\n.clr-segmented label:last-of-type {\r\n  border-radius: 0 10px 10px 0;\r\n}\r\n\r\n.clr-segmented input:checked + label {\r\n  color: #fff;\r\n  background-color: #666;\r\n}\r\n\r\n.clr-swatches {\r\n  order: 2;\r\n  width: calc(100% - 32px);\r\n  margin: 0 16px;\r\n}\r\n\r\n.clr-swatches div {\r\n  display: flex;\r\n  flex-wrap: wrap;\r\n  padding-bottom: 12px;\r\n  justify-content: center;\r\n}\r\n\r\n.clr-swatches button {\r\n  position: relative;\r\n  width: 20px;\r\n  height: 20px;\r\n  margin: 0 4px 6px 4px;\r\n  border: 0;\r\n  border-radius: 50%;\r\n  color: inherit;\r\n  text-indent: -1000px;\r\n  white-space: nowrap;\r\n  overflow: hidden;\r\n  cursor: pointer;\r\n}\r\n\r\n.clr-swatches button:after {\r\n  content: \'\';\r\n  display: block;\r\n  position: absolute;\r\n  width: 100%;\r\n  height: 100%;\r\n  left: 0;\r\n  top: 0;\r\n  border-radius: inherit;\r\n  background-color: currentColor;\r\n  box-shadow: inset 0 0 0 1px rgba(0,0,0,.1);\r\n}\r\n\r\ninput.clr-color {\r\n  order: 1;\r\n  width: calc(100% - 80px);\r\n  height: 32px;\r\n  margin: 15px 20px 20px 0;\r\n  padding: 0 10px;\r\n  border: 1px solid #ddd;\r\n  border-radius: 16px;\r\n  color: #444;\r\n  background-color: #fff;\r\n  font-family: sans-serif;\r\n  font-size: 14px;\r\n  text-align: center;\r\n  box-shadow: none;\r\n}\r\n\r\ninput.clr-color:focus {\r\n  outline: none;\r\n  border: 1px solid #1e90ff;\r\n}\r\n\r\n.clr-clear {\r\n  display: none;\r\n  order: 2;\r\n  height: 24px;\r\n  margin: 0 20px 20px auto;\r\n  padding: 0 20px;\r\n  border: 0;\r\n  border-radius: 12px;\r\n  color: #fff;\r\n  background-color: #666;\r\n  font-family: inherit;\r\n  font-size: 12px;\r\n  font-weight: 400;\r\n  cursor: pointer;\r\n}\r\n\r\n.clr-preview {\r\n  position: relative;\r\n  width: 32px;\r\n  height: 32px;\r\n  margin: 15px 0 20px 20px;\r\n  border: 0;\r\n  border-radius: 50%;\r\n  overflow: hidden;\r\n  cursor: pointer;\r\n}\r\n\r\n.clr-preview:before,\r\n.clr-preview:after {\r\n  content: \'\';\r\n  position: absolute;\r\n  height: 100%;\r\n  width: 100%;\r\n  left: 0;\r\n  top: 0;\r\n  border: 1px solid #fff;\r\n  border-radius: 50%;\r\n}\r\n\r\n.clr-preview:after {\r\n  border: 0;\r\n  background-color: currentColor;\r\n  box-shadow: inset 0 0 0 1px rgba(0,0,0,.1);\r\n}\r\n\r\n.clr-marker,\r\n.clr-hue div,\r\n.clr-alpha div,\r\n.clr-color {\r\n  box-sizing: border-box;\r\n}\r\n\r\n.clr-field {\r\n  display: inline-block;\r\n  position: relative;\r\n  color: transparent;\r\n}\r\n\r\n.clr-field button {\r\n  position: absolute;\r\n  width: 30px;\r\n  height: 100%;\r\n  right: 0;\r\n  top: 50%;\r\n  transform: translateY(-50%);\r\n  border: 0;\r\n  color: inherit;\r\n  text-indent: -1000px;\r\n  white-space: nowrap;\r\n  overflow: hidden;\r\n  pointer-events: none;\r\n}\r\n\r\n.clr-field button:after {\r\n  content: \'\';\r\n  display: block;\r\n  position: absolute;\r\n  width: 100%;\r\n  height: 100%;\r\n  left: 0;\r\n  top: 0;\r\n  border-radius: inherit;\r\n  background-color: currentColor;\r\n  box-shadow: inset 0 0 1px rgba(0,0,0,.5);\r\n}\r\n\r\n.clr-alpha,\r\n.clr-alpha div,\r\n.clr-swatches button,\r\n.clr-preview:before,\r\n.clr-field button {\r\n  background-image: repeating-linear-gradient(45deg, #aaa 25%, transparent 25%, transparent 75%, #aaa 75%, #aaa), repeating-linear-gradient(45deg, #aaa 25%, #fff 25%, #fff 75%, #aaa 75%, #aaa);\r\n  background-position: 0 0, 4px 4px;\r\n  background-size: 8px 8px;\r\n}\r\n\r\n.clr-marker:focus {\r\n  outline: none;\r\n}\r\n\r\n.clr-keyboard-nav .clr-marker:focus,\r\n.clr-keyboard-nav .clr-hue input:focus + div,\r\n.clr-keyboard-nav .clr-alpha input:focus + div,\r\n.clr-keyboard-nav .clr-segmented input:focus + label {\r\n  outline: none;\r\n  box-shadow: 0 0 0 2px #1e90ff, 0 0 2px 2px #fff;\r\n}\r\n\r\n.clr-picker[data-alpha="false"] .clr-alpha {\r\n  display: none;\r\n}\r\n\r\n.clr-picker[data-minimal="true"] {\r\n  padding-top: 16px;\r\n}\r\n\r\n.clr-picker[data-minimal="true"] .clr-gradient,\r\n.clr-picker[data-minimal="true"] .clr-hue,\r\n.clr-picker[data-minimal="true"] .clr-alpha,\r\n.clr-picker[data-minimal="true"] .clr-color,\r\n.clr-picker[data-minimal="true"] .clr-preview {\r\n  display: none;\r\n}\r\n\r\n/** Dark theme **/\r\n\r\n.clr-dark {\r\n  background-color: #444;\r\n}\r\n\r\n.clr-dark .clr-segmented {\r\n  border-color: #777;\r\n}\r\n\r\n.clr-dark .clr-swatches button:after {\r\n  box-shadow: inset 0 0 0 1px rgba(255,255,255,.3);\r\n}\r\n\r\n.clr-dark input.clr-color {\r\n  color: #fff;\r\n  border-color: #777;\r\n  background-color: #555;\r\n}\r\n\r\n.clr-dark input.clr-color:focus {\r\n  border-color: #1e90ff;\r\n}\r\n\r\n.clr-dark .clr-preview:after {\r\n  box-shadow: inset 0 0 0 1px rgba(255,255,255,.5);\r\n}\r\n\r\n.clr-dark .clr-alpha,\r\n.clr-dark .clr-alpha div,\r\n.clr-dark .clr-swatches button,\r\n.clr-dark .clr-preview:before {\r\n  background-image: repeating-linear-gradient(45deg, #666 25%, transparent 25%, transparent 75%, #888 75%, #888), repeating-linear-gradient(45deg, #888 25%, #444 25%, #444 75%, #888 75%, #888);\r\n}\r\n\r\n/** Polaroid theme **/\r\n\r\n.clr-picker.clr-polaroid {\r\n  border-radius: 6px;\r\n  box-shadow: 0 0 5px rgba(0,0,0,.1), 0 5px 30px rgba(0,0,0,.2);\r\n}\r\n\r\n.clr-picker.clr-polaroid:before {\r\n  content: \'\';\r\n  display: block;\r\n  position: absolute;\r\n  width: 16px;\r\n  height: 10px;\r\n  left: 20px;\r\n  top: -10px;\r\n  border: solid transparent;\r\n  border-width: 0 8px 10px 8px;\r\n  border-bottom-color: currentColor;\r\n  box-sizing: border-box;\r\n  color: #fff;\r\n  filter: drop-shadow(0 -4px 3px rgba(0,0,0,.1));\r\n  pointer-events: none;\r\n}\r\n\r\n.clr-picker.clr-polaroid.clr-dark:before {\r\n  color: #444;\r\n}\r\n\r\n.clr-picker.clr-polaroid.clr-left:before {\r\n  left: auto;\r\n  right: 20px;\r\n}\r\n\r\n.clr-picker.clr-polaroid.clr-top:before {\r\n  top: auto;\r\n  bottom: -10px;\r\n  transform: rotateZ(180deg);\r\n}\r\n\r\n.clr-polaroid .clr-gradient {\r\n  width: calc(100% - 20px);\r\n  height: 120px;\r\n  margin: 10px;\r\n  border-radius: 3px;\r\n}\r\n\r\n.clr-polaroid .clr-hue,\r\n.clr-polaroid .clr-alpha {\r\n  width: calc(100% - 30px);\r\n  height: 10px;\r\n  margin: 6px 15px;\r\n  border-radius: 5px;\r\n}\r\n\r\n.clr-polaroid .clr-hue div,\r\n.clr-polaroid .clr-alpha div {\r\n  box-shadow: 0 0 5px rgba(0,0,0,.2);\r\n}\r\n\r\n.clr-polaroid .clr-format {\r\n  width: calc(100% - 20px);\r\n  margin: 0 10px 15px;\r\n}\r\n\r\n.clr-polaroid .clr-swatches {\r\n  width: calc(100% - 12px);\r\n  margin: 0 6px;\r\n}\r\n.clr-polaroid .clr-swatches div {\r\n  padding-bottom: 10px;\r\n}\r\n\r\n.clr-polaroid .clr-swatches button {\r\n  width: 22px;\r\n  height: 22px;\r\n}\r\n\r\n.clr-polaroid input.clr-color {\r\n  width: calc(100% - 60px);\r\n  margin: 10px 10px 15px 0;\r\n}\r\n\r\n.clr-polaroid .clr-clear {\r\n  margin: 0 10px 15px auto;\r\n}\r\n\r\n.clr-polaroid .clr-preview {\r\n  margin: 10px 0 15px 10px;\r\n}\r\n\r\n/** Large theme **/\r\n\r\n.clr-picker.clr-large {\r\n  width: 275px;\r\n}\r\n\r\n.clr-large .clr-gradient {\r\n  height: 150px;\r\n}\r\n\r\n.clr-large .clr-swatches button {\r\n  width: 22px;\r\n  height: 22px;\r\n}\r\n\r\n/** Pill (horizontal) theme **/\r\n\r\n.clr-picker.clr-pill {\r\n  width: 380px;\r\n  padding-left: 180px;\r\n  box-sizing: border-box;\r\n}\r\n\r\n.clr-pill .clr-gradient {\r\n  position: absolute;\r\n  width: 180px;\r\n  height: 100%;\r\n  left: 0;\r\n  top: 0;\r\n  margin-bottom: 0;\r\n  border-radius: 3px 0 0 3px;\r\n}\r\n\r\n.clr-pill .clr-hue {\r\n  margin-top: 20px;\r\n}',""]);const a=s},59:(t,e,n)=>{n.d(e,{Z:()=>d});var i=n(81),r=n.n(i),o=n(645),s=n.n(o),a=n(771),l=n(611),c=n(324),h=s()(r());h.i(a.Z),h.i(l.Z),h.i(c.Z),h.push([t.id,"\n.imageEditorContainer {\n\t/* Deafult colors for the editor */\n    --primary-background-color: white;\n    --primary-background-color-transparent: rgba(255, 255, 255, 0.5);\n    --secondary-background-color: #faf;\n    --primary-foreground-color: black;\n    --secondary-foreground-color: black;\n\t--primary-shadow-color: rgba(0, 0, 0, 0.5);\n}\n\n@media (prefers-color-scheme: dark) {\n\t.imageEditorContainer {\n\t\t--primary-background-color: #151515;\n\t\t--primary-background-color-transparent: rgba(50, 50, 50, 0.5);\n\t\t--secondary-background-color: #607;\n\t\t--primary-foreground-color: white;\n\t\t--secondary-foreground-color: white;\n\t\t--primary-shadow-color: rgba(250, 250, 250, 0.5);\n\t}\n}\n\n.imageEditorContainer {\n\tcolor: var(--primary-foreground-color);\n\tfont-family: system-ui, -apple-system, sans-serif;\n\tbackground-color: var(--primary-background-color);\n\n\tdisplay: flex;\n\tflex-direction: column-reverse;\n}\n\n.imageEditorContainer .imageEditorRenderArea {\n\tdisplay: grid;\n\tgrid-template-columns: 1fr;\n\tflex-grow: 2;\n\tflex-shrink: 1;\n\tmin-height: 100px;\n}\n\n.imageEditorContainer .imageEditorRenderArea canvas {\n\t/* Stack all canvases on top of each other */\n\tgrid-row: 1 / 1;\n\tgrid-column: 1 / 1;\n\ttouch-action: none;\n\n\t/* Fill the container */\n\tbox-sizing: border-box;\n\twidth: 100%;\n\theight: 100%;\n}\n\n.imageEditorContainer .loadingMessage {\n\tposition: fixed;\n\ttext-align: center;\n\tfont-size: 2em;\n\n\tbottom: 0;\n\tleft: 0;\n\tright: 0;\n}\n\n.imageEditorContainer .accessibilityAnnouncement {\n\topacity: 0;\n\twidth: 0;\n\theight: 0;\n\toverflow: hidden;\n\tpointer-events: none;\n}\n\n.imageEditorContainer .textRendererOutputContainer {\n\twidth: 1px;\n\theight: 1px;\n\toverflow: hidden;\n}\n\n.imageEditorContainer .textRendererOutputContainer:focus-within {\n\toverflow: visible;\n}\n",""]);const d=h},771:(t,e,n)=>{n.d(e,{Z:()=>a});var i=n(81),r=n.n(i),o=n(645),s=n.n(o)()(r());s.push([t.id,".toolbar-root {\n\tbackground-color: var(--primary-background-color);\n\t--icon-color: var(--primary-foreground-color);\n\n\n\tborder: 1px solid var(--secondary-background-color);\n\tborder-radius: 2px;\n\tflex-wrap: wrap;\n\n\tbox-sizing: border-box;\n\twidth: 100%;\n\n\tdisplay: flex;\n\tflex-direction: row;\n\tjustify-content: center;\n\n\t/* Display above selection dialogs, etc. */\n\tz-index: 2;\n\n\tfont-family: system-ui, -apple-system, sans-serif;\n}\n\n.toolbar-root > .toolbar-toolContainer > .toolbar-button,\n.toolbar-root > .toolbar-toolContainer > * > button,\n.toolbar-root > .toolbar-buttonGroup > button,\n.toolbar-root > .toolbar-button {\n\twidth: min-content;\n\twhite-space: pre;\n\theight: min(20vh, 60px);\n}\n\n.toolbar-dropdown .toolbar-button > .toolbar-icon {\n\tmax-width: 50px;\n}\n\n.toolbar-button.disabled {\n\tfilter: opacity(0.5) sepia(0.2);\n\tcursor: unset;\n}\n\n.toolbar-button, .toolbar-root button {\n\tcursor: pointer;\n\ttext-align: center;\n\tborder-radius: 6px;\n\n\t--icon-color: var(--primary-foreground-color);\n\tbackground-color: var(--primary-background-color);\n\tcolor: var(--primary-foreground-color);\n\tborder: none;\n\tbox-shadow: 0px 0px 2px var(--primary-shadow-color);\n\n\ttransition: background-color 0.25s ease, box-shadow 0.25s ease, opacity 0.3s ease;\n}\n\n.toolbar-button,\n.toolbar-buttonGroup > button,\n.toolbar-toolContainer > * > button,\n.toolbar-root > button {\n\tdisplay: flex;\n\tflex-direction: column;\n\talign-items: center;\n\tjustify-content: center;\n\n\tpadding-left: 3px;\n\tpadding-right: 3px;\n\tmargin-left: 3px;\n\tmargin-right: 3px;\n\n\tmin-width: 40px;\n\twidth: min-content;\n\tfont-size: 1em;\n}\n\n.toolbar-dropdown > .toolbar-toolContainer > button,\n.toolbar-dropdown > .toolbar-toolContainer > .toolbar-button {\n\twidth: 6em;\n}\n\n.toolbar-button:not(.disabled):hover, .toolbar-root button:not(:disabled):hover {\n\tbox-shadow: 0px 2px 4px var(--primary-shadow-color);\n}\n\n.toolbar-root button:disabled {\n\tcursor: inherit;\n\tfilter: opacity(0.5);\n}\n\n.toolbar-root .toolbar-icon {\n\tflex-shrink: 1;\n\tmin-width: 30px;\n\tmin-height: 30px;\n}\n\n.toolbar-toolContainer.selected > .toolbar-button {\n\tbackground-color: var(--secondary-background-color);\n\tcolor: var(--secondary-foreground-color);\n\t--icon-color: var(--secondary-foreground-color);\n}\n\n.toolbar-toolContainer:not(.selected):not(.dropdownShowable) > .toolbar-button > .toolbar-showHideDropdownIcon {\n\tdisplay: none;\n}\n\n.toolbar-toolContainer > .toolbar-button > .toolbar-showHideDropdownIcon {\n\theight: 10px;\n\ttransition: transform 0.5s ease;\n}\n\n.toolbar-toolContainer.dropdownVisible > .toolbar-button > .toolbar-showHideDropdownIcon {\n\ttransform: rotate(180deg);\n}\n\n.toolbar-dropdown.hidden,\n.toolbar-toolContainer:not(.selected):not(.dropdownShowable) > .toolbar-dropdown {\n\tdisplay: none;\n}\n\n.toolbar-dropdown {\n\tposition: absolute;\n\tpadding: 15px;\n\tpadding-top: 5px;\n\n\t/* Prevent overlap/being displayed under the undo/redo buttons */\n\tz-index: 2;\n\tbackground-color: var(--primary-background-color);\n\tbox-shadow: 0px 3px 3px var(--primary-shadow-color);\n}\n\n.toolbar-buttonGroup {\n\tdisplay: flex;\n\tflex-direction: row;\n\tjustify-content: center;\n}\n\n.toolbar-closeColorPickerOverlay {\n\tdisplay: none;\n\tposition: fixed;\n\ttop: 0;\n\tleft: 0;\n\tbottom: 0;\n\tright: 0;\n\n\tbackground-color: var(--primary-background-color);\n\topacity: 0.3;\n}\n\n/* Make color selection buttons fill their containing label */\n.toolbar-dropdown .clr-field button {\n\twidth: 100%;\n\theight: 100%;\n\tborder-radius: 2px;\n\tmargin-left: 0;\n\tmargin-right: 0;\n}\n\n.toolbar-root .toolbar-zoomLevelEditor {\n\tdisplay: flex;\n\tflex-direction: row;\n}\n\n.toolbar-root .toolbar-zoomLevelEditor .zoomDisplay {\n\tflex-grow: 1;\n}\n\n.toolbar-root .toolbar-zoomLevelEditor button {\n\tmin-width: 48px;\n}\n\n.color-input-container {\n\tdisplay: inline-flex;\n\tflex-direction: row;\n}\n\n.color-input-container .pipetteButton {\n\twidth: 30px;\n\theight: 30px;\n\tpadding: 0;\n\tdisplay: inline-flex;\n}\n\n.color-input-container .pipetteButton > svg {\n\twidth: 100%;\n}\n\n.color-input-container .pipetteButton.active {\n\tbackground-color: var(--secondary-background-color);\n\t--icon-color: var(--secondary-foreground-color);\n}\n",""]);const a=s},324:(t,e,n)=>{n.d(e,{Z:()=>a});var i=n(81),r=n.n(i),o=n(645),s=n.n(o)()(r());s.push([t.id,"\n.find-tool-overlay {\n    /* Show at the bottom of the screen. */\n    order: -1;\n\n    position: absolute;\n}",""]);const a=s},611:(t,e,n)=>{n.d(e,{Z:()=>a});var i=n(81),r=n.n(i),o=n(645),s=n.n(o)()(r());s.push([t.id,"\n.selection-tool-selection-background {\n    background-color: var(--secondary-background-color);\n    opacity: 0.5;\n    overflow: visible;\n    position: absolute;\n}\n\n.selection-tool-handle {\n    border: 1px solid var(--primary-foreground-color);\n    background: var(--primary-background-color);\n    position: absolute;\n    cursor: grab;\n}\n\n.selection-tool-handle.selection-tool-circle {\n    border-radius: 100%;\n}\n\n.overlay.handleOverlay {\n    height: 0;\n    overflow: visible;\n}",""]);const a=s},645:t=>{t.exports=function(t){var e=[];return e.toString=function(){return this.map((function(e){var n="",i=void 0!==e[5];return e[4]&&(n+="@supports (".concat(e[4],") {")),e[2]&&(n+="@media ".concat(e[2]," {")),i&&(n+="@layer".concat(e[5].length>0?" ".concat(e[5]):""," {")),n+=t(e),i&&(n+="}"),e[2]&&(n+="}"),e[4]&&(n+="}"),n})).join("")},e.i=function(t,n,i,r,o){"string"==typeof t&&(t=[[null,t,void 0]]);var s={};if(i)for(var a=0;a<this.length;a++){var l=this[a][0];null!=l&&(s[l]=!0)}for(var c=0;c<t.length;c++){var h=[].concat(t[c]);i&&s[h[0]]||(void 0!==o&&(void 0===h[5]||(h[1]="@layer".concat(h[5].length>0?" ".concat(h[5]):""," {").concat(h[1],"}")),h[5]=o),n&&(h[2]?(h[1]="@media ".concat(h[2]," {").concat(h[1],"}"),h[2]=n):h[2]=n),r&&(h[4]?(h[1]="@supports (".concat(h[4],") {").concat(h[1],"}"),h[4]=r):h[4]="".concat(r)),e.push(h))}},e}},81:t=>{t.exports=function(t){return t[1]}},379:t=>{var e=[];function n(t){for(var n=-1,i=0;i<e.length;i++)if(e[i].identifier===t){n=i;break}return n}function i(t,i){for(var o={},s=[],a=0;a<t.length;a++){var l=t[a],c=i.base?l[0]+i.base:l[0],h=o[c]||0,d="".concat(c," ").concat(h);o[c]=h+1;var u=n(d),p={css:l[1],media:l[2],sourceMap:l[3],supports:l[4],layer:l[5]};if(-1!==u)e[u].references++,e[u].updater(p);else{var m=r(p,i);i.byIndex=a,e.splice(a,0,{identifier:d,updater:m,references:1})}s.push(d)}return s}function r(t,e){var n=e.domAPI(e);return n.update(t),function(e){if(e){if(e.css===t.css&&e.media===t.media&&e.sourceMap===t.sourceMap&&e.supports===t.supports&&e.layer===t.layer)return;n.update(t=e)}else n.remove()}}t.exports=function(t,r){var o=i(t=t||[],r=r||{});return function(t){t=t||[];for(var s=0;s<o.length;s++){var a=n(o[s]);e[a].references--}for(var l=i(t,r),c=0;c<o.length;c++){var h=n(o[c]);0===e[h].references&&(e[h].updater(),e.splice(h,1))}o=l}}},569:t=>{var e={};t.exports=function(t,n){var i=function(t){if(void 0===e[t]){var n=document.querySelector(t);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(t){n=null}e[t]=n}return e[t]}(t);if(!i)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");i.appendChild(n)}},216:t=>{t.exports=function(t){var e=document.createElement("style");return t.setAttributes(e,t.attributes),t.insert(e,t.options),e}},565:(t,e,n)=>{t.exports=function(t){var e=n.nc;e&&t.setAttribute("nonce",e)}},795:t=>{t.exports=function(t){var e=t.insertStyleElement(t);return{update:function(n){!function(t,e,n){var i="";n.supports&&(i+="@supports (".concat(n.supports,") {")),n.media&&(i+="@media ".concat(n.media," {"));var r=void 0!==n.layer;r&&(i+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),i+=n.css,r&&(i+="}"),n.media&&(i+="}"),n.supports&&(i+="}");var o=n.sourceMap;o&&"undefined"!=typeof btoa&&(i+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(o))))," */")),e.styleTagTransform(i,t,e.options)}(e,t,n)},remove:function(){!function(t){if(null===t.parentNode)return!1;t.parentNode.removeChild(t)}(e)}}}},589:t=>{t.exports=function(t,e){if(e.styleSheet)e.styleSheet.cssText=t;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(t))}}}},n={};function i(t){var r=n[t];if(void 0!==r)return r.exports;var o=n[t]={id:t,exports:{}};return e[t](o,o.exports,i),o.exports}i.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return i.d(e,{a:e}),e},i.d=(t,e)=>{for(var n in e)i.o(e,n)&&!i.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),i.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.nc=void 0;var r={};(()=>{i.r(r),i.d(r,{AbstractComponent:()=>E,ActionButtonWidget:()=>Xe,BaseTool:()=>V,BaseToolWidget:()=>qe,BaseWidget:()=>_e,Color4:()=>St,Command:()=>b,Duplicate:()=>ne,Editor:()=>Cn,EditorEventType:()=>M,EditorImage:()=>I,Erase:()=>Dt,EraserTool:()=>Ot,EraserToolWidget:()=>Ze,HTMLToolbar:()=>rn,HandToolWidget:()=>en,IconProvider:()=>Tn,ImageComponent:()=>Ft,InputEvtType:()=>A,LineSegment2:()=>z,Mat33:()=>P,PanZoomMode:()=>W,PanZoomTool:()=>H,PasteHandler:()=>Ce,Path:()=>Tt,PenTool:()=>Lt,PenToolWidget:()=>Ke,Pointer:()=>$,PointerDevice:()=>D,Rect2:()=>B,SelectionTool:()=>he,SelectionToolWidget:()=>Ye,SerializableCommand:()=>w,Stroke:()=>Et,StrokeComponent:()=>Et,StrokeSmoother:()=>Bt,Text:()=>Ut,TextComponent:()=>Ut,TextTool:()=>fe,TextToolWidget:()=>Je,ToolController:()=>Ee,ToolEnabledGroup:()=>At,ToolSwitcherShortcut:()=>ye,ToolbarShortcutHandler:()=>ke,UndoRedoShortcut:()=>de,Vec2:()=>S,Vec3:()=>T,default:()=>kn,defaultEditorLocalization:()=>gn,getLocalizationTable:()=>yn,invertCommand:()=>Te,makeColorInput:()=>je,makeFreehandLineBuilder:()=>Rt,makePressureSensitiveFreehandLineBuilder:()=>xe,uniteCommands:()=>ge});var e=i(379),n=i.n(e),o=i(795),s=i.n(o),a=i(569),l=i.n(a),c=i(565),h=i.n(c),d=i(216),u=i.n(d),p=i(589),m=i.n(p),g=i(59),f={};f.styleTagTransform=m(),f.setAttributes=h(),f.insert=l().bind(null,"head"),f.domAPI=s(),f.insertStyleElement=u(),n()(g.Z,f),g.Z&&g.Z.locals&&g.Z.locals;var v=i(786),y={};y.styleTagTransform=m(),y.setAttributes=h(),y.insert=l().bind(null,"head"),y.domAPI=s(),y.insertStyleElement=u(),n()(v.Z,y),v.Z&&v.Z.locals&&v.Z.locals;class x{onDrop(t){}static union(t,e){return new class extends x{apply(n){t.apply(n),e.apply(n)}unapply(n){e.unapply(n),t.unapply(n)}description(n,i){const r=t.description(n,i),o=e.description(n,i);return r===o?r:`${r}, ${o}`}}}}x.empty=new class extends x{description(t,e){return""}apply(t){}unapply(t){}};const b=x;class w extends b{constructor(t){if(super(),this.commandTypeId=t,!(t in w.deserializationCallbacks))throw new Error(`Command ${t} must have a registered deserialization callback. To do this, call SerializableCommand.register.`)}serialize(){return{data:this.serializeToJSON(),commandType:this.commandTypeId}}static deserialize(t,e){const n="string"==typeof t?JSON.parse(t):t,i=n.commandType;if(!(i in w.deserializationCallbacks))throw new Error(`Unrecognised command type ${i}!`);return w.deserializationCallbacks[i](n.data,e)}static register(t,e){w.deserializationCallbacks[t]=e}}w.deserializationCallbacks={};class T{constructor(t,e,n){this.x=t,this.y=e,this.z=n}get xy(){return{x:this.x,y:this.y}}static of(t,e,n){return new T(t,e,n)}at(t){if(0===t)return this.x;if(1===t)return this.y;if(2===t)return this.z;throw new Error(`${t} out of bounds!`)}length(){return this.magnitude()}magnitude(){return Math.sqrt(this.dot(this))}magnitudeSquared(){return this.dot(this)}angle(){return Math.atan2(this.y,this.x)}normalized(){const t=this.magnitude();return T.of(this.x/t,this.y/t,this.z/t)}times(t){return T.of(this.x*t,this.y*t,this.z*t)}plus(t){return T.of(this.x+t.x,this.y+t.y,this.z+t.z)}minus(t){return this.plus(t.times(-1))}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}cross(t){return T.of(this.y*t.z-t.y*this.z,t.x*this.z-this.x*t.z,this.x*t.y-t.x*this.y)}scale(t){return"number"==typeof t?this.times(t):T.of(this.x*t.x,this.y*t.y,this.z*t.z)}orthog(){return 0===this.dot(T.unitX)&&0===this.dot(T.unitY)?0===this.dot(T.unitX)?T.unitX:this.cross(T.unitX).normalized():this.cross(T.unitZ.times(-1)).normalized()}extend(t,e){return this.plus(e.normalized().times(t))}lerp(t,e){return this.times(1-e).plus(t.times(e))}zip(t,e){return T.of(e(t.x,this.x),e(t.y,this.y),e(t.z,this.z))}map(t){return T.of(t(this.x,0),t(this.y,1),t(this.z,2))}asArray(){return[this.x,this.y,this.z]}eq(t,e=1e-10){for(let n=0;n<3;n++)if(Math.abs(t.at(n)-this.at(n))>e)return!1;return!0}toString(){return`Vec(${this.x}, ${this.y}, ${this.z})`}}var S,C,k;T.unitX=T.of(1,0,0),T.unitY=T.of(0,1,0),T.unitZ=T.of(0,0,1),T.zero=T.of(0,0,0),function(t){t.of=(t,e)=>T.of(t,e,0),t.ofXY=({x:t,y:e})=>T.of(t,e,0),t.unitX=t.of(1,0),t.unitY=t.of(0,1),t.zero=t.of(0,0)}(S||(S={}));class P{constructor(t,e,n,i,r,o,s,a,l){this.a1=t,this.a2=e,this.a3=n,this.b1=i,this.b2=r,this.b3=o,this.c1=s,this.c2=a,this.c3=l,this.cachedInverse=void 0,this.rows=[T.of(t,e,n),T.of(i,r,o),T.of(s,a,l)]}static ofRows(t,e,n){return new P(t.x,t.y,t.z,e.x,e.y,e.z,n.x,n.y,n.z)}inverse(){var t;return null!==(t=this.computeInverse())&&void 0!==t?t:P.identity}invertable(){return null!==this.computeInverse()}computeInverse(){if(void 0!==this.cachedInverse)return this.cachedInverse;const t=[this.rows[0],this.rows[1],this.rows[2]],e=[T.unitX,T.unitY,T.unitZ];for(let n=0;n<3;n++){let i=t[n].at(n);const r=1e-10;if(Math.abs(i)<r){let o=-1;for(let e=1;e<=2;e++){const i=(n+e)%3;if(Math.abs(t[i].at(n))>=r){o=i;break}}if(-1===o)return this.cachedInverse=null,null;const s=t[n],a=e[n];t[n]=t[o],e[n]=e[o],t[o]=s,e[o]=a,i=t[n].at(n)}let o=1/i;t[n]=t[n].times(o),e[n]=e[n].times(o);const s=t[n],a=e[n];for(let i=1;i<=2;i++){const r=(n+i)%3;o=-t[r].at(n),t[r]=t[r].plus(s.times(o)),e[r]=e[r].plus(a.times(o))}}const n=P.ofRows(e[0],e[1],e[2]);return this.cachedInverse=n,n}transposed(){return new P(this.a1,this.b1,this.c1,this.a2,this.b2,this.c2,this.a3,this.b3,this.c3)}rightMul(t){t=t.transposed();const e=(e,n)=>this.rows[e].dot(t.rows[n]);return new P(e(0,0),e(0,1),e(0,2),e(1,0),e(1,1),e(1,2),e(2,0),e(2,1),e(2,2))}transformVec2(t){let e=T.of(t.x,t.y,1);return e=this.transformVec3(e),S.of(e.x,e.y)}transformVec3(t){return T.of(this.rows[0].dot(t),this.rows[1].dot(t),this.rows[2].dot(t))}eq(t,e=0){for(let n=0;n<3;n++)if(!this.rows[n].eq(t.rows[n],e))return!1;return!0}toString(){return`\n⎡ ${this.a1},\t ${this.a2},\t ${this.a3}\t ⎤\n⎢ ${this.b1},\t ${this.b2},\t ${this.b3}\t ⎥\n⎣ ${this.c1},\t ${this.c2},\t ${this.c3}\t ⎦\n\t\t`.trimEnd().trimStart()}toArray(){return[this.a1,this.a2,this.a3,this.b1,this.b2,this.b3,this.c1,this.c2,this.c3]}mapEntries(t){return new P(t(this.a1),t(this.a2),t(this.a3),t(this.b1),t(this.b2),t(this.b3),t(this.c1),t(this.c2),t(this.c3))}getScaleFactor(){return Math.hypot(this.a1,this.a2)}static translation(t){return new P(1,0,t.x,0,1,t.y,0,0,1)}static zRotation(t,e=S.zero){const n=Math.cos(t),i=Math.sin(t);let r=P.translation(e);return r=r.rightMul(new P(n,-i,0,i,n,0,0,0,1)),r.rightMul(P.translation(e.times(-1)))}static scaling2D(t,e=S.zero){let n,i,r=P.translation(e);return"number"==typeof t?(n=t,i=t):(n=t.x,i=t.y),r=r.rightMul(new P(n,0,0,0,i,0,0,0,1)),r.rightMul(P.translation(e.times(-1)))}toCSSMatrix(){return`matrix(${this.a1},${this.b1},${this.a2},${this.b2},${this.a3},${this.b3})`}static fromCSSMatrix(t){if(""===t||"none"===t)return P.identity;const e="([-]?\\d*(?:\\.\\d*)?(?:[eE][-]?\\d+)?)",n=`^\\s*matrix\\s*\\(${[e,e,e,e,e,e].join("[, \\t\\n]+")}[, \\t\\n]*\\)\\s*$`,i=new RegExp(n,"i").exec(t);if(!i)throw new Error(`Unsupported transformation: ${t}`);const r=i.slice(1).map((t=>parseFloat(t))),o=r[0],s=r[1],a=r[2],l=r[3],c=r[4],h=r[5];return new P(o,a,c,s,l,h,0,0,1)}}P.identity=new P(1,0,0,0,1,0,0,0,1);class E{constructor(t){if(this.componentKind=t,this.loadSaveData={},this.lastChangedTime=(new Date).getTime(),this.zIndex=E.zIndexCounter++,this.id=`${(new Date).getTime()}-${Math.random()}`,void 0===E.deserializationCallbacks[t])throw new Error(`Component ${t} has not been registered using AbstractComponent.registerComponent`)}getId(){return this.id}static registerComponent(t,e){this.deserializationCallbacks[t]=null!=e?e:null}attachLoadSaveData(t,e){this.loadSaveData[t]||(this.loadSaveData[t]=[]),this.loadSaveData[t].push(e)}getLoadSaveData(){return this.loadSaveData}getZIndex(){return this.zIndex}getBBox(){return this.contentBBox}transformBy(t){return new E.TransformElementCommand(t,this)}isSelectable(){return!0}clone(){const t=this.createClone();for(const e in this.loadSaveData)for(const n of this.loadSaveData[e])t.attachLoadSaveData(e,n);return t}serialize(){const t=this.serializeToJSON();if(null===t)throw new Error(`${this} cannot be serialized.`);return{name:this.componentKind,zIndex:this.zIndex,id:this.id,loadSaveData:this.loadSaveData,data:t}}static isNotDeserializable(t){return"string"==typeof t&&(t=JSON.parse(t)),"object"!=typeof t||!this.deserializationCallbacks[null==t?void 0:t.name]||!t.data}static deserialize(t){if("string"==typeof t&&(t=JSON.parse(t)),E.isNotDeserializable(t))throw new Error(`Element with data ${t} cannot be deserialized.`);const e=this.deserializationCallbacks[t.name](t.data);return e.zIndex=t.zIndex,e.id=t.id,e}}E.zIndexCounter=0,E.deserializationCallbacks={},E.transformElementCommandId="transform-element",E.UnresolvedTransformElementCommand=class extends w{constructor(t,e){super(E.transformElementCommandId),this.affineTransfm=t,this.componentID=e,this.command=null}resolveCommand(t){if(this.command)return;const e=t.image.lookupElement(this.componentID);if(!e)throw new Error(`Unable to resolve component with ID ${this.componentID}`);this.command=new E.TransformElementCommand(this.affineTransfm,e)}apply(t){this.resolveCommand(t),this.command.apply(t)}unapply(t){this.resolveCommand(t),this.command.unapply(t)}description(t,e){return e.transformedElements(1)}serializeToJSON(){return{id:this.componentID,transfm:this.affineTransfm.toArray()}}},E.TransformElementCommand=(C=class extends w{constructor(t,e){super(E.transformElementCommandId),this.affineTransfm=t,this.component=e,this.origZIndex=e.zIndex}updateTransform(t,e){const n=t.image.findParent(this.component);let i=!1;n&&(n.remove(),i=!0),this.component.applyTransformation(e),i&&I.addElement(this.component).apply(t)}apply(t){this.component.zIndex=E.zIndexCounter++,this.updateTransform(t,this.affineTransfm),t.queueRerender()}unapply(t){this.component.zIndex=this.origZIndex,this.updateTransform(t,this.affineTransfm.inverse()),t.queueRerender()}description(t,e){return e.transformedElements(1)}serializeToJSON(){return{id:this.component.getId(),transfm:this.affineTransfm.toArray()}}},w.register(E.transformElementCommandId,((t,e)=>{const n=e.image.lookupElement(t.id),i=new P(...t.transfm);return n?new E.TransformElementCommand(i,n):new E.UnresolvedTransformElementCommand(i,t.id)})),C);class z{constructor(t,e){this.point1=t,this.point2=e,this.bbox=B.bboxOf([t,e]),this.direction=e.minus(t),this.length=this.direction.magnitude(),this.length>0&&(this.direction=this.direction.times(1/this.length))}get p1(){return this.point1}get p2(){return this.point2}get(t){return this.point1.plus(this.direction.times(t))}intersection(t){let e,n;if(0===this.direction.x){if(0===t.direction.x||0===this.direction.y)return null;const i=this.point1.x,r=(this.point1.x-t.point1.x)*t.direction.y/t.direction.x+t.point1.y;e=S.of(i,r),n=(r-this.point1.y)/this.direction.y}else{const i=(this.point1.y-t.point1.y)*this.direction.x*t.direction.x+this.direction.x*t.direction.y*t.point1.x-this.direction.y*t.direction.x*this.point1.x,r=t.direction.y*this.direction.x-this.direction.y*t.direction.x;if(0===r)return null;const o=i/r,s=(o-this.point1.x)/this.direction.x,a=this.point1.y+this.direction.y*s;e=S.of(o,a),n=(o-this.point1.x)/this.direction.x}const i=e.minus(this.point1).magnitude(),r=e.minus(this.point2).magnitude(),o=e.minus(t.point1).magnitude(),s=e.minus(t.point2).magnitude();return i>this.length||r>this.length||o>t.length||s>t.length?null:{point:e,t:n}}intersects(t){return null!==this.intersection(t)}closestPointTo(t){const e=t.minus(this.p1).dot(this.direction),n=this.length-e,i=this.p1.plus(this.direction.times(e));return e>0&&e<this.length?i:Math.abs(n)<Math.abs(e)?this.p2:this.p1}transformedBy(t){return new z(t.transformVec2(this.p1),t.transformVec2(this.p2))}toString(){return`LineSegment(${this.p1.toString()}, ${this.p2.toString()})`}}class B{constructor(t,e,n,i){this.x=t,this.y=e,this.w=n,this.h=i,n<0&&(this.x+=n,this.w=Math.abs(n)),i<0&&(this.y+=i,this.h=Math.abs(i)),this.topLeft=S.of(this.x,this.y),this.size=S.of(this.w,this.h),this.bottomRight=this.topLeft.plus(this.size),this.center=this.topLeft.plus(this.size.times(.5)),this.area=this.w*this.h}translatedBy(t){return new B(t.x+this.x,t.y+this.y,this.w,this.h)}resizedTo(t){return new B(this.x,this.y,t.x,t.y)}containsPoint(t){return this.x<=t.x&&this.y<=t.y&&this.x+this.w>=t.x&&this.y+this.h>=t.y}containsRect(t){return this.x<=t.x&&this.y<=t.y&&this.bottomRight.x>=t.bottomRight.x&&this.bottomRight.y>=t.bottomRight.y}intersects(t){const e=this.x,n=e+this.w,i=t.x,r=t.x+t.w;if(n<i||e>r)return!1;const o=this.y,s=o+this.h,a=t.y,l=t.y+t.h;return!(s<a||o>l)}intersection(t){if(!this.intersects(t))return null;const e=this.topLeft.zip(t.topLeft,Math.max),n=this.bottomRight.zip(t.bottomRight,Math.min);return B.fromCorners(e,n)}union(t){const e=this.topLeft.zip(t.topLeft,Math.min),n=this.bottomRight.zip(t.bottomRight,Math.max);return B.fromCorners(e,n)}divideIntoGrid(t,e){const n=[];if(t<=0||e<=0)return n;const i=this.w/t,r=this.h/e;0===i&&(t=1),0===r&&(e=1);for(let o=0;o<e;o++)for(let e=0;e<t;e++){const t=i*e+this.x,s=r*o+this.y;n.push(new B(t,s,i,r))}return n}grownToPoint(t,e=0){const n=new B(t.x-e,t.y-e,2*e,2*e);return this.union(n)}grownBy(t){return new B(this.x-t,this.y-t,this.w+2*t,this.h+2*t)}getClosestPointOnBoundaryTo(t){const e=this.getEdges().map((e=>e.closestPointTo(t)));let n=null,i=null;for(const r of e){const e=r.minus(t).length();(null===i||e<i)&&(n=r,i=e)}return n}get corners(){return[this.bottomRight,this.topRight,this.topLeft,this.bottomLeft]}get maxDimension(){return Math.max(this.w,this.h)}get topRight(){return this.bottomRight.plus(S.of(0,-this.h))}get bottomLeft(){return this.topLeft.plus(S.of(0,this.h))}get width(){return this.w}get height(){return this.h}getEdges(){const t=this.corners;return[new z(t[0],t[1]),new z(t[1],t[2]),new z(t[2],t[3]),new z(t[3],t[0])]}transformedBoundingBox(t){return B.bboxOf(this.corners.map((e=>t.transformVec2(e))))}eq(t,e=0){return this.topLeft.eq(t.topLeft,e)&&this.size.eq(t.size,e)}toString(){return`Rect(point(${this.x}, ${this.y}), size(${this.w}, ${this.h}))`}static fromCorners(t,e){return new B(Math.min(t.x,e.x),Math.min(t.y,e.y),Math.abs(t.x-e.x),Math.abs(t.y-e.y))}static bboxOf(t,e=0){let n=0,i=0,r=0,o=0,s=!0;for(const e of t)s&&(n=e.x,i=e.y,r=e.x,o=e.y,s=!1),n=Math.min(n,e.x),i=Math.min(i,e.y),r=Math.max(r,e.x),o=Math.max(o,e.y);return B.fromCorners(S.of(n-e,i-e),S.of(r+e,o+e))}static of(t){var e,n,i,r;const o=null!==(n=null!==(e=t.width)&&void 0!==e?e:t.w)&&void 0!==n?n:0,s=null!==(r=null!==(i=t.height)&&void 0!==i?i:t.h)&&void 0!==r?r:0;return new B(t.x,t.y,o,s)}}B.empty=new B(0,0,0,0),B.unitSquare=new B(0,0,1,1);const R=t=>{t.sort(((t,e)=>t.getContent().getZIndex()-e.getContent().getZIndex()))};class I{constructor(){this.root=new L,this.componentsById={}}findParent(t){const e=this.root.getLeavesIntersectingRegion(t.getBBox());for(const n of e)if(n.getContent()===t)return n;return null}renderWithCache(t,e,n){e.render(t,this.root,n)}render(t,e){this.root.render(t,e.visibleRect)}renderAll(t){const e=this.root.getLeaves();R(e);for(const n of e)n.getContent().render(t,n.getBBox())}getAllElements(){const t=this.root.getLeaves();return R(t),t.map((t=>t.getContent()))}getElementsIntersectingRegion(t){const e=this.root.getLeavesIntersectingRegion(t);return R(e),e.map((t=>t.getContent()))}onDestroyElement(t){delete this.componentsById[t.getId()]}lookupElement(t){var e;return null!==(e=this.componentsById[t])&&void 0!==e?e:null}addElementDirectly(t){return this.componentsById[t.getId()]=t,this.root.addLeaf(t)}static addElement(t,e=!1){return new I.AddElementCommand(t,e)}}I.AddElementCommand=(k=class extends w{constructor(t,e=!1){if(super("add-element"),this.element=t,this.applyByFlattening=e,this.serializedElem=t.serialize(),isNaN(t.getBBox().area))throw new Error("Elements in the image cannot have NaN bounding boxes")}apply(t){t.image.addElementDirectly(this.element),this.applyByFlattening?(this.applyByFlattening=!1,t.display.flatten()):t.queueRerender()}unapply(t){const e=t.image.findParent(this.element);null==e||e.remove(),t.queueRerender()}description(t,e){return e.addElementAction(this.element.description(e))}serializeToJSON(){return{elemData:this.serializedElem}}},w.register("add-element",((t,e)=>{const n=t.elemData.id,i=e.image.lookupElement(n),r=null!=i?i:E.deserialize(t.elemData);return new I.AddElementCommand(r)})),k);class L{constructor(t=null){this.parent=t,this.targetChildCount=30,this.children=[],this.bbox=B.empty,this.content=null,this.id=L.idCounter++}getId(){return this.id}onContentChange(){this.id=L.idCounter++}getContent(){return this.content}getParent(){return this.parent}getChildrenIntersectingRegion(t){return this.children.filter((e=>e.getBBox().intersects(t)))}getChildrenOrSelfIntersectingRegion(t){return this.content?[this]:this.getChildrenIntersectingRegion(t)}getLeavesIntersectingRegion(t,e){const n=[];let i;const r=[];r.push(this);const o=()=>{i=void 0;const o=r.pop();o&&!(null==e?void 0:e(o.bbox))&&(i=o,null!==i.content&&i.getBBox().intersection(t)&&n.push(i),r.push(...i.getChildrenIntersectingRegion(t)))};for(;r.length>0;)o();return n}getLeaves(){if(this.content)return[this];const t=[];for(const e of this.children)t.push(...e.getLeaves());return t}addLeaf(t){if(this.onContentChange(),null===this.content&&0===this.children.length)return this.content=t,this.recomputeBBox(!0),this;if(null!==this.content){console.assert(0===this.children.length);const t=new L(this);t.content=this.content,this.content=null,this.children.push(t),t.recomputeBBox(!1)}const e=t.getBBox();if(e.containsRect(this.getBBox())){const e=new L(this);if(this.children.length<this.targetChildCount)this.children.push(e);else{const t=new L(this);t.children=this.children,this.children=[e,t],t.recomputeBBox(!0),t.updateParents()}return e.addLeaf(t)}const n=this.children.filter((t=>t.getBBox().containsRect(e)));if(n.length>0&&this.children.length>=this.targetChildCount){n.sort(((t,e)=>t.getBBox().area-e.getBBox().area));const e=n[0].addLeaf(t);return e.rebalance(),e}const i=new L(this);return this.children.push(i),i.content=t,i.recomputeBBox(!0),i}getBBox(){return this.bbox}recomputeBBox(t){var e;const n=this.bbox;if(null!==this.content)this.bbox=this.content.getBBox();else{this.bbox=B.empty;let t=!0;for(const e of this.children)t?(this.bbox=e.getBBox(),t=!1):this.bbox=this.bbox.union(e.getBBox())}t&&!n.eq(this.bbox)&&(null===(e=this.parent)||void 0===e||e.recomputeBBox(!0))}updateParents(t=!1){for(const e of this.children)e.parent=this,t&&e.updateParents(t)}rebalance(){if(this.parent&&1===this.parent.children.length){console.assert(null===this.parent.content),console.assert(this.parent.children[0]===this);const t=this.parent;null!==t.parent?(t.children=[],this.parent=t.parent,this.parent.children.push(this),t.parent=null,this.parent.recomputeBBox(!1)):null===this.content&&(this.parent.children=this.children,this.parent.updateParents(),this.parent=null)}}remove(){if(!this.parent)return this.content=null,void(this.children=[]);const t=this.parent.children.length;this.parent.children=this.parent.children.filter((t=>t!==this)),console.assert(this.parent.children.length===t-1,`${t-1} ≠ ${this.parent.children.length} after removing all nodes equal to ${this}. Nodes should only be removed once.`),this.parent.children.forEach((t=>{t.rebalance()})),this.parent.recomputeBBox(!0),this.content=null,this.parent=null,this.children=[]}render(t,e){const n=this.getLeavesIntersectingRegion(e,(e=>t.isTooSmallToRender(e)));R(n);for(const i of n)i.getContent().render(t,e)}}var A,M,D,O,F;L.idCounter=0,function(t){t[t.PointerDownEvt=0]="PointerDownEvt",t[t.PointerMoveEvt=1]="PointerMoveEvt",t[t.PointerUpEvt=2]="PointerUpEvt",t[t.GestureCancelEvt=3]="GestureCancelEvt",t[t.WheelEvt=4]="WheelEvt",t[t.KeyPressEvent=5]="KeyPressEvent",t[t.KeyUpEvent=6]="KeyUpEvent",t[t.CopyEvent=7]="CopyEvent",t[t.PasteEvent=8]="PasteEvent"}(A||(A={})),function(t){t[t.ToolEnabled=0]="ToolEnabled",t[t.ToolDisabled=1]="ToolDisabled",t[t.ToolUpdated=2]="ToolUpdated",t[t.UndoRedoStackUpdated=3]="UndoRedoStackUpdated",t[t.CommandDone=4]="CommandDone",t[t.CommandUndone=5]="CommandUndone",t[t.ObjectAdded=6]="ObjectAdded",t[t.ViewportChanged=7]="ViewportChanged",t[t.DisplayResized=8]="DisplayResized",t[t.ColorPickerToggled=9]="ColorPickerToggled",t[t.ColorPickerColorSelected=10]="ColorPickerColorSelected",t[t.ToolbarDropdownShown=11]="ToolbarDropdownShown"}(M||(M={})),function(t){t[t.Pen=0]="Pen",t[t.Eraser=1]="Eraser",t[t.Touch=2]="Touch",t[t.PrimaryButtonMouse=3]="PrimaryButtonMouse",t[t.RightButtonMouse=4]="RightButtonMouse",t[t.Other=5]="Other"}(D||(D={}));class ${constructor(t,e,n,i,r,o,s,a){this.screenPos=t,this.canvasPos=e,this.pressure=n,this.isPrimary=i,this.down=r,this.device=o,this.id=s,this.timeStamp=a}static ofEvent(t,e,n,i){var r,o;let s=S.of(t.clientX,t.clientY);if(i){const t=i.getBoundingClientRect();s=s.minus(S.of(t.left,t.top))}let a=null!==(r={mouse:D.PrimaryButtonMouse,pen:D.Pen,touch:D.Touch}[t.pointerType])&&void 0!==r?r:D.Other;a===D.Pen&&0!=(32&t.buttons)&&(a=D.Eraser);const l=(new Date).getTime(),c=n.roundPoint(n.screenToCanvas(s));return a===D.PrimaryButtonMouse&&(2&t.buttons?a=D.RightButtonMouse:1&t.buttons||(a=D.Other)),new $(s,c,null!==(o=t.pressure)&&void 0!==o?o:null,t.isPrimary,e,a,t.pointerId,l)}static ofCanvasPoint(t,e,n,i=0,r=D.Pen,o=!0,s=null){const a=n.canvasToScreen(t),l=(new Date).getTime();return new $(a,t,s,o,e,r,i,l)}}class N extends b{}class j{constructor(t){this.notifier=t,this.resetTransform(P.identity),this.screenRect=B.empty}updateScreenSize(t){this.screenRect=this.screenRect.resizedTo(t)}get visibleRect(){return this.screenRect.transformedBoundingBox(this.inverseTransform)}screenToCanvas(t){return this.inverseTransform.transformVec2(t)}canvasToScreen(t){return this.transform.transformVec2(t)}static transformBy(t){return new j.ViewportTransform(t)}resetTransform(t=P.identity){const e=this.transform;this.transform=t,this.inverseTransform=t.inverse(),this.notifier.dispatch(M.ViewportChanged,{kind:M.ViewportChanged,newTransform:t,oldTransform:e})}get screenToCanvasTransform(){return this.inverseTransform}get canvasToScreenTransform(){return this.transform}getResolution(){return this.screenRect.size}getScaleFactor(){return this.transform.transformVec3(T.unitX).magnitude()}getSizeOfPixelOnCanvas(){return 1/this.getScaleFactor()}getRotationAngle(){return this.transform.transformVec3(T.unitX).angle()}static roundPoint(t,e){const n=Math.pow(10,Math.floor(Math.log10(e))),i=t=>Math.round(t/n)*n;return"number"==typeof t?i(t):t.map(i)}roundPoint(t){return j.roundPoint(t,1/this.getScaleFactor())}static roundScaleRatio(t,e=1){if(Math.abs(t)<=1e-12)return 0;const n=Math.pow(10,Math.floor(Math.log10(Math.abs(t)))),i=Math.pow(2,e);return Math.round(t/n*i)/i*n}computeZoomToTransform(t,e=!0,n=!0){let i=P.identity;if(0===t.w||0===t.h)throw new Error(`${t.toString()} rectangle is empty! Cannot zoom to!`);if(isNaN(t.size.magnitude()))throw new Error(`${t.toString()} rectangle has NaN size! Cannot zoom to!`);const r=()=>{const t=this.visibleRect.transformedBoundingBox(i.inverse());return t.transformedBoundingBox(P.scaling2D(.8,t.center))};let o=r();const s=o.w<t.w||o.h<t.h,a=t.maxDimension/o.maxDimension<1/3;if(s&&n||a&&e){const e=Math.max(t.w/o.w,t.h/o.h),n=P.scaling2D(e,o.topLeft).inverse();i=i.rightMul(n)}if(o=r(),!o.containsRect(t)){const e=t.center.minus(o.center),n=P.translation(e).inverse();i=i.rightMul(n)}return i.invertable()||(console.warn("Unable to zoom to ",t,"! Computed transform",i,"is singular."),i=P.identity),i}zoomTo(t,e=!0,n=!0){const i=this.computeZoomToTransform(t,e,n);return new j.ViewportTransform(i)}}j.ViewportTransform=(F=class extends N{constructor(t){super(),this.transform=t,O.set(this,void 0),function(t,e,n,i,r){if("function"==typeof e||!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");e.set(t,n)}(this,O,t.inverse())}apply(t){const e=t.viewport;e.resetTransform(e.transform.rightMul(this.transform)),t.queueRerender()}unapply(t){const e=t.viewport;e.resetTransform(e.transform.rightMul(function(t,e,n,i){if("function"==typeof e||!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return e.get(t)}(this,O))),t.queueRerender()}description(t,e){const n=[],i=t.viewport.visibleRect.center,r=this.transform.transformVec3(S.unitX),o=this.transform.transformVec2(i),s=r.magnitude(),a=180/Math.PI*r.angle(),l=o.minus(i);s>1.2?n.push(e.zoomedIn):s<.8&&n.push(e.zoomedOut),Math.floor(Math.abs(a))>0&&n.push(e.rotatedBy(Math.round(a)));const c=1e-4;return l.x>c?n.push(e.movedLeft):l.x<-1e-4&&n.push(e.movedRight),l.y<-1e-4?n.push(e.movedDown):l.y>c&&n.push(e.movedUp),n.join("; ")}},O=new WeakMap,F);const U=j;class V{onPointerDown(t){return!1}onPointerMove(t){}onPointerUp(t){}onGestureCancel(){}constructor(t,e){this.notifier=t,this.description=e,this.enabled=!0,this.group=null}onWheel(t){return!1}onCopy(t){return!1}onPaste(t){return!1}onKeyPress(t){return!1}onKeyUp(t){return!1}setEnabled(t){var e;this.enabled=t,t?(null===(e=this.group)||void 0===e||e.notifyEnabled(this),this.notifier.dispatch(M.ToolEnabled,{kind:M.ToolEnabled,tool:this})):this.notifier.dispatch(M.ToolDisabled,{kind:M.ToolDisabled,tool:this})}isEnabled(){return this.enabled}setToolGroup(t){this.isEnabled()&&t.notifyEnabled(this),this.group=t}getToolGroup(){return this.group?this.group:null}}var W;!function(t){t[t.OneFingerTouchGestures=1]="OneFingerTouchGestures",t[t.TwoFingerTouchGestures=2]="TwoFingerTouchGestures",t[t.RightClickDrags=4]="RightClickDrags",t[t.SinglePointerGestures=8]="SinglePointerGestures",t[t.Keyboard=16]="Keyboard",t[t.RotationLocked=32]="RotationLocked"}(W||(W={}));class H extends V{constructor(t,e,n){super(t.notifier,n),this.editor=t,this.mode=e,this.transform=null}computePinchData(t,e){const n=e.screenPos.minus(t.screenPos),i=n.angle(),r=n.magnitude();return{canvasCenter:e.canvasPos.plus(t.canvasPos).times(.5),screenCenter:e.screenPos.plus(t.screenPos).times(.5),angle:i,dist:r}}allPointersAreOfType(t,e){return t.every((t=>t.device===e))}onPointerDown({allPointers:t}){var e;let n=!1;const i=this.allPointersAreOfType(t,D.Touch),r=this.allPointersAreOfType(t,D.RightButtonMouse);if(i&&2===t.length&&this.mode&W.TwoFingerTouchGestures){const{screenCenter:e,angle:i,dist:r}=this.computePinchData(t[0],t[1]);this.lastAngle=i,this.lastDist=r,this.lastScreenCenter=e,n=!0}else 1===t.length&&(this.mode&W.OneFingerTouchGestures&&i||r&&this.mode&W.RightClickDrags||this.mode&W.SinglePointerGestures)&&(this.lastScreenCenter=t[0].screenPos,n=!0);return n&&(null!==(e=this.transform)&&void 0!==e||(this.transform=j.transformBy(P.identity)),this.editor.display.setDraftMode(!0)),n}getCenterDelta(t){return this.editor.viewport.screenToCanvasTransform.transformVec3(t.minus(this.lastScreenCenter))}handleTwoFingerMove(t){const{screenCenter:e,canvasCenter:n,angle:i,dist:r}=this.computePinchData(t[0],t[1]),o=this.getCenterDelta(e);let s=i-this.lastAngle;this.isRotationLocked()&&(s=0);const a=P.translation(o).rightMul(P.scaling2D(r/this.lastDist,n)).rightMul(P.zRotation(s,n));this.lastScreenCenter=e,this.lastDist=r,this.lastAngle=i,this.transform=j.transformBy(this.transform.transform.rightMul(a))}handleOneFingerMove(t){const e=this.getCenterDelta(t.screenPos);this.transform=j.transformBy(this.transform.transform.rightMul(P.translation(e))),this.lastScreenCenter=t.screenPos}onPointerMove({allPointers:t}){var e;null!==(e=this.transform)&&void 0!==e||(this.transform=j.transformBy(P.identity));const n=this.transform;2===t.length?this.handleTwoFingerMove(t):1===t.length&&this.handleOneFingerMove(t[0]),n.unapply(this.editor),this.transform.apply(this.editor)}onPointerUp(t){this.transform&&(this.transform.unapply(this.editor),this.editor.dispatch(this.transform,!1)),this.editor.display.setDraftMode(!1),this.transform=null}onGestureCancel(){var t;null===(t=this.transform)||void 0===t||t.unapply(this.editor),this.editor.display.setDraftMode(!1),this.transform=null}updateTransform(t,e=!1){var n;let i=t;this.transform&&(i=this.transform.transform.rightMul(t)),null===(n=this.transform)||void 0===n||n.unapply(this.editor),this.transform=j.transformBy(i),this.transform.apply(this.editor),e&&this.editor.announceForAccessibility(this.transform.description(this.editor,this.editor.localization))}onWheel({delta:t,screenPos:e}){this.transform=j.transformBy(P.identity);const n=this.editor.viewport.screenToCanvas(e),i=this.editor.viewport.screenToCanvasTransform.transformVec3(T.of(-t.x,-t.y,0)),r=P.scaling2D(Math.max(.25,Math.min(Math.pow(1.04,-t.z),4)),n).rightMul(P.translation(i));return this.updateTransform(r,!0),!0}onKeyPress({key:t,ctrlKey:e,altKey:n}){if(!(this.mode&W.Keyboard))return!1;if(e||n)return!1;this.transform=j.transformBy(P.identity);let i=S.zero,r=1,o=0;switch(t){case"a":case"h":case"ArrowLeft":i=S.of(-1,0);break;case"d":case"l":case"ArrowRight":i=S.of(1,0);break;case"q":case"k":case"ArrowUp":i=S.of(0,-1);break;case"e":case"j":case"ArrowDown":i=S.of(0,1);break;case"w":r=.5;break;case"s":r=2;break;case"r":o=1;break;case"R":o=-1;break;default:return!1}i=i.times(30),o*=Math.PI/8,i=i.times(-1),o*=-1,r=1/r,0!==o&&(o+=1e-4),this.isRotationLocked()&&(o=0),i=this.editor.viewport.screenToCanvasTransform.transformVec3(i);const s=this.editor.viewport.visibleRect.center,a=P.scaling2D(r,s).rightMul(P.zRotation(o,s)).rightMul(P.translation(i));return this.updateTransform(a,!0),!0}isRotationLocked(){return!!(this.mode&W.RotationLocked)}setModeEnabled(t,e){let n=this.mode;e?n|=t:n&=~t,this.setMode(n)}setMode(t){t!==this.mode&&(this.mode=t,this.editor.notifier.dispatch(M.ToolUpdated,{kind:M.ToolUpdated,tool:this}))}getMode(){return this.mode}}const{abs:G,cos:_,sin:q,acos:K,atan2:Z,sqrt:X,pow:Y}=Math;function J(t){return t<0?-Y(-t,1/3):Y(t,1/3)}const Q=Math.PI,tt=2*Q,et=Q/2,nt=Number.MAX_SAFE_INTEGER||9007199254740991,it=Number.MIN_SAFE_INTEGER||-9007199254740991,rt={x:0,y:0,z:0},ot={Tvalues:[-.06405689286260563,.06405689286260563,-.1911188674736163,.1911188674736163,-.3150426796961634,.3150426796961634,-.4337935076260451,.4337935076260451,-.5454214713888396,.5454214713888396,-.6480936519369755,.6480936519369755,-.7401241915785544,.7401241915785544,-.820001985973903,.820001985973903,-.8864155270044011,.8864155270044011,-.9382745520027328,.9382745520027328,-.9747285559713095,.9747285559713095,-.9951872199970213,.9951872199970213],Cvalues:[.12793819534675216,.12793819534675216,.1258374563468283,.1258374563468283,.12167047292780339,.12167047292780339,.1155056680537256,.1155056680537256,.10744427011596563,.10744427011596563,.09761865210411388,.09761865210411388,.08619016153195327,.08619016153195327,.0733464814110803,.0733464814110803,.05929858491543678,.05929858491543678,.04427743881741981,.04427743881741981,.028531388628933663,.028531388628933663,.0123412297999872,.0123412297999872],arcfn:function(t,e){const n=e(t);let i=n.x*n.x+n.y*n.y;return void 0!==n.z&&(i+=n.z*n.z),X(i)},compute:function(t,e,n){if(0===t)return e[0].t=0,e[0];const i=e.length-1;if(1===t)return e[i].t=1,e[i];const r=1-t;let o=e;if(0===i)return e[0].t=t,e[0];if(1===i){const e={x:r*o[0].x+t*o[1].x,y:r*o[0].y+t*o[1].y,t};return n&&(e.z=r*o[0].z+t*o[1].z),e}if(i<4){let e,s,a,l=r*r,c=t*t,h=0;2===i?(o=[o[0],o[1],o[2],rt],e=l,s=r*t*2,a=c):3===i&&(e=l*r,s=l*t*3,a=r*c*3,h=t*c);const d={x:e*o[0].x+s*o[1].x+a*o[2].x+h*o[3].x,y:e*o[0].y+s*o[1].y+a*o[2].y+h*o[3].y,t};return n&&(d.z=e*o[0].z+s*o[1].z+a*o[2].z+h*o[3].z),d}const s=JSON.parse(JSON.stringify(e));for(;s.length>1;){for(let e=0;e<s.length-1;e++)s[e]={x:s[e].x+(s[e+1].x-s[e].x)*t,y:s[e].y+(s[e+1].y-s[e].y)*t},void 0!==s[e].z&&(s[e]=s[e].z+(s[e+1].z-s[e].z)*t);s.splice(s.length-1,1)}return s[0].t=t,s[0]},computeWithRatios:function(t,e,n,i){const r=1-t,o=n,s=e;let a,l=o[0],c=o[1],h=o[2],d=o[3];return l*=r,c*=t,2===s.length?(a=l+c,{x:(l*s[0].x+c*s[1].x)/a,y:(l*s[0].y+c*s[1].y)/a,z:!!i&&(l*s[0].z+c*s[1].z)/a,t}):(l*=r,c*=2*r,h*=t*t,3===s.length?(a=l+c+h,{x:(l*s[0].x+c*s[1].x+h*s[2].x)/a,y:(l*s[0].y+c*s[1].y+h*s[2].y)/a,z:!!i&&(l*s[0].z+c*s[1].z+h*s[2].z)/a,t}):(l*=r,c*=1.5*r,h*=3*r,d*=t*t*t,4===s.length?(a=l+c+h+d,{x:(l*s[0].x+c*s[1].x+h*s[2].x+d*s[3].x)/a,y:(l*s[0].y+c*s[1].y+h*s[2].y+d*s[3].y)/a,z:!!i&&(l*s[0].z+c*s[1].z+h*s[2].z+d*s[3].z)/a,t}):void 0))},derive:function(t,e){const n=[];for(let i=t,r=i.length,o=r-1;r>1;r--,o--){const t=[];for(let n,r=0;r<o;r++)n={x:o*(i[r+1].x-i[r].x),y:o*(i[r+1].y-i[r].y)},e&&(n.z=o*(i[r+1].z-i[r].z)),t.push(n);n.push(t),i=t}return n},between:function(t,e,n){return e<=t&&t<=n||ot.approximately(t,e)||ot.approximately(t,n)},approximately:function(t,e,n){return G(t-e)<=(n||1e-6)},length:function(t){const e=ot.Tvalues.length;let n=0;for(let i,r=0;r<e;r++)i=.5*ot.Tvalues[r]+.5,n+=ot.Cvalues[r]*ot.arcfn(i,t);return.5*n},map:function(t,e,n,i,r){return i+(t-e)/(n-e)*(r-i)},lerp:function(t,e,n){const i={x:e.x+t*(n.x-e.x),y:e.y+t*(n.y-e.y)};return void 0!==e.z&&void 0!==n.z&&(i.z=e.z+t*(n.z-e.z)),i},pointToString:function(t){let e=t.x+"/"+t.y;return void 0!==t.z&&(e+="/"+t.z),e},pointsToString:function(t){return"["+t.map(ot.pointToString).join(", ")+"]"},copy:function(t){return JSON.parse(JSON.stringify(t))},angle:function(t,e,n){const i=e.x-t.x,r=e.y-t.y,o=n.x-t.x,s=n.y-t.y;return Z(i*s-r*o,i*o+r*s)},round:function(t,e){const n=""+t,i=n.indexOf(".");return parseFloat(n.substring(0,i+1+e))},dist:function(t,e){const n=t.x-e.x,i=t.y-e.y;return X(n*n+i*i)},closest:function(t,e){let n,i,r=Y(2,63);return t.forEach((function(t,o){i=ot.dist(e,t),i<r&&(r=i,n=o)})),{mdist:r,mpos:n}},abcratio:function(t,e){if(2!==e&&3!==e)return!1;if(void 0===t)t=.5;else if(0===t||1===t)return t;const n=Y(t,e)+Y(1-t,e);return G((n-1)/n)},projectionratio:function(t,e){if(2!==e&&3!==e)return!1;if(void 0===t)t=.5;else if(0===t||1===t)return t;const n=Y(1-t,e);return n/(Y(t,e)+n)},lli8:function(t,e,n,i,r,o,s,a){const l=(t-n)*(o-a)-(e-i)*(r-s);return 0!=l&&{x:((t*i-e*n)*(r-s)-(t-n)*(r*a-o*s))/l,y:((t*i-e*n)*(o-a)-(e-i)*(r*a-o*s))/l}},lli4:function(t,e,n,i){const r=t.x,o=t.y,s=e.x,a=e.y,l=n.x,c=n.y,h=i.x,d=i.y;return ot.lli8(r,o,s,a,l,c,h,d)},lli:function(t,e){return ot.lli4(t,t.c,e,e.c)},makeline:function(t,e){return new gt(t.x,t.y,(t.x+e.x)/2,(t.y+e.y)/2,e.x,e.y)},findbbox:function(t){let e=nt,n=nt,i=it,r=it;return t.forEach((function(t){const o=t.bbox();e>o.x.min&&(e=o.x.min),n>o.y.min&&(n=o.y.min),i<o.x.max&&(i=o.x.max),r<o.y.max&&(r=o.y.max)})),{x:{min:e,mid:(e+i)/2,max:i,size:i-e},y:{min:n,mid:(n+r)/2,max:r,size:r-n}}},shapeintersections:function(t,e,n,i,r){if(!ot.bboxoverlap(e,i))return[];const o=[],s=[t.startcap,t.forward,t.back,t.endcap],a=[n.startcap,n.forward,n.back,n.endcap];return s.forEach((function(e){e.virtual||a.forEach((function(i){if(i.virtual)return;const s=e.intersects(i,r);s.length>0&&(s.c1=e,s.c2=i,s.s1=t,s.s2=n,o.push(s))}))})),o},makeshape:function(t,e,n){const i=e.points.length,r=t.points.length,o=ot.makeline(e.points[i-1],t.points[0]),s=ot.makeline(t.points[r-1],e.points[0]),a={startcap:o,forward:t,back:e,endcap:s,bbox:ot.findbbox([o,t,e,s]),intersections:function(t){return ot.shapeintersections(a,a.bbox,t,t.bbox,n)}};return a},getminmax:function(t,e,n){if(!n)return{min:0,max:0};let i,r,o=nt,s=it;-1===n.indexOf(0)&&(n=[0].concat(n)),-1===n.indexOf(1)&&n.push(1);for(let a=0,l=n.length;a<l;a++)i=n[a],r=t.get(i),r[e]<o&&(o=r[e]),r[e]>s&&(s=r[e]);return{min:o,mid:(o+s)/2,max:s,size:s-o}},align:function(t,e){const n=e.p1.x,i=e.p1.y,r=-Z(e.p2.y-i,e.p2.x-n);return t.map((function(t){return{x:(t.x-n)*_(r)-(t.y-i)*q(r),y:(t.x-n)*q(r)+(t.y-i)*_(r)}}))},roots:function(t,e){e=e||{p1:{x:0,y:0},p2:{x:1,y:0}};const n=t.length-1,i=ot.align(t,e),r=function(t){return 0<=t&&t<=1};if(2===n){const t=i[0].y,e=i[1].y,n=i[2].y,o=t-2*e+n;if(0!==o){const i=-X(e*e-t*n),s=-t+e;return[-(i+s)/o,-(-i+s)/o].filter(r)}return e!==n&&0===o?[(2*e-n)/(2*e-2*n)].filter(r):[]}const o=i[0].y,s=i[1].y,a=i[2].y;let l=3*s-o-3*a+i[3].y,c=3*o-6*s+3*a,h=-3*o+3*s,d=o;if(ot.approximately(l,0)){if(ot.approximately(c,0))return ot.approximately(h,0)?[]:[-d/h].filter(r);const t=X(h*h-4*c*d),e=2*c;return[(t-h)/e,(-h-t)/e].filter(r)}c/=l,h/=l,d/=l;const u=(3*h-c*c)/3,p=u/3,m=(2*c*c*c-9*c*h+27*d)/27,g=m/2,f=g*g+p*p*p;let v,y,x,b,w;if(f<0){const t=-u/3,e=X(t*t*t),n=-m/(2*e),i=K(n<-1?-1:n>1?1:n),o=2*J(e);return x=o*_(i/3)-c/3,b=o*_((i+tt)/3)-c/3,w=o*_((i+2*tt)/3)-c/3,[x,b,w].filter(r)}if(0===f)return v=g<0?J(-g):-J(g),x=2*v-c/3,b=-v-c/3,[x,b].filter(r);{const t=X(f);return v=J(-g+t),y=J(g+t),[v-y-c/3].filter(r)}},droots:function(t){if(3===t.length){const e=t[0],n=t[1],i=t[2],r=e-2*n+i;if(0!==r){const t=-X(n*n-e*i),o=-e+n;return[-(t+o)/r,-(-t+o)/r]}return n!==i&&0===r?[(2*n-i)/(2*(n-i))]:[]}if(2===t.length){const e=t[0],n=t[1];return e!==n?[e/(e-n)]:[]}return[]},curvature:function(t,e,n,i,r){let o,s,a,l,c=0,h=0;const d=ot.compute(t,e),u=ot.compute(t,n),p=d.x*d.x+d.y*d.y;if(i?(o=X(Y(d.y*u.z-u.y*d.z,2)+Y(d.z*u.x-u.z*d.x,2)+Y(d.x*u.y-u.x*d.y,2)),s=Y(p+d.z*d.z,1.5)):(o=d.x*u.y-d.y*u.x,s=Y(p,1.5)),0===o||0===s)return{k:0,r:0};if(c=o/s,h=s/o,!r){const r=ot.curvature(t-.001,e,n,i,!0).k,o=ot.curvature(t+.001,e,n,i,!0).k;l=(o-c+(c-r))/2,a=(G(o-c)+G(c-r))/2}return{k:c,r:h,dk:l,adk:a}},inflections:function(t){if(t.length<4)return[];const e=ot.align(t,{p1:t[0],p2:t.slice(-1)[0]}),n=e[2].x*e[1].y,i=e[3].x*e[1].y,r=e[1].x*e[2].y,o=18*(-3*n+2*i+3*r-e[3].x*e[2].y),s=18*(3*n-i-3*r),a=18*(r-n);if(ot.approximately(o,0)){if(!ot.approximately(s,0)){let t=-a/s;if(0<=t&&t<=1)return[t]}return[]}const l=2*o;if(ot.approximately(l,0))return[];const c=s*s-4*o*a;if(c<0)return[];const h=Math.sqrt(c);return[(h-s)/l,-(s+h)/l].filter((function(t){return 0<=t&&t<=1}))},bboxoverlap:function(t,e){const n=["x","y"],i=n.length;for(let r,o,s,a,l=0;l<i;l++)if(r=n[l],o=t[r].mid,s=e[r].mid,a=(t[r].size+e[r].size)/2,G(o-s)>=a)return!1;return!0},expandbox:function(t,e){e.x.min<t.x.min&&(t.x.min=e.x.min),e.y.min<t.y.min&&(t.y.min=e.y.min),e.z&&e.z.min<t.z.min&&(t.z.min=e.z.min),e.x.max>t.x.max&&(t.x.max=e.x.max),e.y.max>t.y.max&&(t.y.max=e.y.max),e.z&&e.z.max>t.z.max&&(t.z.max=e.z.max),t.x.mid=(t.x.min+t.x.max)/2,t.y.mid=(t.y.min+t.y.max)/2,t.z&&(t.z.mid=(t.z.min+t.z.max)/2),t.x.size=t.x.max-t.x.min,t.y.size=t.y.max-t.y.min,t.z&&(t.z.size=t.z.max-t.z.min)},pairiteration:function(t,e,n){const i=t.bbox(),r=e.bbox(),o=1e5,s=n||.5;if(i.x.size+i.y.size<s&&r.x.size+r.y.size<s)return[(o*(t._t1+t._t2)/2|0)/o+"/"+(o*(e._t1+e._t2)/2|0)/o];let a=t.split(.5),l=e.split(.5),c=[{left:a.left,right:l.left},{left:a.left,right:l.right},{left:a.right,right:l.right},{left:a.right,right:l.left}];c=c.filter((function(t){return ot.bboxoverlap(t.left.bbox(),t.right.bbox())}));let h=[];return 0===c.length||(c.forEach((function(t){h=h.concat(ot.pairiteration(t.left,t.right,s))})),h=h.filter((function(t,e){return h.indexOf(t)===e}))),h},getccenter:function(t,e,n){const i=e.x-t.x,r=e.y-t.y,o=n.x-e.x,s=n.y-e.y,a=i*_(et)-r*q(et),l=i*q(et)+r*_(et),c=o*_(et)-s*q(et),h=o*q(et)+s*_(et),d=(t.x+e.x)/2,u=(t.y+e.y)/2,p=(e.x+n.x)/2,m=(e.y+n.y)/2,g=d+a,f=u+l,v=p+c,y=m+h,x=ot.lli8(d,u,g,f,p,m,v,y),b=ot.dist(x,t);let w,T=Z(t.y-x.y,t.x-x.x),S=Z(e.y-x.y,e.x-x.x),C=Z(n.y-x.y,n.x-x.x);return T<C?((T>S||S>C)&&(T+=tt),T>C&&(w=C,C=T,T=w)):C<S&&S<T?(w=C,C=T,T=w):C+=tt,x.s=T,x.e=C,x.r=b,x},numberSort:function(t,e){return t-e}};class st{constructor(t){this.curves=[],this._3d=!1,t&&(this.curves=t,this._3d=this.curves[0]._3d)}valueOf(){return this.toString()}toString(){return"["+this.curves.map((function(t){return ot.pointsToString(t.points)})).join(", ")+"]"}addCurve(t){this.curves.push(t),this._3d=this._3d||t._3d}length(){return this.curves.map((function(t){return t.length()})).reduce((function(t,e){return t+e}))}curve(t){return this.curves[t]}bbox(){const t=this.curves;for(var e=t[0].bbox(),n=1;n<t.length;n++)ot.expandbox(e,t[n].bbox());return e}offset(t){const e=[];return this.curves.forEach((function(n){e.push(...n.offset(t))})),new st(e)}}const{abs:at,min:lt,max:ct,cos:ht,sin:dt,acos:ut,sqrt:pt}=Math,mt=Math.PI;class gt{constructor(t){let e=t&&t.forEach?t:Array.from(arguments).slice(),n=!1;if("object"==typeof e[0]){n=e.length;const t=[];e.forEach((function(e){["x","y","z"].forEach((function(n){void 0!==e[n]&&t.push(e[n])}))})),e=t}let i=!1;const r=e.length;if(n){if(n>4){if(1!==arguments.length)throw new Error("Only new Bezier(point[]) is accepted for 4th and higher order curves");i=!0}}else if(6!==r&&8!==r&&9!==r&&12!==r&&1!==arguments.length)throw new Error("Only new Bezier(point[]) is accepted for 4th and higher order curves");const o=this._3d=!i&&(9===r||12===r)||t&&t[0]&&void 0!==t[0].z,s=this.points=[];for(let t=0,n=o?3:2;t<r;t+=n){var a={x:e[t],y:e[t+1]};o&&(a.z=e[t+2]),s.push(a)}const l=this.order=s.length-1,c=this.dims=["x","y"];o&&c.push("z"),this.dimlen=c.length;const h=ot.align(s,{p1:s[0],p2:s[l]}),d=ot.dist(s[0],s[l]);this._linear=h.reduce(((t,e)=>t+at(e.y)),0)<d/50,this._lut=[],this._t1=0,this._t2=1,this.update()}static quadraticFromPoints(t,e,n,i){if(void 0===i&&(i=.5),0===i)return new gt(e,e,n);if(1===i)return new gt(t,e,e);const r=gt.getABC(2,t,e,n,i);return new gt(t,r.A,n)}static cubicFromPoints(t,e,n,i,r){void 0===i&&(i=.5);const o=gt.getABC(3,t,e,n,i);void 0===r&&(r=ot.dist(e,o.C));const s=r*(1-i)/i,a=ot.dist(t,n),l=(n.x-t.x)/a,c=(n.y-t.y)/a,h=r*l,d=r*c,u=s*l,p=s*c,m=e.x-h,g=e.y-d,f=e.x+u,v=e.y+p,y=o.A,x=y.x+(m-y.x)/(1-i),b=y.y+(g-y.y)/(1-i),w=y.x+(f-y.x)/i,T=y.y+(v-y.y)/i,S={x:t.x+(x-t.x)/i,y:t.y+(b-t.y)/i},C={x:n.x+(w-n.x)/(1-i),y:n.y+(T-n.y)/(1-i)};return new gt(t,S,C,n)}static getUtils(){return ot}getUtils(){return gt.getUtils()}static get PolyBezier(){return st}valueOf(){return this.toString()}toString(){return ot.pointsToString(this.points)}toSVG(){if(this._3d)return!1;const t=this.points,e=["M",t[0].x,t[0].y,2===this.order?"Q":"C"];for(let n=1,i=t.length;n<i;n++)e.push(t[n].x),e.push(t[n].y);return e.join(" ")}setRatios(t){if(t.length!==this.points.length)throw new Error("incorrect number of ratio values");this.ratios=t,this._lut=[]}verify(){const t=this.coordDigest();t!==this._print&&(this._print=t,this.update())}coordDigest(){return this.points.map((function(t,e){return""+e+t.x+t.y+(t.z?t.z:0)})).join("")}update(){this._lut=[],this.dpoints=ot.derive(this.points,this._3d),this.computedirection()}computedirection(){const t=this.points,e=ot.angle(t[0],t[this.order],t[1]);this.clockwise=e>0}length(){return ot.length(this.derivative.bind(this))}static getABC(t=2,e,n,i,r=.5){const o=ot.projectionratio(r,t),s=1-o,a={x:o*e.x+s*i.x,y:o*e.y+s*i.y},l=ot.abcratio(r,t);return{A:{x:n.x+(n.x-a.x)/l,y:n.y+(n.y-a.y)/l},B:n,C:a,S:e,E:i}}getABC(t,e){e=e||this.get(t);let n=this.points[0],i=this.points[this.order];return gt.getABC(this.order,n,e,i,t)}getLUT(t){if(this.verify(),t=t||100,this._lut.length===t)return this._lut;this._lut=[],t++,this._lut=[];for(let e,n,i=0;i<t;i++)n=i/(t-1),e=this.compute(n),e.t=n,this._lut.push(e);return this._lut}on(e,n){n=n||5;const i=this.getLUT(),r=[];for(let t,o=0,s=0;o<i.length;o++)t=i[o],ot.dist(t,e)<n&&(r.push(t),s+=o/i.length);return!!r.length&&(t/=r.length)}project(t){const e=this.getLUT(),n=e.length-1,i=ot.closest(e,t),r=i.mpos,o=(r-1)/n,s=(r+1)/n,a=.1/n;let l,c,h=i.mdist,d=o,u=d;for(h+=1;d<s+a;d+=a)l=this.compute(d),c=ot.dist(t,l),c<h&&(h=c,u=d);return u=u<0?0:u>1?1:u,l=this.compute(u),l.t=u,l.d=h,l}get(t){return this.compute(t)}point(t){return this.points[t]}compute(t){return this.ratios?ot.computeWithRatios(t,this.points,this.ratios,this._3d):ot.compute(t,this.points,this._3d,this.ratios)}raise(){const t=this.points,e=[t[0]],n=t.length;for(let i,r,o=1;o<n;o++)i=t[o],r=t[o-1],e[o]={x:(n-o)/n*i.x+o/n*r.x,y:(n-o)/n*i.y+o/n*r.y};return e[n]=t[n-1],new gt(e)}derivative(t){return ot.compute(t,this.dpoints[0],this._3d)}dderivative(t){return ot.compute(t,this.dpoints[1],this._3d)}align(){let t=this.points;return new gt(ot.align(t,{p1:t[0],p2:t[t.length-1]}))}curvature(t){return ot.curvature(t,this.dpoints[0],this.dpoints[1],this._3d)}inflections(){return ot.inflections(this.points)}normal(t){return this._3d?this.__normal3(t):this.__normal2(t)}__normal2(t){const e=this.derivative(t),n=pt(e.x*e.x+e.y*e.y);return{t,x:-e.y/n,y:e.x/n}}__normal3(t){const e=this.derivative(t),n=this.derivative(t+.01),i=pt(e.x*e.x+e.y*e.y+e.z*e.z),r=pt(n.x*n.x+n.y*n.y+n.z*n.z);e.x/=i,e.y/=i,e.z/=i,n.x/=r,n.y/=r,n.z/=r;const o={x:n.y*e.z-n.z*e.y,y:n.z*e.x-n.x*e.z,z:n.x*e.y-n.y*e.x},s=pt(o.x*o.x+o.y*o.y+o.z*o.z);o.x/=s,o.y/=s,o.z/=s;const a=[o.x*o.x,o.x*o.y-o.z,o.x*o.z+o.y,o.x*o.y+o.z,o.y*o.y,o.y*o.z-o.x,o.x*o.z-o.y,o.y*o.z+o.x,o.z*o.z];return{t,x:a[0]*e.x+a[1]*e.y+a[2]*e.z,y:a[3]*e.x+a[4]*e.y+a[5]*e.z,z:a[6]*e.x+a[7]*e.y+a[8]*e.z}}hull(t){let e=this.points,n=[],i=[],r=0;for(i[r++]=e[0],i[r++]=e[1],i[r++]=e[2],3===this.order&&(i[r++]=e[3]);e.length>1;){n=[];for(let o,s=0,a=e.length-1;s<a;s++)o=ot.lerp(t,e[s],e[s+1]),i[r++]=o,n.push(o);e=n}return i}split(t,e){if(0===t&&e)return this.split(e).left;if(1===e)return this.split(t).right;const n=this.hull(t),i={left:2===this.order?new gt([n[0],n[3],n[5]]):new gt([n[0],n[4],n[7],n[9]]),right:2===this.order?new gt([n[5],n[4],n[2]]):new gt([n[9],n[8],n[6],n[3]]),span:n};return i.left._t1=ot.map(0,0,1,this._t1,this._t2),i.left._t2=ot.map(t,0,1,this._t1,this._t2),i.right._t1=ot.map(t,0,1,this._t1,this._t2),i.right._t2=ot.map(1,0,1,this._t1,this._t2),e?(e=ot.map(e,t,1,0,1),i.right.split(e).left):i}extrema(){const t={};let e=[];return this.dims.forEach(function(n){let i=function(t){return t[n]},r=this.dpoints[0].map(i);t[n]=ot.droots(r),3===this.order&&(r=this.dpoints[1].map(i),t[n]=t[n].concat(ot.droots(r))),t[n]=t[n].filter((function(t){return t>=0&&t<=1})),e=e.concat(t[n].sort(ot.numberSort))}.bind(this)),t.values=e.sort(ot.numberSort).filter((function(t,n){return e.indexOf(t)===n})),t}bbox(){const t=this.extrema(),e={};return this.dims.forEach(function(n){e[n]=ot.getminmax(this,n,t[n])}.bind(this)),e}overlaps(t){const e=this.bbox(),n=t.bbox();return ot.bboxoverlap(e,n)}offset(t,e){if(void 0!==e){const n=this.get(t),i=this.normal(t),r={c:n,n:i,x:n.x+i.x*e,y:n.y+i.y*e};return this._3d&&(r.z=n.z+i.z*e),r}if(this._linear){const e=this.normal(0),n=this.points.map((function(n){const i={x:n.x+t*e.x,y:n.y+t*e.y};return n.z&&e.z&&(i.z=n.z+t*e.z),i}));return[new gt(n)]}return this.reduce().map((function(e){return e._linear?e.offset(t)[0]:e.scale(t)}))}simple(){if(3===this.order){const t=ot.angle(this.points[0],this.points[3],this.points[1]),e=ot.angle(this.points[0],this.points[3],this.points[2]);if(t>0&&e<0||t<0&&e>0)return!1}const t=this.normal(0),e=this.normal(1);let n=t.x*e.x+t.y*e.y;return this._3d&&(n+=t.z*e.z),at(ut(n))<mt/3}reduce(){let t,e,n=0,i=0,r=.01,o=[],s=[],a=this.extrema().values;for(-1===a.indexOf(0)&&(a=[0].concat(a)),-1===a.indexOf(1)&&a.push(1),n=a[0],t=1;t<a.length;t++)i=a[t],e=this.split(n,i),e._t1=n,e._t2=i,o.push(e),n=i;return o.forEach((function(t){for(n=0,i=0;i<=1;)for(i=n+r;i<=1.01;i+=r)if(e=t.split(n,i),!e.simple()){if(i-=r,at(n-i)<r)return[];e=t.split(n,i),e._t1=ot.map(n,0,1,t._t1,t._t2),e._t2=ot.map(i,0,1,t._t1,t._t2),s.push(e),n=i;break}n<1&&(e=t.split(n,1),e._t1=ot.map(n,0,1,t._t1,t._t2),e._t2=t._t2,s.push(e))})),s}translate(t,e,n){n="number"==typeof n?n:e;const i=this.order;let r=this.points.map(((t,r)=>(1-r/i)*e+r/i*n));return new gt(this.points.map(((e,n)=>({x:e.x+t.x*r[n],y:e.y+t.y*r[n]}))))}scale(t){const e=this.order;let n=!1;if("function"==typeof t&&(n=t),n&&2===e)return this.raise().scale(n);const i=this.clockwise,r=this.points;if(this._linear)return this.translate(this.normal(0),n?n(0):t,n?n(1):t);const o=n?n(0):t,s=n?n(1):t,a=[this.offset(0,10),this.offset(1,10)],l=[],c=ot.lli4(a[0],a[0].c,a[1],a[1].c);if(!c)throw new Error("cannot scale this curve. Try reducing it first.");return[0,1].forEach((function(t){const n=l[t*e]=ot.copy(r[t*e]);n.x+=(t?s:o)*a[t].n.x,n.y+=(t?s:o)*a[t].n.y})),n?([0,1].forEach((function(o){if(2!==e||!o){var s=r[o+1],a={x:s.x-c.x,y:s.y-c.y},h=n?n((o+1)/e):t;n&&!i&&(h=-h);var d=pt(a.x*a.x+a.y*a.y);a.x/=d,a.y/=d,l[o+1]={x:s.x+h*a.x,y:s.y+h*a.y}}})),new gt(l)):([0,1].forEach((t=>{if(2===e&&t)return;const n=l[t*e],i=this.derivative(t),o={x:n.x+i.x,y:n.y+i.y};l[t+1]=ot.lli4(n,o,c,r[t+1])})),new gt(l))}outline(t,e,n,i){if(e=void 0===e?t:e,this._linear){const r=this.normal(0),o=this.points[0],s=this.points[this.points.length-1];let a,l,c;void 0===n&&(n=t,i=e),a={x:o.x+r.x*t,y:o.y+r.y*t},c={x:s.x+r.x*n,y:s.y+r.y*n},l={x:(a.x+c.x)/2,y:(a.y+c.y)/2};const h=[a,l,c];a={x:o.x-r.x*e,y:o.y-r.y*e},c={x:s.x-r.x*i,y:s.y-r.y*i},l={x:(a.x+c.x)/2,y:(a.y+c.y)/2};const d=[c,l,a],u=ot.makeline(d[2],h[0]),p=ot.makeline(h[2],d[0]),m=[u,new gt(h),p,new gt(d)];return new st(m)}const r=this.reduce(),o=r.length,s=[];let a,l=[],c=0,h=this.length();const d=void 0!==n&&void 0!==i;function u(t,e,n,i,r){return function(o){const s=i/n,a=(i+r)/n,l=e-t;return ot.map(o,0,1,t+s*l,t+a*l)}}r.forEach((function(r){const o=r.length();d?(s.push(r.scale(u(t,n,h,c,o))),l.push(r.scale(u(-e,-i,h,c,o)))):(s.push(r.scale(t)),l.push(r.scale(-e))),c+=o})),l=l.map((function(t){return a=t.points,a[3]?t.points=[a[3],a[2],a[1],a[0]]:t.points=[a[2],a[1],a[0]],t})).reverse();const p=s[0].points[0],m=s[o-1].points[s[o-1].points.length-1],g=l[o-1].points[l[o-1].points.length-1],f=l[0].points[0],v=ot.makeline(g,p),y=ot.makeline(m,f),x=[v].concat(s).concat([y]).concat(l);return new st(x)}outlineshapes(t,e,n){e=e||t;const i=this.outline(t,e).curves,r=[];for(let t=1,e=i.length;t<e/2;t++){const o=ot.makeshape(i[t],i[e-t],n);o.startcap.virtual=t>1,o.endcap.virtual=t<e/2-1,r.push(o)}return r}intersects(t,e){return t?t.p1&&t.p2?this.lineIntersects(t):(t instanceof gt&&(t=t.reduce()),this.curveintersects(this.reduce(),t,e)):this.selfintersects(e)}lineIntersects(t){const e=lt(t.p1.x,t.p2.x),n=lt(t.p1.y,t.p2.y),i=ct(t.p1.x,t.p2.x),r=ct(t.p1.y,t.p2.y);return ot.roots(this.points,t).filter((t=>{var o=this.get(t);return ot.between(o.x,e,i)&&ot.between(o.y,n,r)}))}selfintersects(t){const e=this.reduce(),n=e.length-2,i=[];for(let r,o,s,a=0;a<n;a++)o=e.slice(a,a+1),s=e.slice(a+2),r=this.curveintersects(o,s,t),i.push(...r);return i}curveintersects(t,e,n){const i=[];t.forEach((function(t){e.forEach((function(e){t.overlaps(e)&&i.push({left:t,right:e})}))}));let r=[];return i.forEach((function(t){const e=ot.pairiteration(t.left,t.right,n);e.length>0&&(r=r.concat(e))})),r}arcs(t){return t=t||.5,this._iterate(t,[])}_error(t,e,n,i){const r=(i-n)/4,o=this.get(n+r),s=this.get(i-r),a=ot.dist(t,e),l=ot.dist(t,o),c=ot.dist(t,s);return at(l-a)+at(c-a)}_iterate(t,e){let n,i=0,r=1;do{n=0,r=1;let o,s,a,l,c,h=this.get(i),d=!1,u=!1,p=r,m=1,g=0;do{if(u=d,l=a,p=(i+r)/2,g++,o=this.get(p),s=this.get(r),a=ot.getccenter(h,o,s),a.interval={start:i,end:r},d=this._error(a,h,i,r)<=t,c=u&&!d,c||(m=r),d){if(r>=1){if(a.interval.end=m=1,l=a,r>1){let t={x:a.x+a.r*ht(a.e),y:a.y+a.r*dt(a.e)};a.e+=ot.angle({x:a.x,y:a.y},t,this.get(1))}break}r+=(r-i)/2}else r=p}while(!c&&n++<100);if(n>=100)break;l=l||a,e.push(l),i=m}while(r<1);return e}}const ft=t=>{if(t.indexOf("e")>0&&t.match(/[eE][-]\d{2,}$/))return"0";const e=t.charAt(t.length-1);"0"!==e&&"."!==e||(t=(t=(t=t.replace(/([.]\d*[^0]+)0+$/,"$1")).replace(/[.]0+$/,".")).replace(/[.]$/,""));const n=t.charAt(0);return"0"!==n&&"-"!==n||(t=(t=(t=t.replace(/^(0+)[.]/,".")).replace(/^-(0+)[.]/,"-.")).replace(/^(-?)0+$/,"$10")),"-0"===t?"0":t},vt=t=>{let e=t.toString(10);if(-1===e.indexOf("."))return e;const n=/^([-]?)(\d*)\.(\d{3,}9{4,})\d{1,4}$/.exec(e);if(n){const t=n[1],i=n[3],r=parseInt(i.charAt(i.length-1),10),o=parseInt(i,10),s=parseInt(n[2],10),a=n[3];let l=(o+10-r).toString(),c=0;for(l.length>o.toString().length&&(l=l.substring(1),c=1);l.length<a.length;)l=c.toString(10)+l,c=0;e=`${t+(s+c).toString()}.${l}`}return e=e.replace(/^([-]?\d*\.\d{3,})0{4,}\d{1,4}$/,"$1"),ft(e)},yt=/^([-]?)(\d*)[.](\d+)$/,xt=t=>{const e=yt.exec(t);return e?e[3].length:-1!==t.search(/[eE]/)||/^[a-zA-Z]+$/.exec(t)?-1:0},bt=(t,...e)=>{const n=t.toString(10),i=yt.exec(n);if(!i)return n;let r=-1;for(const t of e)r=Math.max(xt(t),r);if(-1===r)return vt(t);let o=i[3].substring(0,r),s=i[2];const a=i[3].charAt(r);if(""!==a&&parseInt(a,10)>=5){if(o.length>0){const t=/^(0+)(\d*)$/.exec(o);let e="",n=o;t&&(e=t[1],n=t[2]),o=(parseInt(o)+1).toString(),o.length>n.length&&e.length>0&&(e=e.substring(1)),o=e+o}(0===o.length||o.length>r)&&(s=(parseInt(s)+1).toString(),o=o.substring(1))}const l=i[1];return ft(`${l}${s}.${o}`)};var wt;!function(t){t[t.LineTo=0]="LineTo",t[t.MoveTo=1]="MoveTo",t[t.CubicBezierTo=2]="CubicBezierTo",t[t.QuadraticBezierTo=3]="QuadraticBezierTo"}(wt||(wt={}));class Tt{constructor(t,e){this.startPoint=t,this.parts=e,this.cachedGeometry=null,this.cachedPolylineApproximation=null,this.cachedStringVersion=null,this.bbox=B.bboxOf([t]);for(const n of e)this.bbox=this.bbox.union(Tt.computeBBoxForSegment(t,n))}get geometry(){if(this.cachedGeometry)return this.cachedGeometry;let t=this.startPoint;const e=[];for(const n of this.parts)switch(n.kind){case wt.CubicBezierTo:e.push(new gt(t.xy,n.controlPoint1.xy,n.controlPoint2.xy,n.endPoint.xy)),t=n.endPoint;break;case wt.QuadraticBezierTo:e.push(new gt(t.xy,n.controlPoint.xy,n.endPoint.xy)),t=n.endPoint;break;case wt.LineTo:e.push(new z(t,n.point)),t=n.point;break;case wt.MoveTo:t=n.point}return this.cachedGeometry=e,this.cachedGeometry}polylineApproximation(){if(this.cachedPolylineApproximation)return this.cachedPolylineApproximation;const t=[];for(const e of this.parts)switch(e.kind){case wt.CubicBezierTo:t.push(e.controlPoint1,e.controlPoint2,e.endPoint);break;case wt.QuadraticBezierTo:t.push(e.controlPoint,e.endPoint);break;case wt.MoveTo:case wt.LineTo:t.push(e.point)}const e=[];let n=this.startPoint;for(const i of t)e.push(new z(n,i)),n=i;return e}static computeBBoxForSegment(t,e){const n=[t];let i;switch(e.kind){case wt.MoveTo:case wt.LineTo:n.push(e.point);break;case wt.CubicBezierTo:n.push(e.controlPoint1,e.controlPoint2,e.endPoint);break;case wt.QuadraticBezierTo:n.push(e.controlPoint,e.endPoint);break;default:return i=e,i}return B.bboxOf(n)}intersection(t){if(!t.bbox.intersects(this.bbox))return[];const e=[];for(const n of this.geometry)if(n instanceof z){const i=n.intersection(t);i&&e.push({curve:n,parameterValue:i.t,point:i.point})}else{const i=n.intersects(t).map((e=>{"string"==typeof e&&(e=parseFloat(e));const i=S.ofXY(n.get(e));return i.minus(t.p1).magnitude()>t.length||i.minus(t.p2).magnitude()>t.length?null:{point:i,parameterValue:e,curve:n}})).filter((t=>null!==t));e.push(...i)}return e}mapPoints(t){const e=t(this.startPoint),n=[];let i;for(const e of this.parts)switch(e.kind){case wt.MoveTo:case wt.LineTo:n.push({kind:e.kind,point:t(e.point)});break;case wt.CubicBezierTo:n.push({kind:e.kind,controlPoint1:t(e.controlPoint1),controlPoint2:t(e.controlPoint2),endPoint:t(e.endPoint)});break;case wt.QuadraticBezierTo:n.push({kind:e.kind,controlPoint:t(e.controlPoint),endPoint:t(e.endPoint)});break;default:return i=e,i}return new Tt(e,n)}transformedBy(t){return this.mapPoints((e=>t.transformVec2(e)))}union(t){return t?new Tt(this.startPoint,[...this.parts,{kind:wt.MoveTo,point:t.startPoint},...t.parts]):this}getEndPoint(){if(0===this.parts.length)return this.startPoint;const t=this.parts[this.parts.length-1];return t.kind===wt.QuadraticBezierTo||t.kind===wt.CubicBezierTo?t.endPoint:t.point}roughlyIntersects(t,e=0){if(0===this.parts.length)return t.containsPoint(this.startPoint);if(this.startPoint.eq(this.getEndPoint())&&0===e)return this.closedRoughlyIntersects(t);if(t.containsRect(this.bbox))return!0;let n=this.startPoint;for(const i of this.parts){const r=Tt.computeBBoxForSegment(n,i).grownBy(e);if(n=i.kind===wt.LineTo||i.kind===wt.MoveTo?i.point:i.endPoint,t.intersects(r))return!0}return!1}closedRoughlyIntersects(t){if(t.containsRect(this.bbox))return!0;const e=this.bbox.topLeft.minus(S.of(1,1)),n=t.corners,i=this.polylineApproximation();for(const t of n){const n=new z(t,e);let r=0;for(const t of i)t.intersects(n)&&r++;if(r%2==1)return!0}const r=t.grownBy(Math.min(t.size.x,t.size.y)),o=[];for(const t of r.divideIntoGrid(4,4))o.push(...t.getEdges());for(const t of o)for(const e of i)if(t.intersects(e))return!0;return!1}static fromRect(t,e=null){const n=[];let i,r;if(null!==e){const n=S.of(e,e).times(.5),o=B.fromCorners(t.topLeft.plus(n),t.bottomRight.minus(n)),s=B.fromCorners(t.topLeft.minus(n),t.bottomRight.plus(n));i=[o.corners[3],...o.corners,...s.corners.reverse()],r=s.corners[3]}else i=t.corners.slice(1),r=t.corners[0];for(const t of i)n.push({kind:wt.LineTo,point:t});return n.push({kind:wt.LineTo,point:r}),new Tt(r,n)}static fromRenderable(t){return t.path?t.path:new Tt(t.startPoint,t.commands)}toRenderable(t){return{startPoint:this.startPoint,style:t,commands:this.parts,path:this}}toString(t){if(this.cachedStringVersion)return this.cachedStringVersion;void 0===t&&(t=Math.abs(this.bbox.topLeft.x)>10&&Math.abs(this.bbox.topLeft.y)>10);const e=Tt.toString(this.startPoint,this.parts,!t);return this.cachedStringVersion=e,e}serialize(){return this.toString()}static toString(t,e,n){const i=[];let r;const o=(t,...e)=>{const o=[],s=[],a=!r||n,l=r?vt(r.x):"",c=r?vt(r.y):"";for(const t of e){const e=vt(t.x),n=vt(t.y);if(a)o.push(`${e},${n}`);else{const i=bt(t.x-r.x,e,l,c),o=bt(t.y-r.y,n,l,c);"-"===o.charAt(0)?s.push(`${i}${o}`):s.push(`${i},${o}`)}}let h;h=a?`${t}${o.join(" ")}`:`${t.toLowerCase()}${s.join(" ")}`,"l0,0"!==h&&(i.push(h),e.length>0&&(r=e[e.length-1]))};let s;o("M",t);for(const t of e)switch(t.kind){case wt.MoveTo:o("M",t.point);break;case wt.LineTo:o("L",t.point);break;case wt.CubicBezierTo:o("C",t.controlPoint1,t.controlPoint2,t.endPoint);break;case wt.QuadraticBezierTo:o("Q",t.controlPoint,t.endPoint);break;default:return s=t,s}return i.join("")}static fromString(t){var e;t=t.split("\n").join(" ");let n=S.zero,i=null,r=null,o=!0;const s=[],a=t=>{o?o=!1:s.push({kind:wt.LineTo,point:t})},l={m:1,l:1,c:3,q:2,z:0,h:1,v:1},c=/([MZLHVCSQTA])\s*([^MZLHVCSQTA]*)/gi;let h;for(;null!==(h=c.exec(t));){const t=h[2].trim().split(/[^0-9Ee.-]/).filter((t=>t.length>0)).reduce(((t,e)=>{const n=(e=e.replace(/([^eE])[-]/g,"$1 -")).split(" -");return""!==n[0]&&t.push(n[0]),t.push(...n.slice(1).map((t=>`-${t}`))),t}),[]);let c=t.map((t=>parseFloat(t))),v=h[1].toLowerCase(),y=h[1]!==v;if("v"===v||"h"===v)c=c.reduce(((t,e)=>"v"===v?t.concat(y?n.x:0,e):t.concat(e,y?n.y:0)),[]),v="l";else if("z"===v){if(!i)continue;c=[i.x,i.y],i=n,y=!0,v="l"}const x=null!==(e=l[v])&&void 0!==e?e:0,b=c.reduce(((t,e,n,i)=>{if(n%2!=0){const r=e,o=i[n-1];return t.concat(S.of(o,r))}return t}),[]).map(((t,e)=>{let i;return i=y?t:n.plus(t),(e+1)%x==0&&(n=i),i}));if(b.length%x!=0)throw new Error([`Incorrect number of arguments: got ${JSON.stringify(b)} with a length of ${b.length} ≠ ${x}k, k ∈ ℤ.`,`The number of arguments to ${v} must be a multiple of ${x}!`,`Command: ${h[0]}`].join("\n"));for(let t=0;t<b.length;t+=x){const e=b.slice(t,t+x);switch(v.toLowerCase()){case"m":0===t?(f=e[0],o?o=!1:s.push({kind:wt.MoveTo,point:f})):a(e[0]);break;case"l":a(e[0]);break;case"c":p=e[0],m=e[1],g=e[2],s.push({kind:wt.CubicBezierTo,controlPoint1:p,controlPoint2:m,endPoint:g});break;case"q":d=e[0],u=e[1],s.push({kind:wt.QuadraticBezierTo,controlPoint:d,endPoint:u});break;default:throw new Error(`Unknown path command ${v}`)}o=!1}b.length>0&&(null!=i||(i=b[0]),null!=r||(r=i),n=b[b.length-1])}var d,u,p,m,g,f;const v=new Tt(null!=r?r:S.zero,s);return v.cachedStringVersion=t,v}}Tt.empty=new Tt(S.zero,[]);class St{constructor(t,e,n,i){this.r=t,this.g=e,this.b=n,this.a=i,this.hexString=null}static ofRGB(t,e,n){return St.ofRGBA(t,e,n,1)}static ofRGBA(t,e,n,i){return t=Math.max(0,Math.min(t,1)),e=Math.max(0,Math.min(e,1)),n=Math.max(0,Math.min(n,1)),i=Math.max(0,Math.min(i,1)),new St(t,e,n,i)}static fromHex(t){var e;if(!(t=(t=(null!==(e=t.match(/^[#]?(.*)$/))&&void 0!==e?e:[])[1]).toUpperCase()).match(/^[0-9A-F]+$/))throw new Error(`${t} is not in a valid format.`);if(3===t.length||4===t.length){const e=t.split("");t=e.map((t=>`${t}0`)).join("")}6===t.length&&(t+="FF");const n=[];for(let e=2;e<=t.length;e+=2){const i=t.substring(e-2,e);n.push(parseInt(i,16)/255)}if(4!==n.length)throw new Error(`Unable to parse ${t}: Wrong number of components.`);return St.ofRGBA(n[0],n[1],n[2],n[3])}static fromString(t){if(t.startsWith("#"))return St.fromHex(t);if("none"===t||"transparent"===t)return St.transparent;{const e=document.createElement("canvas");e.width=1,e.height=1;const n=e.getContext("2d");n.fillStyle=t,n.fillRect(0,0,1,1);const i=n.getImageData(0,0,1,1),r=i.data[0]/255,o=i.data[1]/255,s=i.data[2]/255,a=i.data[3]/255;return St.ofRGBA(r,o,s,a)}}eq(t){return null!=t&&this.toHexString()===t.toHexString()}toHexString(){if(this.hexString)return this.hexString;const t=t=>{const e=Math.round(255*t).toString(16);return 1===e.length?`0${e}`:e},e=t(this.a),n=t(this.r),i=t(this.g),r=t(this.b);return"ff"===e?`#${n}${i}${r}`:(this.hexString=`#${n}${i}${r}${e}`,this.hexString)}}St.transparent=St.ofRGBA(0,0,0,0),St.red=St.ofRGB(1,0,0),St.green=St.ofRGB(0,1,0),St.blue=St.ofRGB(0,0,1),St.purple=St.ofRGB(.5,.2,.5),St.yellow=St.ofRGB(1,1,.1),St.clay=St.ofRGB(.8,.4,.2),St.black=St.ofRGB(0,0,0),St.white=St.ofRGB(1,1,1);const Ct=(t,e)=>{var n,i,r,o,s,a;const l=t===e||t.fill.eq(e.fill)&&null==t.stroke==(null==e.stroke)&&(null===(o=null===(i=null===(n=t.stroke)||void 0===n?void 0:n.color)||void 0===i?void 0:i.eq(null===(r=e.stroke)||void 0===r?void 0:r.color))||void 0===o||o)&&(null===(s=t.stroke)||void 0===s?void 0:s.width)===(null===(a=e.stroke)||void 0===a?void 0:a.width);return null!=l&&l},kt=t=>{const e=t.stroke?{color:t.stroke.color.toHexString(),width:t.stroke.width}:void 0;return{fill:t.fill.toHexString(),stroke:e}},Pt=t=>{const e=t.stroke?{color:St.fromHex(t.stroke.color),width:t.stroke.width}:void 0;return{fill:St.fromHex(t.fill),stroke:e}};class Et extends E{constructor(t){var e;super("stroke"),this.parts=[];for(const e of t){const t=Tt.fromRenderable(e),n=this.bboxForPart(t.bbox,e.style);this.contentBBox?this.contentBBox=this.contentBBox.union(n):this.contentBBox=n,this.parts.push({path:t,startPoint:t.startPoint,style:e.style,commands:t.parts})}null!==(e=this.contentBBox)&&void 0!==e||(this.contentBBox=B.empty)}intersects(t){for(const e of this.parts)if(e.path.intersection(t).length>0)return!0;return!1}render(t,e){var n,i;t.startObject(this.getBBox());for(const r of this.parts){const o=this.bboxForPart(r.path.bbox,r.style);if(e){if(!o.intersects(e))continue;if((o.size.x>2*e.size.x||o.size.y>2*e.size.y)&&!r.path.roughlyIntersects(e,null!==(i=null===(n=r.style.stroke)||void 0===n?void 0:n.width)&&void 0!==i?i:0))continue}t.drawPath(r)}t.endObject(this.getLoadSaveData())}bboxForPart(t,e){return e.stroke?t.grownBy(e.stroke.width/2):t}applyTransformation(t){this.contentBBox=B.empty;let e=!0;this.parts=this.parts.map((n=>{const i=n.path.transformedBy(t),r=Object.assign(Object.assign({},n.style),{stroke:n.style.stroke?Object.assign({},n.style.stroke):void 0});if(r.stroke){const e=t.getScaleFactor();r.stroke.width*=e}const o=this.bboxForPart(i.bbox,r);return e?(this.contentBBox=o,e=!1):this.contentBBox=this.contentBBox.union(o),{path:i,startPoint:i.startPoint,commands:i.parts,style:r}}))}getPath(){let t=null;for(const e of this.parts)t?t=t.union(e.path):null!=t||(t=e.path);return null!=t?t:Tt.empty}description(t){return t.stroke}createClone(){return new Et(this.parts)}serializeToJSON(){return this.parts.map((t=>({style:kt(t.style),path:t.path.serialize()})))}static deserializeFromJSON(t){if("string"==typeof t&&(t=JSON.parse(t)),"object"!=typeof t||"number"!=typeof t.length)throw new Error(`${t} is missing required field, parts, or parts is of the wrong type.`);const e=t.map((t=>{const e=Pt(t.style);return Tt.fromString(t.path).toRenderable(e)}));return new Et(e)}}E.registerComponent("stroke",Et.deserializeFromJSON);class zt{constructor(t,e,n,i){this.startPoint=t,this.minFitAllowed=e,this.maxFitAllowed=n,this.onCurveAdded=i,this.isFirstSegment=!0,this.lastExitingVec=null,this.currentCurve=null,this.lastPoint=this.startPoint,this.buffer=[this.startPoint.pos],this.momentum=S.zero,this.currentCurve=null,this.curveStartWidth=t.width,this.bbox=new B(this.startPoint.pos.x,this.startPoint.pos.y,0,0)}getBBox(){return this.bbox}preview(){return this.currentCurve?this.currentSegmentToPath():null}approxCurrentCurveLength(){if(!this.currentCurve)return 0;const t=S.ofXY(this.currentCurve.points[0]),e=S.ofXY(this.currentCurve.points[1]),n=S.ofXY(this.currentCurve.points[2]);return t.minus(e).length()+n.minus(e).length()}finalizeCurrentCurve(){if(!this.currentCurve)return;this.onCurveAdded(this.currentSegmentToPath());const t=this.buffer[this.buffer.length-1];this.lastExitingVec=S.ofXY(this.currentCurve.points[2]).minus(S.ofXY(this.currentCurve.points[1])),console.assert(0!==this.lastExitingVec.magnitude(),"lastExitingVec has zero length!"),this.buffer=[this.buffer[this.buffer.length-2],t],this.currentCurve=null}currentSegmentToPath(){if(null==this.currentCurve)throw new Error("Invalid State: currentCurve is null!");const t=S.ofXY(this.currentCurve.normal(0)).normalized();if(!isFinite(t.magnitude()))throw new Error(`startVec(${t}) is NaN or ∞`);const e=S.ofXY(this.currentCurve.get(0)),n=S.ofXY(this.currentCurve.get(1));return{startPoint:e,controlPoint:S.ofXY(this.currentCurve.points[1]),endPoint:n,startWidth:this.curveStartWidth,endWidth:this.curveEndWidth}}computeExitingVec(){return this.momentum.normalized().times(this.lastPoint.width/2)}addPoint(t){var e,n;if(this.lastPoint){const e=1e-10,n=t.time-this.lastPoint.time;if(t.pos.eq(this.lastPoint.pos,e)||0===n)return;if(isNaN(t.pos.magnitude()))return void console.warn("Discarding NaN point.",t);const i=Math.min(this.lastPoint.width,t.width)/3;if(this.startPoint.pos.minus(t.pos).magnitude()<i&&this.isFirstSegment)return;const r=t.pos.minus(this.lastPoint.pos).times(1/n*1e3);this.momentum=this.momentum.lerp(r,.9)}const i=null!==(e=this.lastPoint)&&void 0!==e?e:t;this.lastPoint=t,this.buffer.push(t.pos);const r=t.width/2,o=this.curveEndWidth;if(this.curveEndWidth=r,this.isFirstSegment&&(this.curveStartWidth=(this.curveStartWidth+r)/2),this.bbox=this.bbox.grownToPoint(t.pos,r),null===this.currentCurve){const e=i.pos,r=i.pos.plus(null!==(n=this.lastExitingVec)&&void 0!==n?n:S.unitX),o=t.pos;this.currentCurve=new gt(e.xy,r.xy,o.xy),this.curveStartWidth=i.width/2,console.assert(!isNaN(e.magnitude())&&!isNaN(r.magnitude())&&!isNaN(o.magnitude()),"Expected !NaN")}let s=this.lastExitingVec;if(!s){let t=Math.ceil(this.buffer.length/2);(0===t||t>=this.buffer.length)&&(t=this.buffer.length-1),s=this.buffer[t].minus(this.buffer[0])}let a=this.computeExitingVec();const l=this.buffer[0],c=t.pos,h=c.minus(l).magnitude(),d=2.2*h;if(0===d||0===a.magnitude()||!isFinite(a.magnitude()))return;console.assert(isFinite(s.magnitude()),"Pre-normalized enteringVec has NaN or ∞ magnitude!"),s=s.normalized(),a=a.normalized(),console.assert(isFinite(s.magnitude()),"Normalized enteringVec has NaN or ∞ magnitude!");const u=new z(l,l.plus(s.times(d))),p=new z(c.minus(a.times(d)),c).intersection(u);let m=null;p&&(m=p.point),(!m||l.eq(m)||c.eq(m))&&(m=l.plus(s.times(h/4))),console.assert(!l.eq(m,1e-11),"Start and control points are equal!"),console.assert(!m.eq(c,1e-11),"Control and end points are equal!");const g=this.currentCurve;return this.currentCurve=new gt(l.xy,m.xy,c.xy),isNaN(S.ofXY(this.currentCurve.normal(0)).magnitude())&&(console.error("NaN normal at 0. Curve:",this.currentCurve),this.currentCurve=g),this.buffer.length>3&&this.approxCurrentCurveLength()>this.curveStartWidth&&!(t=>{for(const e of this.buffer){const n=S.ofXY(t.project(e.xy)).minus(e).magnitude();if(n>Math.max(Math.min(this.curveStartWidth,this.curveEndWidth)/3,this.minFitAllowed)||n>this.maxFitAllowed)return!1}return!0})(this.currentCurve)?(this.currentCurve=g,this.curveEndWidth=o,this.lastPoint=i,void this.finalizeCurrentCurve()):void 0}}const Bt=zt,Rt=(t,e)=>{const n=3*e.getSizeOfPixelOnCanvas(),i=e.getSizeOfPixelOnCanvas();return new It(t,i,n,e)};class It{constructor(t,e,n,i){this.startPoint=t,this.minFitAllowed=e,this.viewport=i,this.isFirstSegment=!0,this.parts=[],this.widthAverageNumSamples=1,this.curveFitter=new zt(t,e,n,(t=>this.addCurve(t))),this.averageWidth=t.width,this.bbox=new B(this.startPoint.pos.x,this.startPoint.pos.y,0,0)}getBBox(){return this.bbox}getRenderingStyle(){return{fill:St.transparent,stroke:{color:this.startPoint.color,width:this.roundDistance(this.averageWidth)}}}previewCurrentPath(){const t=[...this.parts.slice(),...this.curveToPathCommands(this.curveFitter.preview())];return{startPoint:this.startPoint.pos,commands:t,style:this.getRenderingStyle()}}previewFullPath(){const t=this.previewCurrentPath();return t?[t]:null}previewStroke(){const t=this.previewFullPath();return t?new Et(t):null}preview(t){const e=this.previewFullPath();if(e){const n=this.viewport.visibleRect;t.startObject(n);for(const n of e)t.drawPath(n);t.endObject()}}build(){return this.curveFitter.finalizeCurrentCurve(),this.previewStroke()}getMinFit(){let t=Math.min(this.minFitAllowed,this.averageWidth/2);return t<1e-10&&(t=this.minFitAllowed),t}roundPoint(t){const e=this.getMinFit();return U.roundPoint(t,e)}roundDistance(t){const e=this.getMinFit();return U.roundPoint(t,e)}curveToPathCommands(t){if(!t){if(!this.isFirstSegment)return[];const t=U.roundPoint(this.startPoint.width/3.5,Math.min(this.minFitAllowed,this.startPoint.width/4)),e=this.roundPoint(this.startPoint.pos);return[{kind:wt.QuadraticBezierTo,controlPoint:e.plus(S.of(t,t)),endPoint:e.plus(S.of(0,t))},{kind:wt.QuadraticBezierTo,controlPoint:e.plus(S.of(-t,t)),endPoint:e.plus(S.of(-t,0))},{kind:wt.QuadraticBezierTo,controlPoint:e.plus(S.of(-t,-t)),endPoint:e.plus(S.of(0,-t))},{kind:wt.QuadraticBezierTo,controlPoint:e.plus(S.of(t,-t)),endPoint:e.plus(S.of(t,0))}]}const e=[];return this.isFirstSegment&&e.push({kind:wt.MoveTo,point:this.roundPoint(t.startPoint)}),e.push({kind:wt.QuadraticBezierTo,controlPoint:this.roundPoint(t.controlPoint),endPoint:this.roundPoint(t.endPoint)}),e}addCurve(t){const e=this.curveToPathCommands(t);this.parts.push(...e),this.isFirstSegment&&(this.isFirstSegment=!1)}addPoint(t){this.curveFitter.addPoint(t),this.widthAverageNumSamples++,this.averageWidth=this.averageWidth*(this.widthAverageNumSamples-1)/this.widthAverageNumSamples+t.width/this.widthAverageNumSamples}}class Lt extends V{constructor(t,e,n,i=Rt){super(t.notifier,e),this.editor=t,this.style=n,this.builderFactory=i,this.builder=null,this.lastPoint=null}getPressureMultiplier(){return 1/this.editor.viewport.getScaleFactor()*this.style.thickness}toStrokePoint(t){var e;let n=Math.max(null!==(e=t.pressure)&&void 0!==e?e:1,.3);return isFinite(n)||(console.warn("Non-finite pressure!",t),n=.3),console.assert(isFinite(t.canvasPos.length()),"Non-finite canvas position!"),console.assert(isFinite(t.screenPos.length()),"Non-finite screen position!"),console.assert(isFinite(t.timeStamp),"Non-finite timeStamp on pointer!"),{pos:t.canvasPos,width:n*this.getPressureMultiplier(),color:this.style.color,time:t.timeStamp}}previewStroke(){var t;this.editor.clearWetInk(),null===(t=this.builder)||void 0===t||t.preview(this.editor.display.getWetInkRenderer())}addPointToStroke(t){if(!this.builder)throw new Error("No stroke is currently being generated.");this.builder.addPoint(t),this.lastPoint=t,this.previewStroke()}onPointerDown({current:t,allPointers:e}){const n=t.device===D.Eraser;let i=!1;for(const t of e)if(t.device===D.Pen){i=!0;break}return!((1!==e.length||n)&&!i||(this.builder=this.builderFactory(this.toStrokePoint(t),this.editor.viewport),0))}onPointerMove({current:t}){this.addPointToStroke(this.toStrokePoint(t))}onPointerUp({current:t}){var e,n;if(!this.builder)return;const i=this.toStrokePoint(t),r=Object.assign(Object.assign({},i),{width:null!==(n=null===(e=this.lastPoint)||void 0===e?void 0:e.width)&&void 0!==n?n:i.width});if(this.addPointToStroke(r),this.builder&&t.isPrimary){const t=this.builder.build();if(this.previewStroke(),t.getBBox().area>0){const e=!0,n=I.addElement(t,e);this.editor.dispatch(n)}else console.warn("Pen: Not adding empty stroke",t,"to the canvas.")}this.builder=null,this.editor.clearWetInk()}onGestureCancel(){this.editor.clearWetInk()}noteUpdated(){this.editor.notifier.dispatch(M.ToolUpdated,{kind:M.ToolUpdated,tool:this})}setColor(t){t.toHexString()!==this.style.color.toHexString()&&(this.style=Object.assign(Object.assign({},this.style),{color:t}),this.noteUpdated())}setThickness(t){t!==this.style.thickness&&(this.style=Object.assign(Object.assign({},this.style),{thickness:t}),this.noteUpdated())}setStrokeFactory(t){t!==this.builderFactory&&(this.builderFactory=t,this.noteUpdated())}getThickness(){return this.style.thickness}getColor(){return this.style.color}getStrokeFactory(){return this.builderFactory}onKeyPress({key:t}){let e;return"-"===(t=t.toLowerCase())||"_"===t?e=2*this.getThickness()/3:"+"!==t&&"="!==t||(e=3*this.getThickness()/2),void 0!==e&&(e=Math.min(Math.max(1,e),256),this.setThickness(e),!0)}}class At{constructor(){}notifyEnabled(t){var e;t!==this.activeTool&&(null===(e=this.activeTool)||void 0===e||e.setEnabled(!1),this.activeTool=t)}}const Mt=(t,e)=>{if(0===e.length)return null;const n=e[0].description(t);for(const i of e)if(i.description(t)!==n)return null;return n};class Dt extends w{constructor(t){super("erase"),this.toRemove=t.map((t=>t)),this.applied=!1}apply(t){for(const e of this.toRemove){const n=t.image.findParent(e);n&&n.remove()}this.applied=!0,t.queueRerender()}unapply(t){for(const e of this.toRemove)t.image.findParent(e)||I.addElement(e).apply(t);this.applied=!1,t.queueRerender()}onDrop(t){if(this.applied)for(const e of this.toRemove)t.image.onDestroyElement(e)}description(t,e){var n;if(0===this.toRemove.length)return e.erasedNoElements;const i=null!==(n=Mt(e,this.toRemove))&&void 0!==n?n:e.elements;return e.eraseAction(i,this.toRemove.length)}serializeToJSON(){return this.toRemove.map((t=>t.getId()))}}w.register("erase",((t,e)=>{const n=t.map((t=>e.image.lookupElement(t))).filter((t=>null!==t));return new Dt(n)}));class Ot extends V{constructor(t,e){super(t.notifier,e),this.editor=t,this.command=null}onPointerDown(t){return(1===t.allPointers.length||t.current.device===D.Eraser)&&(this.lastPoint=t.current.canvasPos,this.toRemove=[],!0)}onPointerMove(t){var e;const n=t.current.canvasPos;if(0===n.minus(this.lastPoint).magnitude())return;const i=new z(this.lastPoint,n),r=i.bbox;this.toRemove.push(...this.editor.image.getElementsIntersectingRegion(r).filter((t=>t.intersects(i)))),null===(e=this.command)||void 0===e||e.unapply(this.editor),this.command=new Dt(this.toRemove),this.command.apply(this.editor),this.lastPoint=n}onPointerUp(t){var e;this.command&&this.toRemove.length>0&&(null===(e=this.command)||void 0===e||e.unapply(this.editor),this.editor.dispatch(this.command)),this.command=null}onGestureCancel(){var t;null===(t=this.command)||void 0===t||t.unapply(this.editor),this.command=null}}class Ft extends E{constructor(t){var e,n,i;super("image-component"),this.image=Object.assign(Object.assign({},t),{label:null!==(i=null!==(n=null!==(e=t.label)&&void 0!==e?e:t.image.getAttribute("alt"))&&void 0!==n?n:t.image.getAttribute("aria-label"))&&void 0!==i?i:void 0}),void 0===t.image.getAttribute("src")||t.image.complete||(t.image.onload=()=>this.recomputeBBox()),this.recomputeBBox()}getImageRect(){return new B(0,0,this.image.image.width,this.image.image.height)}recomputeBBox(){this.contentBBox=this.getImageRect(),this.contentBBox=this.contentBBox.transformedBoundingBox(this.image.transform)}static fromImage(t,e){var n;return function(t,e,n,i){return new(n||(n=Promise))((function(e,r){function o(t){try{a(i.next(t))}catch(t){r(t)}}function s(t){try{a(i.throw(t))}catch(t){r(t)}}function a(t){var i;t.done?e(t.value):(i=t.value,i instanceof n?i:new n((function(t){t(i)}))).then(o,s)}a((i=i.apply(t,[])).next())}))}(this,0,void 0,(function*(){let i,r,o;t.complete||(yield new Promise(((e,n)=>{t.onload=e,t.onerror=n,t.onabort=n}))),"number"==typeof t.width&&"number"==typeof t.height&&0!==t.width&&0!==t.height?(i=t.width,r=t.height):(i=t.clientWidth,r=t.clientHeight);let s=null!==(n=t.src)&&void 0!==n?n:"";if(s.startsWith("data:image/"))o=new Image,o.src=s,o.width=i,o.height=r;else{const e=document.createElement("canvas");e.width=i,e.height=r,e.getContext("2d").drawImage(t,0,0,e.width,e.height),s=e.toDataURL(),o=e}return new Ft({image:o,base64Url:s,transform:e})}))}render(t,e){t.drawImage(this.image)}intersects(t){const e=this.getImageRect().getEdges().map((t=>t.transformedBy(this.image.transform)));for(const n of e)if(n.intersects(t))return!0;return!1}serializeToJSON(){return{src:this.image.base64Url,label:this.image.label,width:this.image.image.width,height:this.image.image.height,transform:this.image.transform.toArray()}}applyTransformation(t){this.image.transform=t.rightMul(this.image.transform),this.recomputeBBox()}description(t){return this.image.label?t.imageNode(this.image.label):t.unlabeledImageNode}createClone(){return new Ft(Object.assign({},this.image))}static deserializeFromJSON(t){if("string"!=typeof t.src)throw new Error(`${t} has invalid format! Expected src property.`);const e=new Image;return e.src=t.src,e.width=t.width,e.height=t.height,new Ft({image:e,base64Url:e.src,label:t.label,transform:new P(...t.transform)})}}E.registerComponent("image-component",Ft.deserializeFromJSON);const $t="svg-global-attributes";class Nt extends E{constructor(t){super($t),this.attrs=t,this.contentBBox=B.empty}render(t,e){if(t instanceof Yt)for(const[e,n]of this.attrs)t.setRootSVGAttribute(e,n)}intersects(t){return!1}applyTransformation(t){}isSelectable(){return!1}createClone(){return new Nt(this.attrs)}description(t){return t.svgObject}serializeToJSON(){return JSON.stringify(this.attrs)}static deserializeFromString(t){const e=JSON.parse(t),n=[],i=/^[ \t\n0-9.-eE]+$/;for(const[t,r]of e)"viewBox"!==t&&"width"!==t&&"height"!==t||r&&i.exec(r)&&n.push([t,r]);return new Nt(n)}}E.registerComponent($t,Nt.deserializeFromString);const jt="text";class Ut extends E{constructor(t,e,n){super(jt),this.textObjects=t,this.transform=e,this.style=n,this.recomputeBBox(),!t.some((t=>"string"==typeof t))&&t.length>0&&(this.style=t[0].getTextStyle())}static applyTextStyles(t,e){var n,i;const r=e.fontFamily.match(/\s/)?e.fontFamily.replace(/["]/g,'\\"'):e.fontFamily;t.font=[(null!==(n=e.size)&&void 0!==n?n:12)+"px",null!==(i=e.fontWeight)&&void 0!==i?i:"",`${r}`,e.fontWeight].join(" "),t.textAlign="left"}static estimateTextDimens(t,e){const n=t.length*e.size,i=e.size;return new B(0,2*-i/3,n,i)}static getTextDimens(t,e){var n,i;if(null!==(n=Ut.textMeasuringCtx)&&void 0!==n||(Ut.textMeasuringCtx=null!==(i=document.createElement("canvas").getContext("2d"))&&void 0!==i?i:null),!Ut.textMeasuringCtx)return this.estimateTextDimens(t,e);const r=Ut.textMeasuringCtx;Ut.applyTextStyles(r,e);const o=r.measureText(t),s=-o.actualBoundingBoxAscent,a=o.actualBoundingBoxAscent+o.actualBoundingBoxDescent;return new B(0,s,o.width,a)}computeBBoxOfPart(t){return"string"==typeof t?Ut.getTextDimens(t,this.style).transformedBoundingBox(this.transform):t.contentBBox.transformedBoundingBox(this.transform)}recomputeBBox(){let t=null;for(const e of this.textObjects){const n=this.computeBBoxOfPart(e);null!=t||(t=n),t=t.union(n)}this.contentBBox=null!=t?t:B.empty}renderInternal(t){const e=this.transform;for(const n of this.textObjects)"string"==typeof n?t.drawText(n,e,this.style):(t.pushTransform(e),n.renderInternal(t),t.popTransform())}render(t,e){t.startObject(this.contentBBox),this.renderInternal(t),t.endObject(this.getLoadSaveData())}intersects(t){const e=this.transform.inverse(),n=e.transformVec2(t.p1),i=e.transformVec2(t.p2);t=new z(n,i);for(const e of this.textObjects)if("string"==typeof e){if(Ut.getTextDimens(e,this.style).getEdges().some((e=>null!==t.intersection(e))))return!0}else if(e.intersects(t))return!0;return!1}getBaselinePos(){return this.transform.transformVec2(S.zero)}getTextStyle(){return this.style}getTransform(){return this.transform}applyTransformation(t){this.transform=t.rightMul(this.transform),this.recomputeBBox()}createClone(){return new Ut(this.textObjects,this.transform,this.style)}getText(){const t=[];for(const e of this.textObjects)"string"==typeof e?t.push(e):t.push(e.getText());return t.join("\n")}description(t){return t.text(this.getText())}serializeToJSON(){const t=Object.assign(Object.assign({},this.style),{renderingStyle:kt(this.style.renderingStyle)});return{textObjects:this.textObjects.map((t=>"string"==typeof t?{text:t}:{json:t.serializeToJSON()})),transform:this.transform.toArray(),style:t}}static deserializeFromString(t){const e={renderingStyle:Pt(t.style.renderingStyle),size:t.style.size,fontWeight:t.style.fontWeight,fontVariant:t.style.fontVariant,fontFamily:t.style.fontFamily},n=t.textObjects.map((t=>{var e;return null!==(null!==(e=t.text)&&void 0!==e?e:null)?t.text:Ut.deserializeFromString(t.json)}));if(t.transform=t.transform.filter((t=>"number"==typeof t)),9!==t.transform.length)throw new Error(`Unable to deserialize transform, ${t.transform}.`);const i=t.transform,r=new P(...i);return new Ut(n,r,e)}static fromLines(t,e,n){let i=null;const r=[];for(const e of t){let t=S.zero;if(i){const e=Math.floor(n.size);t=i.getBBox().bottomLeft.plus(S.unitY.times(e))}const o=new Ut([e],P.translation(t),n);r.push(o),i=o}return new Ut(r,e,n)}}Ut.textMeasuringCtx=null,E.registerComponent(jt,(t=>Ut.deserializeFromString(t)));const Vt="unknown-svg-object";class Wt extends E{constructor(t){super(Vt),this.svgObject=t,this.contentBBox=B.of(t.getBoundingClientRect())}render(t,e){t instanceof Yt&&t.drawSVGElem(this.svgObject)}intersects(t){return this.contentBBox.getEdges().some((e=>null!==e.intersection(t)))}applyTransformation(t){}isSelectable(){return!1}createClone(){return new Wt(this.svgObject.cloneNode(!0))}description(t){return t.svgObject}serializeToJSON(){return JSON.stringify({html:this.svgObject.outerHTML})}}E.registerComponent(Vt,null);var Ht=function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{l(i.next(t))}catch(t){o(t)}}function a(t){try{l(i.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}l((i=i.apply(t,e||[])).next())}))};const Gt=new B(0,0,500,500),_t=["stroke","fill","stroke-width"];class qt{constructor(t,e,n=!0){this.source=t,this.onFinish=e,this.storeUnknown=n,this.onAddComponent=null,this.onProgress=null,this.onDetermineExportRect=null,this.processedCount=0,this.totalToProcess=0}getStyle(t){var e,n,i;const r={fill:St.transparent},o=null!==(e=t.getAttribute("fill"))&&void 0!==e?e:t.style.fill;if(o)try{r.fill=St.fromString(o)}catch(t){console.error("Unknown fill color,",o)}const s=null!==(n=t.getAttribute("stroke"))&&void 0!==n?n:t.style.stroke,a=null!==(i=t.getAttribute("stroke-width"))&&void 0!==i?i:t.style.strokeWidth;if(s)try{let t=parseFloat(null!=a?a:"1");isFinite(t)||(t=0),r.stroke={width:t,color:St.fromString(s)}}catch(t){console.error("Error parsing stroke data:",t)}return r}strokeDataFromElem(t){var e;const n=[],i=null!==(e=t.getAttribute("d"))&&void 0!==e?e:"",r=this.getStyle(t),o=i.split("M");let s=!0;for(const t of o){const e=/^[0-9., \t\n]+$/.exec(t);if(""!==t&&!e){const e=s?t:`M${t}`,i=Tt.fromString(e).toRenderable(r);n.push(i)}s=!1}return n}attachUnrecognisedAttrs(t,e,n,i){if(this.storeUnknown){for(const r of e.getAttributeNames())n.has(r)||"style"===r&&i||t.attachLoadSaveData("svgAttrs",[r,e.getAttribute(r)]);if(i&&e.style)for(const n of e.style)""!==n&&n&&(i.has(n)||t.attachLoadSaveData("svgStyleAttrs",{key:n,value:e.style.getPropertyValue(n),priority:e.style.getPropertyPriority(n)}))}}addPath(t){var e;let n;try{const e=this.strokeDataFromElem(t);n=new Et(e),this.attachUnrecognisedAttrs(n,t,new Set([..._t,"d"]),new Set(_t))}catch(e){if(console.error("Invalid path in node",t,"\nError:",e,"\nAdding as an unknown object."),!this.storeUnknown)return;n=new Wt(t)}null===(e=this.onAddComponent)||void 0===e||e.call(this,n)}getTransform(t,e,n){null!=n||(n=window.getComputedStyle(t));let i,r=n.transform;""!==r&&"none"!==r||(r=t.style.transform||"none");try{i=P.fromCSSMatrix(t.style.transform)}catch(t){i=P.fromCSSMatrix(r)}const o=t.getAttribute("x"),s=t.getAttribute("y");if(o||s){const t=parseFloat(null!=o?o:"0"),n=parseFloat(null!=s?s:"0");isNaN(t)||isNaN(n)||(null==e||e.push("x","y"),i=i.rightMul(P.translation(S.of(t,n))))}return i}makeText(t){var e;const n=[];for(const i of t.childNodes)if(i.nodeType===Node.TEXT_NODE)n.push(null!==(e=i.nodeValue)&&void 0!==e?e:"");else{if(i.nodeType!==Node.ELEMENT_NODE)throw new Error(`Unrecognized text child node: ${i}.`);{const t=i;if("tspan"!==t.tagName.toLowerCase())throw new Error(`Unrecognized text child element: ${t}`);n.push(this.makeText(t))}}const i=window.getComputedStyle(t),r=/^([-0-9.e]+)px/i.exec(i.fontSize),o=["fontFamily","transform",..._t];let s=12;r&&(o.push("fontSize"),s=parseFloat(r[1]));const a={size:s,fontFamily:i.fontFamily||t.style.fontFamily||"sans-serif",renderingStyle:this.getStyle(t)},l=[],c=this.getTransform(t,l,i),h=new Ut(n,c,a);return this.attachUnrecognisedAttrs(h,t,new Set(l),new Set(o)),h}addText(t){var e;try{const n=this.makeText(t);null===(e=this.onAddComponent)||void 0===e||e.call(this,n)}catch(e){console.error("Invalid text object in node",t,". Continuing.... Error:",e),this.addUnknownNode(t)}}addImage(t){var e,n;return Ht(this,void 0,void 0,(function*(){const i=new Image;i.src=null!==(e=t.getAttribute("xlink:href"))&&void 0!==e?e:t.href.baseVal;try{const e=[],r=this.getTransform(t,e),o=yield Ft.fromImage(i,r);this.attachUnrecognisedAttrs(o,t,new Set(e),new Set(["transform"])),null===(n=this.onAddComponent)||void 0===n||n.call(this,o)}catch(e){console.error("Error loading image:",e,". Element: ",t,". Continuing..."),this.addUnknownNode(t)}}))}addUnknownNode(t){var e;if(this.storeUnknown){const n=new Wt(t);null===(e=this.onAddComponent)||void 0===e||e.call(this,n)}}updateViewBox(t){var e;const n=t.getAttribute("viewBox");if(this.rootViewBox||!n)return;const i=n.split(/[ \t\n,]+/),r=parseFloat(i[0]),o=parseFloat(i[1]),s=parseFloat(i[2]),a=parseFloat(i[3]);isNaN(r)||isNaN(o)||isNaN(s)||isNaN(a)?console.warn(`node ${t} has an unparsable viewbox. Viewbox: ${n}. Match: ${i}.`):(this.rootViewBox=new B(r,o,s,a),null===(e=this.onDetermineExportRect)||void 0===e||e.call(this,this.rootViewBox))}updateSVGAttrs(t){var e;this.storeUnknown&&(null===(e=this.onAddComponent)||void 0===e||e.call(this,new Nt(this.getSourceAttrs(t))))}visit(t){var e;return Ht(this,void 0,void 0,(function*(){this.totalToProcess+=t.childElementCount;let n=!0;switch(t.tagName.toLowerCase()){case"g":break;case"path":this.addPath(t);break;case"text":this.addText(t),n=!1;break;case"image":yield this.addImage(t),n=!1;break;case"svg":this.updateViewBox(t),this.updateSVGAttrs(t);break;default:return console.warn("Unknown SVG element,",t),t instanceof SVGElement||console.warn("Element",t,"is not an SVGElement!",this.storeUnknown?"Continuing anyway.":"Skipping."),void this.addUnknownNode(t)}if(n)for(const e of t.children)yield this.visit(e);this.processedCount++,yield null===(e=this.onProgress)||void 0===e?void 0:e.call(this,this.processedCount,this.totalToProcess)}))}getSourceAttrs(t){return t.getAttributeNames().map((e=>[e,t.getAttribute(e)]))}start(t,e,n=null){var i,r;return Ht(this,void 0,void 0,(function*(){this.onAddComponent=t,this.onProgress=e,this.onDetermineExportRect=n,this.totalToProcess=this.source.childElementCount,this.processedCount=0,this.rootViewBox=null,yield this.visit(this.source),this.rootViewBox||null===(i=this.onDetermineExportRect)||void 0===i||i.call(this,Gt),null===(r=this.onFinish)||void 0===r||r.call(this)}))}static fromString(t,e=!1){var n,i;const r=document.createElement("iframe");if(r.src="about:blank",r.setAttribute("sandbox","allow-same-origin"),r.setAttribute("csp","default-src 'about:blank'"),r.style.display="none",document.body.appendChild(r),!r.hasAttribute("sandbox"))throw r.remove(),new Error("SVG loading iframe is not sandboxed.");const o=null!==(i=null===(n=r.contentWindow)||void 0===n?void 0:n.document)&&void 0!==i?i:r.contentDocument;if(null==o)throw new Error("Unable to open a sandboxed iframe!");o.open(),o.write("\n\t\t\t<!DOCTYPE html>\n\t\t\t<html>\n\t\t\t\t<head>\n\t\t\t\t\t<title>SVG Loading Sandbox</title>\n\t\t\t\t</head>\n\t\t\t\t<body>\n\t\t\t\t\t<script>\n\t\t\t\t\t\tconsole.error('JavaScript should not be able to run here!');\n\t\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t\t'The SVG sandbox is broken! Please double-check the sandboxing setting.'\n\t\t\t\t\t\t);\n\t\t\t\t\t<\/script>\n\t\t\t\t</body>\n\t\t\t</html>\n\t\t"),o.close();const s=o.createElementNS("http://www.w3.org/2000/svg","svg");return s.innerHTML=t,o.body.appendChild(s),new qt(s,(()=>{s.remove(),r.remove()}),!e)}}class Kt{constructor(t){this.viewport=t,this.selfTransform=null,this.transformStack=[],this.objectLevel=0,this.currentPaths=null}getViewport(){return this.viewport}setDraftMode(t){}flushPath(){if(!this.currentPaths)return;let t=null;for(const e of this.currentPaths){const{startPoint:n,commands:i,style:r}=e;t&&Ct(t,r)?this.moveTo(n):(t&&this.endPath(t),this.beginPath(n),t=r);for(const t of i)t.kind===wt.LineTo?this.lineTo(t.point):t.kind===wt.MoveTo?this.moveTo(t.point):t.kind===wt.CubicBezierTo?this.traceCubicBezierCurve(t.controlPoint1,t.controlPoint2,t.endPoint):t.kind===wt.QuadraticBezierTo&&this.traceQuadraticBezierCurve(t.controlPoint,t.endPoint)}t&&this.endPath(t)}drawPath(t){0===this.objectLevel?(this.currentPaths=[t],this.flushPath(),this.currentPaths=null):this.currentPaths.push(t)}drawRect(t,e,n){const i=Tt.fromRect(t,e);this.drawPath(i.toRenderable(n))}startObject(t,e){this.currentPaths=[],this.objectLevel++}endObject(t){if(this.flushPath(),this.currentPaths=null,this.objectLevel--,this.objectLevel<0)throw new Error("More objects have ended than have been started (negative object nesting level)!")}getNestingLevel(){return this.objectLevel}canRenderFromWithoutDataLoss(t){return!1}renderFromOtherOfSameType(t,e){throw new Error(`Unable to render from ${e}: Not implemented`)}setTransform(t){this.selfTransform=t}pushTransform(t){this.transformStack.push(this.selfTransform),this.setTransform(this.getCanvasToScreenTransform().rightMul(t))}popTransform(){var t;if(0===this.transformStack.length)throw new Error("Unable to pop more transforms than have been pushed!");this.setTransform(null!==(t=this.transformStack.pop())&&void 0!==t?t:null)}getCanvasToScreenTransform(){return this.selfTransform?this.selfTransform:this.viewport.canvasToScreenTransform}canvasToScreen(t){return this.getCanvasToScreenTransform().transformVec2(t)}getSizeOfCanvasPixelOnScreen(){return this.getCanvasToScreenTransform().transformVec3(S.unitX).length()}}const Zt="js-draw-style-sheet",Xt="http://www.w3.org/2000/svg";class Yt extends Kt{constructor(t,e,n=!1){super(e),this.elem=t,this.sanitize=n,this.lastPathStyle=null,this.lastPathString=[],this.objectElems=null,this.overwrittenAttrs={},this.textContainer=null,this.textContainerTransform=null,this.clear(),this.addStyleSheet()}addStyleSheet(){if(!this.elem.querySelector("#js-draw-style-sheet")){const t=document.createElementNS("http://www.w3.org/2000/svg","style");t.innerHTML="\n\t\t\t\tpath {\n\t\t\t\t\tstroke-linecap: round;\n\t\t\t\t\tstroke-linejoin: round;\n\t\t\t\t}\n\t\t\t".replace(/\s+/g,""),t.setAttribute("id",Zt),this.elem.appendChild(t)}}setRootSVGAttribute(t,e){this.sanitize||(t in this.overwrittenAttrs||(this.overwrittenAttrs[t]=this.elem.getAttribute(t)),null!==e?this.elem.setAttribute(t,e):this.elem.removeAttribute(t))}displaySize(){return S.of(this.elem.clientWidth,this.elem.clientHeight)}clear(){if(this.lastPathString=[],!this.sanitize){for(const t in this.overwrittenAttrs){const e=this.overwrittenAttrs[t];e?this.elem.setAttribute(t,e):this.elem.removeAttribute(t)}this.overwrittenAttrs={}}}addPathToSVG(){var t;if(!this.lastPathStyle||0===this.lastPathString.length)return;const e=document.createElementNS(Xt,"path");e.setAttribute("d",this.lastPathString.join(" "));const n=this.lastPathStyle;n.fill.a>0?e.setAttribute("fill",n.fill.toHexString()):e.setAttribute("fill","none"),n.stroke&&(e.setAttribute("stroke",n.stroke.color.toHexString()),e.setAttribute("stroke-width",vt(n.stroke.width))),this.elem.appendChild(e),null===(t=this.objectElems)||void 0===t||t.push(e)}drawPath(t){var e;const n=t.style,i=Tt.fromRenderable(t).transformedBy(this.getCanvasToScreenTransform());n.fill.eq(null===(e=this.lastPathStyle)||void 0===e?void 0:e.fill)&&0!==this.lastPathString.length||(this.addPathToSVG(),this.lastPathStyle=n,this.lastPathString=[]),this.lastPathString.push(i.toString())}transformFrom(t,e,n=!1,i=!0){let r=n?t:this.getCanvasToScreenTransform().rightMul(t);const o=r.transformVec2(S.zero);i&&(r=r.rightMul(P.translation(o.times(-1)))),r.eq(P.identity)?e.style.transform="":e.style.transform=`matrix(\n\t\t\t\t${r.a1}, ${r.b1},\n\t\t\t\t${r.a2}, ${r.b2},\n\t\t\t\t${r.a3}, ${r.b3}\n\t\t\t)`,i&&(e.setAttribute("x",`${vt(o.x)}`),e.setAttribute("y",`${vt(o.y)}`))}drawText(t,e,n){var i;const r=(t,e)=>{var n,i;if(t.style.fontFamily=e.fontFamily,t.style.fontVariant=null!==(n=e.fontVariant)&&void 0!==n?n:"",t.style.fontWeight=null!==(i=e.fontWeight)&&void 0!==i?i:"",t.style.fontSize=e.size+"px",t.style.fill=e.renderingStyle.fill.toHexString(),e.renderingStyle.stroke){const n=e.renderingStyle.stroke;t.style.stroke=n.color.toHexString(),t.style.strokeWidth=n.width+"px"}};if(e=this.getCanvasToScreenTransform().rightMul(e),this.textContainer){const i=document.createElementNS(Xt,"tspan");i.appendChild(document.createTextNode(t)),this.textContainer.appendChild(i);const o=(e=this.textContainerTransform.inverse().rightMul(e)).transformVec2(S.zero);i.setAttribute("x",`${vt(o.x)}`),i.setAttribute("y",`${vt(o.y)}`),r(i,n)}else{const o=document.createElementNS(Xt,"text");o.appendChild(document.createTextNode(t));const s=!1;this.transformFrom(e,o,!0,s),r(o,n),this.elem.appendChild(o),null===(i=this.objectElems)||void 0===i||i.push(o),this.objectLevel>0&&(this.textContainer=o,this.textContainerTransform=e)}}drawImage(t){var e,n,i,r,o;const s=document.createElementNS(Xt,"image");s.setAttribute("href",t.base64Url),s.setAttribute("width",null!==(e=t.image.getAttribute("width"))&&void 0!==e?e:""),s.setAttribute("height",null!==(n=t.image.getAttribute("height"))&&void 0!==n?n:""),s.setAttribute("aria-label",null!==(r=null!==(i=t.image.getAttribute("aria-label"))&&void 0!==i?i:t.image.getAttribute("alt"))&&void 0!==r?r:""),this.transformFrom(t.transform,s),this.elem.appendChild(s),null===(o=this.objectElems)||void 0===o||o.push(s)}startObject(t){super.startObject(t),this.lastPathString=[],this.lastPathStyle=null,this.textContainer=null,this.objectElems=[]}endObject(t){var e;if(super.endObject(t),this.addPathToSVG(),t&&!this.sanitize)for(const n of null!==(e=this.objectElems)&&void 0!==e?e:[]){const e=t.svgAttrs,i=t.svgStyleAttrs;if(e)for(const[t,i]of e)n.setAttribute(t,i);if(i)for(const t of i)n.style.setProperty(t.key,t.value,t.priority)}}unimplementedMessage(){throw new Error("Not implemenented!")}beginPath(t){this.unimplementedMessage()}endPath(t){this.unimplementedMessage()}lineTo(t){this.unimplementedMessage()}moveTo(t){this.unimplementedMessage()}traceCubicBezierCurve(t,e,n){this.unimplementedMessage()}traceQuadraticBezierCurve(t,e){this.unimplementedMessage()}drawPoints(...t){t.map((t=>{const e=document.createElementNS(Xt,"circle");e.setAttribute("cx",`${t.x}`),e.setAttribute("cy",`${t.y}`),e.setAttribute("r","15"),this.elem.appendChild(e)}))}drawSVGElem(t){this.sanitize||"style"===t.tagName.toLowerCase()&&t.getAttribute("id")===Zt||this.elem.appendChild(t.cloneNode(!0))}isTooSmallToRender(t){return!1}}var Jt,Qt,te;!function(t){t[t.Circle=0]="Circle",t[t.Square=1]="Square"}(Jt||(Jt={}));class ee{constructor(t,e,n,i,r,o){switch(this.shape=t,this.parentSide=e,this.parent=n,this.onDragStart=i,this.onDragUpdate=r,this.onDragEnd=o,this.dragLastPos=null,this.element=document.createElement("div"),this.element.classList.add(`${ce}handle`),t){case Jt.Circle:this.element.classList.add(`${ce}circle`);break;case Jt.Square:this.element.classList.add(`${ce}square`);break;default:(t=>{throw new Error(`Should be unreachable. Key: ${t}.`)})(t)}this.updatePosition()}addTo(t){t.appendChild(this.element)}updatePosition(){const t=this.parent.screenRegion,e=S.of(30,30),n=t.size.scale(this.parentSide).minus(e.times(.5));this.element.style.marginLeft=`${n.x}px`,this.element.style.marginTop=`${n.y}px`,this.element.style.width=`${e.x}px`,this.element.style.height=`${e.y}px`}isTarget(t){return t===this.element}handleDragStart(t){this.onDragStart(t.canvasPos),this.dragLastPos=t.canvasPos}handleDragUpdate(t){this.dragLastPos&&this.onDragUpdate(t.canvasPos)}handleDragEnd(){this.dragLastPos&&this.onDragEnd()}}class ne extends w{constructor(t){super("duplicate"),this.toDuplicate=t,this.duplicates=t.map((t=>t.clone())),this.reverse=new Dt(this.duplicates)}apply(t){this.reverse.unapply(t)}unapply(t){this.reverse.apply(t)}description(t,e){var n;return 0===this.duplicates.length?e.duplicatedNoElements:e.duplicateAction(null!==(n=Mt(e,this.duplicates))&&void 0!==n?n:e.elements,this.duplicates.length)}serializeToJSON(){return this.toDuplicate.map((t=>t.getId()))}}w.register("duplicate",((t,e)=>{const n=t.map((t=>e.image.lookupElement(t)));return new ne(n)})),function(t){t[t.Both=0]="Both",t[t.HorizontalOnly=1]="HorizontalOnly",t[t.VerticalOnly=2]="VerticalOnly"}(Qt||(Qt={})),function(t){t[t.Snap=0]="Snap",t[t.NoSnap=1]="NoSnap"}(te||(te={}));class ie{constructor(t,e){this.editor=t,this.selection=e}onDragStart(t){this.selection.setTransform(P.identity),this.dragStartPoint=t}onDragUpdate(t){const e=this.editor.viewport.roundPoint(t.minus(this.dragStartPoint));this.selection.setTransform(P.translation(e))}onDragEnd(){this.selection.finalizeTransform()}}class re{constructor(t,e){this.editor=t,this.selection=e,this.mode=Qt.Both}onDragStart(t,e){this.selection.setTransform(P.identity),this.mode=e,this.dragStartPoint=t}onDragUpdate(t){const e=t.minus(this.dragStartPoint),n=this.selection.preTransformRegion.width,i=this.selection.preTransformRegion.height;let r=S.of(1,1);if(this.mode===Qt.HorizontalOnly){const t=n+e.x;r=S.of(t/n,r.y)}if(this.mode===Qt.VerticalOnly){const t=i+e.y;r=S.of(r.x,t/i)}if(this.mode===Qt.Both){const t=n+(Math.abs(e.x)>Math.abs(e.y)?e.x:e.y);r=S.of(t/n,t/n)}if(r=r.map((t=>U.roundScaleRatio(t,2))),r.x>0&&r.y>0){const t=this.editor.viewport.roundPoint(this.selection.preTransformRegion.topLeft);this.selection.setTransform(P.scaling2D(r,t))}}onDragEnd(){this.selection.finalizeTransform()}}class oe{constructor(t,e){this.editor=t,this.selection=e,this.startAngle=0}getAngle(t){const e=this.selection.preTransformRegion.center;return t.minus(e).angle()}roundAngle(t){const e=8/Math.PI;return Math.round(t*e)/e}onDragStart(t){this.selection.setTransform(P.identity),this.startAngle=this.getAngle(t)}onDragUpdate(t){const e=this.roundAngle(this.getAngle(t)-this.startAngle),n=this.editor.viewport.roundPoint(this.selection.preTransformRegion.center),i=P.zRotation(e).mapEntries((t=>U.roundScaleRatio(t))),r=P.translation(n).rightMul(i).rightMul(P.translation(n.times(-1)));this.selection.setTransform(r)}onDragEnd(){this.selection.finalizeTransform()}}var se,ae=function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{l(i.next(t))}catch(t){o(t)}}function a(t){try{l(i.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}l((i=i.apply(t,e||[])).next())}))};class le{constructor(t,e){this.editor=e,this.transform=P.identity,this.transformCommands=[],this.selectedElems=[],this.hasParent=!0,this.targetHandle=null,this.backgroundDragging=!1,this.originalRegion=new B(t.x,t.y,0,0),this.transformers={drag:new ie(e,this),resize:new re(e,this),rotate:new oe(e,this)},this.container=document.createElement("div"),this.backgroundElem=document.createElement("div"),this.backgroundElem.classList.add(`${ce}selection-background`),this.container.appendChild(this.backgroundElem);const n=new ee(Jt.Square,S.of(1,.5),this,(t=>this.transformers.resize.onDragStart(t,Qt.HorizontalOnly)),(t=>this.transformers.resize.onDragUpdate(t)),(()=>this.transformers.resize.onDragEnd())),i=new ee(Jt.Square,S.of(.5,1),this,(t=>this.transformers.resize.onDragStart(t,Qt.VerticalOnly)),(t=>this.transformers.resize.onDragUpdate(t)),(()=>this.transformers.resize.onDragEnd())),r=new ee(Jt.Square,S.of(1,1),this,(t=>this.transformers.resize.onDragStart(t,Qt.Both)),(t=>this.transformers.resize.onDragUpdate(t)),(()=>this.transformers.resize.onDragEnd())),o=new ee(Jt.Circle,S.of(.5,0),this,(t=>this.transformers.rotate.onDragStart(t)),(t=>this.transformers.rotate.onDragUpdate(t)),(()=>this.transformers.rotate.onDragEnd()));this.handles=[r,n,i,o];for(const t of this.handles)t.addTo(this.backgroundElem)}getTransform(){return this.transform}get preTransformRegion(){return this.originalRegion}get region(){const t=P.zRotation(this.regionRotation,this.originalRegion.center),e=this.transform.rightMul(t.inverse());return this.originalRegion.transformedBoundingBox(e)}get regionRotation(){return this.transform.transformVec3(S.unitX).angle()}get preTransformedScreenRegion(){const t=t=>this.editor.viewport.canvasToScreen(t);return B.fromCorners(t(this.preTransformRegion.topLeft),t(this.preTransformRegion.bottomRight))}get preTransformedScreenRegionRotation(){return this.editor.viewport.getRotationAngle()}get screenRegion(){const t=this.editor.viewport.canvasToScreenTransform,e=this.editor.viewport.getScaleFactor(),n=t.transformVec2(this.region.center);return new B(n.x,n.y,e*this.region.width,e*this.region.height).translatedBy(this.region.size.times(-e/2))}get screenRegionRotation(){return this.regionRotation+this.editor.viewport.getRotationAngle()}computeTransformCommands(){return this.selectedElems.map((t=>t.transformBy(this.transform)))}setTransform(t,e=!0){this.transform=t,e&&this.hasParent&&(this.previewTransformCmds(),this.scrollTo())}finalizeTransform(){this.transformCommands.forEach((t=>{t.unapply(this.editor)}));const t=this.transform,e=this.selectedElems;this.transformCommands=[],this.originalRegion=this.originalRegion.transformedBoundingBox(this.transform),this.transform=P.identity,this.editor.dispatch(new le.ApplyTransformationCommand(this,e,t))}previewTransformCmds(){this.selectedElems.length>100||(this.transformCommands.forEach((t=>t.unapply(this.editor))),this.transformCommands=this.computeTransformCommands(),this.transformCommands.forEach((t=>t.apply(this.editor)))),this.updateUI()}resolveToObjects(){let t=!1;if(this.transform=P.identity,0===this.region.w||0===this.region.h){const e=this.editor.viewport.visibleRect.maxDimension/200;this.originalRegion=B.bboxOf(this.region.corners,e),t=!0}return this.selectedElems=this.editor.image.getElementsIntersectingRegion(this.region).filter((t=>{if(this.region.containsRect(t.getBBox()))return!0;const e=[];for(const t of this.region.divideIntoGrid(2,2))e.push(...t.getEdges());return e.some((e=>t.intersects(e)))})),t&&this.selectedElems.length>0&&(this.selectedElems=[this.selectedElems[this.selectedElems.length-1]]),!!this.recomputeRegion()&&(this.updateUI(),!0)}recomputeRegion(){const t=this.selectedElems.reduce(((t,e)=>(null!=t?t:e.getBBox()).union(e.getBBox())),null);if(!t)return this.cancelSelection(),!1;this.originalRegion=t;const e=this.getMinCanvasSize();if(this.originalRegion.w<e||this.originalRegion.h<e){const t=e/2;this.originalRegion=B.bboxOf(this.originalRegion.corners,t)}return!0}getMinCanvasSize(){return 30/this.editor.viewport.getScaleFactor()*2}getSelectedItemCount(){return this.selectedElems.length}updateUI(){if(!this.hasParent)return;this.backgroundElem.style.marginLeft=`${this.screenRegion.topLeft.x}px`,this.backgroundElem.style.marginTop=`${this.screenRegion.topLeft.y}px`,this.backgroundElem.style.width=`${this.screenRegion.width}px`,this.backgroundElem.style.height=`${this.screenRegion.height}px`;const t=180*this.screenRegionRotation/Math.PI;this.backgroundElem.style.transform=`rotate(${t}deg)`,this.backgroundElem.style.transformOrigin="center";for(const t of this.handles)t.updatePosition()}onDragStart(t,e){for(const n of this.handles)if(n.isTarget(e))return n.handleDragStart(t),this.targetHandle=n,!0;return this.backgroundElem===e&&(this.backgroundDragging=!0,this.transformers.drag.onDragStart(t.canvasPos),!0)}onDragUpdate(t){this.backgroundDragging&&this.transformers.drag.onDragUpdate(t.canvasPos),this.targetHandle&&this.targetHandle.handleDragUpdate(t),this.updateUI()}onDragEnd(){this.backgroundDragging?this.transformers.drag.onDragEnd():this.targetHandle&&this.targetHandle.handleDragEnd(),this.backgroundDragging=!1,this.targetHandle=null,this.updateUI()}onDragCancel(){this.backgroundDragging=!1,this.targetHandle=null,this.setTransform(P.identity)}scrollTo(){if(0===this.selectedElems.length)return;const t=new B(0,0,this.editor.display.width,this.editor.display.height);if(!t.containsPoint(this.screenRegion.center)){const e=t.getClosestPointOnBoundaryTo(this.screenRegion.center),n=this.screenRegion.center.minus(e),i=this.editor.viewport.screenToCanvasTransform.transformVec3(n);this.editor.dispatchNoAnnounce(U.transformBy(P.translation(i.times(-1))),!1)}}deleteSelectedObjects(){return new Dt(this.selectedElems)}duplicateSelectedObjects(){return new ne(this.selectedElems)}addTo(t){this.container.parentElement&&this.container.remove(),t.appendChild(this.container),this.hasParent=!0}setToPoint(t){this.originalRegion=this.originalRegion.grownToPoint(t),this.updateUI()}cancelSelection(){this.container.parentElement&&this.container.remove(),this.originalRegion=B.empty,this.hasParent=!1}setSelectedObjects(t,e){this.originalRegion=e,this.selectedElems=t.filter((t=>t.isSelectable())),this.updateUI()}getSelectedObjects(){return this.selectedElems}}se=le,w.register("selection-tool-transform",((t,e)=>{var n;const i=new P(...t.transform),r=null!==(n=t.elems)&&void 0!==n?n:[];return new se.ApplyTransformationCommand(null,r,i)})),le.ApplyTransformationCommand=class extends w{constructor(t,e,n){super("selection-tool-transform"),this.selection=t,this.fullTransform=n,"string"==typeof e[0]?this.selectedElemIds=e:(this.selectedElemIds=e.map((t=>t.getId())),this.transformCommands=e.map((t=>t.transformBy(this.fullTransform))))}resolveToElems(t){this.transformCommands||(this.transformCommands=this.selectedElemIds.map((e=>{const n=t.image.lookupElement(e);if(!n)throw new Error(`Unable to find element with ID, ${e}.`);return n.transformBy(this.fullTransform)})))}apply(t){var e,n,i,r,o;return ae(this,void 0,void 0,(function*(){this.resolveToElems(t),null===(e=this.selection)||void 0===e||e.setTransform(this.fullTransform,!1),null===(n=this.selection)||void 0===n||n.updateUI(),yield t.asyncApplyCommands(this.transformCommands,100),null===(i=this.selection)||void 0===i||i.setTransform(P.identity,!1),null===(r=this.selection)||void 0===r||r.recomputeRegion(),null===(o=this.selection)||void 0===o||o.updateUI()}))}unapply(t){var e,n,i,r,o;return ae(this,void 0,void 0,(function*(){this.resolveToElems(t),null===(e=this.selection)||void 0===e||e.setTransform(this.fullTransform.inverse(),!1),null===(n=this.selection)||void 0===n||n.updateUI(),yield t.asyncUnapplyCommands(this.transformCommands,100),null===(i=this.selection)||void 0===i||i.setTransform(P.identity),null===(r=this.selection)||void 0===r||r.recomputeRegion(),null===(o=this.selection)||void 0===o||o.updateUI()}))}serializeToJSON(){return{elems:this.selectedElemIds,transform:this.fullTransform.toArray()}}description(t,e){return e.transformedElements(this.selectedElemIds.length)}};const ce="selection-tool-";class he extends V{constructor(t,e){super(t.notifier,e),this.editor=t,this.lastEvtTarget=null,this.expandingSelectionBox=!1,this.shiftKeyPressed=!1,this.selectionBoxHandlingEvt=!1,this.handleOverlay=document.createElement("div"),t.createHTMLOverlay(this.handleOverlay),this.handleOverlay.style.display="none",this.handleOverlay.classList.add("handleOverlay"),t.notifier.on(M.ViewportChanged,(t=>{var e;null===(e=this.selectionBox)||void 0===e||e.updateUI()})),this.editor.handleKeyEventsFrom(this.handleOverlay),this.editor.handlePointerEventsFrom(this.handleOverlay,((t,e)=>("pointerdown"===t&&(this.lastEvtTarget=e.target),!0)))}makeSelectionBox(t){var e;this.prevSelectionBox=this.selectionBox,this.selectionBox=new le(t,this.editor),this.expandingSelectionBox||null===(e=this.prevSelectionBox)||void 0===e||e.cancelSelection(),this.selectionBox.addTo(this.handleOverlay)}onPointerDown(t){var e;return!(1!==t.allPointers.length||!t.current.isPrimary||(this.lastEvtTarget&&(null===(e=this.selectionBox)||void 0===e?void 0:e.onDragStart(t.current,this.lastEvtTarget))?(this.selectionBoxHandlingEvt=!0,this.expandingSelectionBox=!1):(this.expandingSelectionBox=this.shiftKeyPressed,this.makeSelectionBox(t.current.canvasPos)),0))}onPointerMove(t){this.selectionBox&&(this.selectionBoxHandlingEvt?this.selectionBox.onDragUpdate(t.current):this.selectionBox.setToPoint(t.current.canvasPos))}onSelectionUpdated(){var t,e;this.editor.notifier.dispatch(M.ToolUpdated,{kind:M.ToolUpdated,tool:this});const n=null!==(e=null===(t=this.selectionBox)||void 0===t?void 0:t.getSelectedItemCount())&&void 0!==e?e:0;n>0?(this.editor.announceForAccessibility(this.editor.localization.selectedElements(n)),this.zoomToSelection()):this.selectionBox&&(this.selectionBox.cancelSelection(),this.prevSelectionBox=this.selectionBox,this.selectionBox=null)}onGestureEnd(){this.lastEvtTarget=null,this.selectionBox&&(this.selectionBoxHandlingEvt?this.selectionBox.onDragEnd():(this.selectionBox.resolveToObjects(),this.onSelectionUpdated()),this.selectionBoxHandlingEvt=!1)}zoomToSelection(){if(this.selectionBox){const t=this.selectionBox.region;this.editor.dispatchNoAnnounce(this.editor.viewport.zoomTo(t,!1),!1)}}onPointerUp(t){this.selectionBox&&(this.selectionBox.setToPoint(t.current.canvasPos),this.expandingSelectionBox&&this.prevSelectionBox?(this.expandingSelectionBox=!1,this.selectionBox.resolveToObjects(),this.setSelection([...this.selectionBox.getSelectedObjects(),...this.prevSelectionBox.getSelectedObjects()])):this.onGestureEnd())}onGestureCancel(){var t,e,n;this.selectionBoxHandlingEvt?null===(t=this.selectionBox)||void 0===t||t.onDragCancel():(null===(e=this.selectionBox)||void 0===e||e.cancelSelection(),this.selectionBox=this.prevSelectionBox,null===(n=this.selectionBox)||void 0===n||n.addTo(this.handleOverlay)),this.expandingSelectionBox=!1}onKeyPress(t){if(this.selectionBox&&t.ctrlKey&&"d"===t.key)return!0;if("a"===t.key&&t.ctrlKey)return!0;if(t.ctrlKey)return!1;if("Shift"===t.key)return this.shiftKeyPressed=!0,!0;let e=0,n=0,i=0,r=0,o=0;switch(t.key){case"a":case"h":case"ArrowLeft":n-=1;break;case"d":case"l":case"ArrowRight":n+=1;break;case"q":case"k":case"ArrowUp":i-=1;break;case"e":case"j":case"ArrowDown":i+=1;break;case"r":e+=1;break;case"R":e-=1;break;case"i":r-=1;break;case"I":r+=1;break;case"o":o-=1;break;case"O":o+=1}let s=0!==n||0!==i||0!==e||0!==r||0!==o;if(this.selectionBox){if(s){const t=10*this.editor.viewport.getSizeOfPixelOnCanvas(),s=Math.PI/8,a=5/4,l=this.selectionBox.region,c=S.of(Math.pow(a,r),Math.pow(a,o)),h=P.zRotation(e*s).mapEntries((t=>U.roundScaleRatio(t))),d=this.editor.viewport.roundPoint(l.center),u=P.scaling2D(c,this.editor.viewport.roundPoint(l.topLeft)).rightMul(P.translation(d).rightMul(h).rightMul(P.translation(d.times(-1)))).rightMul(P.translation(this.editor.viewport.roundPoint(S.of(n,i).times(t)))),p=this.selectionBox.getTransform();this.selectionBox.setTransform(p.rightMul(u))}}else s=!1;return!this.selectionBox||s||"Delete"!==t.key&&"Backspace"!==t.key||(this.editor.dispatch(this.selectionBox.deleteSelectedObjects()),this.clearSelection(),s=!0),s}onKeyUp(t){if("Shift"===t.key)return this.shiftKeyPressed=!1,!0;if(t.ctrlKey){if(this.selectionBox&&"d"===t.key)return this.editor.dispatch(this.selectionBox.duplicateSelectedObjects()),!0;if("a"===t.key)return this.setSelection(this.editor.image.getAllElements()),!0}return!(!this.selectionBox||!he.handleableKeys.some((e=>e===t.key))||(this.selectionBox.finalizeTransform(),0))}onCopy(t){if(!this.selectionBox)return!1;const e=this.selectionBox.getSelectedObjects(),n=this.selectionBox.region;if(0===e.length)return!1;const i=new U(this.editor.notifier);i.updateScreenSize(S.of(n.w,n.h)),i.resetTransform(P.translation(n.topLeft));const r=document.createElementNS("http://www.w3.org/2000/svg","svg"),o=new Yt(r,i,!0),s=[];for(const t of e)t.render(o),t instanceof Ut&&s.push(t.getText());return t.setData("image/svg+xml",r.outerHTML),s.length>0&&t.setData("text/plain",s.join("\n")),!0}setEnabled(t){super.setEnabled(t),this.handleOverlay.replaceChildren(),this.selectionBox=null,this.handleOverlay.style.display=t?"block":"none",t?(this.handleOverlay.tabIndex=0,this.handleOverlay.setAttribute("aria-label",this.editor.localization.selectionToolKeyboardShortcuts)):this.handleOverlay.tabIndex=-1}getSelection(){return this.selectionBox}getSelectedObjects(){var t,e;return null!==(e=null===(t=this.selectionBox)||void 0===t?void 0:t.getSelectedObjects())&&void 0!==e?e:[]}setSelection(t){t=t.filter((t=>t.isSelectable()));let e=null;for(const n of t)e=e?e.union(n.getBBox()):n.getBBox();e&&(this.clearSelection(),this.selectionBox||this.makeSelectionBox(e.topLeft),this.selectionBox.setSelectedObjects(t,e),this.onSelectionUpdated())}clearSelection(){this.handleOverlay.replaceChildren(),this.prevSelectionBox=this.selectionBox,this.selectionBox=null,this.onSelectionUpdated()}}he.handleableKeys=["a","h","ArrowLeft","d","l","ArrowRight","q","k","ArrowUp","e","j","ArrowDown","r","R","i","I","o","O"];class de extends V{constructor(t){super(t.notifier,t.localization.undoRedoTool),this.editor=t}onKeyPress({key:t,ctrlKey:e}){if(e){if("z"===t)return this.editor.history.undo(),!0;if("Z"===t)return this.editor.history.redo(),!0}return!1}}class ue extends b{constructor(t,e){super(),this.commands=t,this.applyChunkSize=e}static waitForAll(t){if(t.some((t=>t&&t.then)))return console.log("waiting..."),Promise.all(t).then((()=>{}))}apply(t){if(void 0===this.applyChunkSize){const e=this.commands.map((e=>e.apply(t)));return ue.waitForAll(e)}return t.asyncApplyCommands(this.commands,this.applyChunkSize)}unapply(t){if(void 0===this.applyChunkSize){const e=this.commands.map((e=>e.unapply(t)));return ue.waitForAll(e)}return t.asyncUnapplyCommands(this.commands,this.applyChunkSize)}description(t,e){const n=[];let i=null,r=0;for(const o of this.commands){const s=o.description(t,e);s!==i&&null!==i&&(n.push(e.unionOf(i,r)),i=null,r=0),r++,null!=i||(i=s)}return r>1?n.push(e.unionOf(i,r)):1===r&&n.push(i),n.join(", ")}}class pe extends w{constructor(t,e){super("union"),this.commands=t,this.applyChunkSize=e,this.nonserializableCommand=new ue(t,e)}serializeToJSON(){return{applyChunkSize:this.applyChunkSize,data:this.commands.map((t=>t.serialize()))}}apply(t){return this.nonserializableCommand.apply(t)}unapply(t){return this.nonserializableCommand.unapply(t)}description(t,e){return this.nonserializableCommand.description(t,e)}}const me=(t,e)=>{let n=!0;for(const e of t)if(!(e instanceof w)){n=!1;break}return n?new pe(t,e):new ue(t,e)};w.register("union",((t,e)=>{if("number"!=typeof t.data.length)throw new Error("Unions of commands must serialize to lists of serialization data.");const n=t.applyChunkSize;if("number"!=typeof n&&void 0!==n)throw new Error("serialized applyChunkSize is neither undefined nor a number.");const i=[];for(const n of t.data)i.push(w.deserialize(n,e));return me(i,n)}));const ge=me;class fe extends V{constructor(t,e,n){super(t.notifier,e),this.editor=t,this.localizationTable=n,this.textInputElem=null,this.textTargetPosition=null,this.textMeasuringCtx=null,this.textScale=S.of(1,1),this.removeExistingCommand=null,this.textStyle={size:32,fontFamily:"sans-serif",renderingStyle:{fill:St.purple}},this.textEditOverlay=document.createElement("div"),this.textEditOverlay.classList.add("textEditorOverlay"),this.editor.addStyleSheet("\n\t\t\t.textEditorOverlay {\n\t\t\t\theight: 0;\n\t\t\t\toverflow: visible;\n\t\t\t}\n\n\t\t\t.textEditorOverlay textarea {\n\t\t\t\tbackground-color: rgba(0, 0, 0, 0);\n\n\t\t\t\twhite-space: pre;\n\t\t\t\toverflow: hidden;\n\n\t\t\t\tpadding: 0;\n\t\t\t\tmargin: 0;\n\t\t\t\tborder: none;\n\t\t\t\tpadding: 0;\n\n\t\t\t\tmin-width: 100px;\n\t\t\t\tmin-height: 1.1em;\n\t\t\t}\n\t\t"),this.editor.createHTMLOverlay(this.textEditOverlay),this.editor.notifier.on(M.ViewportChanged,(()=>this.updateTextInput()))}getTextAscent(t,e){var n;return null!==(n=this.textMeasuringCtx)&&void 0!==n||(this.textMeasuringCtx=document.createElement("canvas").getContext("2d")),this.textMeasuringCtx?(Ut.applyTextStyles(this.textMeasuringCtx,e),this.textMeasuringCtx.measureText(t).actualBoundingBoxAscent):2*e.size/3}flushInput(){if(this.textInputElem&&this.textTargetPosition){const t=this.textInputElem.value.trimEnd();if(this.textInputElem.remove(),this.textInputElem=null,""===t)return;const e=P.translation(this.textTargetPosition).rightMul(this.getTextScaleMatrix()).rightMul(P.scaling2D(this.editor.viewport.getSizeOfPixelOnCanvas())).rightMul(P.zRotation(this.textRotation)),n=Ut.fromLines(t.split("\n"),e,this.textStyle),i=I.addElement(n);this.removeExistingCommand?(this.removeExistingCommand.unapply(this.editor),this.editor.dispatch(ge([this.removeExistingCommand,i])),this.removeExistingCommand=null):this.editor.dispatch(i)}}getTextScaleMatrix(){return P.scaling2D(this.textScale.times(1/this.editor.viewport.getSizeOfPixelOnCanvas()))}updateTextInput(){var t,e,n;if(!this.textInputElem||!this.textTargetPosition)return void(null===(t=this.textInputElem)||void 0===t||t.remove());const i=this.editor.viewport,r=i.canvasToScreen(this.textTargetPosition);this.textInputElem.placeholder=this.localizationTable.enterTextToInsert,this.textInputElem.style.fontFamily=this.textStyle.fontFamily,this.textInputElem.style.fontVariant=null!==(e=this.textStyle.fontVariant)&&void 0!==e?e:"",this.textInputElem.style.fontWeight=null!==(n=this.textStyle.fontWeight)&&void 0!==n?n:"",this.textInputElem.style.fontSize=`${this.textStyle.size}px`,this.textInputElem.style.color=this.textStyle.renderingStyle.fill.toHexString(),this.textInputElem.style.position="relative",this.textInputElem.style.left=`${r.x}px`,this.textInputElem.style.top=`${r.y}px`,this.textInputElem.style.margin="0",this.textInputElem.style.width=`${this.textInputElem.scrollWidth}px`,this.textInputElem.style.height=`${this.textInputElem.scrollHeight}px`;const o=this.getTextAscent("⎢",this.textStyle),s=this.textRotation+i.getRotationAngle(),a=this.getTextScaleMatrix();this.textInputElem.style.transform=`${a.toCSSMatrix()} rotate(${180*s/Math.PI}deg) translate(0, ${-o}px)`,this.textInputElem.style.transformOrigin="top left"}startTextInput(t,e){this.flushInput(),this.textInputElem=document.createElement("textarea"),this.textInputElem.value=e,this.textInputElem.style.display="inline-block",this.textTargetPosition=this.editor.viewport.roundPoint(t),this.textRotation=-this.editor.viewport.getRotationAngle(),this.textScale=S.of(1,1).times(this.editor.viewport.getSizeOfPixelOnCanvas()),this.updateTextInput(),setTimeout((()=>this.updateTextInput()),0),this.textInputElem.oninput=()=>{this.textInputElem&&(this.textInputElem.style.width=`${this.textInputElem.scrollWidth}px`,this.textInputElem.style.height=`${this.textInputElem.scrollHeight}px`)},this.textInputElem.onblur=()=>{setTimeout((()=>this.flushInput()),0)},this.textInputElem.onkeyup=t=>{var e,n;"Enter"!==t.key||t.shiftKey?"Escape"===t.key&&(null===(e=this.textInputElem)||void 0===e||e.remove(),this.textInputElem=null,this.editor.focus(),null===(n=this.removeExistingCommand)||void 0===n||n.unapply(this.editor),this.removeExistingCommand=null):(this.flushInput(),this.editor.focus())},this.textEditOverlay.replaceChildren(this.textInputElem),setTimeout((()=>{var t;return null===(t=this.textInputElem)||void 0===t?void 0:t.focus()}),0)}setEnabled(t){super.setEnabled(t),t||this.flushInput(),this.textEditOverlay.style.display=t?"block":"none"}onPointerDown({current:t,allPointers:e}){if(t.device===D.Eraser)return!1;if(1===e.length){const e=t.canvasPos,n=S.of(2.5,2.5).times(this.editor.viewport.getSizeOfPixelOnCanvas()),i=B.fromCorners(e.minus(n),e.plus(n));let r=this.editor.image.getElementsIntersectingRegion(i).filter((t=>t instanceof Ut));const o=this.editor.viewport.visibleRect;if(r=r.filter((t=>!t.getBBox().containsRect(o))),this.flushInput(),r.length>0){const t=r[r.length-1];this.setTextStyle(t.getTextStyle()),this.removeExistingCommand=new Dt([t]),this.removeExistingCommand.apply(this.editor),this.startTextInput(t.getBaselinePos(),t.getText());const e=t.getTransform();this.textRotation=e.transformVec3(S.unitX).angle();const n=e.transformVec3(S.unitX).magnitude();this.textScale=S.of(1,1).times(n),this.updateTextInput()}else this.removeExistingCommand=null,this.startTextInput(t.canvasPos,"");return!0}return!1}onGestureCancel(){this.flushInput(),this.editor.focus()}dispatchUpdateEvent(){this.updateTextInput(),this.editor.notifier.dispatch(M.ToolUpdated,{kind:M.ToolUpdated,tool:this})}setFontFamily(t){t!==this.textStyle.fontFamily&&(this.textStyle=Object.assign(Object.assign({},this.textStyle),{fontFamily:t}),this.dispatchUpdateEvent())}setColor(t){t.eq(this.textStyle.renderingStyle.fill)||(this.textStyle=Object.assign(Object.assign({},this.textStyle),{renderingStyle:Object.assign(Object.assign({},this.textStyle.renderingStyle),{fill:t})}),this.dispatchUpdateEvent())}setFontSize(t){t!==this.textStyle.size&&(this.textStyle=Object.assign(Object.assign({},this.textStyle),{size:t}),this.dispatchUpdateEvent())}getTextStyle(){return this.textStyle}setTextStyle(t){this.textStyle=Object.assign(Object.assign({},t),{renderingStyle:Object.assign({},t.renderingStyle)}),this.dispatchUpdateEvent()}}class ve extends V{constructor(t,e){super(t.notifier,e),this.editor=t,this.colorPreviewListener=null,this.colorSelectListener=null}setColorListener(t,e){this.colorPreviewListener=t,this.colorSelectListener=e}clearColorListener(){this.colorPreviewListener=null,this.colorSelectListener=null}onPointerDown({current:t,allPointers:e}){return!(!this.colorPreviewListener||1!==e.length||(this.colorPreviewListener(this.editor.display.getColorAt(t.screenPos)),0))}onPointerMove({current:t}){var e;null===(e=this.colorPreviewListener)||void 0===e||e.call(this,this.editor.display.getColorAt(t.screenPos))}onPointerUp({current:t}){var e;null===(e=this.colorSelectListener)||void 0===e||e.call(this,this.editor.display.getColorAt(t.screenPos))}onGestureCancel(){var t;null===(t=this.colorSelectListener)||void 0===t||t.call(this,null)}}class ye extends V{constructor(t){super(t.notifier,t.localization.changeTool),this.editor=t}onKeyPress({key:t}){const e=this.editor.toolController.getPrimaryTools(),n=/^[0-9]$/.exec(t);let i;return n&&(i=e[parseInt(n[0],10)-1]),!!i&&(i.setEnabled(!0),!0)}}const xe=(t,e)=>{const n=3*e.getSizeOfPixelOnCanvas(),i=e.getSizeOfPixelOnCanvas();return new be(t,i,n,e)};class be{constructor(t,e,n,i){this.startPoint=t,this.minFitAllowed=e,this.viewport=i,this.isFirstSegment=!0,this.pathStartConnector=null,this.mostRecentConnector=null,this.lastUpperBezier=null,this.lastLowerBezier=null,this.parts=[],this.upperSegments=[],this.lowerSegments=[],this.curveFitter=new zt(t,e,n,(t=>this.addCurve(t))),this.curveStartWidth=t.width,this.bbox=new B(this.startPoint.pos.x,this.startPoint.pos.y,0,0)}getBBox(){return this.bbox}getRenderingStyle(){var t;return{fill:null!==(t=this.startPoint.color)&&void 0!==t?t:null}}previewCurrentPath(){var t;const e=this.upperSegments.slice(),n=this.lowerSegments.slice();let i,r;const o=this.curveFitter.preview();if(o){const{upperCurveCommand:s,lowerToUpperConnector:a,upperToLowerConnector:l,lowerCurveCommand:c}=this.segmentToPath(o);e.push(s),n.push(c),i=a,r=null!==(t=this.pathStartConnector)&&void 0!==t?t:l}else{if(null===this.mostRecentConnector||null===this.pathStartConnector)return null;i=this.mostRecentConnector,r=this.pathStartConnector}let s;const a=n[n.length-1];return s=a.kind===wt.LineTo||a.kind===wt.MoveTo?a.point:a.endPoint,{startPoint:s,commands:[i,...e.reverse(),r,...n],style:this.getRenderingStyle()}}previewFullPath(){const t=this.previewCurrentPath();return t?[...this.parts,t]:null}previewStroke(){const t=this.previewFullPath();return t?new Et(t):null}preview(t){const e=this.previewFullPath();if(e){const n=this.viewport.visibleRect;t.startObject(n);for(const n of e)t.drawPath(n);t.endObject()}}build(){return this.curveFitter.finalizeCurrentCurve(),this.isFirstSegment&&this.addCurve(null),this.previewStroke()}roundPoint(t){let e=Math.min(this.minFitAllowed,this.curveStartWidth/2);return e<1e-10&&(e=this.minFitAllowed),U.roundPoint(t,e)}shouldStartNewSegment(t,e){if(!this.lastLowerBezier||!this.lastUpperBezier)return!1;const n=(t,e)=>{const n=t.intersects(e);if(!n||0===n.length)return null;const i=n[0],r=/^([-0-9.eE]+)\/([-0-9.eE]+)$/.exec(i);if(!r)throw new Error(`Incorrect format returned by .intersects: ${n} should be array of "number/number"!`);const o=parseFloat(r[1]);return S.ofXY(t.get(o))},i=t=>S.ofXY(t.points[2]).minus(S.ofXY(t.points[1])).normalized(),r=t=>S.ofXY(t.points[1]).minus(S.ofXY(t.points[0])).normalized();if(r(e).dot(i(this.lastUpperBezier))<.3||r(t).dot(i(this.lastLowerBezier))<.3||r(e).dot(i(e))<0||r(t).dot(i(t))<0)return!0;const o=n(t,this.lastUpperBezier),s=n(e,this.lastLowerBezier);return!(!o&&!s)}addCurve(t){if(!t){if(!this.isFirstSegment)return;const t=U.roundPoint(this.startPoint.width/3.5,Math.min(this.minFitAllowed,this.startPoint.width/4)),e=this.roundPoint(this.startPoint.pos),n=this.startPoint.pos.plus(S.of(t,0));return this.lowerSegments.push({kind:wt.QuadraticBezierTo,controlPoint:e.plus(S.of(t,t)),endPoint:e.plus(S.of(0,t))},{kind:wt.QuadraticBezierTo,controlPoint:e.plus(S.of(-t,t)),endPoint:e.plus(S.of(-t,0))},{kind:wt.QuadraticBezierTo,controlPoint:e.plus(S.of(-t,-t)),endPoint:e.plus(S.of(0,-t))},{kind:wt.QuadraticBezierTo,controlPoint:e.plus(S.of(t,-t)),endPoint:e.plus(S.of(t,0))}),this.pathStartConnector={kind:wt.LineTo,point:n},void(this.mostRecentConnector=this.pathStartConnector)}const{upperCurveCommand:e,lowerToUpperConnector:n,upperToLowerConnector:i,lowerCurveCommand:r,lowerCurve:o,upperCurve:s}=this.segmentToPath(t),a=this.shouldStartNewSegment(o,s);if(a){const t=this.previewCurrentPath();t&&(this.parts.push(t),this.upperSegments=[],this.lowerSegments=[])}(this.isFirstSegment||a)&&(this.pathStartConnector=i,this.isFirstSegment=!1),this.mostRecentConnector=n,this.lowerSegments.push(r),this.upperSegments.push(e),this.lastLowerBezier=o,this.lastUpperBezier=s,this.curveStartWidth=t.startWidth}segmentToPath(t){const e=new gt(t.startPoint.xy,t.controlPoint.xy,t.endPoint.xy);let n=S.ofXY(e.normal(0)).normalized(),i=S.ofXY(e.normal(1)).normalized();n=n.times(t.startWidth/2),i=i.times(t.endWidth/2),isFinite(n.magnitude())||(console.error("Warning: startVec is NaN or ∞",n,i,t),n=i);const r=t.startPoint,o=t.endPoint,s=t.controlPoint;let a=e.project(s.xy).t;a||(a=r.minus(s).magnitudeSquared()<o.minus(s).magnitudeSquared()?.1:.9);const l=a,c=S.ofXY(e.normal(l)).normalized().times(t.startWidth/2*l+t.endWidth/2*(1-l)),h=this.roundPoint(r.plus(n)),d=this.roundPoint(s.plus(c)),u=this.roundPoint(o.plus(i)),p=this.roundPoint(s.minus(c)),m=this.roundPoint(o.minus(i)),g=this.roundPoint(r.minus(n)),f={kind:wt.QuadraticBezierTo,controlPoint:d,endPoint:u},v={kind:wt.LineTo,point:h},y={kind:wt.LineTo,point:m};return{upperCurveCommand:{kind:wt.QuadraticBezierTo,controlPoint:p,endPoint:g},upperToLowerConnector:v,lowerToUpperConnector:y,lowerCurveCommand:f,upperCurve:new gt(m,p,g),lowerCurve:new gt(h,d,u)}}addPoint(t){this.curveFitter.addPoint(t)}}const we=t=>t instanceof w?new class extends w{serializeToJSON(){return t.serialize()}apply(e){t.unapply(e)}unapply(e){t.unapply(e)}description(e,n){return n.inverseOf(t.description(e,n))}}("inverse"):new class extends b{apply(e){t.unapply(e)}unapply(e){t.apply(e)}description(e,n){return n.inverseOf(t.description(e,n))}};w.register("inverse",((t,e)=>we(w.deserialize(t,e))));const Te=we;var Se=function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{l(i.next(t))}catch(t){o(t)}}function a(t){try{l(i.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}l((i=i.apply(t,e||[])).next())}))};class Ce extends V{constructor(t){super(t.notifier,t.localization.pasteHandler),this.editor=t}onPaste(t){const e=t.mime.toLowerCase();return"image/svg+xml"===e?(this.doSVGPaste(t.data),!0):"text/plain"===e?(this.doTextPaste(t.data),!0):("image/png"===e||"image/jpeg"===e)&&(this.doImagePaste(t.data),!0)}addComponentsFromPaste(t){return Se(this,void 0,void 0,(function*(){let e=null;for(const n of t)e=e?e.union(n.getBBox()):n.getBBox();if(!e)return;const n=this.editor.viewport.visibleRect,i=n.width/e.width,r=n.height/e.height;let o=i;(e.width*o>n.width||e.height*o>n.height)&&(o=r),o*=2/3,o=U.roundScaleRatio(o);const s=P.translation(n.center.minus(e.center)).rightMul(P.scaling2D(o,e.center)),a=[];for(const e of t)a.push(I.addElement(e)),a.push(e.transformBy(s));this.editor.dispatch(ge(a,100),!0);for(const e of this.editor.toolController.getMatchingTools(he))e.setEnabled(!0),e.setSelection(t)}))}doSVGPaste(t){return Se(this,void 0,void 0,(function*(){const e=qt.fromString(t,!0),n=[];yield e.start((t=>{n.push(t)}),((t,e)=>null)),yield this.addComponentsFromPaste(n)}))}doTextPaste(t){var e,n;return Se(this,void 0,void 0,(function*(){const i=this.editor.toolController.getMatchingTools(fe);i.sort(((t,e)=>!t.isEnabled()&&e.isEnabled()?-1:!e.isEnabled()&&t.isEnabled()?1:0));const r={size:12,fontFamily:"sans",renderingStyle:{fill:St.red}},o=null!==(n=null===(e=i[0])||void 0===e?void 0:e.getTextStyle())&&void 0!==n?n:r,s=t.split("\n");yield this.addComponentsFromPaste([Ut.fromLines(s,P.identity,o)])}))}doImagePaste(t){return Se(this,void 0,void 0,(function*(){const e=new Image;e.src=t;const n=yield Ft.fromImage(e,P.identity);yield this.addComponentsFromPaste([n])}))}}class ke extends V{constructor(t){super(t.notifier,t.localization.changeTool),this.listeners=new Set([])}registerListener(t){this.listeners.add(t)}removeListener(t){this.listeners.delete(t)}onKeyPress(t){for(const e of this.listeners)if(e(t))return!0;return!1}}class Pe extends V{constructor(t){super(t.notifier,t.localization.findLabel),this.editor=t,this.currentMatchIdx=0,this.overlay=document.createElement("div"),this.fillOverlay(),t.createHTMLOverlay(this.overlay),this.overlay.style.display="none",this.overlay.classList.add("find-tool-overlay")}getMatches(t){return t=t.toLocaleLowerCase(),this.editor.image.getAllElements().filter((t=>t instanceof Ut)).filter((e=>-1!==e.getText().toLocaleLowerCase().indexOf(t))).map((t=>t.getBBox()))}focusCurrentMatch(){const t=this.getMatches(this.searchInput.value);let e=this.currentMatchIdx%t.length;e<0&&(e=t.length+e),e<t.length&&(this.editor.dispatch(this.editor.viewport.zoomTo(t[e],!0,!0)),this.editor.announceForAccessibility(this.editor.localization.focusedFoundText(e+1,t.length)))}toNextMatch(){this.currentMatchIdx++,this.focusCurrentMatch()}toPrevMatch(){this.currentMatchIdx--,this.focusCurrentMatch()}fillOverlay(){const t=document.createElement("label");this.searchInput=document.createElement("input");const e=document.createElement("button"),n=document.createElement("button");this.searchInput.setAttribute("id",`find-tool-searchInput-${Math.random()}`),t.htmlFor=this.searchInput.getAttribute("id"),t.innerText=this.editor.localization.findLabel,e.innerText=this.editor.localization.toNextMatch,n.innerText=this.editor.localization.closeFindDialog,this.searchInput.onkeydown=t=>{"Enter"===t.key?t.shiftKey?this.toPrevMatch():this.toNextMatch():"Escape"===t.key?this.setVisible(!1):"f"===t.key&&t.ctrlKey&&(t.preventDefault(),this.toggleVisible())},e.onclick=()=>{this.toNextMatch()},n.onclick=()=>{this.setVisible(!1)},this.overlay.replaceChildren(t,this.searchInput,e,n)}isVisible(){return"none"!==this.overlay.style.display}setVisible(t){t!==this.isVisible()&&(this.overlay.style.display=t?"block":"none",t?(this.searchInput.focus(),this.editor.announceForAccessibility(this.editor.localization.findDialogShown)):(this.editor.focus(),this.editor.announceForAccessibility(this.editor.localization.findDialogHidden)))}toggleVisible(){this.setVisible(!this.isVisible())}onKeyPress(t){return!(!t.ctrlKey||"f"!==t.key||(this.toggleVisible(),0))}setEnabled(t){super.setEnabled(t),t&&this.setVisible(!1)}}class Ee{constructor(t,e){this.activeTool=null;const n=new At;this.primaryToolGroup=n;const i=new H(t,W.TwoFingerTouchGestures|W.RightClickDrags,e.touchPanTool),r=new H(t,W.Keyboard,e.keyboardPanZoom),o=new Lt(t,e.penTool(1),{color:St.purple,thickness:16}),s=[o,new Lt(t,e.penTool(2),{color:St.clay,thickness:4}),new Lt(t,e.penTool(3),{color:St.ofRGBA(1,1,0,.5),thickness:64},xe),new Ot(t,e.eraserTool),new he(t,e.selectionTool),new fe(t,e.textTool,e),new H(t,W.SinglePointerGestures,e.anyDevicePanning)];this.tools=[new ve(t,e.pipetteTool),i,...s,r,new de(t),new ke(t),new ye(t),new Pe(t),new Ce(t)],s.forEach((t=>t.setToolGroup(n))),i.setEnabled(!0),o.setEnabled(!0),t.notifier.on(M.ToolEnabled,(n=>{n.kind===M.ToolEnabled&&t.announceForAccessibility(e.toolEnabledAnnouncement(n.tool.description))})),t.notifier.on(M.ToolDisabled,(n=>{n.kind===M.ToolDisabled&&t.announceForAccessibility(e.toolDisabledAnnouncement(n.tool.description))})),this.activeTool=null}setTools(t,e){this.tools=t,this.primaryToolGroup=null!=e?e:new At}addPrimaryTool(t){t.setToolGroup(this.primaryToolGroup),t.isEnabled()&&this.primaryToolGroup.notifyEnabled(t),this.addTool(t)}getPrimaryTools(){return this.tools.filter((t=>t.getToolGroup()===this.primaryToolGroup))}addTool(t){this.tools.push(t)}dispatchInputEvent(t){var e,n;let i=!1;if(t.kind===A.PointerDownEvt){for(const n of this.tools)if(n.isEnabled()&&n.onPointerDown(t)){this.activeTool!==n&&(null===(e=this.activeTool)||void 0===e||e.onGestureCancel()),this.activeTool=n,i=!0;break}}else if(t.kind===A.PointerUpEvt)null===(n=this.activeTool)||void 0===n||n.onPointerUp(t),this.activeTool=null,i=!0;else if(t.kind===A.PointerMoveEvt)null!==this.activeTool&&(this.activeTool.onPointerMove(t),i=!0);else if(t.kind===A.GestureCancelEvt)null!==this.activeTool&&(this.activeTool.onGestureCancel(),this.activeTool=null);else{let e;for(const n of this.tools)if(n.isEnabled()){switch(t.kind){case A.KeyPressEvent:i=n.onKeyPress(t);break;case A.KeyUpEvent:i=n.onKeyUp(t);break;case A.WheelEvt:i=n.onWheel(t);break;case A.CopyEvent:i=n.onCopy(t);break;case A.PasteEvent:i=n.onPaste(t);break;default:return e=t,e}if(i)break}}return i}getMatchingTools(t){return this.tools.filter((e=>e instanceof t))}}class ze{constructor(){this.listeners={}}dispatch(t,e){const n=this.listeners[t];if(n)for(let t=0;t<n.length;t++)n[t](e)}on(t,e){return this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e),{remove:()=>{const n=this.listeners[t];return this.off(t,e),n.length!==this.listeners[t].length}}}off(t,e){const n=this.listeners[t];n&&(this.listeners[t]=n.filter((t=>t!==e)))}}var Be=function(t,e,n){var i,r,o,s,a,l,c,h,d,u,p,m,g,f,v,y=e.createElement("canvas").getContext("2d"),x={r:0,g:0,b:0,h:0,s:0,v:0,a:1},b={el:"[data-coloris]",parent:"body",theme:"default",themeMode:"light",wrap:!0,margin:2,format:"hex",formatToggle:!1,swatches:[],swatchesOnly:!1,alpha:!0,forceAlpha:!1,focusInput:!0,selectInput:!1,inline:!1,defaultColor:"#000000",clearButton:!1,clearLabel:"Clear",a11y:{open:"Open color picker",close:"Close color picker",marker:"Saturation: {s}. Brightness: {v}.",hueSlider:"Hue slider",alphaSlider:"Opacity slider",input:"Color value field",format:"Color format",swatch:"Color swatch",instruction:"Saturation and brightness selector. Use up, down, left and right arrow keys to select."}},w={},T="",S={},C=!1;function k(n){if("object"==typeof n)for(var s in n)switch(s){case"el":B(n.el),!1!==n.wrap&&I(n.el);break;case"parent":(i=e.querySelector(n.parent))&&(i.appendChild(r),b.parent=n.parent,i===e.body&&(i=null));break;case"themeMode":b.themeMode=n.themeMode,"auto"===n.themeMode&&t.matchMedia&&t.matchMedia("(prefers-color-scheme: dark)").matches&&(b.themeMode="dark");case"theme":n.theme&&(b.theme=n.theme),r.className="clr-picker clr-"+b.theme+" clr-"+b.themeMode,b.inline&&R();break;case"margin":n.margin*=1,b.margin=isNaN(n.margin)?b.margin:n.margin;break;case"wrap":n.el&&n.wrap&&I(n.el);break;case"formatToggle":b.formatToggle=!!n.formatToggle,H("clr-format").style.display=b.formatToggle?"block":"none",b.formatToggle&&(b.format="auto");break;case"swatches":Array.isArray(n.swatches)&&function(){var t=[];n.swatches.forEach((function(e,n){t.push('<button type="button" id="clr-swatch-'+n+'" aria-labelledby="clr-swatch-label clr-swatch-'+n+'" style="color: '+e+';">'+e+"</button>")})),H("clr-swatches").innerHTML=t.length?"<div>"+t.join("")+"</div>":"",b.swatches=n.swatches.slice()}();break;case"swatchesOnly":b.swatchesOnly=!!n.swatchesOnly,r.setAttribute("data-minimal",b.swatchesOnly);break;case"alpha":b.alpha=!!n.alpha,r.setAttribute("data-alpha",b.alpha);break;case"inline":if(b.inline=!!n.inline,r.setAttribute("data-inline",b.inline),b.inline){var a=n.defaultColor||b.defaultColor;f=M(a),R(),A(a)}break;case"clearButton":"object"==typeof n.clearButton&&(n.clearButton.label&&(b.clearLabel=n.clearButton.label,h.innerHTML=b.clearLabel),n.clearButton=n.clearButton.show),b.clearButton=!!n.clearButton,h.style.display=b.clearButton?"block":"none";break;case"clearLabel":b.clearLabel=n.clearLabel,h.innerHTML=b.clearLabel;break;case"a11y":var u=n.a11y,m=!1;if("object"==typeof u)for(var g in u)u[g]&&b.a11y[g]&&(b.a11y[g]=u[g],m=!0);if(m){var v=H("clr-open-label"),y=H("clr-swatch-label");v.innerHTML=b.a11y.open,y.innerHTML=b.a11y.swatch,l.setAttribute("aria-label",b.a11y.close),d.setAttribute("aria-label",b.a11y.hueSlider),p.setAttribute("aria-label",b.a11y.alphaSlider),c.setAttribute("aria-label",b.a11y.input),o.setAttribute("aria-label",b.a11y.instruction)}default:b[s]=n[s]}}function P(t,e){"string"==typeof t&&"object"==typeof e&&(w[t]=e,C=!0)}function E(t){delete w[t],0===Object.keys(w).length&&(C=!1,t===T&&z())}function z(){Object.keys(S).length>0&&(k(S),T="",S={})}function B(t){G(e,"click",t,(function(t){b.inline||(function(t){if(C){var e=["el","wrap","inline","defaultColor","a11y"],n=function(n){var i=w[n];if(t.matches(n)){for(var r in T=n,S={},e.forEach((function(t){return delete i[t]})),i)S[r]=Array.isArray(b[r])?b[r].slice():b[r];return k(i),"break"}};for(var i in w)if("break"===n(i))break}}(t.target),g=t.target,v=g.value,f=M(v),r.classList.add("clr-open"),R(),A(v),(b.focusInput||b.selectInput)&&c.focus({preventScroll:!0}),b.selectInput&&c.select(),g.dispatchEvent(new Event("open",{bubbles:!0})))})),G(e,"input",t,(function(t){var e=t.target.parentNode;e.classList.contains("clr-field")&&(e.style.color=t.target.value)}))}function R(){var n,a,l,c=i,h=t.scrollY,d=r.offsetWidth,u=r.offsetHeight,p={left:!1,top:!1},m={x:0,y:0};if(c&&(n=t.getComputedStyle(c),a=parseFloat(n.marginTop),l=parseFloat(n.borderTopWidth),(m=c.getBoundingClientRect()).y+=l+h),!b.inline){var f=g.getBoundingClientRect(),v=f.x,y=h+f.y+f.height+b.margin;c?(v-=m.x,y-=m.y,v+d>c.clientWidth&&(v+=f.width-d,p.left=!0),y+u>c.clientHeight-a&&u+b.margin<=f.top-(m.y-h)&&(y-=f.height+u+2*b.margin,p.top=!0),y+=c.scrollTop):(v+d>e.documentElement.clientWidth&&(v+=f.width-d,p.left=!0),y+u-h>e.documentElement.clientHeight&&u+b.margin<=f.top&&(y=h+f.y-u-b.margin,p.top=!0)),r.classList.toggle("clr-left",p.left),r.classList.toggle("clr-top",p.top),r.style.left=v+"px",r.style.top=y+"px"}s={width:o.offsetWidth,height:o.offsetHeight,x:r.offsetLeft+o.offsetLeft+m.x,y:r.offsetTop+o.offsetTop+m.y}}function I(t){e.querySelectorAll(t).forEach((function(t){var n=t.parentNode;if(!n.classList.contains("clr-field")){var i=e.createElement("div");i.innerHTML='<button type="button" aria-labelledby="clr-open-label"></button>',n.insertBefore(i,t),i.setAttribute("class","clr-field"),i.style.color=t.value,i.appendChild(t)}}))}function L(t){if(g&&!b.inline){var e=g;t&&(g=null,v!==e.value&&(e.value=v,e.dispatchEvent(new Event("input",{bubbles:!0})))),setTimeout((function(){v!==e.value&&e.dispatchEvent(new Event("change",{bubbles:!0}))})),r.classList.remove("clr-open"),C&&z(),e.dispatchEvent(new Event("close",{bubbles:!0})),b.focusInput&&e.focus({preventScroll:!0}),g=null}}function A(t){var e=function(t){var e,n;return y.fillStyle="#000",y.fillStyle=t,(e=/^((rgba)|rgb)[\D]+([\d.]+)[\D]+([\d.]+)[\D]+([\d.]+)[\D]*?([\d.]+|$)/i.exec(y.fillStyle))?(n={r:1*e[3],g:1*e[4],b:1*e[5],a:1*e[6]}).a=+n.a.toFixed(2):n={r:(e=y.fillStyle.replace("#","").match(/.{2}/g).map((function(t){return parseInt(t,16)})))[0],g:e[1],b:e[2],a:1},n}(t),i=function(t){var e=t.r/255,i=t.g/255,r=t.b/255,o=n.max(e,i,r),s=o-n.min(e,i,r),a=o,l=0,c=0;return s&&(o===e&&(l=(i-r)/s),o===i&&(l=2+(r-e)/s),o===r&&(l=4+(e-i)/s),o&&(c=s/o)),{h:(l=n.floor(60*l))<0?l+360:l,s:n.round(100*c),v:n.round(100*a),a:t.a}}(e);F(i.s,i.v),j(e,i),d.value=i.h,r.style.color="hsl("+i.h+", 100%, 50%)",u.style.left=i.h/360*100+"%",a.style.left=s.width*i.s/100+"px",a.style.top=s.height-s.height*i.v/100+"px",p.value=100*i.a,m.style.left=100*i.a+"%"}function M(t){var e=t.substring(0,3).toLowerCase();return"rgb"===e||"hsl"===e?e:"hex"}function D(t){t=void 0!==t?t:c.value,g&&(g.value=t,g.dispatchEvent(new Event("input",{bubbles:!0}))),e.dispatchEvent(new CustomEvent("coloris:pick",{detail:{color:t}}))}function O(t,e){var i={h:1*d.value,s:t/s.width*100,v:100-e/s.height*100,a:p.value/100},r=function(t){var e=t.v/100,i=t.s/100*e,r=t.h/60,o=i*(1-n.abs(r%2-1)),s=e-i;i+=s,o+=s;var a=n.floor(r)%6,l=[i,o,s,s,o,i][a],c=[o,i,i,o,s,s][a],h=[s,s,o,i,i,o][a];return{r:n.round(255*l),g:n.round(255*c),b:n.round(255*h),a:t.a}}(i);F(i.s,i.v),j(r,i),D()}function F(t,e){var n=b.a11y.marker;t=1*t.toFixed(1),e=1*e.toFixed(1),n=(n=n.replace("{s}",t)).replace("{v}",e),a.setAttribute("aria-label",n)}function $(t){var e=function(t){return{pageX:t.changedTouches?t.changedTouches[0].pageX:t.pageX,pageY:t.changedTouches?t.changedTouches[0].pageY:t.pageY}}(t),n=e.pageX-s.x,r=e.pageY-s.y;i&&(r+=i.scrollTop),n=n<0?0:n>s.width?s.width:n,r=r<0?0:r>s.height?s.height:r,a.style.left=n+"px",a.style.top=r+"px",O(n,r),t.preventDefault(),t.stopPropagation()}function N(t,e){var n=1*a.style.left.replace("px","")+t,i=1*a.style.top.replace("px","")+e;a.style.left=n+"px",a.style.top=i+"px",O(n,i)}function j(t,i){void 0===t&&(t={}),void 0===i&&(i={});var r=b.format;for(var s in t)x[s]=t[s];for(var h in i)x[h]=i[h];var d,u=function(t){var e=t.r.toString(16),n=t.g.toString(16),i=t.b.toString(16),r="";if(t.r<16&&(e="0"+e),t.g<16&&(n="0"+n),t.b<16&&(i="0"+i),b.alpha&&(t.a<1||b.forceAlpha)){var o=255*t.a|0;r=o.toString(16),o<16&&(r="0"+r)}return"#"+e+n+i+r}(x),p=u.substring(0,7);switch(a.style.color=p,m.parentNode.style.color=p,m.style.color=u,l.style.color=u,o.style.display="none",o.offsetHeight,o.style.display="",m.nextElementSibling.style.display="none",m.nextElementSibling.offsetHeight,m.nextElementSibling.style.display="","mixed"===r?r=1===x.a?"hex":"rgb":"auto"===r&&(r=f),r){case"hex":c.value=u;break;case"rgb":c.value=function(t){return!b.alpha||1===t.a&&!b.forceAlpha?"rgb("+t.r+", "+t.g+", "+t.b+")":"rgba("+t.r+", "+t.g+", "+t.b+", "+t.a+")"}(x);break;case"hsl":c.value=(d=function(t){var e,i=t.v/100,r=i*(1-t.s/100/2);return r>0&&r<1&&(e=n.round((i-r)/n.min(r,1-r)*100)),{h:t.h,s:e||0,l:n.round(100*r),a:t.a}}(x),!b.alpha||1===d.a&&!b.forceAlpha?"hsl("+d.h+", "+d.s+"%, "+d.l+"%)":"hsla("+d.h+", "+d.s+"%, "+d.l+"%, "+d.a+")")}e.querySelector('.clr-format [value="'+r+'"]').checked=!0}function U(){var t=1*d.value,e=1*a.style.left.replace("px",""),n=1*a.style.top.replace("px","");r.style.color="hsl("+t+", 100%, 50%)",u.style.left=t/360*100+"%",O(e,n)}function V(){var t=p.value/100;m.style.left=100*t+"%",j({a:t}),D()}function W(){i=null,(r=e.createElement("div")).setAttribute("id","clr-picker"),r.className="clr-picker",r.innerHTML='<input id="clr-color-value" class="clr-color" type="text" value="" spellcheck="false" aria-label="'+b.a11y.input+'"><div id="clr-color-area" class="clr-gradient" role="application" aria-label="'+b.a11y.instruction+'"><div id="clr-color-marker" class="clr-marker" tabindex="0"></div></div><div class="clr-hue"><input id="clr-hue-slider" type="range" min="0" max="360" step="1" aria-label="'+b.a11y.hueSlider+'"><div id="clr-hue-marker"></div></div><div class="clr-alpha"><input id="clr-alpha-slider" type="range" min="0" max="100" step="1" aria-label="'+b.a11y.alphaSlider+'"><div id="clr-alpha-marker"></div><span></span></div><div id="clr-format" class="clr-format"><fieldset class="clr-segmented"><legend>'+b.a11y.format+'</legend><input id="clr-f1" type="radio" name="clr-format" value="hex"><label for="clr-f1">Hex</label><input id="clr-f2" type="radio" name="clr-format" value="rgb"><label for="clr-f2">RGB</label><input id="clr-f3" type="radio" name="clr-format" value="hsl"><label for="clr-f3">HSL</label><span></span></fieldset></div><div id="clr-swatches" class="clr-swatches"></div><button type="button" id="clr-clear" class="clr-clear">'+b.clearLabel+'</button><button type="button" id="clr-color-preview" class="clr-preview" aria-label="'+b.a11y.close+'"></button><span id="clr-open-label" hidden>'+b.a11y.open+'</span><span id="clr-swatch-label" hidden>'+b.a11y.swatch+"</span>",e.body.appendChild(r),o=H("clr-color-area"),a=H("clr-color-marker"),h=H("clr-clear"),l=H("clr-color-preview"),c=H("clr-color-value"),d=H("clr-hue-slider"),u=H("clr-hue-marker"),p=H("clr-alpha-slider"),m=H("clr-alpha-marker"),B(b.el),I(b.el),G(r,"mousedown",(function(t){r.classList.remove("clr-keyboard-nav"),t.stopPropagation()})),G(o,"mousedown",(function(t){G(e,"mousemove",$)})),G(o,"touchstart",(function(t){e.addEventListener("touchmove",$,{passive:!1})})),G(a,"mousedown",(function(t){G(e,"mousemove",$)})),G(a,"touchstart",(function(t){e.addEventListener("touchmove",$,{passive:!1})})),G(c,"change",(function(t){g&&(A(c.value),D())})),G(h,"click",(function(t){D(""),L()})),G(l,"click",(function(t){D(),L()})),G(e,"click",".clr-format input",(function(t){f=t.target.value,j(),D()})),G(r,"click",".clr-swatches button",(function(t){A(t.target.textContent),D(),b.swatchesOnly&&L()})),G(e,"mouseup",(function(t){e.removeEventListener("mousemove",$)})),G(e,"touchend",(function(t){e.removeEventListener("touchmove",$)})),G(e,"mousedown",(function(t){r.classList.remove("clr-keyboard-nav"),L()})),G(e,"keydown",(function(t){"Escape"===t.key?L(!0):"Tab"===t.key&&r.classList.add("clr-keyboard-nav")})),G(e,"click",".clr-field button",(function(t){C&&z(),t.target.nextElementSibling.dispatchEvent(new Event("click",{bubbles:!0}))})),G(a,"keydown",(function(t){var e={ArrowUp:[0,-1],ArrowDown:[0,1],ArrowLeft:[-1,0],ArrowRight:[1,0]};-1!==Object.keys(e).indexOf(t.key)&&(N.apply(void 0,e[t.key]),t.preventDefault())})),G(o,"click",$),G(d,"input",U),G(p,"input",V)}function H(t){return e.getElementById(t)}function G(t,e,n,i){var r=Element.prototype.matches||Element.prototype.msMatchesSelector;"string"==typeof n?t.addEventListener(e,(function(t){r.call(t.target,n)&&i.call(t.target,t)})):(i=n,t.addEventListener(e,i))}function _(t,n){n=void 0!==n?n:[],"loading"!==e.readyState?t.apply(void 0,n):e.addEventListener("DOMContentLoaded",(function(){t.apply(void 0,n)}))}void 0!==NodeList&&NodeList.prototype&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=Array.prototype.forEach);var q=function(){var t={init:W,set:k,wrap:I,close:L,setInstance:P,removeInstance:E,updatePosition:R};function e(t){_((function(){t&&("string"==typeof t?B(t):k(t))}))}var n=function(n){e[n]=function(){for(var e=arguments.length,i=new Array(e),r=0;r<e;r++)i[r]=arguments[r];_(t[n],i)}};for(var i in t)n(i);return e}();return q.coloris=q,q}(window,document,Math),Re=Be.coloris,Ie=Be.init;Be.set,Be.wrap,Be.close;const Le={pen:"Pen",eraser:"Eraser",select:"Select",handTool:"Pan",zoom:"Zoom",resetView:"Reset view",thicknessLabel:"Thickness: ",colorLabel:"Color: ",fontLabel:"Font: ",textSize:"Size: ",resizeImageToSelection:"Resize image to selection",deleteSelection:"Delete selection",duplicateSelection:"Duplicate selection",undo:"Undo",redo:"Redo",selectObjectType:"Object type: ",pickColorFromScreen:"Pick color from screen",clickToPickColorAnnouncement:"Click on the screen to pick a color",selectionToolKeyboardShortcuts:"Selection tool: Use arrow keys to move selected items, lowercase/uppercase ‘i’ and ‘o’ to resize.",touchPanning:"Touchscreen panning",freehandPen:"Freehand",pressureSensitiveFreehandPen:"Freehand (pressure sensitive)",arrowPen:"Arrow",linePen:"Line",outlinedRectanglePen:"Outlined rectangle",filledRectanglePen:"Filled rectangle",lockRotation:"Lock rotation",dropdownShown:t=>`Dropdown for ${t} shown`,dropdownHidden:t=>`Dropdown for ${t} hidden`,zoomLevel:t=>`Zoom: ${t}%`,colorChangedAnnouncement:t=>`Color changed to ${t}`},Ae=(t,e)=>new Me(t);class Me{constructor(t){this.startPoint=t,this.endPoint=t}getLineWidth(){return Math.max(this.endPoint.width,this.startPoint.width)}getBBox(){return this.buildPreview().getBBox()}buildPreview(){const t=this.startPoint.pos,e=this.endPoint.pos,n=e.minus(t).normalized(),i=e.minus(t).length(),r=Math.min(this.getLineWidth(),i/2),o=this.startPoint.width/2,s=this.endPoint.width/2,a=e.minus(n.times(r)),l=n.orthog(),c=l.times(o),h=l.times(s);return new Et([{startPoint:a.minus(h),commands:[{kind:wt.LineTo,point:t.minus(c)},{kind:wt.LineTo,point:t.plus(c)},{kind:wt.LineTo,point:a.plus(h)},{kind:wt.LineTo,point:a.plus(l.times(r).plus(h))},{kind:wt.LineTo,point:e.plus(n.times(s))},{kind:wt.LineTo,point:a.plus(l.times(-r).minus(h))},{kind:wt.LineTo,point:a.minus(h)}],style:{fill:this.startPoint.color}}])}build(){return this.buildPreview()}preview(t){this.buildPreview().render(t)}addPoint(t){this.endPoint=t}}const De=(t,e)=>new Oe(t);class Oe{constructor(t){this.startPoint=t,this.endPoint=t}getBBox(){return this.buildPreview().getBBox()}buildPreview(){const t=this.startPoint.pos,e=this.endPoint.pos,n=e.minus(t).normalized(),i=this.startPoint.width/2,r=this.endPoint.width/2,o=n.orthog(),s=o.times(i),a=o.times(r);return new Et([{startPoint:t.minus(s),commands:[{kind:wt.LineTo,point:t.plus(s)},{kind:wt.LineTo,point:e.plus(a)},{kind:wt.LineTo,point:e.minus(a)},{kind:wt.LineTo,point:t.minus(s)}],style:{fill:this.startPoint.color}}])}build(){return this.buildPreview()}preview(t){this.buildPreview().render(t)}addPoint(t){this.endPoint=t}}const Fe=(t,e)=>new Ne(t,!0,e),$e=(t,e)=>new Ne(t,!1,e);class Ne{constructor(t,e,n){this.startPoint=t,this.filled=e,this.viewport=n,this.endPoint=t}getBBox(){return this.buildPreview().getBBox()}buildPreview(){const t=this.viewport.getRotationAngle(),e=P.zRotation(-t),n=e.inverse().transformVec2(this.startPoint.pos),i=e.inverse().transformVec2(this.endPoint.pos),r=B.fromCorners(n,i),o=Tt.fromRect(r,this.filled?null:this.endPoint.width).transformedBy(e);return new Et([o.toRenderable({fill:this.endPoint.color})])}build(){return this.buildPreview()}preview(t){this.buildPreview().render(t)}addPoint(t){this.endPoint=t}}const je=(t,e)=>{const n=document.createElement("span"),i=document.createElement("input");let r;i.type="button",i.classList.add("coloris_input"),n.classList.add("color-input-container"),n.appendChild(i),Ue(t,n,(t=>{i.value=t.toHexString(),s();const e=i.parentElement;e&&e.classList.contains("clr-field")&&(e.style.color=i.value)}));const o=()=>{r=St.fromHex(i.value)},s=()=>{o(),r&&(t.announceForAccessibility(t.localization.colorChangedAnnouncement(r.toHexString())),e(r),t.notifier.dispatch(M.ColorPickerColorSelected,{kind:M.ColorPickerColorSelected,color:r}))};return i.oninput=o,i.addEventListener("open",(()=>{t.notifier.dispatch(M.ColorPickerToggled,{kind:M.ColorPickerToggled,open:!0})})),i.addEventListener("close",(()=>{t.notifier.dispatch(M.ColorPickerToggled,{kind:M.ColorPickerToggled,open:!1}),s()})),[i,n,t=>{"object"==typeof t&&(t=t.toHexString()),i.value=t,i.dispatchEvent(new Event("input",{bubbles:!0}))}]},Ue=(t,e,n)=>{const i=document.createElement("button");i.classList.add("pipetteButton"),i.title=t.localization.pickColorFromScreen,i.setAttribute("alt",i.title);const r=e=>{i.replaceChildren(t.icons.makePipetteIcon(e))};r();const o=t.toolController.getMatchingTools(ve)[0],s=()=>{null==o||o.clearColorListener(),r(),i.classList.remove("active")},a=t=>{s(),t&&n(t)},l=t=>{t?r(t):r()};i.onclick=()=>{i.classList.contains("active")?s():(null==o||o.setColorListener(l,a),o&&(i.classList.add("active"),t.announceForAccessibility(t.localization.clickToPickColorAnnouncement)))},e.appendChild(i)},Ve=je;var We,He=function(t,e,n,i,r){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!r:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?r.call(t,n):r?r.value=n:e.set(t,n),n},Ge=function(t,e,n,i){if("a"===n&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!i:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?i:"a"===n?i.call(t):i?i.value:e.get(t)};class _e{constructor(t,e,n){this.editor=t,this.id=e,We.set(this,void 0),this.disabled=!1,this.subWidgets={},this.toplevel=!0,this.localizationTable=null!=n?n:t.localization,this.icon=null,this.container=document.createElement("div"),this.container.classList.add(`${nn}toolContainer`),this.dropdownContainer=document.createElement("div"),this.dropdownContainer.classList.add(`${nn}dropdown`),this.dropdownContainer.classList.add("hidden"),He(this,We,!1,"f"),this.button=document.createElement("div"),this.button.classList.add(`${nn}button`),this.label=document.createElement("label"),this.button.setAttribute("role","button"),this.button.tabIndex=0;const i=this.editor.toolController.getMatchingTools(ke);i.length>0&&this.onKeyPress!==_e.prototype.onKeyPress&&i[0].registerListener((t=>this.onKeyPress(t)))}getId(){return this.id}getUniqueIdIn(t){let e=this.getId(),n=0;for(;e in t&&t[e]!==this;)e=this.getId()+"-"+n.toString(),n++;return e}fillDropdown(t){if(0===Object.keys(this.subWidgets).length)return!1;for(const e in this.subWidgets){const n=this.subWidgets[e];n.addTo(t),n.setIsToplevel(!1)}return!0}setupActionBtnClickListener(t){const e={Enter:!0," ":!0};t.onkeydown=t=>{let n=!1;t.key in e&&(this.disabled||(this.handleClick(),n=!0)),n||this.editor.toolController.dispatchInputEvent({kind:A.KeyPressEvent,key:t.key,ctrlKey:t.ctrlKey,altKey:t.altKey})},t.onkeyup=t=>{t.key in e||this.editor.toolController.dispatchInputEvent({kind:A.KeyUpEvent,key:t.key,ctrlKey:t.ctrlKey,altKey:t.altKey})},t.onclick=()=>{this.disabled||this.handleClick()}}onKeyPress(t){return!1}get hasDropdown(){return Ge(this,We,"f")}addSubWidget(t){const e=t.getUniqueIdIn(this.subWidgets);this.subWidgets[e]=t}addTo(t){this.label.innerText=this.getTitle(),this.setupActionBtnClickListener(this.button),this.icon=null,this.updateIcon(),this.button.replaceChildren(this.icon,this.label),this.container.appendChild(this.button),He(this,We,this.fillDropdown(this.dropdownContainer),"f"),Ge(this,We,"f")&&(this.dropdownIcon=this.createDropdownIcon(),this.button.appendChild(this.dropdownIcon),this.container.appendChild(this.dropdownContainer),this.editor.notifier.on(M.ToolbarDropdownShown,(t=>{t.kind===M.ToolbarDropdownShown&&t.parentWidget!==this&&t.parentWidget.toplevel&&this.setDropdownVisible(!1)}))),this.setDropdownVisible(!1),t.appendChild(this.container)}updateIcon(){var t;const e=this.createIcon();null===(t=this.icon)||void 0===t||t.replaceWith(e),this.icon=e,this.icon.classList.add(`${nn}icon`)}setDisabled(t){this.disabled=t,this.disabled?(this.button.classList.add("disabled"),this.button.setAttribute("aria-disabled","true")):(this.button.classList.remove("disabled"),this.button.removeAttribute("aria-disabled"))}setSelected(t){this.isSelected()!==t&&(t?(this.container.classList.add("selected"),this.button.ariaSelected="true"):(this.container.classList.remove("selected"),this.button.ariaSelected="false"))}setDropdownVisible(t){this.container.classList.contains("dropdownVisible")!==t&&(t?(this.dropdownContainer.classList.remove("hidden"),this.container.classList.add("dropdownVisible"),this.editor.announceForAccessibility(this.localizationTable.dropdownShown(this.getTitle())),this.editor.notifier.dispatch(M.ToolbarDropdownShown,{kind:M.ToolbarDropdownShown,parentWidget:this})):(this.dropdownContainer.classList.add("hidden"),this.container.classList.remove("dropdownVisible"),this.editor.announceForAccessibility(this.localizationTable.dropdownHidden(this.getTitle()))),this.repositionDropdown())}repositionDropdown(){const t=this.dropdownContainer.getBoundingClientRect(),e=document.body.clientWidth;t.left>e/2?(this.dropdownContainer.style.marginLeft=this.button.clientWidth+"px",this.dropdownContainer.style.transform="translate(-100%, 0)"):(this.dropdownContainer.style.marginLeft="",this.dropdownContainer.style.transform="")}setIsToplevel(t){this.toplevel=t}isDropdownVisible(){return!this.dropdownContainer.classList.contains("hidden")}isSelected(){return this.container.classList.contains("selected")}createDropdownIcon(){const t=this.editor.icons.makeDropdownIcon();return t.classList.add(`${nn}showHideDropdownIcon`),t}serializeState(){const t={};for(const e in this.subWidgets)t[e]=this.subWidgets[e].serializeState();return{subwidgetState:t}}deserializeFrom(t){if(t.subwidgetState)for(const e in t.subwidgetState)e in this.subWidgets&&this.subWidgets[e].deserializeFrom(t.subwidgetState[e])}}We=new WeakMap;class qe extends _e{constructor(t,e,n,i){super(t,n,i),this.editor=t,this.targetTool=e,t.notifier.on(M.ToolEnabled,(t=>{if(t.kind!==M.ToolEnabled)throw new Error("Incorrect event type! (Expected ToolEnabled)");t.tool===e&&this.setSelected(!0)})),t.notifier.on(M.ToolDisabled,(t=>{if(t.kind!==M.ToolDisabled)throw new Error("Incorrect event type! (Expected ToolDisabled)");t.tool===e&&(this.setSelected(!1),this.setDropdownVisible(!1))}))}handleClick(){this.hasDropdown?this.targetTool.isEnabled()?this.setDropdownVisible(!this.isDropdownVisible()):this.targetTool.setEnabled(!0):this.targetTool.setEnabled(!this.targetTool.isEnabled())}addTo(t){super.addTo(t),this.setSelected(this.targetTool.isEnabled())}}class Ke extends qe{constructor(t,e,n){super(t,e,"pen",n),this.tool=e,this.updateInputs=()=>{},this.penTypes=[{name:this.localizationTable.pressureSensitiveFreehandPen,id:"pressure-sensitive-pen",factory:xe},{name:this.localizationTable.freehandPen,id:"freehand-pen",factory:Rt},{name:this.localizationTable.arrowPen,id:"arrow",factory:Ae},{name:this.localizationTable.linePen,id:"line",factory:De},{name:this.localizationTable.filledRectanglePen,id:"filled-rectangle",factory:Fe},{name:this.localizationTable.outlinedRectanglePen,id:"outlined-rectangle",factory:$e}],this.editor.notifier.on(M.ToolUpdated,(t=>{if(t.kind!==M.ToolUpdated)throw new Error("Invalid event type!");t.tool===this.tool&&(this.updateIcon(),this.updateInputs())}))}getTitle(){return this.targetTool.description}getCurrentPenTypeIdx(){const t=this.tool.getStrokeFactory();for(let e=0;e<this.penTypes.length;e++)if(this.penTypes[e].factory===t)return e;return-1}getCurrentPenType(){for(const t of this.penTypes)if(t.factory===this.tool.getStrokeFactory())return t;return null}createIcon(){const t=this.tool.getStrokeFactory();if(t===Rt||t===xe){const t=Math.round(4*Math.sqrt(this.tool.getThickness())),e=this.tool.getColor();return this.editor.icons.makePenIcon(t,e.toHexString())}{const t=this.tool.getStrokeFactory();return this.editor.icons.makeIconFromFactory(this.tool,t)}}fillDropdown(t){const e=document.createElement("div"),n=document.createElement("div"),i=document.createElement("div"),r=document.createElement("label"),o=document.createElement("input"),s=document.createElement("label"),a=document.createElement("select");o.id=`${nn}thicknessInput${Ke.idCounter++}`,a.id=`${nn}builderSelect${Ke.idCounter++}`,r.innerText=this.localizationTable.thicknessLabel,r.setAttribute("for",o.id),s.innerText=this.localizationTable.selectObjectType,s.setAttribute("for",a.id);const l=t=>Math.log10(t);o.type="range",o.min=`${l(2)}`,o.max=`${l(400)}`,o.step="0.1",o.oninput=()=>{this.tool.setThickness((t=>Math.pow(10,t))(parseFloat(o.value)))},n.appendChild(r),n.appendChild(o),a.oninput=()=>{const t=parseInt(a.value);t<0||t>=this.penTypes.length?console.error("Invalid pen type index",t):this.tool.setStrokeFactory(this.penTypes[t].factory)},i.appendChild(s),i.appendChild(a);const c=document.createElement("div"),h=document.createElement("label"),[d,u,p]=Ve(this.editor,(t=>{this.tool.setColor(t)}));return d.id=`${nn}colorInput${Ke.idCounter++}`,h.innerText=this.localizationTable.colorLabel,h.setAttribute("for",d.id),c.appendChild(h),c.appendChild(u),this.updateInputs=()=>{p(this.tool.getColor()),o.value=l(this.tool.getThickness()).toString(),a.replaceChildren();for(let t=0;t<this.penTypes.length;t++){const e=this.penTypes[t],n=document.createElement("option");n.value=t.toString(),n.innerText=e.name,a.appendChild(n)}const t=this.getCurrentPenTypeIdx();a.value=-1===t?"":t.toString()},this.updateInputs(),e.replaceChildren(c,n,i),t.replaceChildren(e),!0}onKeyPress(t){if(!this.isSelected())return!1;if(/^[0-9]$/.exec(t.key)&&t.ctrlKey){const e=parseInt(t.key)-1;if(e>=0&&e<this.penTypes.length)return this.tool.setStrokeFactory(this.penTypes[e].factory),!0}return!1}serializeState(){var t;return Object.assign(Object.assign({},super.serializeState()),{color:this.tool.getColor().toHexString(),thickness:this.tool.getThickness(),strokeFactoryId:null===(t=this.getCurrentPenType())||void 0===t?void 0:t.id})}deserializeFrom(t){super.deserializeFrom(t);const e=(e,n)=>{const i=typeof t[e];if(i!==n)throw new Error(`Deserializing property ${e}: Invalid type. Expected ${n}, was ${i}.`)};if(t.color&&(e("color","string"),this.tool.setColor(St.fromHex(t.color))),t.thickness&&(e("thickness","number"),this.tool.setThickness(t.thickness)),t.strokeFactoryId){e("strokeFactoryId","string");const n=t.strokeFactoryId;for(const t of this.penTypes)if(n===t.id){this.tool.setStrokeFactory(t.factory);break}}}}Ke.idCounter=0;class Ze extends qe{constructor(t,e,n){super(t,e,"eraser-tool-widget",n)}getTitle(){return this.localizationTable.eraser}createIcon(){return this.editor.icons.makeEraserIcon()}fillDropdown(t){return!1}}class Xe extends _e{constructor(t,e,n,i,r,o){super(t,e,o),this.makeIcon=n,this.title=i,this.clickAction=r}handleClick(){this.clickAction()}getTitle(){return this.title}createIcon(){return this.makeIcon()}fillDropdown(t){return!1}}class Ye extends qe{constructor(t,e,n){super(t,e,"selection-tool-widget",n),this.tool=e;const i=new Xe(t,"resize-btn",(()=>t.icons.makeResizeViewportIcon()),this.localizationTable.resizeImageToSelection,(()=>{this.resizeImageToSelection()}),n),r=new Xe(t,"delete-btn",(()=>t.icons.makeDeleteSelectionIcon()),this.localizationTable.deleteSelection,(()=>{const t=this.tool.getSelection();this.editor.dispatch(t.deleteSelectedObjects()),this.tool.clearSelection()}),n),o=new Xe(t,"duplicate-btn",(()=>t.icons.makeDuplicateSelectionIcon()),this.localizationTable.duplicateSelection,(()=>{const t=this.tool.getSelection();this.editor.dispatch(t.duplicateSelectedObjects())}),n);this.addSubWidget(i),this.addSubWidget(r),this.addSubWidget(o);const s=t=>{i.setDisabled(t),r.setDisabled(t),o.setDisabled(t)};s(!0),this.editor.notifier.on(M.ToolUpdated,(t=>{if(t.kind!==M.ToolUpdated)throw new Error("Invalid event type!");if(t.tool===this.tool){const t=this.tool.getSelection(),e=t&&t.region.area>0;s(!e)}}))}resizeImageToSelection(){const t=this.tool.getSelection();t&&this.editor.dispatch(this.editor.setImportExportRect(t.region))}onKeyPress(t){return!(!t.ctrlKey||"r"!==t.key||(this.resizeImageToSelection(),0))}getTitle(){return this.localizationTable.select}createIcon(){return this.editor.icons.makeSelectionIcon()}}class Je extends qe{constructor(t,e,n){super(t,e,"text-tool-widget",n),this.tool=e,this.updateDropdownInputs=null,t.notifier.on(M.ToolUpdated,(t=>{var n;t.kind===M.ToolUpdated&&t.tool===e&&(this.updateIcon(),null===(n=this.updateDropdownInputs)||void 0===n||n.call(this))}))}getTitle(){return this.targetTool.description}createIcon(){const t=this.tool.getTextStyle();return this.editor.icons.makeTextIcon(t)}fillDropdown(t){const e=document.createElement("div"),n=document.createElement("div"),i=document.createElement("div"),r=document.createElement("select"),o=document.createElement("label"),s=document.createElement("input"),a=document.createElement("label"),[l,c,h]=Ve(this.editor,(t=>{this.tool.setColor(t)})),d=document.createElement("label"),u=new Set,p=t=>{const e=document.createElement("option");e.value=t,e.textContent=t,r.appendChild(e),u.add(t)};return s.setAttribute("type","number"),s.min="1",s.max="128",o.innerText=this.localizationTable.fontLabel,d.innerText=this.localizationTable.colorLabel,a.innerText=this.localizationTable.textSize,l.id=`${nn}-text-color-input-${Je.idCounter++}`,d.setAttribute("for",l.id),s.id=`${nn}-text-size-input-${Je.idCounter++}`,a.setAttribute("for",s.id),p("monospace"),p("serif"),p("sans-serif"),r.id=`${nn}-text-font-input-${Je.idCounter++}`,o.setAttribute("for",r.id),r.onchange=()=>{this.tool.setFontFamily(r.value)},s.onchange=()=>{const t=parseInt(s.value);!isNaN(t)&&t>0&&this.tool.setFontSize(t)},n.appendChild(d),n.appendChild(c),e.appendChild(o),e.appendChild(r),i.appendChild(a),i.appendChild(s),this.updateDropdownInputs=()=>{const t=this.tool.getTextStyle();h(t.renderingStyle.fill),u.has(t.fontFamily)||p(t.fontFamily),r.value=t.fontFamily,s.value=`${t.size}`},this.updateDropdownInputs(),t.replaceChildren(n,i,e),!0}serializeState(){const t=this.tool.getTextStyle();return Object.assign(Object.assign({},super.serializeState()),{fontFamily:t.fontFamily,textSize:t.size,color:t.renderingStyle.fill.toHexString()})}deserializeFrom(t){t.fontFamily&&"string"==typeof t.fontFamily&&this.tool.setFontFamily(t.fontFamily),t.color&&"string"==typeof t.color&&this.tool.setColor(St.fromHex(t.color)),t.textSize&&"number"==typeof t.textSize&&this.tool.setFontSize(t.textSize),super.deserializeFrom(t)}}Je.idCounter=0;class Qe extends _e{constructor(t,e){super(t,"zoom-widget",e),this.container.classList.add("dropdownShowable")}getTitle(){return this.localizationTable.zoom}createIcon(){return this.editor.icons.makeZoomIcon()}handleClick(){this.setDropdownVisible(!this.isDropdownVisible())}fillDropdown(t){return t.appendChild(((t,e)=>{const n=document.createElement("div"),i=document.createElement("button"),r=document.createElement("button"),o=document.createElement("button"),s=document.createElement("span");let a;i.innerText="+",r.innerText="-",o.innerText=t.resetView,n.replaceChildren(s,i,r,o),n.classList.add(`${nn}zoomLevelEditor`),s.classList.add("zoomDisplay");const l=()=>{let n=100*e.viewport.getScaleFactor();n=n>.1?Math.round(10*n)/10:Math.round(1e3*n)/1e3,n!==a&&(s.innerText=t.zoomLevel(n),a=n)};l(),e.notifier.on(M.ViewportChanged,(t=>{t.kind===M.ViewportChanged&&(l(),o.disabled=t.newTransform.eq(P.identity))}));const c=t=>{const n=e.viewport.visibleRect.center,i=P.scaling2D(t,n);e.dispatch(U.transformBy(i),!1)};return i.onclick=()=>{c(5/4)},r.onclick=()=>{c(.8)},o.onclick=()=>{e.dispatch(U.transformBy(e.viewport.canvasToScreenTransform.inverse()),!0)},n})(this.localizationTable,this.editor)),!0}}class tn extends _e{constructor(t,e,n,i,r,o){super(t,`pan-mode-${n}`,o),this.tool=e,this.flag=n,this.makeIcon=i,this.title=r,t.notifier.on(M.ToolUpdated,(t=>{if(t.kind===M.ToolUpdated&&t.tool===e){const t=!!(e.getMode()&W.SinglePointerGestures);this.setSelected(!!(e.getMode()&n)||t),this.setDisabled(t&&n!==W.SinglePointerGestures)}})),this.setSelected(!1)}setModeFlag(t){this.tool.setModeEnabled(this.flag,t)}handleClick(){this.setModeFlag(!this.isSelected())}getTitle(){return this.title}createIcon(){return this.makeIcon()}fillDropdown(t){return!1}}class en extends qe{constructor(t,e,n){const i=en.getPrimaryHandTool(t.toolController);super(t,null!=i?i:e,"hand-tool-widget",n),this.overridePanZoomTool=e,this.allowTogglingBaseTool=null!==i,this.allowTogglingBaseTool||this.container.classList.add("dropdownShowable");const r=new tn(t,e,W.OneFingerTouchGestures,(()=>this.editor.icons.makeTouchPanningIcon()),n.touchPanning,n),o=new tn(t,e,W.RotationLocked,(()=>this.editor.icons.makeRotationLockIcon()),n.lockRotation,n);this.addSubWidget(r),this.addSubWidget(o),this.addSubWidget(new Qe(t,n))}static getPrimaryHandTool(t){return t.getPrimaryTools().filter((t=>t instanceof H))[0]}getTitle(){return this.localizationTable.handTool}createIcon(){return this.editor.icons.makeHandToolIcon()}handleClick(){this.allowTogglingBaseTool?super.handleClick():this.setDropdownVisible(!this.isDropdownVisible())}setSelected(t){this.allowTogglingBaseTool&&super.setSelected(t)}serializeState(){const t=this.overridePanZoomTool.getMode();return Object.assign(Object.assign({},super.serializeState()),{touchPanning:t&W.OneFingerTouchGestures,rotationLocked:t&W.RotationLocked})}deserializeFrom(t){void 0!==t.touchPanning&&this.overridePanZoomTool.setModeEnabled(W.OneFingerTouchGestures,t.touchPanning),void 0!==t.rotationLocked&&this.overridePanZoomTool.setModeEnabled(W.RotationLocked,t.rotationLocked),super.deserializeFrom(t)}}const nn="toolbar-";class rn{constructor(t,e,n=Le){this.editor=t,this.localizationTable=n,this.widgets={},this.updateColoris=null,this.container=document.createElement("div"),this.container.classList.add(`${nn}root`),this.container.setAttribute("role","toolbar"),e.appendChild(this.container),rn.colorisStarted||(Ie(),rn.colorisStarted=!0),this.setupColorPickers()}setupColorPickers(){if(this.updateColoris)return void this.updateColoris();const t=document.createElement("div");t.className=`${nn}closeColorPickerOverlay`,this.editor.createHTMLOverlay(t);const e=[St.red.toHexString(),St.purple.toHexString(),St.blue.toHexString(),St.clay.toHexString(),St.black.toHexString(),St.white.toHexString()],n=e.length,i=()=>{Re({el:".coloris_input",format:"hex",selectInput:!1,focusInput:!1,themeMode:"auto",swatches:e})};i(),this.updateColoris=i,this.editor.notifier.on(M.ColorPickerToggled,(e=>{e.kind===M.ColorPickerToggled&&(t.style.display=e.open?"block":"none")})),this.editor.notifier.on(M.ColorPickerColorSelected,(t=>{t.kind===M.ColorPickerColorSelected&&(t=>{let r=!1;for(const n of e)n===t&&(r=!0);r||(e.push(t),e.length>12&&e.splice(n,1),i())})(t.color.toHexString())}))}addWidget(t){const e=t.getUniqueIdIn(this.widgets);this.widgets[e]=t,t.addTo(this.container),this.setupColorPickers()}serializeState(){const t={};for(const e in this.widgets)t[e]=this.widgets[e].serializeState();return JSON.stringify(t)}deserializeState(t){const e=JSON.parse(t);for(const t in e)t in this.widgets||console.warn(`Unable to deserialize widget ${t} ­— no such widget.`),this.widgets[t].deserializeFrom(e[t])}addActionButton(t,e,n){const i=document.createElement("button");if(i.classList.add(`${nn}button`),"string"==typeof t)i.innerText=t;else{const e=t.icon.cloneNode(!0),n=document.createElement("label");e.setAttribute("alt",""),n.innerText=t.label,e.classList.add("toolbar-icon"),i.replaceChildren(e,n)}return i.onclick=e,(null!=n?n:this.container).appendChild(i),i}addUndoRedoButtons(){const t=document.createElement("div");t.classList.add(`${nn}buttonGroup`);const e=this.addActionButton({label:this.localizationTable.undo,icon:this.editor.icons.makeUndoIcon()},(()=>{this.editor.history.undo()}),t),n=this.addActionButton({label:this.localizationTable.redo,icon:this.editor.icons.makeRedoIcon()},(()=>{this.editor.history.redo()}),t);this.container.appendChild(t),e.disabled=!0,n.disabled=!0,this.editor.notifier.on(M.UndoRedoStackUpdated,(t=>{if(t.kind!==M.UndoRedoStackUpdated)throw new Error("Wrong event type!");e.disabled=0===t.undoStackSize,n.disabled=0===t.redoStackSize}))}addDefaultToolWidgets(){const t=this.editor.toolController;for(const e of t.getMatchingTools(Lt)){const t=new Ke(this.editor,e,this.localizationTable);this.addWidget(t)}for(const e of t.getMatchingTools(Ot))this.addWidget(new Ze(this.editor,e,this.localizationTable));for(const e of t.getMatchingTools(he))this.addWidget(new Ye(this.editor,e,this.localizationTable));for(const e of t.getMatchingTools(fe))this.addWidget(new Je(this.editor,e,this.localizationTable));const e=t.getMatchingTools(H)[0];e&&this.addWidget(new en(this.editor,e,this.localizationTable))}addDefaultActionButtons(){this.addUndoRedoButtons()}}rn.colorisStarted=!1;class on extends Kt{constructor(t,e){super(e),this.ctx=t,this.ignoreObjectsAboveLevel=null,this.ignoringObject=!1,this.clipLevels=[],this.setDraftMode(!1)}transformBy(t){this.ctx.transform(t.a1,t.b1,t.a2,t.b2,t.a3,t.b3)}canRenderFromWithoutDataLoss(t){return t instanceof on}renderFromOtherOfSameType(t,e){if(!(e instanceof on))throw new Error(`${e} cannot be rendered onto ${this}`);t=this.getCanvasToScreenTransform().rightMul(t),this.ctx.save(),this.transformBy(t),this.ctx.drawImage(e.ctx.canvas,0,0),this.ctx.restore()}setDraftMode(t){t?(this.minSquareCurveApproxDist=9,this.minRenderSizeBothDimens=2,this.minRenderSizeAnyDimen=.5):(this.minSquareCurveApproxDist=.5,this.minRenderSizeBothDimens=.3,this.minRenderSizeAnyDimen=1e-5)}displaySize(){return S.of(this.ctx.canvas.clientWidth,this.ctx.canvas.clientHeight)}clear(){this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)}beginPath(t){t=this.canvasToScreen(t),this.ctx.beginPath(),this.ctx.moveTo(t.x,t.y)}endPath(t){this.ctx.fillStyle=t.fill.toHexString(),this.ctx.fill(),t.stroke&&(this.ctx.strokeStyle=t.stroke.color.toHexString(),this.ctx.lineWidth=this.getSizeOfCanvasPixelOnScreen()*t.stroke.width,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.ctx.stroke()),this.ctx.closePath()}lineTo(t){t=this.canvasToScreen(t),this.ctx.lineTo(t.x,t.y)}moveTo(t){t=this.canvasToScreen(t),this.ctx.moveTo(t.x,t.y)}traceCubicBezierCurve(t,e,n){t=this.canvasToScreen(t),e=this.canvasToScreen(e),n=this.canvasToScreen(n);const i=e.minus(t),r=n.minus(e);i.magnitudeSquared()<this.minSquareCurveApproxDist&&r.magnitudeSquared()<this.minSquareCurveApproxDist?this.ctx.lineTo(n.x,n.y):this.ctx.bezierCurveTo(t.x,t.y,e.x,e.y,n.x,n.y)}traceQuadraticBezierCurve(t,e){t=this.canvasToScreen(t),e=this.canvasToScreen(e),t.minus(e).magnitudeSquared()<this.minSquareCurveApproxDist?this.ctx.lineTo(e.x,e.y):this.ctx.quadraticCurveTo(t.x,t.y,e.x,e.y)}drawPath(t){this.ignoringObject||super.drawPath(t)}drawText(t,e,n){this.ctx.save(),e=this.getCanvasToScreenTransform().rightMul(e),this.transformBy(e),Ut.applyTextStyles(this.ctx,n),0!==n.renderingStyle.fill.a&&(this.ctx.fillStyle=n.renderingStyle.fill.toHexString(),this.ctx.fillText(t,0,0)),n.renderingStyle.stroke&&(this.ctx.strokeStyle=n.renderingStyle.stroke.color.toHexString(),this.ctx.lineWidth=n.renderingStyle.stroke.width,this.ctx.strokeText(t,0,0)),this.ctx.restore()}drawImage(t){this.ctx.save();const e=this.getCanvasToScreenTransform().rightMul(t.transform);this.transformBy(e),this.ctx.drawImage(t.image,0,0),this.ctx.restore()}startObject(t,e){if(this.isTooSmallToRender(t)&&(this.ignoreObjectsAboveLevel=this.getNestingLevel(),this.ignoringObject=!0),super.startObject(t),!this.ignoringObject&&e){this.clipLevels.push(this.objectLevel),this.ctx.save(),this.ctx.beginPath();for(const e of t.corners){const t=this.canvasToScreen(e);this.ctx.lineTo(t.x,t.y)}this.ctx.clip()}}endObject(){!this.ignoringObject&&this.clipLevels.length>0&&this.clipLevels[this.clipLevels.length-1]===this.objectLevel&&(this.ctx.restore(),this.clipLevels.pop()),super.endObject(),null!==this.ignoreObjectsAboveLevel&&this.getNestingLevel()<=this.ignoreObjectsAboveLevel&&(this.ignoreObjectsAboveLevel=null,this.ignoringObject=!1)}drawPoints(...t){for(let e=0;e<t.length;e++){const n=this.canvasToScreen(t[e]);this.ctx.beginPath(),this.ctx.arc(n.x,n.y,10,0,2*Math.PI),this.ctx.fillStyle=St.ofRGBA(.5+Math.sin(e)/2,1,.5+Math.cos(.2*e)/4,.5).toHexString(),this.ctx.fill(),this.ctx.stroke(),this.ctx.closePath(),this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillStyle="black",this.ctx.fillText(`${e}`,n.x,n.y,20)}}isTooSmallToRender(t){const e=this.getCanvasToScreenTransform().transformVec3(t.size),n=this.minRenderSizeBothDimens,i=Math.abs(e.x)<n&&Math.abs(e.y)<n,r=this.minRenderSizeAnyDimen,o=Math.abs(e.x)<r||Math.abs(e.y)<r;return i||o}}class sn extends Kt{constructor(t){super(t),this.clearedCount=0,this.renderedPathCount=0,this.lastFillStyle=null,this.lastPoint=null,this.objectNestingLevel=0,this.lastText=null,this.lastImage=null,this.pointBuffer=[]}displaySize(){const t=this.getViewport().getResolution();return 0===t.x||0===t.y?S.of(640,480):t}clear(){if(this.clearedCount++,this.renderedPathCount=0,this.pointBuffer=[],this.lastText=null,this.lastImage=null,this.objectNestingLevel>0)throw new Error(`Within an object while clearing! Nesting level: ${this.objectNestingLevel}`)}beginPath(t){this.lastPoint=t,this.pointBuffer.push(t)}endPath(t){this.renderedPathCount++,this.lastFillStyle=t}lineTo(t){t=this.canvasToScreen(t),this.lastPoint=t,this.pointBuffer.push(t)}moveTo(t){t=this.canvasToScreen(t),this.lastPoint=t,this.pointBuffer.push(t)}traceCubicBezierCurve(t,e,n){t=this.canvasToScreen(t),e=this.canvasToScreen(e),n=this.canvasToScreen(n),this.lastPoint=n,this.pointBuffer.push(t,e,n)}traceQuadraticBezierCurve(t,e){t=this.canvasToScreen(t),e=this.canvasToScreen(e),this.lastPoint=e,this.pointBuffer.push(t,e)}drawPoints(...t){}drawText(t,e,n){this.lastText=t}drawImage(t){this.lastImage=t}startObject(t,e){super.startObject(t),this.objectNestingLevel+=1}endObject(){super.endObject(),this.objectNestingLevel-=1}isTooSmallToRender(t){return!1}canRenderFromWithoutDataLoss(t){return t instanceof sn}renderFromOtherOfSameType(t,e){if(!(e instanceof sn))throw new Error(`${e} cannot be rendered onto ${this}`);this.renderedPathCount+=e.renderedPathCount,this.lastFillStyle=e.lastFillStyle,this.lastPoint=e.lastPoint,this.pointBuffer.push(...e.pointBuffer.map((e=>t.transformVec2(e))))}}class an{constructor(t,e){this.region=t,this.cacheState=e,this.instantiatedChildren=[],this.parent=null,this.cachedRenderer=null,this.renderedIds=[],this.renderedMaxZIndex=null}generateParent(){if(this.parent)return this.parent;const t=B.fromCorners(this.region.topLeft.minus(this.region.size),this.region.bottomRight.plus(this.region.size)),e=new an(t,this.cacheState);e.generateChildren();const n=this.region.maxDimension/100,i=(e.instantiatedChildren.length-1)/2;if(!e.instantiatedChildren[i].region.eq(this.region,n))throw console.error(e.instantiatedChildren[i].region,"≠",this.region),new Error("Logic error: [this] is not contained within its parent's center child");return e.instantiatedChildren[i]=this,this.parent=e,e}generateChildren(){if(0===this.instantiatedChildren.length){const t=this.region.divideIntoGrid(3,3);if(0===this.region.size.x||0===this.region.size.y)return void console.warn("Cache element has zero size! Not generating children.");for(const e of t){const t=new an(e,this.cacheState);t.parent=this,this.instantiatedChildren.push(t)}}this.checkRep()}getChildren(){return this.checkRep(),this.generateChildren(),this.instantiatedChildren}smallestChildContaining(t){var e;const n=t.maxDimension>this.region.maxDimension/3;if(!this.region.containsRect(t)||n)return null;for(const n of this.getChildren())if(n.region.containsRect(t))return null!==(e=n.smallestChildContaining(t))&&void 0!==e?e:n;return null}renderingWouldBeHighEnoughResolution(t){const e=this.region.w/this.cacheState.props.blockResolution.x;return!(t.getScaleFactor()*e>this.cacheState.props.maxScale)}allChildrenCanRender(t,e){if(0===this.instantiatedChildren.length)return!1;for(const n of this.instantiatedChildren)if(n.region.intersects(t.visibleRect)&&!n.renderingIsUpToDate(this.idsOfIntersecting(e)))return!1;return!0}computeSortedByLeafIds(t){const e=t.slice();return e.sort(((t,e)=>t.getId()-e.getId())),e}idsOfIntersecting(t){const e=[];for(const n of t)n.getBBox().intersects(this.region)&&e.push(n.getId());return e}allRenderedIdsIn(t){if(this.renderedIds.length>t.length)return!1;for(let e=0;e<this.renderedIds.length;e++)if(t[e]!==this.renderedIds[e])return!1;return!0}renderingIsUpToDate(t){return null!==this.cachedRenderer&&t.length===this.renderedIds.length&&this.allRenderedIdsIn(t)}renderItems(t,e,n){var i,r;if(!n.visibleRect.intersects(this.region)||0===e.length)return;const o=[];for(const t of e){const e=t.getBBox();e.intersects(this.region)&&(e.maxDimension>=this.region.maxDimension?o.push(...t.getChildrenOrSelfIntersectingRegion(this.region)):o.push(t))}if(e=o,this.cacheState.props.isOfCorrectType(t)){if(this.renderingWouldBeHighEnoughResolution(n)){const o=t=>t.w/this.region.w<1/this.cacheState.props.blockResolution.x,s=[];for(const t of e)s.push(...t.getLeavesIntersectingRegion(this.region,o));R(s);const a=this.computeSortedByLeafIds(s);if(0===a.length)return;const l=a.map((t=>t.getId()));let c;if(this.renderingIsUpToDate(l))c=this.cachedRenderer.startRender();else{if(this.allChildrenCanRender(n,a)){for(const i of this.getChildren())i.renderItems(t,e,n);return}if(a.length>this.cacheState.props.minComponentsPerCache){let t=!0;if(this.cachedRenderer){if(a.length>this.renderedIds.length&&this.allRenderedIdsIn(l)&&null!==this.renderedMaxZIndex){const e=[];let n=null;for(let t=0;t<a.length;t++){const i=a[t],r=i.getContent().getZIndex();(t>=this.renderedIds.length||i.getId()!==this.renderedIds[t])&&(e.push(i),(null===n||r<n)&&(n=r))}if(null!==n&&n>this.renderedMaxZIndex){t=!1,c=this.cachedRenderer.startRender();for(let t=0;t<s.length;t++){const e=s[t],n=e.getContent().getZIndex();n>this.renderedMaxZIndex&&(e.render(c,this.region),this.renderedMaxZIndex=n)}}}}else this.cachedRenderer=this.cacheState.recordManager.allocCanvas(this.region,(()=>this.onRegionDealloc()));if(t){c=this.cachedRenderer.startRender(),c.clear(),this.renderedMaxZIndex=null;for(const t of s){const e=t.getContent();null!==(i=this.renderedMaxZIndex)&&void 0!==i||(this.renderedMaxZIndex=e.getZIndex()),this.renderedMaxZIndex=Math.max(this.renderedMaxZIndex,e.getZIndex()),t.render(c,this.region)}}this.renderedIds=l}else{null===(r=this.cachedRenderer)||void 0===r||r.dealloc();const e=n.getSizeOfPixelOnCanvas(),i=new B(this.region.x,this.region.y,this.region.w+e,this.region.h+e),o=!0;t.startObject(i,o);for(const e of s)e.render(t,this.region.intersection(n.visibleRect));t.endObject()}}if(c){const e=this.cachedRenderer.getTransform(this.region).inverse();t.renderFromOtherOfSameType(e,c)}this.instantiatedChildren.every((t=>t.isEmpty()))&&(this.instantiatedChildren=[])}else for(const i of this.getChildren())i.renderItems(t,e.filter((t=>t.getBBox().intersects(i.region))),n);this.checkRep()}else e.forEach((e=>e.render(t,n.visibleRect)))}isEmpty(){return null===this.cachedRenderer&&this.instantiatedChildren.every((t=>t.isEmpty()))}onRegionDealloc(){this.cachedRenderer=null,this.isEmpty()&&(this.instantiatedChildren=[])}checkRep(){if(9!==this.instantiatedChildren.length&&0!==this.instantiatedChildren.length)throw new Error(`Repcheck: Wrong number of children. Got ${this.instantiatedChildren.length}`);if(void 0!==this.renderedIds[1]&&this.renderedIds[0]>=this.renderedIds[1])throw console.error(this.renderedIds),new Error("Repcheck: First two ids are not in ascending order!");for(const t of this.instantiatedChildren)if(t.parent!==this)throw new Error("Children should be linked to their parents!");if(this.cachedRenderer&&!this.cachedRenderer.isAllocd())throw new Error("this' cachedRenderer != null, but is dealloc'd")}}class ln{constructor(t,e){this.onBeforeDeallocCallback=t,this.cacheState=e,this.allocd=!1,this.allocCount=0,this.renderer=e.props.createRenderer(),this.lastUsedCycle=-1,this.allocd=!0}startRender(){if(this.lastUsedCycle=this.cacheState.currentRenderingCycle,!this.allocd)throw new Error("Only alloc'd canvases can be rendered to");return this.renderer}dealloc(){var t;null===(t=this.onBeforeDeallocCallback)||void 0===t||t.call(this),this.allocd=!1,this.onBeforeDeallocCallback=null,this.lastUsedCycle=0}isAllocd(){return this.allocd}realloc(t){this.allocd&&this.dealloc(),this.allocd=!0,this.onBeforeDeallocCallback=t,this.lastUsedCycle=this.cacheState.currentRenderingCycle,this.allocCount++}getLastUsedCycle(){return this.lastUsedCycle}getTransform(t){return P.scaling2D(this.cacheState.props.blockResolution.x/t.size.x).rightMul(P.translation(t.topLeft.times(-1)))}setRenderingRegion(t){this.renderer.setTransform(this.getTransform(t))}}class cn{constructor(t){this.cacheRecords=[],this.maxCanvases=Math.ceil(t.cacheSize/4/t.blockResolution.x/t.blockResolution.y)}setSharedState(t){this.cacheState=t}allocCanvas(t,e){if(this.cacheRecords.length<this.maxCanvases){const n=new ln(e,this.cacheState);return n.setRenderingRegion(t),this.cacheRecords.push(n),n}{const n=this.getLeastRecentlyUsedRecord();return n.realloc(e),n.setRenderingRegion(t),n}}getLeastRecentlyUsedRecord(){return this.cacheRecords.sort(((t,e)=>t.getLastUsedCycle()-e.getLastUsedCycle())),this.cacheRecords[0]}}class hn{constructor(t){this.recordManager=new cn(t),this.sharedState={props:t,currentRenderingCycle:0,recordManager:this.recordManager},this.recordManager.setSharedState(this.sharedState)}render(t,e,n){var i;const r=n.visibleRect;if(this.sharedState.currentRenderingCycle++,this.sharedState.props.isOfCorrectType(t)){if(!this.rootNode){const t=this.sharedState.props.blockResolution,e=r.topLeft;this.rootNode=new an(new B(e.x,e.y,t.x,t.y),this.sharedState)}for(;!this.rootNode.region.containsRect(r);)this.rootNode=this.rootNode.generateParent();this.rootNode=null!==(i=this.rootNode.smallestChildContaining(r))&&void 0!==i?i:this.rootNode,e.getLeavesIntersectingRegion(n.visibleRect,(e=>t.isTooSmallToRender(e))).length>this.sharedState.props.minComponentsToUseCache?this.rootNode.renderItems(t,[e],n):e.render(t,r)}else e.render(t,r)}}class dn extends Kt{constructor(t,e){super(t),this.localizationTable=e,this.descriptionBuilder=[],this.pathCount=0,this.textNodeCount=0,this.imageNodeCount=0}displaySize(){return S.of(500,500)}clear(){this.descriptionBuilder=[],this.pathCount=0,this.textNodeCount=0}getDescription(){return[this.localizationTable.pathNodeCount(this.pathCount),...this.textNodeCount>0?[this.localizationTable.textNodeCount(this.textNodeCount)]:[],...this.imageNodeCount>0?[this.localizationTable.imageNodeCount(this.imageNodeCount)]:[],...this.descriptionBuilder].join("\n")}beginPath(t){}endPath(t){this.pathCount++}lineTo(t){}moveTo(t){}traceCubicBezierCurve(t,e,n){}traceQuadraticBezierCurve(t,e){}drawText(t,e,n){this.descriptionBuilder.push(this.localizationTable.textNode(t)),this.textNodeCount++}drawImage(t){const e=t.label?this.localizationTable.imageNode(t.label):this.localizationTable.unlabeledImageNode;this.descriptionBuilder.push(e),this.imageNodeCount++}isTooSmallToRender(t){return t.maxDimension<15/this.getSizeOfCanvasPixelOnScreen()}drawPoints(...t){}}var un;!function(t){t[t.DummyRenderer=0]="DummyRenderer",t[t.CanvasRenderer=1]="CanvasRenderer"}(un||(un={}));class pn{constructor(t,e,n){if(this.editor=t,this.parent=n,this.textRerenderOutput=null,this.getColorAt=t=>null,e===un.CanvasRenderer)this.initializeCanvasRendering();else{if(e!==un.DummyRenderer)throw new Error(`Unknown rendering mode, ${e}!`);this.dryInkRenderer=new sn(t.viewport),this.wetInkRenderer=new sn(t.viewport)}this.textRenderer=new dn(t.viewport,t.localization),this.initializeTextRendering();const i=S.of(600,600);this.cache=new hn({createRenderer:()=>{if(e===un.DummyRenderer)return new sn(t.viewport);if(e!==un.CanvasRenderer)throw new Error("Unspported rendering mode");const n=document.createElement("canvas");n.width=i.x+1,n.height=i.y+1;const r=n.getContext("2d");return new on(r,t.viewport)},isOfCorrectType:t=>this.dryInkRenderer.canRenderFromWithoutDataLoss(t),blockResolution:i,cacheSize:1296e5,maxScale:1.4,minComponentsPerCache:20,minComponentsToUseCache:105}),this.editor.notifier.on(M.DisplayResized,(t=>{var e;if(t.kind!==M.DisplayResized)throw new Error("Mismatched event.kinds!");null===(e=this.resizeSurfacesCallback)||void 0===e||e.call(this)}))}get width(){return this.dryInkRenderer.displaySize().x}get height(){return this.dryInkRenderer.displaySize().y}getCache(){return this.cache}initializeCanvasRendering(){const t=document.createElement("canvas"),e=document.createElement("canvas"),n=t.getContext("2d"),i=e.getContext("2d");this.dryInkRenderer=new on(n,this.editor.viewport),this.wetInkRenderer=new on(i,this.editor.viewport),t.className="dryInkCanvas",e.className="wetInkCanvas",this.parent&&(this.parent.appendChild(t),this.parent.appendChild(e)),this.resizeSurfacesCallback=()=>{const n=t=>t.clientHeight!==t.height||t.clientWidth!==t.width;(n(t)||n(e))&&(t.width=t.clientWidth,t.height=t.clientHeight,e.width=e.clientWidth,e.height=e.clientHeight,this.editor.notifier.dispatch(M.DisplayResized,{kind:M.DisplayResized,newSize:S.of(this.width,this.height)}))},this.resizeSurfacesCallback(),this.flattenCallback=()=>{n.drawImage(e,0,0)},this.getColorAt=t=>{const e=n.getImageData(t.x,t.y,1,1),i=null==e?void 0:e.data;return i?St.ofRGBA(i[0]/255,i[1]/255,i[2]/255,i[3]/255):null}}initializeTextRendering(){const t=document.createElement("div");t.classList.add("textRendererOutputContainer");const e=document.createElement("button");e.classList.add("rerenderButton"),e.innerText=this.editor.localization.rerenderAsText,this.textRerenderOutput=document.createElement("div"),this.textRerenderOutput.setAttribute("aria-live","polite"),e.onclick=()=>{this.rerenderAsText()},t.replaceChildren(e,this.textRerenderOutput),this.editor.createHTMLOverlay(t)}rerenderAsText(){this.textRenderer.clear(),this.editor.image.render(this.textRenderer,this.editor.viewport),this.textRerenderOutput&&(this.textRerenderOutput.innerText=this.textRenderer.getDescription())}startRerender(){var t;return null===(t=this.resizeSurfacesCallback)||void 0===t||t.call(this),this.wetInkRenderer.clear(),this.dryInkRenderer.clear(),this.dryInkRenderer}setDraftMode(t){this.dryInkRenderer.setDraftMode(t)}getDryInkRenderer(){return this.dryInkRenderer}getWetInkRenderer(){return this.wetInkRenderer}flatten(){var t;null===(t=this.flattenCallback)||void 0===t||t.call(this)}}const mn={updatedViewport:"Transformed Viewport",transformedElements:t=>`Transformed ${t} element${1===t?"":"s"}`,resizeOutputCommand:t=>`Resized image to ${t.w}x${t.h}`,addElementAction:t=>`Added ${t}`,eraseAction:(t,e)=>`Erased ${e} ${t}`,duplicateAction:(t,e)=>`Duplicated ${e} ${t}`,unionOf:(t,e)=>`Union: ${e} ${t}`,inverseOf:t=>`Inverse of ${t}`,elements:"Elements",erasedNoElements:"Erased nothing",duplicatedNoElements:"Duplicated nothing",rotatedBy:t=>`Rotated by ${Math.abs(t)} degrees ${t<0?"clockwise":"counter-clockwise"}`,movedLeft:"Moved left",movedUp:"Moved up",movedDown:"Moved down",movedRight:"Moved right",zoomedOut:"Zoomed out",zoomedIn:"Zoomed in",selectedElements:t=>`Selected ${t} element${1===t?"":"s"}`},gn=Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},Le),{penTool:t=>`Pen ${t}`,selectionTool:"Selection",eraserTool:"Eraser",touchPanTool:"Touch panning",twoFingerPanZoomTool:"Panning and zooming",undoRedoTool:"Undo/Redo",rightClickDragPanTool:"Right-click drag",pipetteTool:"Pick color from screen",keyboardPanZoom:"Keyboard pan/zoom shortcuts",textTool:"Text",enterTextToInsert:"Text to insert",changeTool:"Change tool",pasteHandler:"Copy paste handler",findLabel:"Find",toNextMatch:"Next",closeFindDialog:"Close",findDialogShown:"Find dialog shown",findDialogHidden:"Find dialog hidden",focusedFoundText:(t,e)=>`Viewing match ${t} of ${e}`,anyDevicePanning:"Any device panning",copied:(t,e)=>`Copied ${t} ${e}`,pasted:(t,e)=>`Pasted ${t} ${e}`,toolEnabledAnnouncement:t=>`${t} enabled`,toolDisabledAnnouncement:t=>`${t} disabled`}),mn),{unlabeledImageNode:"Unlabeled image node",stroke:"Stroke",svgObject:"SVG Object",text:t=>`Text object: ${t}`,imageNode:t=>`Image: ${t}`}),{pathNodeCount:t=>`There are ${t} visible path objects.`,textNodeCount:t=>`There are ${t} visible text nodes.`,imageNodeCount:t=>`There are ${t} visible image nodes.`,textNode:t=>`Text: ${t}`,imageNode:t=>`Image: ${t}`,unlabeledImageNode:"Unlabeled image",rerenderAsText:"Re-render as text"}),{accessibilityInputInstructions:['Press "t" to read the contents of the viewport as text.',"Use the arrow keys to move the viewport, click and drag to draw strokes.",'Press "w" to zoom in and "s" to zoom out.'].join(" "),loading:t=>`Loading ${t}%...`,imageEditor:"Image Editor",doneLoading:"Done loading",undoAnnouncement:t=>`Undid ${t}`,redoAnnouncement:t=>`Redid ${t}`}),fn={de:Object.assign(Object.assign({},gn),{pen:"Stift",eraser:"Radierer",select:"Auswahl",handTool:"Verschieben",zoom:"Vergrößerung",resetView:"Ansicht zurücksetzen",thicknessLabel:"Dicke: ",colorLabel:"Farbe: ",fontLabel:"Schriftart: ",resizeImageToSelection:"Bildgröße an Auswahl anpassen",deleteSelection:"Auswahl löschen",duplicateSelection:"Auswahl duplizieren",undo:"Rückgängig",redo:"Wiederholen",pickColorFromScreen:"Farbe von Bildschirm auswählen",clickToPickColorAnnouncement:"Klicke auf den Bildschirm, um eine Farbe auszuwählen",selectionToolKeyboardShortcuts:"Auswahl-Werkzeug: Verwende die Pfeiltasten, um ausgewählte Elemente zu verschieben und ‚i‘ und ‚o‘, um ihre Größe zu ändern.",touchPanning:"Ansicht mit Touchscreen verschieben",anyDevicePanning:"Ansicht mit jedem Eingabegerät verschieben",selectObjectType:"Objekt-Typ: ",freehandPen:"Freihand",arrowPen:"Pfeil",linePen:"Linie",outlinedRectanglePen:"Umrissenes Rechteck",filledRectanglePen:"Ausgefülltes Rechteck",dropdownShown:t=>`Dropdown-Menü für ${t} angezeigt`,dropdownHidden:t=>`Dropdown-Menü für ${t} versteckt`,zoomLevel:t=>`Vergößerung: ${t}%`,colorChangedAnnouncement:t=>`Farbe zu ${t} geändert`,penTool:t=>`Stift ${t}`,selectionTool:"Auswahl",eraserTool:"Radiergummi",touchPanTool:"Ansicht mit Touchscreen verschieben",twoFingerPanZoomTool:"Ansicht verschieben und vergrößern",undoRedoTool:"Rückgängig/Wiederholen",rightClickDragPanTool:"Rechtsklick-Ziehen",pipetteTool:"Farbe von Bildschirm auswählen",keyboardPanZoom:"Tastaturkürzel zum Verschieben/Vergrößern der Ansicht",textTool:"Text",enterTextToInsert:"Einzufügender Text",toolEnabledAnnouncement:t=>`${t} aktiviert`,toolDisabledAnnouncement:t=>`${t} deaktiviert`,updatedViewport:"Transformierte Ansicht",transformedElements:t=>`${t} Element${1===t?"":"e"} transformiert`,resizeOutputCommand:t=>`Bildgröße auf ${t.w}x${t.h} geändert`,addElementAction:t=>`${t} hinzugefügt`,eraseAction:(t,e)=>`${e} ${t} gelöscht`,duplicateAction:(t,e)=>`${e} ${t} dupliziert`,inverseOf:t=>`Umkehrung von ${t}`,elements:"Elemente",erasedNoElements:"Nichts entfernt",duplicatedNoElements:"Nichts dupliziert",rotatedBy:t=>`${Math.abs(t)} Grad ${t<0?"im Uhrzeigersinn":"gegen den Uhrzeigersinn"} gedreht`,movedLeft:"Nacht links bewegt",movedUp:"Nacht oben bewegt",movedDown:"Nacht unten bewegt",movedRight:"Nacht rechts bewegt",zoomedOut:"Ansicht verkleinert",zoomedIn:"Ansicht vergrößert",selectedElements:t=>`${t} Element${1===t?"":"e"} ausgewählt`,stroke:"Strich",svgObject:"SVG-Objekt",text:t=>`Text-Objekt: ${t}`,pathNodeCount:t=>`Es gibt ${t} sichtbare Pfad-Objekte.`,textNodeCount:t=>`Es gibt ${t} sichtbare Text-Knotenpunkte.`,textNode:t=>`Text: ${t}`,rerenderAsText:"Als Text darstellen",accessibilityInputInstructions:"Drücke ‚t‘, um den Inhalt des Ansichtsfensters als Text zu lesen. Verwende die Pfeiltasten, um die Ansicht zu verschieben, und klicke und ziehe, um Striche zu zeichnen. Drücke ‚w‘ zum Vergrößern und ‚s‘ zum Verkleinern der Ansicht.",loading:t=>`Laden ${t}%...`,doneLoading:"Laden fertig",imageEditor:"Bild-Editor",undoAnnouncement:t=>`Rückgangig gemacht ${t}`,redoAnnouncement:t=>`Wiederholt ${t}`}),en:Object.assign({},gn),es:Object.assign(Object.assign({},gn),{loading:t=>`Cargando: ${t}%...`,imageEditor:"Editor de dibujos",undoAnnouncement:t=>`${t} fue deshecho`,redoAnnouncement:t=>`${t} fue rehecho`,undo:"Deshace",redo:"Rehace",pen:"Lapiz",eraser:"Borrador",select:"Selecciona",thicknessLabel:"Tamaño: ",colorLabel:"Color: ",doneLoading:"El cargado terminó",fontLabel:"Fuente: ",anyDevicePanning:"Mover la pantalla con todo dispotivo",touchPanning:"Mover la pantalla con un dedo",touchPanTool:"Instrumento de mover la pantalla con un dedo",outlinedRectanglePen:"Rectángulo con nada más que un borde",filledRectanglePen:"Rectángulo sin borde",linePen:"Línea",arrowPen:"Flecha",freehandPen:"Dibuja sin restricción de forma",selectObjectType:"Forma de dibuja:",handTool:"Mover",zoom:"Zoom",resetView:"Reiniciar vista",resizeImageToSelection:"Redimensionar la imagen a lo que está seleccionado",deleteSelection:"Borra la selección",duplicateSelection:"Duplica la selección",pickColorFromScreen:"Selecciona un color de la pantalla",clickToPickColorAnnouncement:"Haga un clic en la pantalla para seleccionar un color",dropdownShown:t=>`Menú por ${t} es visible`,dropdownHidden:function(t){return`Menú por ${t} fue ocultado`},colorChangedAnnouncement:function(t){return`Color fue cambiado a ${t}`},keyboardPanZoom:"Mover la pantalla con el teclado",penTool:function(t){return`Lapiz ${t}`},selectionTool:"Selecciona",eraserTool:"Borrador",textTool:"Texto",enterTextToInsert:"Entra texto",rerenderAsText:"Redibuja la pantalla al texto"})},vn=t=>{const e=/^(\w+)[_-](\w+)$/.exec(t);return e?e[1]:t},yn=t=>{let e;null!=t||(t=navigator.languages);for(const n of t){const t=vn(n);if(e&&t!==e&&e in fn)return fn[e];if(n in fn)return fn[n];e=t}return e&&e in fn?fn[e]:gn},xn="http://www.w3.org/2000/svg",bn="\n\tstyle='fill: var(--icon-color);'\n",wn="\n\t<pattern\n\t\tid='checkerboard'\n\t\tviewBox='0,0,10,10'\n\t\twidth='20%'\n\t\theight='20%'\n\t\tpatternUnits='userSpaceOnUse'\n\t>\n\t\t<rect x=0 y=0 width=10 height=10 fill='white'/>\n\t\t<rect x=0 y=0 width=5 height=5 fill='gray'/>\n\t\t<rect x=5 y=5 width=5 height=5 fill='gray'/>\n\t</pattern>\n";class Tn{makeUndoIcon(){return this.makeRedoIcon(!0)}makeRedoIcon(t=!1){const e=document.createElementNS(xn,"svg");return e.innerHTML=`\n\t\t\t<style>\n\t\t\t\t.toolbar-svg-undo-redo-icon {\n\t\t\t\t\tstroke: var(--icon-color);\n\t\t\t\t\tstroke-width: 12;\n\t\t\t\t\tstroke-linejoin: round;\n\t\t\t\t\tstroke-linecap: round;\n\t\t\t\t\tfill: none;\n\t\n\t\t\t\t\ttransform-origin: center;\n\t\t\t\t}\n\t\t\t</style>\n\t\t\t<path\n\t\t\t\td='M20,20 A15,15 0 0 1 70,80 L80,90 L60,70 L65,90 L87,90 L65,80'\n\t\t\t\tclass='toolbar-svg-undo-redo-icon'\n\t\t\t\tstyle='${t?"transform: scale(-1, 1);":""}'/>\n\t\t`,e.setAttribute("viewBox","0 0 100 100"),e}makeDropdownIcon(){const t=document.createElementNS(xn,"svg");return t.innerHTML=`\n\t\t<g>\n\t\t\t<path\n\t\t\t\td='M5,10 L50,90 L95,10 Z'\n\t\t\t\t${bn}\n\t\t\t/>\n\t\t</g>\n\t\t`,t.setAttribute("viewBox","0 0 100 100"),t}makeEraserIcon(){const t=document.createElementNS(xn,"svg");return t.innerHTML=`\n\t\t<g>\n\t\t\t<rect x=10 y=50 width=80 height=30 rx=10 fill='pink' />\n\t\t\t<rect\n\t\t\t\tx=10 y=10 width=80 height=50\n\t\t\t\t${bn}\n\t\t\t/>\n\t\t</g>\n\t\t`,t.setAttribute("viewBox","0 0 100 100"),t}makeSelectionIcon(){const t=document.createElementNS(xn,"svg");return t.innerHTML="\n\t\t<g>\n\t\t\t<rect x=10 y=10 width=70 height=70 fill='pink' stroke='black'/>\n\t\t\t<rect x=75 y=75 width=10 height=10 fill='white' stroke='black'/>\n\t\t</g>\n\t\t",t.setAttribute("viewBox","0 0 100 100"),t}makeIconFromPath(t,e="var(--icon-color)",n="none",i="0px"){const r=document.createElementNS(xn,"svg"),o=document.createElementNS(xn,"path");return o.setAttribute("d",t),o.style.fill=e,o.style.stroke=n,o.style.strokeWidth=i,r.appendChild(o),r.setAttribute("viewBox","0 0 100 100"),r}makeHandToolIcon(){return this.makeIconFromPath("\n\t\t\tm 10,60\n\t\t\t\t5,30\n\t\t\tH 90\n\t\t\tV 30\n\t\t\tC 90,20 75,20 75,30\n\t\t\tV 60\n\t\t\t\t20\n\t\t\tC 75,10 60,10 60,20\n\t\t\tV 60\n\t\t\t\t15\n\t\t\tC 60,5 45,5 45,15\n\t\t\tV 60\n\t\t\t\t25\n\t\t\tC 45,15 30,15 30,25\n\t\t\tV 60\n\t\t\t\t75\n\t\t\tL 25,60\n\t\t\tC 20,45 10,50 10,60\n\t\t\tZ\n\t\t","none","var(--icon-color)","3")}makeTouchPanningIcon(){return this.makeIconFromPath("\n\t\t\tM 5,5.5\n\t\t\tV 17.2\n\t\t\tL 16.25,5.46\n\t\t\tZ\n\t\n\t\t\tm 33.75,0\n\t\t\tL 50,17\n\t\t\tV 5.5\n\t\t\tZ\n\t\n\t\t\tM 5,40.7\n\t\t\tv 11.7\n\t\t\th 11.25\n\t\t\tz\n\t\n\t\t\tM 26,19\n\t\t\tC 19.8,19.4 17.65,30.4 21.9,34.8\n\t\t\tL 50,70\n\t\t\tH 27.5\n\t\t\tc -11.25,0 -11.25,17.6 0,17.6\n\t\t\tH 61.25\n\t\t\tC 94.9,87.8 95,87.6 95,40.7 78.125,23 67,29 55.6,46.5\n\t\t\tL 33.1,23\n\t\t\tC 30.3125,20.128192 27.9,19 25.830078,19.119756\n\t\t\tZ\n\t\t","none","var(--icon-color)","3")}makeAllDevicePanningIcon(){return this.makeIconFromPath("\n\t\t\tM 5 5\n\t\t\tL 5 17.5\n\t\t\t\t17.5 5\n\t\t\t\t5 5\n\t\t\tz\n\t\n\t\t\tM 42.5 5\n\t\t\tL 55 17.5\n\t\t\t\t55 5\n\t\t\t\t42.5 5\n\t\t\tz\n\t\n\t\t\tM 70 10\n\t\t\tL 70 21\n\t\t\t\t61 15\n\t\t\t\t55.5 23\n\t\t\t\t66 30\n\t\t\t\t56 37\n\t\t\t\t61 45\n\t\t\t\t70 39\n\t\t\t\t70 50\n\t\t\t\t80 50\n\t\t\t\t80 39\n\t\t\t\t89 45\n\t\t\t\t95 36\n\t\t\t\t84 30\n\t\t\t\t95 23\n\t\t\t\t89 15\n\t\t\t\t80 21\n\t\t\t\t80 10\n\t\t\t\t70 10\n\t\t\tz\n\t\n\t\t\tM 27.5 26.25\n\t\t\tL 27.5 91.25\n\t\t\tL 43.75 83.125\n\t\t\tL 52 99\n\t\t\tL 68 91\n\t\t\tL 60 75\n\t\t\tL 76.25 66.875\n\t\t\tL 27.5 26.25\n\t\t\tz\n\t\n\t\t\tM 5 42.5\n\t\t\tL 5 55\n\t\t\tL 17.5 55\n\t\t\tL 5 42.5\n\t\t\tz\n\t\t","none","var(--icon-color)","3")}makeZoomIcon(){const t=document.createElementNS(xn,"svg");t.setAttribute("viewBox","0 0 100 100");const e=(e,n,i)=>{const r=document.createElementNS(xn,"text");r.appendChild(document.createTextNode(e)),r.setAttribute("x",n.toString()),r.setAttribute("y",i.toString()),r.style.textAlign="center",r.style.textAnchor="middle",r.style.fontSize="55px",r.style.fill="var(--icon-color)",r.style.fontFamily="monospace",t.appendChild(r)};return e("+",40,45),e("-",70,75),t}makeRotationLockIcon(){const t=this.makeIconFromPath("\n\t\t\tM 40.1 25.1 \n\t\t\tC 32.5 25 27.9 34.1 27.9 34.1 \n\t\t\tL 25.7 30 \n\t\t\tL 28 44.7 \n\t\t\tL 36.6 40.3 \n\t\t\tL 32.3 38.3 \n\t\t\tC 33.6 28 38.1 25.2 45.1 31.8 \n\t\t\tL 49.4 29.6 \n\t\t\tC 45.9 26.3 42.8 25.1 40.1 25.1 \n\t\t\tz\n\n\t\t\tM 51.7 34.2 \n\t\t\tL 43.5 39.1 \n\t\t\tL 48 40.8 \n\t\t\tC 47.4 51.1 43.1 54.3 35.7 48.2 \n\t\t\tL 31.6 50.7 \n\t\t\tC 45.5 62.1 52.6 44.6 52.6 44.6 \n\t\t\tL 55.1 48.6 \n\t\t\tL 51.7 34.2 \n\t\t\tz\n\n\t\t\tM 56.9 49.9 \n\t\t\tC 49.8 49.9 49.2 57.3 49.3 60.9 \n\t\t\tL 47.6 60.9 \n\t\t\tL 47.6 73.7 \n\t\t\tL 66.1 73.7 \n\t\t\tL 66.1 60.9 \n\t\t\tL 64.4 60.9 \n\t\t\tC 64.5 57.3 63.9 49.9 56.9 49.9 \n\t\t\tz\n\n\t\t\tM 56.9 53.5 \n\t\t\tC 60.8 53.5 61 58.2 60.8 60.9 \n\t\t\tL 52.9 60.9 \n\t\t\tC 52.7 58.2 52.9 53.5 56.9 53.5 \n\t\t\tz\n\t\t");return t.setAttribute("viewBox","10 10 70 70"),t}makeTextIcon(t){var e,n;const i=document.createElementNS(xn,"svg");i.setAttribute("viewBox","0 0 100 100");const r=document.createElementNS(xn,"text");return r.appendChild(document.createTextNode("T")),r.style.fontFamily=t.fontFamily,r.style.fontWeight=null!==(e=t.fontWeight)&&void 0!==e?e:"",r.style.fontVariant=null!==(n=t.fontVariant)&&void 0!==n?n:"",r.style.fill=t.renderingStyle.fill.toHexString(),r.style.textAnchor="middle",r.setAttribute("x","50"),r.setAttribute("y","75"),r.style.fontSize="65px",r.style.filter="drop-shadow(0px 0px 10px var(--primary-shadow-color))",i.appendChild(r),i}makePenIcon(t,e){e instanceof St&&(e=e.toHexString());const n=document.createElementNS(xn,"svg");n.setAttribute("viewBox","0 0 100 100");const i=t/2,r=`M14,63 L${50-i},95 L${50+i},90 L88,60 Z`,o=`M14,63 L${50-i},85 L${50+i},83 L88,60 Z`;return n.innerHTML=`\n\t\t<defs>\n\t\t\t${wn}\n\t\t</defs>\n\t\t<g>\n\t\t\t\x3c!-- Pen grip --\x3e\n\t\t\t<path\n\t\t\t\td='M10,10 L90,10 L90,60 L${50+i},80 L${50-i},80 L10,60 Z'\n\t\t\t\t\n\tstyle='fill: var(--icon-color); stroke: var(--icon-color);'\n\n\t\t\t/>\n\t\t</g>\n\t\t<g>\n\t\t\t\x3c!-- Checkerboard background for slightly transparent pens --\x3e\n\t\t\t<path d='${o}' fill='url(#checkerboard)'/>\n\t\n\t\t\t\x3c!-- Actual pen tip --\x3e\n\t\t\t<path\n\t\t\t\td='${r}'\n\t\t\t\tfill='${e}'\n\t\t\t\tstroke='${e}'\n\t\t\t/>\n\t\t</g>\n\t\t`,n}makeIconFromFactory(t,e){const n=t.getThickness(),i=(new Date).getTime(),r={pos:S.of(10,10),width:n/5,color:t.getColor(),time:i-100},o={pos:S.of(90,90),width:n/5,color:t.getColor(),time:i},s=new U(new ze),a=e(r,s);a.addPoint(o);const l=document.createElementNS(xn,"svg");l.setAttribute("viewBox","0 0 100 100"),s.updateScreenSize(S.of(100,100));const c=new Yt(l,s);return a.preview(c),l}makePipetteIcon(t){const e=document.createElementNS(xn,"svg"),n=document.createElementNS(xn,"path");if(n.setAttribute("d","\n\t\t\tM 47,6\n\t\t\tC 35,5 25,15 35,30\n\t\t\tc -9.2,1.3 -15,0 -15,3\n\t\t\t\t0,2 5,5 15,7\n\t\t\tV 81\n\t\t\tL 40,90\n\t\t\th 6\n\t\t\tL 40,80\n\t\t\tV 40\n\t\t\th 15\n\t\t\tv 40\n\t\t\tl -6,10\n\t\t\th 6\n\t\t\tl 5,-9.2\n\t\t\tV 40\n\t\t\tC 70,38 75,35 75,33\n\t\t\t\t75,30 69.2,31.2 60,30\n\t\t\t\t65,15 65,5      47,6\n\t\t\tZ\n\t\t"),n.style.fill="var(--icon-color)",t){const n=document.createElementNS(xn,"defs");n.innerHTML=wn,e.appendChild(n);const i=document.createElementNS(xn,"path"),r=document.createElementNS(xn,"path"),o="\n\t\t\t\tm 40,50 c 5,5 10,0 15,-5 V 80 L 50,90 H 45 L 40,80 Z\n\t\t\t";r.setAttribute("d",o),i.setAttribute("d",o),r.style.fill=t.toHexString(),i.style.fill="url(#checkerboard)",e.appendChild(i),e.appendChild(r)}return e.appendChild(n),e.setAttribute("viewBox","0 0 100 100"),e}makeResizeViewportIcon(){return this.makeIconFromPath("\n\t\t\tM 75 5 75 10 90 10 90 25 95 25 95 5 75 5 z\n\t\t\tM 15 15 15 30 20 30 20 20 30 20 30 15 15 15 z\n\t\t\tM 84 15 82 17 81 16 81 20 85 20 84 19 86 17 84 15 z\n\t\t\tM 26 24 24 26 26 28 25 29 29 29 29 25 28 26 26 24 z\n\t\t\tM 25 71 26 72 24 74 26 76 28 74 29 75 29 71 25 71 z\n\t\t\tM 15 75 15 85 25 85 25 80 20 80 20 75 15 75 z\n\t\t\tM 90 75 90 90 75 90 75 95 95 95 95 75 90 75 z\n\t\t\tM 81 81 81 85 82 84 84 86 86 84 84 82 85 81 81 81 z\n\t\t")}makeDuplicateSelectionIcon(){return this.makeIconFromPath("\n\t\t\tM 45,10 45,55 90,55 90,10 45,10 z\n\t\t\tM 10,25 10,90 70,90 70,60 40,60 40,25 10,25 z \n\t\t")}makeDeleteSelectionIcon(){return this.makeIconFromPath("\n\t\t\tM 10,10 90,90\n\t\t\tM 10,90 90,10\n\t\t","none","var(--icon-color)","5px")}makeSaveIcon(){const t=document.createElementNS("http://www.w3.org/2000/svg","svg");return t.innerHTML="\n\t\t\t<style>\n\t\t\t\t.toolbar-save-icon {\n\t\t\t\t\tstroke: var(--icon-color);\n\t\t\t\t\tstroke-width: 10;\n\t\t\t\t\tstroke-linejoin: round;\n\t\t\t\t\tstroke-linecap: round;\n\t\t\t\t\tfill: none;\n\t\t\t\t}\n\t\t\t</style>\n\t\t\t<path\n\t\t\t\td='\n\t\t\t\t\tM 15,55 30,70 85,20\n\t\t\t\t'\n\t\t\t\tclass='toolbar-save-icon'\n\t\t\t/>\n\t\t",t.setAttribute("viewBox","0 0 100 100"),t}}var Sn=function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{l(i.next(t))}catch(t){o(t)}}function a(t){try{l(i.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}l((i=i.apply(t,e||[])).next())}))};const Cn=class{constructor(t,e={}){var n,i,r,o,s;this.eventListenerTargets=[],this.previousAccessibilityAnnouncement="",this.pointers={},this.announceUndoCallback=t=>{this.announceForAccessibility(this.localization.undoAnnouncement(t.description(this,this.localization)))},this.announceRedoCallback=t=>{this.announceForAccessibility(this.localization.redoAnnouncement(t.description(this,this.localization)))},this.rerenderQueued=!1,this.localization=Object.assign(Object.assign({},yn()),e.localization),this.settings={wheelEventsEnabled:null===(n=e.wheelEventsEnabled)||void 0===n||n,renderingMode:null!==(i=e.renderingMode)&&void 0!==i?i:un.CanvasRenderer,localization:this.localization,minZoom:null!==(r=e.minZoom)&&void 0!==r?r:2e-10,maxZoom:null!==(o=e.maxZoom)&&void 0!==o?o:1e12,iconProvider:null!==(s=e.iconProvider)&&void 0!==s?s:new Tn},this.icons=this.settings.iconProvider,this.container=document.createElement("div"),this.renderingRegion=document.createElement("div"),this.container.appendChild(this.renderingRegion),this.container.className="imageEditorContainer",this.loadingWarning=document.createElement("div"),this.loadingWarning.classList.add("loadingMessage"),this.loadingWarning.ariaLive="polite",this.container.appendChild(this.loadingWarning),this.accessibilityControlArea=document.createElement("textarea"),this.accessibilityControlArea.setAttribute("placeholder",this.localization.accessibilityInputInstructions),this.accessibilityControlArea.style.opacity="0",this.accessibilityControlArea.style.width="0",this.accessibilityControlArea.style.height="0",this.accessibilityControlArea.style.position="absolute",this.accessibilityAnnounceArea=document.createElement("div"),this.accessibilityAnnounceArea.setAttribute("aria-live","assertive"),this.accessibilityAnnounceArea.className="accessibilityAnnouncement",this.container.appendChild(this.accessibilityAnnounceArea),this.renderingRegion.style.touchAction="none",this.renderingRegion.className="imageEditorRenderArea",this.renderingRegion.appendChild(this.accessibilityControlArea),this.renderingRegion.setAttribute("tabIndex","0"),this.renderingRegion.setAttribute("alt",""),this.notifier=new ze,this.importExportViewport=new U(this.notifier),this.viewport=new U(this.notifier),this.display=new pn(this,this.settings.renderingMode,this.renderingRegion),this.image=new I,this.history=new class{constructor(t,e,n){this.editor=t,this.announceRedoCallback=e,this.announceUndoCallback=n,this.maxUndoRedoStackSize=700,this.undoStack=[],this.redoStack=[]}fireUpdateEvent(){this.editor.notifier.dispatch(M.UndoRedoStackUpdated,{kind:M.UndoRedoStackUpdated,undoStackSize:this.undoStack.length,redoStackSize:this.redoStack.length})}push(t,e=!0){e&&t.apply(this.editor),this.undoStack.push(t);for(const t of this.redoStack)t.onDrop(this.editor);if(this.redoStack=[],this.undoStack.length>this.maxUndoRedoStackSize){const t=10;this.undoStack.splice(0,t).forEach((t=>t.onDrop(this.editor)))}this.fireUpdateEvent(),this.editor.notifier.dispatch(M.CommandDone,{kind:M.CommandDone,command:t})}undo(){const t=this.undoStack.pop();t&&(this.redoStack.push(t),t.unapply(this.editor),this.announceUndoCallback(t),this.fireUpdateEvent(),this.editor.notifier.dispatch(M.CommandUndone,{kind:M.CommandUndone,command:t}))}redo(){const t=this.redoStack.pop();t&&(this.undoStack.push(t),t.apply(this.editor),this.announceRedoCallback(t),this.fireUpdateEvent(),this.editor.notifier.dispatch(M.CommandDone,{kind:M.CommandDone,command:t}))}get undoStackSize(){return this.undoStack.length}get redoStackSize(){return this.redoStack.length}}(this,this.announceRedoCallback,this.announceUndoCallback),this.toolController=new Ee(this,this.localization),t.appendChild(this.container),this.importExportViewport.updateScreenSize(S.of(500,500)),this.viewport.updateScreenSize(S.of(this.display.width,this.display.height)),this.registerListeners(),this.queueRerender(),this.hideLoadingWarning(),this.notifier.on(M.ViewportChanged,(t=>{if(t.kind===M.ViewportChanged){const e=t.newTransform.transformVec3(S.unitX).length();if(e>this.settings.maxZoom||e<this.settings.minZoom){const e=t.oldTransform.transformVec3(S.unitX).length();let n=P.identity;e<=this.settings.maxZoom&&e>=this.settings.minZoom&&(n=t.oldTransform),this.viewport.resetTransform(n)}}}))}getRootElement(){return this.container}showLoadingWarning(t){const e=Math.round(100*t);this.loadingWarning.innerText=this.localization.loading(e),this.loadingWarning.style.display="block"}hideLoadingWarning(){this.loadingWarning.style.display="none",this.announceForAccessibility(this.localization.doneLoading)}announceForAccessibility(t){t===this.previousAccessibilityAnnouncement&&(t+=". "),this.accessibilityAnnounceArea.innerText=t,this.previousAccessibilityAnnouncement=t}addToolbar(t=!0){const e=new rn(this,this.container,this.localization);return t&&(e.addDefaultToolWidgets(),e.addDefaultActionButtons()),e}registerListeners(){this.handlePointerEventsFrom(this.renderingRegion),this.handleKeyEventsFrom(this.renderingRegion),this.container.addEventListener("wheel",(t=>{let e=T.of(t.deltaX,t.deltaY,t.deltaZ);if(!t.ctrlKey){if(!this.settings.wheelEventsEnabled)return;if("only-if-focused"===this.settings.wheelEventsEnabled&&!this.container.querySelector(":focus"))return}t.deltaMode===WheelEvent.DOM_DELTA_LINE?e=e.times(15):t.deltaMode===WheelEvent.DOM_DELTA_PAGE&&(e=e.times(100)),t.ctrlKey&&(e=T.of(0,0,t.deltaY));const n=this.container.getBoundingClientRect(),i=S.of(t.clientX,t.clientY).minus(S.of(n.left,n.top));return!!this.toolController.dispatchInputEvent({kind:A.WheelEvt,delta:e,screenPos:i})&&(t.preventDefault(),!0)})),this.notifier.on(M.DisplayResized,(t=>{this.viewport.updateScreenSize(S.of(this.display.width,this.display.height))})),window.addEventListener("resize",(()=>{this.notifier.dispatch(M.DisplayResized,{kind:M.DisplayResized,newSize:S.of(this.display.width,this.display.height)}),this.queueRerender()})),this.accessibilityControlArea.addEventListener("input",(()=>{this.accessibilityControlArea.value=""})),document.addEventListener("copy",(t=>{if(!this.isEventSink(document.querySelector(":focus")))return;const e=t.clipboardData;this.toolController.dispatchInputEvent({kind:A.CopyEvent,setData:(t,n)=>{null==e||e.setData(t,n)}})&&t.preventDefault()})),document.addEventListener("paste",(t=>{this.handlePaste(t)}))}getPointerList(){const t=(new Date).getTime(),e=[];for(const n in this.pointers){const i=2e3;this.pointers[n]&&t-this.pointers[n].timeStamp<i&&e.push(this.pointers[n])}return e}handleHTMLPointerEvent(t,e){var n,i,r;const o=this.renderingRegion,s=null!==(n=e.target)&&void 0!==n?n:this.renderingRegion;if("pointerdown"===t){const t=$.ofEvent(e,!0,this.viewport,o);this.pointers[t.id]=t,s.setPointerCapture(t.id);const n={kind:A.PointerDownEvt,current:t,allPointers:this.getPointerList()};return this.toolController.dispatchInputEvent(n),!0}if("pointermove"===t){const t=$.ofEvent(e,null!==(r=null===(i=this.pointers[e.pointerId])||void 0===i?void 0:i.down)&&void 0!==r&&r,this.viewport,o);if(t.down){const n=this.pointers[t.id];if(n&&t.screenPos.minus(n.screenPos).magnitude()<2)return!1;this.pointers[t.id]=t,this.toolController.dispatchInputEvent({kind:A.PointerMoveEvt,current:t,allPointers:this.getPointerList()})&&e.preventDefault()}return!0}if("pointercancel"===t||"pointerup"===t){const t=$.ofEvent(e,!1,this.viewport,o);return!!this.pointers[t.id]&&(this.pointers[t.id]=t,s.releasePointerCapture(t.id),this.toolController.dispatchInputEvent({kind:A.PointerUpEvt,current:t,allPointers:this.getPointerList()})&&e.preventDefault(),delete this.pointers[t.id],!0)}return t}isEventSink(t){let e=t;for(;null!==e;){for(const t of this.eventListenerTargets)if(t===e)return!0;e=e.parentElement}return!1}handlePaste(t){var e,n;return Sn(this,void 0,void 0,(function*(){const i=null!==(e=document.querySelector(":focus"))&&void 0!==e?e:t.target;if(!this.isEventSink(i))return;const r=null!==(n=t.dataTransfer)&&void 0!==n?n:t.clipboardData;if(!r)return;for(const e of r.files)if("image/svg+xml"===e.type.toLowerCase()){const n=yield e.text();if(this.toolController.dispatchInputEvent({kind:A.PasteEvent,mime:e.type,data:n}))return void t.preventDefault()}for(const e of r.files){const n=e.type.toLowerCase();if("image/png"===n||"image/jpg"===n){const i=new FileReader;this.showLoadingWarning(0);try{const r=yield new Promise(((t,n)=>{i.onload=()=>t(i.result),i.onerror=n,i.onabort=n,i.onprogress=t=>{this.showLoadingWarning(t.loaded/t.total)},i.readAsDataURL(e)}));if(r&&this.toolController.dispatchInputEvent({kind:A.PasteEvent,mime:n,data:r}))return t.preventDefault(),void this.hideLoadingWarning()}catch(t){console.error("Error reading image:",t)}this.hideLoadingWarning()}}const o=["image/svg+xml","text/plain"];for(const e of o){const n=r.getData(e);if(n&&this.toolController.dispatchInputEvent({kind:A.PasteEvent,mime:e,data:n}))return void t.preventDefault()}}))}handlePointerEventsFrom(t,e){t.addEventListener("touchstart",(t=>t.preventDefault())),t.addEventListener("contextmenu",(t=>{t.preventDefault()}));const n=["pointerdown","pointermove","pointerup","pointercancel"];for(const i of n)t.addEventListener(i,(t=>!(!e||e(i,t))||this.handleHTMLPointerEvent(i,t)))}handleKeyEventsFrom(t){t.addEventListener("keydown",(t=>{"t"===t.key||"T"===t.key?(t.preventDefault(),this.display.rerenderAsText()):this.toolController.dispatchInputEvent({kind:A.KeyPressEvent,key:t.key,ctrlKey:t.ctrlKey,altKey:t.altKey})?t.preventDefault():"Escape"===t.key&&this.renderingRegion.blur()})),t.addEventListener("keyup",(t=>{this.toolController.dispatchInputEvent({kind:A.KeyUpEvent,key:t.key,ctrlKey:t.ctrlKey,altKey:t.altKey})&&t.preventDefault()})),t.ondragover=t=>{t.preventDefault()},t.ondrop=t=>{t.preventDefault(),this.handlePaste(t)},this.eventListenerTargets.push(t)}dispatch(t,e=!0){e?this.history.push(t):t.apply(this),this.announceForAccessibility(t.description(this,this.localization))}dispatchNoAnnounce(t,e=!1){e?this.history.push(t):t.apply(this)}asyncApplyOrUnapplyCommands(t,e,n){return Sn(this,void 0,void 0,(function*(){console.assert(n>0),this.display.setDraftMode(!0);for(let i=0;i<t.length;i+=n){this.showLoadingWarning(i/t.length);for(let r=i;r<t.length&&r<i+n;r++){const n=t[r];e?n.apply(this):n.unapply(this)}i+n<t.length&&(yield new Promise((t=>{this.rerender(),requestAnimationFrame(t)})))}this.display.setDraftMode(!1),this.hideLoadingWarning()}))}asyncApplyCommands(t,e){return this.asyncApplyOrUnapplyCommands(t,!0,e)}asyncUnapplyCommands(t,e){return this.asyncApplyOrUnapplyCommands(t,!1,e)}queueRerender(){this.rerenderQueued||(this.rerenderQueued=!0,requestAnimationFrame((()=>{this.rerender(),this.rerenderQueued=!1})))}rerender(t=!0){if(this.display.startRerender(),0===this.display.width||0===this.display.height)return;const e=this.display.getDryInkRenderer();if(this.image.renderWithCache(e,this.display.getCache(),this.viewport),t){const t={fill:St.fromHex("#44444455")},n=5*this.viewport.getSizeOfPixelOnCanvas();e.drawRect(this.importExportViewport.visibleRect,n,t)}this.rerenderQueued=!1}drawWetInk(...t){for(const e of t)this.display.getWetInkRenderer().drawPath(e)}clearWetInk(){this.display.getWetInkRenderer().clear()}focus(){this.renderingRegion.focus()}createHTMLOverlay(t){return t.classList.add("overlay"),this.container.appendChild(t),{remove:()=>t.remove()}}addStyleSheet(t){const e=document.createElement("style");return e.innerText=t,this.container.appendChild(e),e}sendKeyboardEvent(t,e,n=!1,i=!1){this.toolController.dispatchInputEvent({kind:t,key:e,ctrlKey:n,altKey:i})}sendPenEvent(t,e,n){const i=$.ofCanvasPoint(e,t!==A.PointerUpEvt,this.viewport);this.toolController.dispatchInputEvent({kind:t,allPointers:null!=n?n:[i],current:i})}toDataURL(t="image/png"){const e=document.createElement("canvas"),n=this.importExportViewport.getResolution();e.width=n.x,e.height=n.y;const i=e.getContext("2d"),r=new on(i,this.importExportViewport);return this.image.renderAll(r),e.toDataURL(t)}toSVG(){const t=this.importExportViewport,e="http://www.w3.org/2000/svg",n=document.createElementNS(e,"svg"),i=new Yt(n,t),r=this.importExportViewport.canvasToScreenTransform;t.resetTransform(P.identity),this.image.renderAll(i),t.resetTransform(r);const o=t.visibleRect;return n.setAttribute("viewBox",[o.x,o.y,o.w,o.h].map((t=>vt(t))).join(" ")),n.setAttribute("width",vt(o.w)),n.setAttribute("height",vt(o.h)),n.setAttribute("version","1.1"),n.setAttribute("baseProfile","full"),n.setAttribute("xmlns",e),n}loadFrom(t){return Sn(this,void 0,void 0,(function*(){this.showLoadingWarning(0),this.display.setDraftMode(!0),yield t.start((t=>{this.dispatchNoAnnounce(I.addElement(t))}),((t,e)=>t%500==0?(this.showLoadingWarning(t/e),this.rerender(),new Promise((t=>{requestAnimationFrame((()=>t()))}))):null),(t=>{this.dispatchNoAnnounce(this.setImportExportRect(t),!1),this.dispatchNoAnnounce(this.viewport.zoomTo(t),!1)})),this.hideLoadingWarning(),this.display.setDraftMode(!1),this.queueRerender()}))}getImportExportRect(){return this.importExportViewport.visibleRect}setImportExportRect(t){const e=this.importExportViewport.visibleRect.size,n=this.importExportViewport.canvasToScreenTransform;return new class extends b{apply(e){const n=e.importExportViewport;n.updateScreenSize(t.size),n.resetTransform(P.translation(t.topLeft.times(-1))),e.queueRerender()}unapply(t){const i=t.importExportViewport;i.updateScreenSize(e),i.resetTransform(n),t.queueRerender()}description(e,n){return n.resizeOutputCommand(t)}}}loadFromSVG(t,e=!1){return Sn(this,void 0,void 0,(function*(){const n=qt.fromString(t,e);yield this.loadFrom(n)}))}},kn=Cn})(),window.jsdraw=r})()},729:(e,n,i)=>{"use strict";i.r(n),i.d(n,{AbstractComponent:()=>u,ActionButtonWidget:()=>De,BaseTool:()=>E,BaseToolWidget:()=>Le,BaseWidget:()=>Ie,Color4:()=>lt,Command:()=>o,Duplicate:()=>Ut,Editor:()=>cn,EditorEventType:()=>x,EditorImage:()=>f,Erase:()=>bt,EraserTool:()=>wt,EraserToolWidget:()=>Me,HTMLToolbar:()=>Ve,HandToolWidget:()=>je,IconProvider:()=>an,ImageComponent:()=>Tt,InputEvtType:()=>y,LineSegment2:()=>p,Mat33:()=>d,PanZoomMode:()=>z,PanZoomTool:()=>B,PasteHandler:()=>ce,Path:()=>at,PenTool:()=>vt,PenToolWidget:()=>Ae,Pointer:()=>w,PointerDevice:()=>b,Rect2:()=>m,SelectionTool:()=>Zt,SelectionToolWidget:()=>Oe,SerializableCommand:()=>s,Stroke:()=>ut,StrokeComponent:()=>ut,StrokeSmoother:()=>mt,Text:()=>Pt,TextComponent:()=>Pt,TextTool:()=>ee,TextToolWidget:()=>Fe,ToolController:()=>ue,ToolEnabledGroup:()=>yt,ToolSwitcherShortcut:()=>ie,ToolbarShortcutHandler:()=>he,UndoRedoShortcut:()=>Xt,Vec2:()=>l,Vec3:()=>a,default:()=>hn,defaultEditorLocalization:()=>Qe,getLocalizationTable:()=>nn,invertCommand:()=>ae,makeColorInput:()=>ke,makeFreehandLineBuilder:()=>gt,makePressureSensitiveFreehandLineBuilder:()=>re,uniteCommands:()=>te});class r{onDrop(t){}static union(t,e){return new class extends r{apply(n){t.apply(n),e.apply(n)}unapply(n){e.unapply(n),t.unapply(n)}description(n,i){const r=t.description(n,i),o=e.description(n,i);return r===o?r:`${r}, ${o}`}}}}r.empty=new class extends r{description(t,e){return""}apply(t){}unapply(t){}};const o=r;class s extends o{constructor(t){if(super(),this.commandTypeId=t,!(t in s.deserializationCallbacks))throw new Error(`Command ${t} must have a registered deserialization callback. To do this, call SerializableCommand.register.`)}serialize(){return{data:this.serializeToJSON(),commandType:this.commandTypeId}}static deserialize(t,e){const n="string"==typeof t?JSON.parse(t):t,i=n.commandType;if(!(i in s.deserializationCallbacks))throw new Error(`Unrecognised command type ${i}!`);return s.deserializationCallbacks[i](n.data,e)}static register(t,e){s.deserializationCallbacks[t]=e}}s.deserializationCallbacks={};class a{constructor(t,e,n){this.x=t,this.y=e,this.z=n}get xy(){return{x:this.x,y:this.y}}static of(t,e,n){return new a(t,e,n)}at(t){if(0===t)return this.x;if(1===t)return this.y;if(2===t)return this.z;throw new Error(`${t} out of bounds!`)}length(){return this.magnitude()}magnitude(){return Math.sqrt(this.dot(this))}magnitudeSquared(){return this.dot(this)}angle(){return Math.atan2(this.y,this.x)}normalized(){const t=this.magnitude();return a.of(this.x/t,this.y/t,this.z/t)}times(t){return a.of(this.x*t,this.y*t,this.z*t)}plus(t){return a.of(this.x+t.x,this.y+t.y,this.z+t.z)}minus(t){return this.plus(t.times(-1))}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}cross(t){return a.of(this.y*t.z-t.y*this.z,t.x*this.z-this.x*t.z,this.x*t.y-t.x*this.y)}scale(t){return"number"==typeof t?this.times(t):a.of(this.x*t.x,this.y*t.y,this.z*t.z)}orthog(){return 0===this.dot(a.unitX)&&0===this.dot(a.unitY)?0===this.dot(a.unitX)?a.unitX:this.cross(a.unitX).normalized():this.cross(a.unitZ.times(-1)).normalized()}extend(t,e){return this.plus(e.normalized().times(t))}lerp(t,e){return this.times(1-e).plus(t.times(e))}zip(t,e){return a.of(e(t.x,this.x),e(t.y,this.y),e(t.z,this.z))}map(t){return a.of(t(this.x,0),t(this.y,1),t(this.z,2))}asArray(){return[this.x,this.y,this.z]}eq(t,e=1e-10){for(let n=0;n<3;n++)if(Math.abs(t.at(n)-this.at(n))>e)return!1;return!0}toString(){return`Vec(${this.x}, ${this.y}, ${this.z})`}}var l,c,h;a.unitX=a.of(1,0,0),a.unitY=a.of(0,1,0),a.unitZ=a.of(0,0,1),a.zero=a.of(0,0,0),function(t){t.of=(t,e)=>a.of(t,e,0),t.ofXY=({x:t,y:e})=>a.of(t,e,0),t.unitX=t.of(1,0),t.unitY=t.of(0,1),t.zero=t.of(0,0)}(l||(l={}));class d{constructor(t,e,n,i,r,o,s,l,c){this.a1=t,this.a2=e,this.a3=n,this.b1=i,this.b2=r,this.b3=o,this.c1=s,this.c2=l,this.c3=c,this.cachedInverse=void 0,this.rows=[a.of(t,e,n),a.of(i,r,o),a.of(s,l,c)]}static ofRows(t,e,n){return new d(t.x,t.y,t.z,e.x,e.y,e.z,n.x,n.y,n.z)}inverse(){var t;return null!==(t=this.computeInverse())&&void 0!==t?t:d.identity}invertable(){return null!==this.computeInverse()}computeInverse(){if(void 0!==this.cachedInverse)return this.cachedInverse;const t=[this.rows[0],this.rows[1],this.rows[2]],e=[a.unitX,a.unitY,a.unitZ];for(let n=0;n<3;n++){let i=t[n].at(n);const r=1e-10;if(Math.abs(i)<r){let o=-1;for(let e=1;e<=2;e++){const i=(n+e)%3;if(Math.abs(t[i].at(n))>=r){o=i;break}}if(-1===o)return this.cachedInverse=null,null;const s=t[n],a=e[n];t[n]=t[o],e[n]=e[o],t[o]=s,e[o]=a,i=t[n].at(n)}let o=1/i;t[n]=t[n].times(o),e[n]=e[n].times(o);const s=t[n],a=e[n];for(let i=1;i<=2;i++){const r=(n+i)%3;o=-t[r].at(n),t[r]=t[r].plus(s.times(o)),e[r]=e[r].plus(a.times(o))}}const n=d.ofRows(e[0],e[1],e[2]);return this.cachedInverse=n,n}transposed(){return new d(this.a1,this.b1,this.c1,this.a2,this.b2,this.c2,this.a3,this.b3,this.c3)}rightMul(t){t=t.transposed();const e=(e,n)=>this.rows[e].dot(t.rows[n]);return new d(e(0,0),e(0,1),e(0,2),e(1,0),e(1,1),e(1,2),e(2,0),e(2,1),e(2,2))}transformVec2(t){let e=a.of(t.x,t.y,1);return e=this.transformVec3(e),l.of(e.x,e.y)}transformVec3(t){return a.of(this.rows[0].dot(t),this.rows[1].dot(t),this.rows[2].dot(t))}eq(t,e=0){for(let n=0;n<3;n++)if(!this.rows[n].eq(t.rows[n],e))return!1;return!0}toString(){return`\n⎡ ${this.a1},\t ${this.a2},\t ${this.a3}\t ⎤\n⎢ ${this.b1},\t ${this.b2},\t ${this.b3}\t ⎥\n⎣ ${this.c1},\t ${this.c2},\t ${this.c3}\t ⎦\n\t\t`.trimEnd().trimStart()}toArray(){return[this.a1,this.a2,this.a3,this.b1,this.b2,this.b3,this.c1,this.c2,this.c3]}mapEntries(t){return new d(t(this.a1),t(this.a2),t(this.a3),t(this.b1),t(this.b2),t(this.b3),t(this.c1),t(this.c2),t(this.c3))}getScaleFactor(){return Math.hypot(this.a1,this.a2)}static translation(t){return new d(1,0,t.x,0,1,t.y,0,0,1)}static zRotation(t,e=l.zero){const n=Math.cos(t),i=Math.sin(t);let r=d.translation(e);return r=r.rightMul(new d(n,-i,0,i,n,0,0,0,1)),r.rightMul(d.translation(e.times(-1)))}static scaling2D(t,e=l.zero){let n,i,r=d.translation(e);return"number"==typeof t?(n=t,i=t):(n=t.x,i=t.y),r=r.rightMul(new d(n,0,0,0,i,0,0,0,1)),r.rightMul(d.translation(e.times(-1)))}toCSSMatrix(){return`matrix(${this.a1},${this.b1},${this.a2},${this.b2},${this.a3},${this.b3})`}static fromCSSMatrix(t){if(""===t||"none"===t)return d.identity;const e="([-]?\\d*(?:\\.\\d*)?(?:[eE][-]?\\d+)?)",n=`^\\s*matrix\\s*\\(${[e,e,e,e,e,e].join("[, \\t\\n]+")}[, \\t\\n]*\\)\\s*$`,i=new RegExp(n,"i").exec(t);if(!i)throw new Error(`Unsupported transformation: ${t}`);const r=i.slice(1).map((t=>parseFloat(t))),o=r[0],s=r[1],a=r[2],l=r[3],c=r[4],h=r[5];return new d(o,a,c,s,l,h,0,0,1)}}d.identity=new d(1,0,0,0,1,0,0,0,1);class u{constructor(t){if(this.componentKind=t,this.loadSaveData={},this.lastChangedTime=(new Date).getTime(),this.zIndex=u.zIndexCounter++,this.id=`${(new Date).getTime()}-${Math.random()}`,void 0===u.deserializationCallbacks[t])throw new Error(`Component ${t} has not been registered using AbstractComponent.registerComponent`)}getId(){return this.id}static registerComponent(t,e){this.deserializationCallbacks[t]=null!=e?e:null}attachLoadSaveData(t,e){this.loadSaveData[t]||(this.loadSaveData[t]=[]),this.loadSaveData[t].push(e)}getLoadSaveData(){return this.loadSaveData}getZIndex(){return this.zIndex}getBBox(){return this.contentBBox}transformBy(t){return new u.TransformElementCommand(t,this)}isSelectable(){return!0}clone(){const t=this.createClone();for(const e in this.loadSaveData)for(const n of this.loadSaveData[e])t.attachLoadSaveData(e,n);return t}serialize(){const t=this.serializeToJSON();if(null===t)throw new Error(`${this} cannot be serialized.`);return{name:this.componentKind,zIndex:this.zIndex,id:this.id,loadSaveData:this.loadSaveData,data:t}}static isNotDeserializable(t){return"string"==typeof t&&(t=JSON.parse(t)),"object"!=typeof t||!this.deserializationCallbacks[null==t?void 0:t.name]||!t.data}static deserialize(t){if("string"==typeof t&&(t=JSON.parse(t)),u.isNotDeserializable(t))throw new Error(`Element with data ${t} cannot be deserialized.`);const e=this.deserializationCallbacks[t.name](t.data);return e.zIndex=t.zIndex,e.id=t.id,e}}u.zIndexCounter=0,u.deserializationCallbacks={},u.transformElementCommandId="transform-element",u.UnresolvedTransformElementCommand=class extends s{constructor(t,e){super(u.transformElementCommandId),this.affineTransfm=t,this.componentID=e,this.command=null}resolveCommand(t){if(this.command)return;const e=t.image.lookupElement(this.componentID);if(!e)throw new Error(`Unable to resolve component with ID ${this.componentID}`);this.command=new u.TransformElementCommand(this.affineTransfm,e)}apply(t){this.resolveCommand(t),this.command.apply(t)}unapply(t){this.resolveCommand(t),this.command.unapply(t)}description(t,e){return e.transformedElements(1)}serializeToJSON(){return{id:this.componentID,transfm:this.affineTransfm.toArray()}}},u.TransformElementCommand=(c=class extends s{constructor(t,e){super(u.transformElementCommandId),this.affineTransfm=t,this.component=e,this.origZIndex=e.zIndex}updateTransform(t,e){const n=t.image.findParent(this.component);let i=!1;n&&(n.remove(),i=!0),this.component.applyTransformation(e),i&&f.addElement(this.component).apply(t)}apply(t){this.component.zIndex=u.zIndexCounter++,this.updateTransform(t,this.affineTransfm),t.queueRerender()}unapply(t){this.component.zIndex=this.origZIndex,this.updateTransform(t,this.affineTransfm.inverse()),t.queueRerender()}description(t,e){return e.transformedElements(1)}serializeToJSON(){return{id:this.component.getId(),transfm:this.affineTransfm.toArray()}}},s.register(u.transformElementCommandId,((t,e)=>{const n=e.image.lookupElement(t.id),i=new d(...t.transfm);return n?new u.TransformElementCommand(i,n):new u.UnresolvedTransformElementCommand(i,t.id)})),c);class p{constructor(t,e){this.point1=t,this.point2=e,this.bbox=m.bboxOf([t,e]),this.direction=e.minus(t),this.length=this.direction.magnitude(),this.length>0&&(this.direction=this.direction.times(1/this.length))}get p1(){return this.point1}get p2(){return this.point2}get(t){return this.point1.plus(this.direction.times(t))}intersection(t){let e,n;if(0===this.direction.x){if(0===t.direction.x||0===this.direction.y)return null;const i=this.point1.x,r=(this.point1.x-t.point1.x)*t.direction.y/t.direction.x+t.point1.y;e=l.of(i,r),n=(r-this.point1.y)/this.direction.y}else{const i=(this.point1.y-t.point1.y)*this.direction.x*t.direction.x+this.direction.x*t.direction.y*t.point1.x-this.direction.y*t.direction.x*this.point1.x,r=t.direction.y*this.direction.x-this.direction.y*t.direction.x;if(0===r)return null;const o=i/r,s=(o-this.point1.x)/this.direction.x,a=this.point1.y+this.direction.y*s;e=l.of(o,a),n=(o-this.point1.x)/this.direction.x}const i=e.minus(this.point1).magnitude(),r=e.minus(this.point2).magnitude(),o=e.minus(t.point1).magnitude(),s=e.minus(t.point2).magnitude();return i>this.length||r>this.length||o>t.length||s>t.length?null:{point:e,t:n}}intersects(t){return null!==this.intersection(t)}closestPointTo(t){const e=t.minus(this.p1).dot(this.direction),n=this.length-e,i=this.p1.plus(this.direction.times(e));return e>0&&e<this.length?i:Math.abs(n)<Math.abs(e)?this.p2:this.p1}transformedBy(t){return new p(t.transformVec2(this.p1),t.transformVec2(this.p2))}toString(){return`LineSegment(${this.p1.toString()}, ${this.p2.toString()})`}}class m{constructor(t,e,n,i){this.x=t,this.y=e,this.w=n,this.h=i,n<0&&(this.x+=n,this.w=Math.abs(n)),i<0&&(this.y+=i,this.h=Math.abs(i)),this.topLeft=l.of(this.x,this.y),this.size=l.of(this.w,this.h),this.bottomRight=this.topLeft.plus(this.size),this.center=this.topLeft.plus(this.size.times(.5)),this.area=this.w*this.h}translatedBy(t){return new m(t.x+this.x,t.y+this.y,this.w,this.h)}resizedTo(t){return new m(this.x,this.y,t.x,t.y)}containsPoint(t){return this.x<=t.x&&this.y<=t.y&&this.x+this.w>=t.x&&this.y+this.h>=t.y}containsRect(t){return this.x<=t.x&&this.y<=t.y&&this.bottomRight.x>=t.bottomRight.x&&this.bottomRight.y>=t.bottomRight.y}intersects(t){const e=this.x,n=e+this.w,i=t.x,r=t.x+t.w;if(n<i||e>r)return!1;const o=this.y,s=o+this.h,a=t.y,l=t.y+t.h;return!(s<a||o>l)}intersection(t){if(!this.intersects(t))return null;const e=this.topLeft.zip(t.topLeft,Math.max),n=this.bottomRight.zip(t.bottomRight,Math.min);return m.fromCorners(e,n)}union(t){const e=this.topLeft.zip(t.topLeft,Math.min),n=this.bottomRight.zip(t.bottomRight,Math.max);return m.fromCorners(e,n)}divideIntoGrid(t,e){const n=[];if(t<=0||e<=0)return n;const i=this.w/t,r=this.h/e;0===i&&(t=1),0===r&&(e=1);for(let o=0;o<e;o++)for(let e=0;e<t;e++){const t=i*e+this.x,s=r*o+this.y;n.push(new m(t,s,i,r))}return n}grownToPoint(t,e=0){const n=new m(t.x-e,t.y-e,2*e,2*e);return this.union(n)}grownBy(t){return new m(this.x-t,this.y-t,this.w+2*t,this.h+2*t)}getClosestPointOnBoundaryTo(t){const e=this.getEdges().map((e=>e.closestPointTo(t)));let n=null,i=null;for(const r of e){const e=r.minus(t).length();(null===i||e<i)&&(n=r,i=e)}return n}get corners(){return[this.bottomRight,this.topRight,this.topLeft,this.bottomLeft]}get maxDimension(){return Math.max(this.w,this.h)}get topRight(){return this.bottomRight.plus(l.of(0,-this.h))}get bottomLeft(){return this.topLeft.plus(l.of(0,this.h))}get width(){return this.w}get height(){return this.h}getEdges(){const t=this.corners;return[new p(t[0],t[1]),new p(t[1],t[2]),new p(t[2],t[3]),new p(t[3],t[0])]}transformedBoundingBox(t){return m.bboxOf(this.corners.map((e=>t.transformVec2(e))))}eq(t,e=0){return this.topLeft.eq(t.topLeft,e)&&this.size.eq(t.size,e)}toString(){return`Rect(point(${this.x}, ${this.y}), size(${this.w}, ${this.h}))`}static fromCorners(t,e){return new m(Math.min(t.x,e.x),Math.min(t.y,e.y),Math.abs(t.x-e.x),Math.abs(t.y-e.y))}static bboxOf(t,e=0){let n=0,i=0,r=0,o=0,s=!0;for(const e of t)s&&(n=e.x,i=e.y,r=e.x,o=e.y,s=!1),n=Math.min(n,e.x),i=Math.min(i,e.y),r=Math.max(r,e.x),o=Math.max(o,e.y);return m.fromCorners(l.of(n-e,i-e),l.of(r+e,o+e))}static of(t){var e,n,i,r;const o=null!==(n=null!==(e=t.width)&&void 0!==e?e:t.w)&&void 0!==n?n:0,s=null!==(r=null!==(i=t.height)&&void 0!==i?i:t.h)&&void 0!==r?r:0;return new m(t.x,t.y,o,s)}}m.empty=new m(0,0,0,0),m.unitSquare=new m(0,0,1,1);const g=t=>{t.sort(((t,e)=>t.getContent().getZIndex()-e.getContent().getZIndex()))};class f{constructor(){this.root=new v,this.componentsById={}}findParent(t){const e=this.root.getLeavesIntersectingRegion(t.getBBox());for(const n of e)if(n.getContent()===t)return n;return null}renderWithCache(t,e,n){e.render(t,this.root,n)}render(t,e){this.root.render(t,e.visibleRect)}renderAll(t){const e=this.root.getLeaves();g(e);for(const n of e)n.getContent().render(t,n.getBBox())}getAllElements(){const t=this.root.getLeaves();return g(t),t.map((t=>t.getContent()))}getElementsIntersectingRegion(t){const e=this.root.getLeavesIntersectingRegion(t);return g(e),e.map((t=>t.getContent()))}onDestroyElement(t){delete this.componentsById[t.getId()]}lookupElement(t){var e;return null!==(e=this.componentsById[t])&&void 0!==e?e:null}addElementDirectly(t){return this.componentsById[t.getId()]=t,this.root.addLeaf(t)}static addElement(t,e=!1){return new f.AddElementCommand(t,e)}}f.AddElementCommand=(h=class extends s{constructor(t,e=!1){if(super("add-element"),this.element=t,this.applyByFlattening=e,this.serializedElem=t.serialize(),isNaN(t.getBBox().area))throw new Error("Elements in the image cannot have NaN bounding boxes")}apply(t){t.image.addElementDirectly(this.element),this.applyByFlattening?(this.applyByFlattening=!1,t.display.flatten()):t.queueRerender()}unapply(t){const e=t.image.findParent(this.element);null==e||e.remove(),t.queueRerender()}description(t,e){return e.addElementAction(this.element.description(e))}serializeToJSON(){return{elemData:this.serializedElem}}},s.register("add-element",((t,e)=>{const n=t.elemData.id,i=e.image.lookupElement(n),r=null!=i?i:u.deserialize(t.elemData);return new f.AddElementCommand(r)})),h);class v{constructor(t=null){this.parent=t,this.targetChildCount=30,this.children=[],this.bbox=m.empty,this.content=null,this.id=v.idCounter++}getId(){return this.id}onContentChange(){this.id=v.idCounter++}getContent(){return this.content}getParent(){return this.parent}getChildrenIntersectingRegion(t){return this.children.filter((e=>e.getBBox().intersects(t)))}getChildrenOrSelfIntersectingRegion(t){return this.content?[this]:this.getChildrenIntersectingRegion(t)}getLeavesIntersectingRegion(t,e){const n=[];let i;const r=[];r.push(this);const o=()=>{i=void 0;const o=r.pop();o&&!(null==e?void 0:e(o.bbox))&&(i=o,null!==i.content&&i.getBBox().intersection(t)&&n.push(i),r.push(...i.getChildrenIntersectingRegion(t)))};for(;r.length>0;)o();return n}getLeaves(){if(this.content)return[this];const t=[];for(const e of this.children)t.push(...e.getLeaves());return t}addLeaf(t){if(this.onContentChange(),null===this.content&&0===this.children.length)return this.content=t,this.recomputeBBox(!0),this;if(null!==this.content){console.assert(0===this.children.length);const t=new v(this);t.content=this.content,this.content=null,this.children.push(t),t.recomputeBBox(!1)}const e=t.getBBox();if(e.containsRect(this.getBBox())){const e=new v(this);if(this.children.length<this.targetChildCount)this.children.push(e);else{const t=new v(this);t.children=this.children,this.children=[e,t],t.recomputeBBox(!0),t.updateParents()}return e.addLeaf(t)}const n=this.children.filter((t=>t.getBBox().containsRect(e)));if(n.length>0&&this.children.length>=this.targetChildCount){n.sort(((t,e)=>t.getBBox().area-e.getBBox().area));const e=n[0].addLeaf(t);return e.rebalance(),e}const i=new v(this);return this.children.push(i),i.content=t,i.recomputeBBox(!0),i}getBBox(){return this.bbox}recomputeBBox(t){var e;const n=this.bbox;if(null!==this.content)this.bbox=this.content.getBBox();else{this.bbox=m.empty;let t=!0;for(const e of this.children)t?(this.bbox=e.getBBox(),t=!1):this.bbox=this.bbox.union(e.getBBox())}t&&!n.eq(this.bbox)&&(null===(e=this.parent)||void 0===e||e.recomputeBBox(!0))}updateParents(t=!1){for(const e of this.children)e.parent=this,t&&e.updateParents(t)}rebalance(){if(this.parent&&1===this.parent.children.length){console.assert(null===this.parent.content),console.assert(this.parent.children[0]===this);const t=this.parent;null!==t.parent?(t.children=[],this.parent=t.parent,this.parent.children.push(this),t.parent=null,this.parent.recomputeBBox(!1)):null===this.content&&(this.parent.children=this.children,this.parent.updateParents(),this.parent=null)}}remove(){if(!this.parent)return this.content=null,void(this.children=[]);const t=this.parent.children.length;this.parent.children=this.parent.children.filter((t=>t!==this)),console.assert(this.parent.children.length===t-1,`${t-1} ≠ ${this.parent.children.length} after removing all nodes equal to ${this}. Nodes should only be removed once.`),this.parent.children.forEach((t=>{t.rebalance()})),this.parent.recomputeBBox(!0),this.content=null,this.parent=null,this.children=[]}render(t,e){const n=this.getLeavesIntersectingRegion(e,(e=>t.isTooSmallToRender(e)));g(n);for(const i of n)i.getContent().render(t,e)}}var y,x,b;v.idCounter=0,function(t){t[t.PointerDownEvt=0]="PointerDownEvt",t[t.PointerMoveEvt=1]="PointerMoveEvt",t[t.PointerUpEvt=2]="PointerUpEvt",t[t.GestureCancelEvt=3]="GestureCancelEvt",t[t.WheelEvt=4]="WheelEvt",t[t.KeyPressEvent=5]="KeyPressEvent",t[t.KeyUpEvent=6]="KeyUpEvent",t[t.CopyEvent=7]="CopyEvent",t[t.PasteEvent=8]="PasteEvent"}(y||(y={})),function(t){t[t.ToolEnabled=0]="ToolEnabled",t[t.ToolDisabled=1]="ToolDisabled",t[t.ToolUpdated=2]="ToolUpdated",t[t.UndoRedoStackUpdated=3]="UndoRedoStackUpdated",t[t.CommandDone=4]="CommandDone",t[t.CommandUndone=5]="CommandUndone",t[t.ObjectAdded=6]="ObjectAdded",t[t.ViewportChanged=7]="ViewportChanged",t[t.DisplayResized=8]="DisplayResized",t[t.ColorPickerToggled=9]="ColorPickerToggled",t[t.ColorPickerColorSelected=10]="ColorPickerColorSelected",t[t.ToolbarDropdownShown=11]="ToolbarDropdownShown"}(x||(x={})),function(t){t[t.Pen=0]="Pen",t[t.Eraser=1]="Eraser",t[t.Touch=2]="Touch",t[t.PrimaryButtonMouse=3]="PrimaryButtonMouse",t[t.RightButtonMouse=4]="RightButtonMouse",t[t.Other=5]="Other"}(b||(b={}));class w{constructor(t,e,n,i,r,o,s,a){this.screenPos=t,this.canvasPos=e,this.pressure=n,this.isPrimary=i,this.down=r,this.device=o,this.id=s,this.timeStamp=a}static ofEvent(t,e,n,i){var r,o;let s=l.of(t.clientX,t.clientY);if(i){const t=i.getBoundingClientRect();s=s.minus(l.of(t.left,t.top))}let a=null!==(r={mouse:b.PrimaryButtonMouse,pen:b.Pen,touch:b.Touch}[t.pointerType])&&void 0!==r?r:b.Other;a===b.Pen&&0!=(32&t.buttons)&&(a=b.Eraser);const c=(new Date).getTime(),h=n.roundPoint(n.screenToCanvas(s));return a===b.PrimaryButtonMouse&&(2&t.buttons?a=b.RightButtonMouse:1&t.buttons||(a=b.Other)),new w(s,h,null!==(o=t.pressure)&&void 0!==o?o:null,t.isPrimary,e,a,t.pointerId,c)}static ofCanvasPoint(t,e,n,i=0,r=b.Pen,o=!0,s=null){const a=n.canvasToScreen(t),l=(new Date).getTime();return new w(a,t,s,o,e,r,i,l)}}var T,S;class C extends o{}class k{constructor(t){this.notifier=t,this.resetTransform(d.identity),this.screenRect=m.empty}updateScreenSize(t){this.screenRect=this.screenRect.resizedTo(t)}get visibleRect(){return this.screenRect.transformedBoundingBox(this.inverseTransform)}screenToCanvas(t){return this.inverseTransform.transformVec2(t)}canvasToScreen(t){return this.transform.transformVec2(t)}static transformBy(t){return new k.ViewportTransform(t)}resetTransform(t=d.identity){const e=this.transform;this.transform=t,this.inverseTransform=t.inverse(),this.notifier.dispatch(x.ViewportChanged,{kind:x.ViewportChanged,newTransform:t,oldTransform:e})}get screenToCanvasTransform(){return this.inverseTransform}get canvasToScreenTransform(){return this.transform}getResolution(){return this.screenRect.size}getScaleFactor(){return this.transform.transformVec3(a.unitX).magnitude()}getSizeOfPixelOnCanvas(){return 1/this.getScaleFactor()}getRotationAngle(){return this.transform.transformVec3(a.unitX).angle()}static roundPoint(t,e){const n=Math.pow(10,Math.floor(Math.log10(e))),i=t=>Math.round(t/n)*n;return"number"==typeof t?i(t):t.map(i)}roundPoint(t){return k.roundPoint(t,1/this.getScaleFactor())}static roundScaleRatio(t,e=1){if(Math.abs(t)<=1e-12)return 0;const n=Math.pow(10,Math.floor(Math.log10(Math.abs(t)))),i=Math.pow(2,e);return Math.round(t/n*i)/i*n}computeZoomToTransform(t,e=!0,n=!0){let i=d.identity;if(0===t.w||0===t.h)throw new Error(`${t.toString()} rectangle is empty! Cannot zoom to!`);if(isNaN(t.size.magnitude()))throw new Error(`${t.toString()} rectangle has NaN size! Cannot zoom to!`);const r=()=>{const t=this.visibleRect.transformedBoundingBox(i.inverse());return t.transformedBoundingBox(d.scaling2D(.8,t.center))};let o=r();const s=o.w<t.w||o.h<t.h,a=t.maxDimension/o.maxDimension<1/3;if(s&&n||a&&e){const e=Math.max(t.w/o.w,t.h/o.h),n=d.scaling2D(e,o.topLeft).inverse();i=i.rightMul(n)}if(o=r(),!o.containsRect(t)){const e=t.center.minus(o.center),n=d.translation(e).inverse();i=i.rightMul(n)}return i.invertable()||(console.warn("Unable to zoom to ",t,"! Computed transform",i,"is singular."),i=d.identity),i}zoomTo(t,e=!0,n=!0){const i=this.computeZoomToTransform(t,e,n);return new k.ViewportTransform(i)}}k.ViewportTransform=(S=class extends C{constructor(t){super(),this.transform=t,T.set(this,void 0),function(t,e,n,i,r){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!r:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");"a"===i?r.call(t,n):r?r.value=n:e.set(t,n)}(this,T,t.inverse(),"f")}apply(t){const e=t.viewport;e.resetTransform(e.transform.rightMul(this.transform)),t.queueRerender()}unapply(t){const e=t.viewport;e.resetTransform(e.transform.rightMul(function(t,e,n,i){if("a"===n&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!i:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?i:"a"===n?i.call(t):i?i.value:e.get(t)}(this,T,"f"))),t.queueRerender()}description(t,e){const n=[],i=t.viewport.visibleRect.center,r=this.transform.transformVec3(l.unitX),o=this.transform.transformVec2(i),s=r.magnitude(),a=180/Math.PI*r.angle(),c=o.minus(i);s>1.2?n.push(e.zoomedIn):s<.8&&n.push(e.zoomedOut),Math.floor(Math.abs(a))>0&&n.push(e.rotatedBy(Math.round(a)));const h=1e-4;return c.x>h?n.push(e.movedLeft):c.x<-1e-4&&n.push(e.movedRight),c.y<-1e-4?n.push(e.movedDown):c.y>h&&n.push(e.movedUp),n.join("; ")}},T=new WeakMap,S);const P=k;class E{onPointerDown(t){return!1}onPointerMove(t){}onPointerUp(t){}onGestureCancel(){}constructor(t,e){this.notifier=t,this.description=e,this.enabled=!0,this.group=null}onWheel(t){return!1}onCopy(t){return!1}onPaste(t){return!1}onKeyPress(t){return!1}onKeyUp(t){return!1}setEnabled(t){var e;this.enabled=t,t?(null===(e=this.group)||void 0===e||e.notifyEnabled(this),this.notifier.dispatch(x.ToolEnabled,{kind:x.ToolEnabled,tool:this})):this.notifier.dispatch(x.ToolDisabled,{kind:x.ToolDisabled,tool:this})}isEnabled(){return this.enabled}setToolGroup(t){this.isEnabled()&&t.notifyEnabled(this),this.group=t}getToolGroup(){return this.group?this.group:null}}var z;!function(t){t[t.OneFingerTouchGestures=1]="OneFingerTouchGestures",t[t.TwoFingerTouchGestures=2]="TwoFingerTouchGestures",t[t.RightClickDrags=4]="RightClickDrags",t[t.SinglePointerGestures=8]="SinglePointerGestures",t[t.Keyboard=16]="Keyboard",t[t.RotationLocked=32]="RotationLocked"}(z||(z={}));class B extends E{constructor(t,e,n){super(t.notifier,n),this.editor=t,this.mode=e,this.transform=null}computePinchData(t,e){const n=e.screenPos.minus(t.screenPos),i=n.angle(),r=n.magnitude();return{canvasCenter:e.canvasPos.plus(t.canvasPos).times(.5),screenCenter:e.screenPos.plus(t.screenPos).times(.5),angle:i,dist:r}}allPointersAreOfType(t,e){return t.every((t=>t.device===e))}onPointerDown({allPointers:t}){var e;let n=!1;const i=this.allPointersAreOfType(t,b.Touch),r=this.allPointersAreOfType(t,b.RightButtonMouse);if(i&&2===t.length&&this.mode&z.TwoFingerTouchGestures){const{screenCenter:e,angle:i,dist:r}=this.computePinchData(t[0],t[1]);this.lastAngle=i,this.lastDist=r,this.lastScreenCenter=e,n=!0}else 1===t.length&&(this.mode&z.OneFingerTouchGestures&&i||r&&this.mode&z.RightClickDrags||this.mode&z.SinglePointerGestures)&&(this.lastScreenCenter=t[0].screenPos,n=!0);return n&&(null!==(e=this.transform)&&void 0!==e||(this.transform=k.transformBy(d.identity)),this.editor.display.setDraftMode(!0)),n}getCenterDelta(t){return this.editor.viewport.screenToCanvasTransform.transformVec3(t.minus(this.lastScreenCenter))}handleTwoFingerMove(t){const{screenCenter:e,canvasCenter:n,angle:i,dist:r}=this.computePinchData(t[0],t[1]),o=this.getCenterDelta(e);let s=i-this.lastAngle;this.isRotationLocked()&&(s=0);const a=d.translation(o).rightMul(d.scaling2D(r/this.lastDist,n)).rightMul(d.zRotation(s,n));this.lastScreenCenter=e,this.lastDist=r,this.lastAngle=i,this.transform=k.transformBy(this.transform.transform.rightMul(a))}handleOneFingerMove(t){const e=this.getCenterDelta(t.screenPos);this.transform=k.transformBy(this.transform.transform.rightMul(d.translation(e))),this.lastScreenCenter=t.screenPos}onPointerMove({allPointers:t}){var e;null!==(e=this.transform)&&void 0!==e||(this.transform=k.transformBy(d.identity));const n=this.transform;2===t.length?this.handleTwoFingerMove(t):1===t.length&&this.handleOneFingerMove(t[0]),n.unapply(this.editor),this.transform.apply(this.editor)}onPointerUp(t){this.transform&&(this.transform.unapply(this.editor),this.editor.dispatch(this.transform,!1)),this.editor.display.setDraftMode(!1),this.transform=null}onGestureCancel(){var t;null===(t=this.transform)||void 0===t||t.unapply(this.editor),this.editor.display.setDraftMode(!1),this.transform=null}updateTransform(t,e=!1){var n;let i=t;this.transform&&(i=this.transform.transform.rightMul(t)),null===(n=this.transform)||void 0===n||n.unapply(this.editor),this.transform=k.transformBy(i),this.transform.apply(this.editor),e&&this.editor.announceForAccessibility(this.transform.description(this.editor,this.editor.localization))}onWheel({delta:t,screenPos:e}){this.transform=k.transformBy(d.identity);const n=this.editor.viewport.screenToCanvas(e),i=this.editor.viewport.screenToCanvasTransform.transformVec3(a.of(-t.x,-t.y,0)),r=d.scaling2D(Math.max(.25,Math.min(Math.pow(1.04,-t.z),4)),n).rightMul(d.translation(i));return this.updateTransform(r,!0),!0}onKeyPress({key:t,ctrlKey:e,altKey:n}){if(!(this.mode&z.Keyboard))return!1;if(e||n)return!1;this.transform=k.transformBy(d.identity);let i=l.zero,r=1,o=0;switch(t){case"a":case"h":case"ArrowLeft":i=l.of(-1,0);break;case"d":case"l":case"ArrowRight":i=l.of(1,0);break;case"q":case"k":case"ArrowUp":i=l.of(0,-1);break;case"e":case"j":case"ArrowDown":i=l.of(0,1);break;case"w":r=.5;break;case"s":r=2;break;case"r":o=1;break;case"R":o=-1;break;default:return!1}i=i.times(30),o*=Math.PI/8,i=i.times(-1),o*=-1,r=1/r,0!==o&&(o+=1e-4),this.isRotationLocked()&&(o=0),i=this.editor.viewport.screenToCanvasTransform.transformVec3(i);const s=this.editor.viewport.visibleRect.center,a=d.scaling2D(r,s).rightMul(d.zRotation(o,s)).rightMul(d.translation(i));return this.updateTransform(a,!0),!0}isRotationLocked(){return!!(this.mode&z.RotationLocked)}setModeEnabled(t,e){let n=this.mode;e?n|=t:n&=~t,this.setMode(n)}setMode(t){t!==this.mode&&(this.mode=t,this.editor.notifier.dispatch(x.ToolUpdated,{kind:x.ToolUpdated,tool:this}))}getMode(){return this.mode}}const{abs:R,cos:I,sin:L,acos:A,atan2:M,sqrt:D,pow:O}=Math;function F(t){return t<0?-O(-t,1/3):O(t,1/3)}const $=Math.PI,N=2*$,j=$/2,U=Number.MAX_SAFE_INTEGER||9007199254740991,V=Number.MIN_SAFE_INTEGER||-9007199254740991,W={x:0,y:0,z:0},H={Tvalues:[-.06405689286260563,.06405689286260563,-.1911188674736163,.1911188674736163,-.3150426796961634,.3150426796961634,-.4337935076260451,.4337935076260451,-.5454214713888396,.5454214713888396,-.6480936519369755,.6480936519369755,-.7401241915785544,.7401241915785544,-.820001985973903,.820001985973903,-.8864155270044011,.8864155270044011,-.9382745520027328,.9382745520027328,-.9747285559713095,.9747285559713095,-.9951872199970213,.9951872199970213],Cvalues:[.12793819534675216,.12793819534675216,.1258374563468283,.1258374563468283,.12167047292780339,.12167047292780339,.1155056680537256,.1155056680537256,.10744427011596563,.10744427011596563,.09761865210411388,.09761865210411388,.08619016153195327,.08619016153195327,.0733464814110803,.0733464814110803,.05929858491543678,.05929858491543678,.04427743881741981,.04427743881741981,.028531388628933663,.028531388628933663,.0123412297999872,.0123412297999872],arcfn:function(t,e){const n=e(t);let i=n.x*n.x+n.y*n.y;return void 0!==n.z&&(i+=n.z*n.z),D(i)},compute:function(t,e,n){if(0===t)return e[0].t=0,e[0];const i=e.length-1;if(1===t)return e[i].t=1,e[i];const r=1-t;let o=e;if(0===i)return e[0].t=t,e[0];if(1===i){const e={x:r*o[0].x+t*o[1].x,y:r*o[0].y+t*o[1].y,t};return n&&(e.z=r*o[0].z+t*o[1].z),e}if(i<4){let e,s,a,l=r*r,c=t*t,h=0;2===i?(o=[o[0],o[1],o[2],W],e=l,s=r*t*2,a=c):3===i&&(e=l*r,s=l*t*3,a=r*c*3,h=t*c);const d={x:e*o[0].x+s*o[1].x+a*o[2].x+h*o[3].x,y:e*o[0].y+s*o[1].y+a*o[2].y+h*o[3].y,t};return n&&(d.z=e*o[0].z+s*o[1].z+a*o[2].z+h*o[3].z),d}const s=JSON.parse(JSON.stringify(e));for(;s.length>1;){for(let e=0;e<s.length-1;e++)s[e]={x:s[e].x+(s[e+1].x-s[e].x)*t,y:s[e].y+(s[e+1].y-s[e].y)*t},void 0!==s[e].z&&(s[e]=s[e].z+(s[e+1].z-s[e].z)*t);s.splice(s.length-1,1)}return s[0].t=t,s[0]},computeWithRatios:function(t,e,n,i){const r=1-t,o=n,s=e;let a,l=o[0],c=o[1],h=o[2],d=o[3];return l*=r,c*=t,2===s.length?(a=l+c,{x:(l*s[0].x+c*s[1].x)/a,y:(l*s[0].y+c*s[1].y)/a,z:!!i&&(l*s[0].z+c*s[1].z)/a,t}):(l*=r,c*=2*r,h*=t*t,3===s.length?(a=l+c+h,{x:(l*s[0].x+c*s[1].x+h*s[2].x)/a,y:(l*s[0].y+c*s[1].y+h*s[2].y)/a,z:!!i&&(l*s[0].z+c*s[1].z+h*s[2].z)/a,t}):(l*=r,c*=1.5*r,h*=3*r,d*=t*t*t,4===s.length?(a=l+c+h+d,{x:(l*s[0].x+c*s[1].x+h*s[2].x+d*s[3].x)/a,y:(l*s[0].y+c*s[1].y+h*s[2].y+d*s[3].y)/a,z:!!i&&(l*s[0].z+c*s[1].z+h*s[2].z+d*s[3].z)/a,t}):void 0))},derive:function(t,e){const n=[];for(let i=t,r=i.length,o=r-1;r>1;r--,o--){const t=[];for(let n,r=0;r<o;r++)n={x:o*(i[r+1].x-i[r].x),y:o*(i[r+1].y-i[r].y)},e&&(n.z=o*(i[r+1].z-i[r].z)),t.push(n);n.push(t),i=t}return n},between:function(t,e,n){return e<=t&&t<=n||H.approximately(t,e)||H.approximately(t,n)},approximately:function(t,e,n){return R(t-e)<=(n||1e-6)},length:function(t){const e=H.Tvalues.length;let n=0;for(let i,r=0;r<e;r++)i=.5*H.Tvalues[r]+.5,n+=H.Cvalues[r]*H.arcfn(i,t);return.5*n},map:function(t,e,n,i,r){return i+(t-e)/(n-e)*(r-i)},lerp:function(t,e,n){const i={x:e.x+t*(n.x-e.x),y:e.y+t*(n.y-e.y)};return void 0!==e.z&&void 0!==n.z&&(i.z=e.z+t*(n.z-e.z)),i},pointToString:function(t){let e=t.x+"/"+t.y;return void 0!==t.z&&(e+="/"+t.z),e},pointsToString:function(t){return"["+t.map(H.pointToString).join(", ")+"]"},copy:function(t){return JSON.parse(JSON.stringify(t))},angle:function(t,e,n){const i=e.x-t.x,r=e.y-t.y,o=n.x-t.x,s=n.y-t.y;return M(i*s-r*o,i*o+r*s)},round:function(t,e){const n=""+t,i=n.indexOf(".");return parseFloat(n.substring(0,i+1+e))},dist:function(t,e){const n=t.x-e.x,i=t.y-e.y;return D(n*n+i*i)},closest:function(t,e){let n,i,r=O(2,63);return t.forEach((function(t,o){i=H.dist(e,t),i<r&&(r=i,n=o)})),{mdist:r,mpos:n}},abcratio:function(t,e){if(2!==e&&3!==e)return!1;if(void 0===t)t=.5;else if(0===t||1===t)return t;const n=O(t,e)+O(1-t,e);return R((n-1)/n)},projectionratio:function(t,e){if(2!==e&&3!==e)return!1;if(void 0===t)t=.5;else if(0===t||1===t)return t;const n=O(1-t,e);return n/(O(t,e)+n)},lli8:function(t,e,n,i,r,o,s,a){const l=(t-n)*(o-a)-(e-i)*(r-s);return 0!=l&&{x:((t*i-e*n)*(r-s)-(t-n)*(r*a-o*s))/l,y:((t*i-e*n)*(o-a)-(e-i)*(r*a-o*s))/l}},lli4:function(t,e,n,i){const r=t.x,o=t.y,s=e.x,a=e.y,l=n.x,c=n.y,h=i.x,d=i.y;return H.lli8(r,o,s,a,l,c,h,d)},lli:function(t,e){return H.lli4(t,t.c,e,e.c)},makeline:function(t,e){return new tt(t.x,t.y,(t.x+e.x)/2,(t.y+e.y)/2,e.x,e.y)},findbbox:function(t){let e=U,n=U,i=V,r=V;return t.forEach((function(t){const o=t.bbox();e>o.x.min&&(e=o.x.min),n>o.y.min&&(n=o.y.min),i<o.x.max&&(i=o.x.max),r<o.y.max&&(r=o.y.max)})),{x:{min:e,mid:(e+i)/2,max:i,size:i-e},y:{min:n,mid:(n+r)/2,max:r,size:r-n}}},shapeintersections:function(t,e,n,i,r){if(!H.bboxoverlap(e,i))return[];const o=[],s=[t.startcap,t.forward,t.back,t.endcap],a=[n.startcap,n.forward,n.back,n.endcap];return s.forEach((function(e){e.virtual||a.forEach((function(i){if(i.virtual)return;const s=e.intersects(i,r);s.length>0&&(s.c1=e,s.c2=i,s.s1=t,s.s2=n,o.push(s))}))})),o},makeshape:function(t,e,n){const i=e.points.length,r=t.points.length,o=H.makeline(e.points[i-1],t.points[0]),s=H.makeline(t.points[r-1],e.points[0]),a={startcap:o,forward:t,back:e,endcap:s,bbox:H.findbbox([o,t,e,s]),intersections:function(t){return H.shapeintersections(a,a.bbox,t,t.bbox,n)}};return a},getminmax:function(t,e,n){if(!n)return{min:0,max:0};let i,r,o=U,s=V;-1===n.indexOf(0)&&(n=[0].concat(n)),-1===n.indexOf(1)&&n.push(1);for(let a=0,l=n.length;a<l;a++)i=n[a],r=t.get(i),r[e]<o&&(o=r[e]),r[e]>s&&(s=r[e]);return{min:o,mid:(o+s)/2,max:s,size:s-o}},align:function(t,e){const n=e.p1.x,i=e.p1.y,r=-M(e.p2.y-i,e.p2.x-n);return t.map((function(t){return{x:(t.x-n)*I(r)-(t.y-i)*L(r),y:(t.x-n)*L(r)+(t.y-i)*I(r)}}))},roots:function(t,e){e=e||{p1:{x:0,y:0},p2:{x:1,y:0}};const n=t.length-1,i=H.align(t,e),r=function(t){return 0<=t&&t<=1};if(2===n){const t=i[0].y,e=i[1].y,n=i[2].y,o=t-2*e+n;if(0!==o){const i=-D(e*e-t*n),s=-t+e;return[-(i+s)/o,-(-i+s)/o].filter(r)}return e!==n&&0===o?[(2*e-n)/(2*e-2*n)].filter(r):[]}const o=i[0].y,s=i[1].y,a=i[2].y;let l=3*s-o-3*a+i[3].y,c=3*o-6*s+3*a,h=-3*o+3*s,d=o;if(H.approximately(l,0)){if(H.approximately(c,0))return H.approximately(h,0)?[]:[-d/h].filter(r);const t=D(h*h-4*c*d),e=2*c;return[(t-h)/e,(-h-t)/e].filter(r)}c/=l,h/=l,d/=l;const u=(3*h-c*c)/3,p=u/3,m=(2*c*c*c-9*c*h+27*d)/27,g=m/2,f=g*g+p*p*p;let v,y,x,b,w;if(f<0){const t=-u/3,e=D(t*t*t),n=-m/(2*e),i=A(n<-1?-1:n>1?1:n),o=2*F(e);return x=o*I(i/3)-c/3,b=o*I((i+N)/3)-c/3,w=o*I((i+2*N)/3)-c/3,[x,b,w].filter(r)}if(0===f)return v=g<0?F(-g):-F(g),x=2*v-c/3,b=-v-c/3,[x,b].filter(r);{const t=D(f);return v=F(-g+t),y=F(g+t),[v-y-c/3].filter(r)}},droots:function(t){if(3===t.length){const e=t[0],n=t[1],i=t[2],r=e-2*n+i;if(0!==r){const t=-D(n*n-e*i),o=-e+n;return[-(t+o)/r,-(-t+o)/r]}return n!==i&&0===r?[(2*n-i)/(2*(n-i))]:[]}if(2===t.length){const e=t[0],n=t[1];return e!==n?[e/(e-n)]:[]}return[]},curvature:function(t,e,n,i,r){let o,s,a,l,c=0,h=0;const d=H.compute(t,e),u=H.compute(t,n),p=d.x*d.x+d.y*d.y;if(i?(o=D(O(d.y*u.z-u.y*d.z,2)+O(d.z*u.x-u.z*d.x,2)+O(d.x*u.y-u.x*d.y,2)),s=O(p+d.z*d.z,1.5)):(o=d.x*u.y-d.y*u.x,s=O(p,1.5)),0===o||0===s)return{k:0,r:0};if(c=o/s,h=s/o,!r){const r=H.curvature(t-.001,e,n,i,!0).k,o=H.curvature(t+.001,e,n,i,!0).k;l=(o-c+(c-r))/2,a=(R(o-c)+R(c-r))/2}return{k:c,r:h,dk:l,adk:a}},inflections:function(t){if(t.length<4)return[];const e=H.align(t,{p1:t[0],p2:t.slice(-1)[0]}),n=e[2].x*e[1].y,i=e[3].x*e[1].y,r=e[1].x*e[2].y,o=18*(-3*n+2*i+3*r-e[3].x*e[2].y),s=18*(3*n-i-3*r),a=18*(r-n);if(H.approximately(o,0)){if(!H.approximately(s,0)){let t=-a/s;if(0<=t&&t<=1)return[t]}return[]}const l=2*o;if(H.approximately(l,0))return[];const c=s*s-4*o*a;if(c<0)return[];const h=Math.sqrt(c);return[(h-s)/l,-(s+h)/l].filter((function(t){return 0<=t&&t<=1}))},bboxoverlap:function(t,e){const n=["x","y"],i=n.length;for(let r,o,s,a,l=0;l<i;l++)if(r=n[l],o=t[r].mid,s=e[r].mid,a=(t[r].size+e[r].size)/2,R(o-s)>=a)return!1;return!0},expandbox:function(t,e){e.x.min<t.x.min&&(t.x.min=e.x.min),e.y.min<t.y.min&&(t.y.min=e.y.min),e.z&&e.z.min<t.z.min&&(t.z.min=e.z.min),e.x.max>t.x.max&&(t.x.max=e.x.max),e.y.max>t.y.max&&(t.y.max=e.y.max),e.z&&e.z.max>t.z.max&&(t.z.max=e.z.max),t.x.mid=(t.x.min+t.x.max)/2,t.y.mid=(t.y.min+t.y.max)/2,t.z&&(t.z.mid=(t.z.min+t.z.max)/2),t.x.size=t.x.max-t.x.min,t.y.size=t.y.max-t.y.min,t.z&&(t.z.size=t.z.max-t.z.min)},pairiteration:function(t,e,n){const i=t.bbox(),r=e.bbox(),o=1e5,s=n||.5;if(i.x.size+i.y.size<s&&r.x.size+r.y.size<s)return[(o*(t._t1+t._t2)/2|0)/o+"/"+(o*(e._t1+e._t2)/2|0)/o];let a=t.split(.5),l=e.split(.5),c=[{left:a.left,right:l.left},{left:a.left,right:l.right},{left:a.right,right:l.right},{left:a.right,right:l.left}];c=c.filter((function(t){return H.bboxoverlap(t.left.bbox(),t.right.bbox())}));let h=[];return 0===c.length||(c.forEach((function(t){h=h.concat(H.pairiteration(t.left,t.right,s))})),h=h.filter((function(t,e){return h.indexOf(t)===e}))),h},getccenter:function(t,e,n){const i=e.x-t.x,r=e.y-t.y,o=n.x-e.x,s=n.y-e.y,a=i*I(j)-r*L(j),l=i*L(j)+r*I(j),c=o*I(j)-s*L(j),h=o*L(j)+s*I(j),d=(t.x+e.x)/2,u=(t.y+e.y)/2,p=(e.x+n.x)/2,m=(e.y+n.y)/2,g=d+a,f=u+l,v=p+c,y=m+h,x=H.lli8(d,u,g,f,p,m,v,y),b=H.dist(x,t);let w,T=M(t.y-x.y,t.x-x.x),S=M(e.y-x.y,e.x-x.x),C=M(n.y-x.y,n.x-x.x);return T<C?((T>S||S>C)&&(T+=N),T>C&&(w=C,C=T,T=w)):C<S&&S<T?(w=C,C=T,T=w):C+=N,x.s=T,x.e=C,x.r=b,x},numberSort:function(t,e){return t-e}};class G{constructor(t){this.curves=[],this._3d=!1,t&&(this.curves=t,this._3d=this.curves[0]._3d)}valueOf(){return this.toString()}toString(){return"["+this.curves.map((function(t){return H.pointsToString(t.points)})).join(", ")+"]"}addCurve(t){this.curves.push(t),this._3d=this._3d||t._3d}length(){return this.curves.map((function(t){return t.length()})).reduce((function(t,e){return t+e}))}curve(t){return this.curves[t]}bbox(){const t=this.curves;for(var e=t[0].bbox(),n=1;n<t.length;n++)H.expandbox(e,t[n].bbox());return e}offset(t){const e=[];return this.curves.forEach((function(n){e.push(...n.offset(t))})),new G(e)}}const{abs:_,min:q,max:K,cos:Z,sin:X,acos:Y,sqrt:J}=Math,Q=Math.PI;class tt{constructor(t){let e=t&&t.forEach?t:Array.from(arguments).slice(),n=!1;if("object"==typeof e[0]){n=e.length;const t=[];e.forEach((function(e){["x","y","z"].forEach((function(n){void 0!==e[n]&&t.push(e[n])}))})),e=t}let i=!1;const r=e.length;if(n){if(n>4){if(1!==arguments.length)throw new Error("Only new Bezier(point[]) is accepted for 4th and higher order curves");i=!0}}else if(6!==r&&8!==r&&9!==r&&12!==r&&1!==arguments.length)throw new Error("Only new Bezier(point[]) is accepted for 4th and higher order curves");const o=this._3d=!i&&(9===r||12===r)||t&&t[0]&&void 0!==t[0].z,s=this.points=[];for(let t=0,n=o?3:2;t<r;t+=n){var a={x:e[t],y:e[t+1]};o&&(a.z=e[t+2]),s.push(a)}const l=this.order=s.length-1,c=this.dims=["x","y"];o&&c.push("z"),this.dimlen=c.length;const h=H.align(s,{p1:s[0],p2:s[l]}),d=H.dist(s[0],s[l]);this._linear=h.reduce(((t,e)=>t+_(e.y)),0)<d/50,this._lut=[],this._t1=0,this._t2=1,this.update()}static quadraticFromPoints(t,e,n,i){if(void 0===i&&(i=.5),0===i)return new tt(e,e,n);if(1===i)return new tt(t,e,e);const r=tt.getABC(2,t,e,n,i);return new tt(t,r.A,n)}static cubicFromPoints(t,e,n,i,r){void 0===i&&(i=.5);const o=tt.getABC(3,t,e,n,i);void 0===r&&(r=H.dist(e,o.C));const s=r*(1-i)/i,a=H.dist(t,n),l=(n.x-t.x)/a,c=(n.y-t.y)/a,h=r*l,d=r*c,u=s*l,p=s*c,m=e.x-h,g=e.y-d,f=e.x+u,v=e.y+p,y=o.A,x=y.x+(m-y.x)/(1-i),b=y.y+(g-y.y)/(1-i),w=y.x+(f-y.x)/i,T=y.y+(v-y.y)/i,S={x:t.x+(x-t.x)/i,y:t.y+(b-t.y)/i},C={x:n.x+(w-n.x)/(1-i),y:n.y+(T-n.y)/(1-i)};return new tt(t,S,C,n)}static getUtils(){return H}getUtils(){return tt.getUtils()}static get PolyBezier(){return G}valueOf(){return this.toString()}toString(){return H.pointsToString(this.points)}toSVG(){if(this._3d)return!1;const t=this.points,e=["M",t[0].x,t[0].y,2===this.order?"Q":"C"];for(let n=1,i=t.length;n<i;n++)e.push(t[n].x),e.push(t[n].y);return e.join(" ")}setRatios(t){if(t.length!==this.points.length)throw new Error("incorrect number of ratio values");this.ratios=t,this._lut=[]}verify(){const t=this.coordDigest();t!==this._print&&(this._print=t,this.update())}coordDigest(){return this.points.map((function(t,e){return""+e+t.x+t.y+(t.z?t.z:0)})).join("")}update(){this._lut=[],this.dpoints=H.derive(this.points,this._3d),this.computedirection()}computedirection(){const t=this.points,e=H.angle(t[0],t[this.order],t[1]);this.clockwise=e>0}length(){return H.length(this.derivative.bind(this))}static getABC(t=2,e,n,i,r=.5){const o=H.projectionratio(r,t),s=1-o,a={x:o*e.x+s*i.x,y:o*e.y+s*i.y},l=H.abcratio(r,t);return{A:{x:n.x+(n.x-a.x)/l,y:n.y+(n.y-a.y)/l},B:n,C:a,S:e,E:i}}getABC(t,e){e=e||this.get(t);let n=this.points[0],i=this.points[this.order];return tt.getABC(this.order,n,e,i,t)}getLUT(t){if(this.verify(),t=t||100,this._lut.length===t)return this._lut;this._lut=[],t++,this._lut=[];for(let e,n,i=0;i<t;i++)n=i/(t-1),e=this.compute(n),e.t=n,this._lut.push(e);return this._lut}on(e,n){n=n||5;const i=this.getLUT(),r=[];for(let t,o=0,s=0;o<i.length;o++)t=i[o],H.dist(t,e)<n&&(r.push(t),s+=o/i.length);return!!r.length&&(t/=r.length)}project(t){const e=this.getLUT(),n=e.length-1,i=H.closest(e,t),r=i.mpos,o=(r-1)/n,s=(r+1)/n,a=.1/n;let l,c,h=i.mdist,d=o,u=d;for(h+=1;d<s+a;d+=a)l=this.compute(d),c=H.dist(t,l),c<h&&(h=c,u=d);return u=u<0?0:u>1?1:u,l=this.compute(u),l.t=u,l.d=h,l}get(t){return this.compute(t)}point(t){return this.points[t]}compute(t){return this.ratios?H.computeWithRatios(t,this.points,this.ratios,this._3d):H.compute(t,this.points,this._3d,this.ratios)}raise(){const t=this.points,e=[t[0]],n=t.length;for(let i,r,o=1;o<n;o++)i=t[o],r=t[o-1],e[o]={x:(n-o)/n*i.x+o/n*r.x,y:(n-o)/n*i.y+o/n*r.y};return e[n]=t[n-1],new tt(e)}derivative(t){return H.compute(t,this.dpoints[0],this._3d)}dderivative(t){return H.compute(t,this.dpoints[1],this._3d)}align(){let t=this.points;return new tt(H.align(t,{p1:t[0],p2:t[t.length-1]}))}curvature(t){return H.curvature(t,this.dpoints[0],this.dpoints[1],this._3d)}inflections(){return H.inflections(this.points)}normal(t){return this._3d?this.__normal3(t):this.__normal2(t)}__normal2(t){const e=this.derivative(t),n=J(e.x*e.x+e.y*e.y);return{t,x:-e.y/n,y:e.x/n}}__normal3(t){const e=this.derivative(t),n=this.derivative(t+.01),i=J(e.x*e.x+e.y*e.y+e.z*e.z),r=J(n.x*n.x+n.y*n.y+n.z*n.z);e.x/=i,e.y/=i,e.z/=i,n.x/=r,n.y/=r,n.z/=r;const o={x:n.y*e.z-n.z*e.y,y:n.z*e.x-n.x*e.z,z:n.x*e.y-n.y*e.x},s=J(o.x*o.x+o.y*o.y+o.z*o.z);o.x/=s,o.y/=s,o.z/=s;const a=[o.x*o.x,o.x*o.y-o.z,o.x*o.z+o.y,o.x*o.y+o.z,o.y*o.y,o.y*o.z-o.x,o.x*o.z-o.y,o.y*o.z+o.x,o.z*o.z];return{t,x:a[0]*e.x+a[1]*e.y+a[2]*e.z,y:a[3]*e.x+a[4]*e.y+a[5]*e.z,z:a[6]*e.x+a[7]*e.y+a[8]*e.z}}hull(t){let e=this.points,n=[],i=[],r=0;for(i[r++]=e[0],i[r++]=e[1],i[r++]=e[2],3===this.order&&(i[r++]=e[3]);e.length>1;){n=[];for(let o,s=0,a=e.length-1;s<a;s++)o=H.lerp(t,e[s],e[s+1]),i[r++]=o,n.push(o);e=n}return i}split(t,e){if(0===t&&e)return this.split(e).left;if(1===e)return this.split(t).right;const n=this.hull(t),i={left:2===this.order?new tt([n[0],n[3],n[5]]):new tt([n[0],n[4],n[7],n[9]]),right:2===this.order?new tt([n[5],n[4],n[2]]):new tt([n[9],n[8],n[6],n[3]]),span:n};return i.left._t1=H.map(0,0,1,this._t1,this._t2),i.left._t2=H.map(t,0,1,this._t1,this._t2),i.right._t1=H.map(t,0,1,this._t1,this._t2),i.right._t2=H.map(1,0,1,this._t1,this._t2),e?(e=H.map(e,t,1,0,1),i.right.split(e).left):i}extrema(){const t={};let e=[];return this.dims.forEach(function(n){let i=function(t){return t[n]},r=this.dpoints[0].map(i);t[n]=H.droots(r),3===this.order&&(r=this.dpoints[1].map(i),t[n]=t[n].concat(H.droots(r))),t[n]=t[n].filter((function(t){return t>=0&&t<=1})),e=e.concat(t[n].sort(H.numberSort))}.bind(this)),t.values=e.sort(H.numberSort).filter((function(t,n){return e.indexOf(t)===n})),t}bbox(){const t=this.extrema(),e={};return this.dims.forEach(function(n){e[n]=H.getminmax(this,n,t[n])}.bind(this)),e}overlaps(t){const e=this.bbox(),n=t.bbox();return H.bboxoverlap(e,n)}offset(t,e){if(void 0!==e){const n=this.get(t),i=this.normal(t),r={c:n,n:i,x:n.x+i.x*e,y:n.y+i.y*e};return this._3d&&(r.z=n.z+i.z*e),r}if(this._linear){const e=this.normal(0),n=this.points.map((function(n){const i={x:n.x+t*e.x,y:n.y+t*e.y};return n.z&&e.z&&(i.z=n.z+t*e.z),i}));return[new tt(n)]}return this.reduce().map((function(e){return e._linear?e.offset(t)[0]:e.scale(t)}))}simple(){if(3===this.order){const t=H.angle(this.points[0],this.points[3],this.points[1]),e=H.angle(this.points[0],this.points[3],this.points[2]);if(t>0&&e<0||t<0&&e>0)return!1}const t=this.normal(0),e=this.normal(1);let n=t.x*e.x+t.y*e.y;return this._3d&&(n+=t.z*e.z),_(Y(n))<Q/3}reduce(){let t,e,n=0,i=0,r=.01,o=[],s=[],a=this.extrema().values;for(-1===a.indexOf(0)&&(a=[0].concat(a)),-1===a.indexOf(1)&&a.push(1),n=a[0],t=1;t<a.length;t++)i=a[t],e=this.split(n,i),e._t1=n,e._t2=i,o.push(e),n=i;return o.forEach((function(t){for(n=0,i=0;i<=1;)for(i=n+r;i<=1.01;i+=r)if(e=t.split(n,i),!e.simple()){if(i-=r,_(n-i)<r)return[];e=t.split(n,i),e._t1=H.map(n,0,1,t._t1,t._t2),e._t2=H.map(i,0,1,t._t1,t._t2),s.push(e),n=i;break}n<1&&(e=t.split(n,1),e._t1=H.map(n,0,1,t._t1,t._t2),e._t2=t._t2,s.push(e))})),s}translate(t,e,n){n="number"==typeof n?n:e;const i=this.order;let r=this.points.map(((t,r)=>(1-r/i)*e+r/i*n));return new tt(this.points.map(((e,n)=>({x:e.x+t.x*r[n],y:e.y+t.y*r[n]}))))}scale(t){const e=this.order;let n=!1;if("function"==typeof t&&(n=t),n&&2===e)return this.raise().scale(n);const i=this.clockwise,r=this.points;if(this._linear)return this.translate(this.normal(0),n?n(0):t,n?n(1):t);const o=n?n(0):t,s=n?n(1):t,a=[this.offset(0,10),this.offset(1,10)],l=[],c=H.lli4(a[0],a[0].c,a[1],a[1].c);if(!c)throw new Error("cannot scale this curve. Try reducing it first.");return[0,1].forEach((function(t){const n=l[t*e]=H.copy(r[t*e]);n.x+=(t?s:o)*a[t].n.x,n.y+=(t?s:o)*a[t].n.y})),n?([0,1].forEach((function(o){if(2!==e||!o){var s=r[o+1],a={x:s.x-c.x,y:s.y-c.y},h=n?n((o+1)/e):t;n&&!i&&(h=-h);var d=J(a.x*a.x+a.y*a.y);a.x/=d,a.y/=d,l[o+1]={x:s.x+h*a.x,y:s.y+h*a.y}}})),new tt(l)):([0,1].forEach((t=>{if(2===e&&t)return;const n=l[t*e],i=this.derivative(t),o={x:n.x+i.x,y:n.y+i.y};l[t+1]=H.lli4(n,o,c,r[t+1])})),new tt(l))}outline(t,e,n,i){if(e=void 0===e?t:e,this._linear){const r=this.normal(0),o=this.points[0],s=this.points[this.points.length-1];let a,l,c;void 0===n&&(n=t,i=e),a={x:o.x+r.x*t,y:o.y+r.y*t},c={x:s.x+r.x*n,y:s.y+r.y*n},l={x:(a.x+c.x)/2,y:(a.y+c.y)/2};const h=[a,l,c];a={x:o.x-r.x*e,y:o.y-r.y*e},c={x:s.x-r.x*i,y:s.y-r.y*i},l={x:(a.x+c.x)/2,y:(a.y+c.y)/2};const d=[c,l,a],u=H.makeline(d[2],h[0]),p=H.makeline(h[2],d[0]),m=[u,new tt(h),p,new tt(d)];return new G(m)}const r=this.reduce(),o=r.length,s=[];let a,l=[],c=0,h=this.length();const d=void 0!==n&&void 0!==i;function u(t,e,n,i,r){return function(o){const s=i/n,a=(i+r)/n,l=e-t;return H.map(o,0,1,t+s*l,t+a*l)}}r.forEach((function(r){const o=r.length();d?(s.push(r.scale(u(t,n,h,c,o))),l.push(r.scale(u(-e,-i,h,c,o)))):(s.push(r.scale(t)),l.push(r.scale(-e))),c+=o})),l=l.map((function(t){return a=t.points,a[3]?t.points=[a[3],a[2],a[1],a[0]]:t.points=[a[2],a[1],a[0]],t})).reverse();const p=s[0].points[0],m=s[o-1].points[s[o-1].points.length-1],g=l[o-1].points[l[o-1].points.length-1],f=l[0].points[0],v=H.makeline(g,p),y=H.makeline(m,f),x=[v].concat(s).concat([y]).concat(l);return new G(x)}outlineshapes(t,e,n){e=e||t;const i=this.outline(t,e).curves,r=[];for(let t=1,e=i.length;t<e/2;t++){const o=H.makeshape(i[t],i[e-t],n);o.startcap.virtual=t>1,o.endcap.virtual=t<e/2-1,r.push(o)}return r}intersects(t,e){return t?t.p1&&t.p2?this.lineIntersects(t):(t instanceof tt&&(t=t.reduce()),this.curveintersects(this.reduce(),t,e)):this.selfintersects(e)}lineIntersects(t){const e=q(t.p1.x,t.p2.x),n=q(t.p1.y,t.p2.y),i=K(t.p1.x,t.p2.x),r=K(t.p1.y,t.p2.y);return H.roots(this.points,t).filter((t=>{var o=this.get(t);return H.between(o.x,e,i)&&H.between(o.y,n,r)}))}selfintersects(t){const e=this.reduce(),n=e.length-2,i=[];for(let r,o,s,a=0;a<n;a++)o=e.slice(a,a+1),s=e.slice(a+2),r=this.curveintersects(o,s,t),i.push(...r);return i}curveintersects(t,e,n){const i=[];t.forEach((function(t){e.forEach((function(e){t.overlaps(e)&&i.push({left:t,right:e})}))}));let r=[];return i.forEach((function(t){const e=H.pairiteration(t.left,t.right,n);e.length>0&&(r=r.concat(e))})),r}arcs(t){return t=t||.5,this._iterate(t,[])}_error(t,e,n,i){const r=(i-n)/4,o=this.get(n+r),s=this.get(i-r),a=H.dist(t,e),l=H.dist(t,o),c=H.dist(t,s);return _(l-a)+_(c-a)}_iterate(t,e){let n,i=0,r=1;do{n=0,r=1;let o,s,a,l,c,h=this.get(i),d=!1,u=!1,p=r,m=1,g=0;do{if(u=d,l=a,p=(i+r)/2,g++,o=this.get(p),s=this.get(r),a=H.getccenter(h,o,s),a.interval={start:i,end:r},d=this._error(a,h,i,r)<=t,c=u&&!d,c||(m=r),d){if(r>=1){if(a.interval.end=m=1,l=a,r>1){let t={x:a.x+a.r*Z(a.e),y:a.y+a.r*X(a.e)};a.e+=H.angle({x:a.x,y:a.y},t,this.get(1))}break}r+=(r-i)/2}else r=p}while(!c&&n++<100);if(n>=100)break;l=l||a,e.push(l),i=m}while(r<1);return e}}const et=t=>{if(t.indexOf("e")>0&&t.match(/[eE][-]\d{2,}$/))return"0";const e=t.charAt(t.length-1);"0"!==e&&"."!==e||(t=(t=(t=t.replace(/([.]\d*[^0]+)0+$/,"$1")).replace(/[.]0+$/,".")).replace(/[.]$/,""));const n=t.charAt(0);return"0"!==n&&"-"!==n||(t=(t=(t=t.replace(/^(0+)[.]/,".")).replace(/^-(0+)[.]/,"-.")).replace(/^(-?)0+$/,"$10")),"-0"===t?"0":t},nt=t=>{let e=t.toString(10);if(-1===e.indexOf("."))return e;const n=/^([-]?)(\d*)\.(\d{3,}9{4,})\d{1,4}$/.exec(e);if(n){const t=n[1],i=n[3],r=parseInt(i.charAt(i.length-1),10),o=parseInt(i,10),s=parseInt(n[2],10),a=n[3];let l=(o+10-r).toString(),c=0;for(l.length>o.toString().length&&(l=l.substring(1),c=1);l.length<a.length;)l=c.toString(10)+l,c=0;e=`${t+(s+c).toString()}.${l}`}return e=e.replace(/^([-]?\d*\.\d{3,})0{4,}\d{1,4}$/,"$1"),et(e)},it=/^([-]?)(\d*)[.](\d+)$/,rt=t=>{const e=it.exec(t);return e?e[3].length:-1!==t.search(/[eE]/)||/^[a-zA-Z]+$/.exec(t)?-1:0},ot=(t,...e)=>{const n=t.toString(10),i=it.exec(n);if(!i)return n;let r=-1;for(const t of e)r=Math.max(rt(t),r);if(-1===r)return nt(t);let o=i[3].substring(0,r),s=i[2];const a=i[3].charAt(r);if(""!==a&&parseInt(a,10)>=5){if(o.length>0){const t=/^(0+)(\d*)$/.exec(o);let e="",n=o;t&&(e=t[1],n=t[2]),o=(parseInt(o)+1).toString(),o.length>n.length&&e.length>0&&(e=e.substring(1)),o=e+o}(0===o.length||o.length>r)&&(s=(parseInt(s)+1).toString(),o=o.substring(1))}const l=i[1];return et(`${l}${s}.${o}`)};var st;!function(t){t[t.LineTo=0]="LineTo",t[t.MoveTo=1]="MoveTo",t[t.CubicBezierTo=2]="CubicBezierTo",t[t.QuadraticBezierTo=3]="QuadraticBezierTo"}(st||(st={}));class at{constructor(t,e){this.startPoint=t,this.parts=e,this.cachedGeometry=null,this.cachedPolylineApproximation=null,this.cachedStringVersion=null,this.bbox=m.bboxOf([t]);for(const n of e)this.bbox=this.bbox.union(at.computeBBoxForSegment(t,n))}get geometry(){if(this.cachedGeometry)return this.cachedGeometry;let t=this.startPoint;const e=[];for(const n of this.parts)switch(n.kind){case st.CubicBezierTo:e.push(new tt(t.xy,n.controlPoint1.xy,n.controlPoint2.xy,n.endPoint.xy)),t=n.endPoint;break;case st.QuadraticBezierTo:e.push(new tt(t.xy,n.controlPoint.xy,n.endPoint.xy)),t=n.endPoint;break;case st.LineTo:e.push(new p(t,n.point)),t=n.point;break;case st.MoveTo:t=n.point}return this.cachedGeometry=e,this.cachedGeometry}polylineApproximation(){if(this.cachedPolylineApproximation)return this.cachedPolylineApproximation;const t=[];for(const e of this.parts)switch(e.kind){case st.CubicBezierTo:t.push(e.controlPoint1,e.controlPoint2,e.endPoint);break;case st.QuadraticBezierTo:t.push(e.controlPoint,e.endPoint);break;case st.MoveTo:case st.LineTo:t.push(e.point)}const e=[];let n=this.startPoint;for(const i of t)e.push(new p(n,i)),n=i;return e}static computeBBoxForSegment(t,e){const n=[t];let i;switch(e.kind){case st.MoveTo:case st.LineTo:n.push(e.point);break;case st.CubicBezierTo:n.push(e.controlPoint1,e.controlPoint2,e.endPoint);break;case st.QuadraticBezierTo:n.push(e.controlPoint,e.endPoint);break;default:return i=e,i}return m.bboxOf(n)}intersection(t){if(!t.bbox.intersects(this.bbox))return[];const e=[];for(const n of this.geometry)if(n instanceof p){const i=n.intersection(t);i&&e.push({curve:n,parameterValue:i.t,point:i.point})}else{const i=n.intersects(t).map((e=>{"string"==typeof e&&(e=parseFloat(e));const i=l.ofXY(n.get(e));return i.minus(t.p1).magnitude()>t.length||i.minus(t.p2).magnitude()>t.length?null:{point:i,parameterValue:e,curve:n}})).filter((t=>null!==t));e.push(...i)}return e}mapPoints(t){const e=t(this.startPoint),n=[];let i;for(const e of this.parts)switch(e.kind){case st.MoveTo:case st.LineTo:n.push({kind:e.kind,point:t(e.point)});break;case st.CubicBezierTo:n.push({kind:e.kind,controlPoint1:t(e.controlPoint1),controlPoint2:t(e.controlPoint2),endPoint:t(e.endPoint)});break;case st.QuadraticBezierTo:n.push({kind:e.kind,controlPoint:t(e.controlPoint),endPoint:t(e.endPoint)});break;default:return i=e,i}return new at(e,n)}transformedBy(t){return this.mapPoints((e=>t.transformVec2(e)))}union(t){return t?new at(this.startPoint,[...this.parts,{kind:st.MoveTo,point:t.startPoint},...t.parts]):this}getEndPoint(){if(0===this.parts.length)return this.startPoint;const t=this.parts[this.parts.length-1];return t.kind===st.QuadraticBezierTo||t.kind===st.CubicBezierTo?t.endPoint:t.point}roughlyIntersects(t,e=0){if(0===this.parts.length)return t.containsPoint(this.startPoint);if(this.startPoint.eq(this.getEndPoint())&&0===e)return this.closedRoughlyIntersects(t);if(t.containsRect(this.bbox))return!0;let n=this.startPoint;for(const i of this.parts){const r=at.computeBBoxForSegment(n,i).grownBy(e);if(n=i.kind===st.LineTo||i.kind===st.MoveTo?i.point:i.endPoint,t.intersects(r))return!0}return!1}closedRoughlyIntersects(t){if(t.containsRect(this.bbox))return!0;const e=this.bbox.topLeft.minus(l.of(1,1)),n=t.corners,i=this.polylineApproximation();for(const t of n){const n=new p(t,e);let r=0;for(const t of i)t.intersects(n)&&r++;if(r%2==1)return!0}const r=t.grownBy(Math.min(t.size.x,t.size.y)),o=[];for(const t of r.divideIntoGrid(4,4))o.push(...t.getEdges());for(const t of o)for(const e of i)if(t.intersects(e))return!0;return!1}static fromRect(t,e=null){const n=[];let i,r;if(null!==e){const n=l.of(e,e).times(.5),o=m.fromCorners(t.topLeft.plus(n),t.bottomRight.minus(n)),s=m.fromCorners(t.topLeft.minus(n),t.bottomRight.plus(n));i=[o.corners[3],...o.corners,...s.corners.reverse()],r=s.corners[3]}else i=t.corners.slice(1),r=t.corners[0];for(const t of i)n.push({kind:st.LineTo,point:t});return n.push({kind:st.LineTo,point:r}),new at(r,n)}static fromRenderable(t){return t.path?t.path:new at(t.startPoint,t.commands)}toRenderable(t){return{startPoint:this.startPoint,style:t,commands:this.parts,path:this}}toString(t){if(this.cachedStringVersion)return this.cachedStringVersion;void 0===t&&(t=Math.abs(this.bbox.topLeft.x)>10&&Math.abs(this.bbox.topLeft.y)>10);const e=at.toString(this.startPoint,this.parts,!t);return this.cachedStringVersion=e,e}serialize(){return this.toString()}static toString(t,e,n){const i=[];let r;const o=(t,...e)=>{const o=[],s=[],a=!r||n,l=r?nt(r.x):"",c=r?nt(r.y):"";for(const t of e){const e=nt(t.x),n=nt(t.y);if(a)o.push(`${e},${n}`);else{const i=ot(t.x-r.x,e,l,c),o=ot(t.y-r.y,n,l,c);"-"===o.charAt(0)?s.push(`${i}${o}`):s.push(`${i},${o}`)}}let h;h=a?`${t}${o.join(" ")}`:`${t.toLowerCase()}${s.join(" ")}`,"l0,0"!==h&&(i.push(h),e.length>0&&(r=e[e.length-1]))};let s;o("M",t);for(const t of e)switch(t.kind){case st.MoveTo:o("M",t.point);break;case st.LineTo:o("L",t.point);break;case st.CubicBezierTo:o("C",t.controlPoint1,t.controlPoint2,t.endPoint);break;case st.QuadraticBezierTo:o("Q",t.controlPoint,t.endPoint);break;default:return s=t,s}return i.join("")}static fromString(t){var e;t=t.split("\n").join(" ");let n=l.zero,i=null,r=null,o=!0;const s=[],a=t=>{o?o=!1:s.push({kind:st.LineTo,point:t})},c={m:1,l:1,c:3,q:2,z:0,h:1,v:1},h=/([MZLHVCSQTA])\s*([^MZLHVCSQTA]*)/gi;let d;for(;null!==(d=h.exec(t));){const t=d[2].trim().split(/[^0-9Ee.-]/).filter((t=>t.length>0)).reduce(((t,e)=>{const n=(e=e.replace(/([^eE])[-]/g,"$1 -")).split(" -");return""!==n[0]&&t.push(n[0]),t.push(...n.slice(1).map((t=>`-${t}`))),t}),[]);let h=t.map((t=>parseFloat(t))),y=d[1].toLowerCase(),x=d[1]!==y;if("v"===y||"h"===y)h=h.reduce(((t,e)=>"v"===y?t.concat(x?n.x:0,e):t.concat(e,x?n.y:0)),[]),y="l";else if("z"===y){if(!i)continue;h=[i.x,i.y],i=n,x=!0,y="l"}const b=null!==(e=c[y])&&void 0!==e?e:0,w=h.reduce(((t,e,n,i)=>{if(n%2!=0){const r=e,o=i[n-1];return t.concat(l.of(o,r))}return t}),[]).map(((t,e)=>{let i;return i=x?t:n.plus(t),(e+1)%b==0&&(n=i),i}));if(w.length%b!=0)throw new Error([`Incorrect number of arguments: got ${JSON.stringify(w)} with a length of ${w.length} ≠ ${b}k, k ∈ ℤ.`,`The number of arguments to ${y} must be a multiple of ${b}!`,`Command: ${d[0]}`].join("\n"));for(let t=0;t<w.length;t+=b){const e=w.slice(t,t+b);switch(y.toLowerCase()){case"m":0===t?(v=e[0],o?o=!1:s.push({kind:st.MoveTo,point:v})):a(e[0]);break;case"l":a(e[0]);break;case"c":m=e[0],g=e[1],f=e[2],s.push({kind:st.CubicBezierTo,controlPoint1:m,controlPoint2:g,endPoint:f});break;case"q":u=e[0],p=e[1],s.push({kind:st.QuadraticBezierTo,controlPoint:u,endPoint:p});break;default:throw new Error(`Unknown path command ${y}`)}o=!1}w.length>0&&(null!=i||(i=w[0]),null!=r||(r=i),n=w[w.length-1])}var u,p,m,g,f,v;const y=new at(null!=r?r:l.zero,s);return y.cachedStringVersion=t,y}}at.empty=new at(l.zero,[]);class lt{constructor(t,e,n,i){this.r=t,this.g=e,this.b=n,this.a=i,this.hexString=null}static ofRGB(t,e,n){return lt.ofRGBA(t,e,n,1)}static ofRGBA(t,e,n,i){return t=Math.max(0,Math.min(t,1)),e=Math.max(0,Math.min(e,1)),n=Math.max(0,Math.min(n,1)),i=Math.max(0,Math.min(i,1)),new lt(t,e,n,i)}static fromHex(t){var e;if(!(t=(t=(null!==(e=t.match(/^[#]?(.*)$/))&&void 0!==e?e:[])[1]).toUpperCase()).match(/^[0-9A-F]+$/))throw new Error(`${t} is not in a valid format.`);if(3===t.length||4===t.length){const e=t.split("");t=e.map((t=>`${t}0`)).join("")}6===t.length&&(t+="FF");const n=[];for(let e=2;e<=t.length;e+=2){const i=t.substring(e-2,e);n.push(parseInt(i,16)/255)}if(4!==n.length)throw new Error(`Unable to parse ${t}: Wrong number of components.`);return lt.ofRGBA(n[0],n[1],n[2],n[3])}static fromString(t){if(t.startsWith("#"))return lt.fromHex(t);if("none"===t||"transparent"===t)return lt.transparent;{const e=document.createElement("canvas");e.width=1,e.height=1;const n=e.getContext("2d");n.fillStyle=t,n.fillRect(0,0,1,1);const i=n.getImageData(0,0,1,1),r=i.data[0]/255,o=i.data[1]/255,s=i.data[2]/255,a=i.data[3]/255;return lt.ofRGBA(r,o,s,a)}}eq(t){return null!=t&&this.toHexString()===t.toHexString()}toHexString(){if(this.hexString)return this.hexString;const t=t=>{const e=Math.round(255*t).toString(16);return 1===e.length?`0${e}`:e},e=t(this.a),n=t(this.r),i=t(this.g),r=t(this.b);return"ff"===e?`#${n}${i}${r}`:(this.hexString=`#${n}${i}${r}${e}`,this.hexString)}}lt.transparent=lt.ofRGBA(0,0,0,0),lt.red=lt.ofRGB(1,0,0),lt.green=lt.ofRGB(0,1,0),lt.blue=lt.ofRGB(0,0,1),lt.purple=lt.ofRGB(.5,.2,.5),lt.yellow=lt.ofRGB(1,1,.1),lt.clay=lt.ofRGB(.8,.4,.2),lt.black=lt.ofRGB(0,0,0),lt.white=lt.ofRGB(1,1,1);const ct=(t,e)=>{var n,i,r,o,s,a;const l=t===e||t.fill.eq(e.fill)&&null==t.stroke==(null==e.stroke)&&(null===(o=null===(i=null===(n=t.stroke)||void 0===n?void 0:n.color)||void 0===i?void 0:i.eq(null===(r=e.stroke)||void 0===r?void 0:r.color))||void 0===o||o)&&(null===(s=t.stroke)||void 0===s?void 0:s.width)===(null===(a=e.stroke)||void 0===a?void 0:a.width);return null!=l&&l},ht=t=>{const e=t.stroke?{color:t.stroke.color.toHexString(),width:t.stroke.width}:void 0;return{fill:t.fill.toHexString(),stroke:e}},dt=t=>{const e=t.stroke?{color:lt.fromHex(t.stroke.color),width:t.stroke.width}:void 0;return{fill:lt.fromHex(t.fill),stroke:e}};class ut extends u{constructor(t){var e;super("stroke"),this.parts=[];for(const e of t){const t=at.fromRenderable(e),n=this.bboxForPart(t.bbox,e.style);this.contentBBox?this.contentBBox=this.contentBBox.union(n):this.contentBBox=n,this.parts.push({path:t,startPoint:t.startPoint,style:e.style,commands:t.parts})}null!==(e=this.contentBBox)&&void 0!==e||(this.contentBBox=m.empty)}intersects(t){for(const e of this.parts)if(e.path.intersection(t).length>0)return!0;return!1}render(t,e){var n,i;t.startObject(this.getBBox());for(const r of this.parts){const o=this.bboxForPart(r.path.bbox,r.style);if(e){if(!o.intersects(e))continue;if((o.size.x>2*e.size.x||o.size.y>2*e.size.y)&&!r.path.roughlyIntersects(e,null!==(i=null===(n=r.style.stroke)||void 0===n?void 0:n.width)&&void 0!==i?i:0))continue}t.drawPath(r)}t.endObject(this.getLoadSaveData())}bboxForPart(t,e){return e.stroke?t.grownBy(e.stroke.width/2):t}applyTransformation(t){this.contentBBox=m.empty;let e=!0;this.parts=this.parts.map((n=>{const i=n.path.transformedBy(t),r=Object.assign(Object.assign({},n.style),{stroke:n.style.stroke?Object.assign({},n.style.stroke):void 0});if(r.stroke){const e=t.getScaleFactor();r.stroke.width*=e}const o=this.bboxForPart(i.bbox,r);return e?(this.contentBBox=o,e=!1):this.contentBBox=this.contentBBox.union(o),{path:i,startPoint:i.startPoint,commands:i.parts,style:r}}))}getPath(){let t=null;for(const e of this.parts)t?t=t.union(e.path):null!=t||(t=e.path);return null!=t?t:at.empty}description(t){return t.stroke}createClone(){return new ut(this.parts)}serializeToJSON(){return this.parts.map((t=>({style:ht(t.style),path:t.path.serialize()})))}static deserializeFromJSON(t){if("string"==typeof t&&(t=JSON.parse(t)),"object"!=typeof t||"number"!=typeof t.length)throw new Error(`${t} is missing required field, parts, or parts is of the wrong type.`);const e=t.map((t=>{const e=dt(t.style);return at.fromString(t.path).toRenderable(e)}));return new ut(e)}}u.registerComponent("stroke",ut.deserializeFromJSON);class pt{constructor(t,e,n,i){this.startPoint=t,this.minFitAllowed=e,this.maxFitAllowed=n,this.onCurveAdded=i,this.isFirstSegment=!0,this.lastExitingVec=null,this.currentCurve=null,this.lastPoint=this.startPoint,this.buffer=[this.startPoint.pos],this.momentum=l.zero,this.currentCurve=null,this.curveStartWidth=t.width,this.bbox=new m(this.startPoint.pos.x,this.startPoint.pos.y,0,0)}getBBox(){return this.bbox}preview(){return this.currentCurve?this.currentSegmentToPath():null}approxCurrentCurveLength(){if(!this.currentCurve)return 0;const t=l.ofXY(this.currentCurve.points[0]),e=l.ofXY(this.currentCurve.points[1]),n=l.ofXY(this.currentCurve.points[2]);return t.minus(e).length()+n.minus(e).length()}finalizeCurrentCurve(){if(!this.currentCurve)return;this.onCurveAdded(this.currentSegmentToPath());const t=this.buffer[this.buffer.length-1];this.lastExitingVec=l.ofXY(this.currentCurve.points[2]).minus(l.ofXY(this.currentCurve.points[1])),console.assert(0!==this.lastExitingVec.magnitude(),"lastExitingVec has zero length!"),this.buffer=[this.buffer[this.buffer.length-2],t],this.currentCurve=null}currentSegmentToPath(){if(null==this.currentCurve)throw new Error("Invalid State: currentCurve is null!");const t=l.ofXY(this.currentCurve.normal(0)).normalized();if(!isFinite(t.magnitude()))throw new Error(`startVec(${t}) is NaN or ∞`);const e=l.ofXY(this.currentCurve.get(0)),n=l.ofXY(this.currentCurve.get(1));return{startPoint:e,controlPoint:l.ofXY(this.currentCurve.points[1]),endPoint:n,startWidth:this.curveStartWidth,endWidth:this.curveEndWidth}}computeExitingVec(){return this.momentum.normalized().times(this.lastPoint.width/2)}addPoint(t){var e,n;if(this.lastPoint){const e=1e-10,n=t.time-this.lastPoint.time;if(t.pos.eq(this.lastPoint.pos,e)||0===n)return;if(isNaN(t.pos.magnitude()))return void console.warn("Discarding NaN point.",t);const i=Math.min(this.lastPoint.width,t.width)/3;if(this.startPoint.pos.minus(t.pos).magnitude()<i&&this.isFirstSegment)return;const r=t.pos.minus(this.lastPoint.pos).times(1/n*1e3);this.momentum=this.momentum.lerp(r,.9)}const i=null!==(e=this.lastPoint)&&void 0!==e?e:t;this.lastPoint=t,this.buffer.push(t.pos);const r=t.width/2,o=this.curveEndWidth;if(this.curveEndWidth=r,this.isFirstSegment&&(this.curveStartWidth=(this.curveStartWidth+r)/2),this.bbox=this.bbox.grownToPoint(t.pos,r),null===this.currentCurve){const e=i.pos,r=i.pos.plus(null!==(n=this.lastExitingVec)&&void 0!==n?n:l.unitX),o=t.pos;this.currentCurve=new tt(e.xy,r.xy,o.xy),this.curveStartWidth=i.width/2,console.assert(!isNaN(e.magnitude())&&!isNaN(r.magnitude())&&!isNaN(o.magnitude()),"Expected !NaN")}let s=this.lastExitingVec;if(!s){let t=Math.ceil(this.buffer.length/2);(0===t||t>=this.buffer.length)&&(t=this.buffer.length-1),s=this.buffer[t].minus(this.buffer[0])}let a=this.computeExitingVec();const c=this.buffer[0],h=t.pos,d=h.minus(c).magnitude(),u=2.2*d;if(0===u||0===a.magnitude()||!isFinite(a.magnitude()))return;console.assert(isFinite(s.magnitude()),"Pre-normalized enteringVec has NaN or ∞ magnitude!"),s=s.normalized(),a=a.normalized(),console.assert(isFinite(s.magnitude()),"Normalized enteringVec has NaN or ∞ magnitude!");const m=new p(c,c.plus(s.times(u))),g=new p(h.minus(a.times(u)),h).intersection(m);let f=null;g&&(f=g.point),(!f||c.eq(f)||h.eq(f))&&(f=c.plus(s.times(d/4))),console.assert(!c.eq(f,1e-11),"Start and control points are equal!"),console.assert(!f.eq(h,1e-11),"Control and end points are equal!");const v=this.currentCurve;this.currentCurve=new tt(c.xy,f.xy,h.xy),isNaN(l.ofXY(this.currentCurve.normal(0)).magnitude())&&(console.error("NaN normal at 0. Curve:",this.currentCurve),this.currentCurve=v);return this.buffer.length>3&&this.approxCurrentCurveLength()>this.curveStartWidth&&!(t=>{for(const e of this.buffer){const n=l.ofXY(t.project(e.xy)).minus(e).magnitude();if(n>Math.max(Math.min(this.curveStartWidth,this.curveEndWidth)/3,this.minFitAllowed)||n>this.maxFitAllowed)return!1}return!0})(this.currentCurve)?(this.currentCurve=v,this.curveEndWidth=o,this.lastPoint=i,void this.finalizeCurrentCurve()):void 0}}const mt=pt,gt=(t,e)=>{const n=3*e.getSizeOfPixelOnCanvas(),i=e.getSizeOfPixelOnCanvas();return new ft(t,i,n,e)};class ft{constructor(t,e,n,i){this.startPoint=t,this.minFitAllowed=e,this.viewport=i,this.isFirstSegment=!0,this.parts=[],this.widthAverageNumSamples=1,this.curveFitter=new pt(t,e,n,(t=>this.addCurve(t))),this.averageWidth=t.width,this.bbox=new m(this.startPoint.pos.x,this.startPoint.pos.y,0,0)}getBBox(){return this.bbox}getRenderingStyle(){return{fill:lt.transparent,stroke:{color:this.startPoint.color,width:this.roundDistance(this.averageWidth)}}}previewCurrentPath(){const t=[...this.parts.slice(),...this.curveToPathCommands(this.curveFitter.preview())];return{startPoint:this.startPoint.pos,commands:t,style:this.getRenderingStyle()}}previewFullPath(){const t=this.previewCurrentPath();return t?[t]:null}previewStroke(){const t=this.previewFullPath();return t?new ut(t):null}preview(t){const e=this.previewFullPath();if(e){const n=this.viewport.visibleRect;t.startObject(n);for(const n of e)t.drawPath(n);t.endObject()}}build(){return this.curveFitter.finalizeCurrentCurve(),this.previewStroke()}getMinFit(){let t=Math.min(this.minFitAllowed,this.averageWidth/2);return t<1e-10&&(t=this.minFitAllowed),t}roundPoint(t){const e=this.getMinFit();return P.roundPoint(t,e)}roundDistance(t){const e=this.getMinFit();return P.roundPoint(t,e)}curveToPathCommands(t){if(!t){if(!this.isFirstSegment)return[];const t=P.roundPoint(this.startPoint.width/3.5,Math.min(this.minFitAllowed,this.startPoint.width/4)),e=this.roundPoint(this.startPoint.pos);return[{kind:st.QuadraticBezierTo,controlPoint:e.plus(l.of(t,t)),endPoint:e.plus(l.of(0,t))},{kind:st.QuadraticBezierTo,controlPoint:e.plus(l.of(-t,t)),endPoint:e.plus(l.of(-t,0))},{kind:st.QuadraticBezierTo,controlPoint:e.plus(l.of(-t,-t)),endPoint:e.plus(l.of(0,-t))},{kind:st.QuadraticBezierTo,controlPoint:e.plus(l.of(t,-t)),endPoint:e.plus(l.of(t,0))}]}const e=[];return this.isFirstSegment&&e.push({kind:st.MoveTo,point:this.roundPoint(t.startPoint)}),e.push({kind:st.QuadraticBezierTo,controlPoint:this.roundPoint(t.controlPoint),endPoint:this.roundPoint(t.endPoint)}),e}addCurve(t){const e=this.curveToPathCommands(t);this.parts.push(...e),this.isFirstSegment&&(this.isFirstSegment=!1)}addPoint(t){this.curveFitter.addPoint(t),this.widthAverageNumSamples++,this.averageWidth=this.averageWidth*(this.widthAverageNumSamples-1)/this.widthAverageNumSamples+t.width/this.widthAverageNumSamples}}class vt extends E{constructor(t,e,n,i=gt){super(t.notifier,e),this.editor=t,this.style=n,this.builderFactory=i,this.builder=null,this.lastPoint=null}getPressureMultiplier(){return 1/this.editor.viewport.getScaleFactor()*this.style.thickness}toStrokePoint(t){var e;let n=Math.max(null!==(e=t.pressure)&&void 0!==e?e:1,.3);return isFinite(n)||(console.warn("Non-finite pressure!",t),n=.3),console.assert(isFinite(t.canvasPos.length()),"Non-finite canvas position!"),console.assert(isFinite(t.screenPos.length()),"Non-finite screen position!"),console.assert(isFinite(t.timeStamp),"Non-finite timeStamp on pointer!"),{pos:t.canvasPos,width:n*this.getPressureMultiplier(),color:this.style.color,time:t.timeStamp}}previewStroke(){var t;this.editor.clearWetInk(),null===(t=this.builder)||void 0===t||t.preview(this.editor.display.getWetInkRenderer())}addPointToStroke(t){if(!this.builder)throw new Error("No stroke is currently being generated.");this.builder.addPoint(t),this.lastPoint=t,this.previewStroke()}onPointerDown({current:t,allPointers:e}){const n=t.device===b.Eraser;let i=!1;for(const t of e)if(t.device===b.Pen){i=!0;break}return!((1!==e.length||n)&&!i||(this.builder=this.builderFactory(this.toStrokePoint(t),this.editor.viewport),0))}onPointerMove({current:t}){this.addPointToStroke(this.toStrokePoint(t))}onPointerUp({current:t}){var e,n;if(!this.builder)return;const i=this.toStrokePoint(t),r=Object.assign(Object.assign({},i),{width:null!==(n=null===(e=this.lastPoint)||void 0===e?void 0:e.width)&&void 0!==n?n:i.width});if(this.addPointToStroke(r),this.builder&&t.isPrimary){const t=this.builder.build();if(this.previewStroke(),t.getBBox().area>0){const e=!0,n=f.addElement(t,e);this.editor.dispatch(n)}else console.warn("Pen: Not adding empty stroke",t,"to the canvas.")}this.builder=null,this.editor.clearWetInk()}onGestureCancel(){this.editor.clearWetInk()}noteUpdated(){this.editor.notifier.dispatch(x.ToolUpdated,{kind:x.ToolUpdated,tool:this})}setColor(t){t.toHexString()!==this.style.color.toHexString()&&(this.style=Object.assign(Object.assign({},this.style),{color:t}),this.noteUpdated())}setThickness(t){t!==this.style.thickness&&(this.style=Object.assign(Object.assign({},this.style),{thickness:t}),this.noteUpdated())}setStrokeFactory(t){t!==this.builderFactory&&(this.builderFactory=t,this.noteUpdated())}getThickness(){return this.style.thickness}getColor(){return this.style.color}getStrokeFactory(){return this.builderFactory}onKeyPress({key:t}){let e;return"-"===(t=t.toLowerCase())||"_"===t?e=2*this.getThickness()/3:"+"!==t&&"="!==t||(e=3*this.getThickness()/2),void 0!==e&&(e=Math.min(Math.max(1,e),256),this.setThickness(e),!0)}}class yt{constructor(){}notifyEnabled(t){var e;t!==this.activeTool&&(null===(e=this.activeTool)||void 0===e||e.setEnabled(!1),this.activeTool=t)}}const xt=(t,e)=>{if(0===e.length)return null;const n=e[0].description(t);for(const i of e)if(i.description(t)!==n)return null;return n};class bt extends s{constructor(t){super("erase"),this.toRemove=t.map((t=>t)),this.applied=!1}apply(t){for(const e of this.toRemove){const n=t.image.findParent(e);n&&n.remove()}this.applied=!0,t.queueRerender()}unapply(t){for(const e of this.toRemove)t.image.findParent(e)||f.addElement(e).apply(t);this.applied=!1,t.queueRerender()}onDrop(t){if(this.applied)for(const e of this.toRemove)t.image.onDestroyElement(e)}description(t,e){var n;if(0===this.toRemove.length)return e.erasedNoElements;const i=null!==(n=xt(e,this.toRemove))&&void 0!==n?n:e.elements;return e.eraseAction(i,this.toRemove.length)}serializeToJSON(){return this.toRemove.map((t=>t.getId()))}}s.register("erase",((t,e)=>{const n=t.map((t=>e.image.lookupElement(t))).filter((t=>null!==t));return new bt(n)}));class wt extends E{constructor(t,e){super(t.notifier,e),this.editor=t,this.command=null}onPointerDown(t){return(1===t.allPointers.length||t.current.device===b.Eraser)&&(this.lastPoint=t.current.canvasPos,this.toRemove=[],!0)}onPointerMove(t){var e;const n=t.current.canvasPos;if(0===n.minus(this.lastPoint).magnitude())return;const i=new p(this.lastPoint,n),r=i.bbox;this.toRemove.push(...this.editor.image.getElementsIntersectingRegion(r).filter((t=>t.intersects(i)))),null===(e=this.command)||void 0===e||e.unapply(this.editor),this.command=new bt(this.toRemove),this.command.apply(this.editor),this.lastPoint=n}onPointerUp(t){var e;this.command&&this.toRemove.length>0&&(null===(e=this.command)||void 0===e||e.unapply(this.editor),this.editor.dispatch(this.command)),this.command=null}onGestureCancel(){var t;null===(t=this.command)||void 0===t||t.unapply(this.editor),this.command=null}}class Tt extends u{constructor(t){var e,n,i;super("image-component"),this.image=Object.assign(Object.assign({},t),{label:null!==(i=null!==(n=null!==(e=t.label)&&void 0!==e?e:t.image.getAttribute("alt"))&&void 0!==n?n:t.image.getAttribute("aria-label"))&&void 0!==i?i:void 0}),void 0===t.image.getAttribute("src")||t.image.complete||(t.image.onload=()=>this.recomputeBBox()),this.recomputeBBox()}getImageRect(){return new m(0,0,this.image.image.width,this.image.image.height)}recomputeBBox(){this.contentBBox=this.getImageRect(),this.contentBBox=this.contentBBox.transformedBoundingBox(this.image.transform)}static fromImage(t,e){var n,i,r,o,s;return i=this,r=void 0,s=function*(){let i,r,o;t.complete||(yield new Promise(((e,n)=>{t.onload=e,t.onerror=n,t.onabort=n}))),"number"==typeof t.width&&"number"==typeof t.height&&0!==t.width&&0!==t.height?(i=t.width,r=t.height):(i=t.clientWidth,r=t.clientHeight);let s=null!==(n=t.src)&&void 0!==n?n:"";if(s.startsWith("data:image/"))o=new Image,o.src=s,o.width=i,o.height=r;else{const e=document.createElement("canvas");e.width=i,e.height=r,e.getContext("2d").drawImage(t,0,0,e.width,e.height),s=e.toDataURL(),o=e}return new Tt({image:o,base64Url:s,transform:e})},new((o=void 0)||(o=Promise))((function(t,e){function n(t){try{l(s.next(t))}catch(t){e(t)}}function a(t){try{l(s.throw(t))}catch(t){e(t)}}function l(e){var i;e.done?t(e.value):(i=e.value,i instanceof o?i:new o((function(t){t(i)}))).then(n,a)}l((s=s.apply(i,r||[])).next())}))}render(t,e){t.drawImage(this.image)}intersects(t){const e=this.getImageRect().getEdges().map((t=>t.transformedBy(this.image.transform)));for(const n of e)if(n.intersects(t))return!0;return!1}serializeToJSON(){return{src:this.image.base64Url,label:this.image.label,width:this.image.image.width,height:this.image.image.height,transform:this.image.transform.toArray()}}applyTransformation(t){this.image.transform=t.rightMul(this.image.transform),this.recomputeBBox()}description(t){return this.image.label?t.imageNode(this.image.label):t.unlabeledImageNode}createClone(){return new Tt(Object.assign({},this.image))}static deserializeFromJSON(t){if("string"!=typeof t.src)throw new Error(`${t} has invalid format! Expected src property.`);const e=new Image;return e.src=t.src,e.width=t.width,e.height=t.height,new Tt({image:e,base64Url:e.src,label:t.label,transform:new d(...t.transform)})}}u.registerComponent("image-component",Tt.deserializeFromJSON);const St="svg-global-attributes";class Ct extends u{constructor(t){super(St),this.attrs=t,this.contentBBox=m.empty}render(t,e){if(t instanceof Ot)for(const[e,n]of this.attrs)t.setRootSVGAttribute(e,n)}intersects(t){return!1}applyTransformation(t){}isSelectable(){return!1}createClone(){return new Ct(this.attrs)}description(t){return t.svgObject}serializeToJSON(){return JSON.stringify(this.attrs)}static deserializeFromString(t){const e=JSON.parse(t),n=[],i=/^[ \t\n0-9.-eE]+$/;for(const[t,r]of e)"viewBox"!==t&&"width"!==t&&"height"!==t||r&&i.exec(r)&&n.push([t,r]);return new Ct(n)}}u.registerComponent(St,Ct.deserializeFromString);const kt="text";class Pt extends u{constructor(t,e,n){super(kt),this.textObjects=t,this.transform=e,this.style=n,this.recomputeBBox(),!t.some((t=>"string"==typeof t))&&t.length>0&&(this.style=t[0].getTextStyle())}static applyTextStyles(t,e){var n,i;const r=e.fontFamily.match(/\s/)?e.fontFamily.replace(/["]/g,'\\"'):e.fontFamily;t.font=[(null!==(n=e.size)&&void 0!==n?n:12)+"px",null!==(i=e.fontWeight)&&void 0!==i?i:"",`${r}`,e.fontWeight].join(" "),t.textAlign="left"}static estimateTextDimens(t,e){const n=t.length*e.size,i=e.size;return new m(0,2*-i/3,n,i)}static getTextDimens(t,e){var n,i;if(null!==(n=Pt.textMeasuringCtx)&&void 0!==n||(Pt.textMeasuringCtx=null!==(i=document.createElement("canvas").getContext("2d"))&&void 0!==i?i:null),!Pt.textMeasuringCtx)return this.estimateTextDimens(t,e);const r=Pt.textMeasuringCtx;Pt.applyTextStyles(r,e);const o=r.measureText(t),s=-o.actualBoundingBoxAscent,a=o.actualBoundingBoxAscent+o.actualBoundingBoxDescent;return new m(0,s,o.width,a)}computeBBoxOfPart(t){return"string"==typeof t?Pt.getTextDimens(t,this.style).transformedBoundingBox(this.transform):t.contentBBox.transformedBoundingBox(this.transform)}recomputeBBox(){let t=null;for(const e of this.textObjects){const n=this.computeBBoxOfPart(e);null!=t||(t=n),t=t.union(n)}this.contentBBox=null!=t?t:m.empty}renderInternal(t){const e=this.transform;for(const n of this.textObjects)"string"==typeof n?t.drawText(n,e,this.style):(t.pushTransform(e),n.renderInternal(t),t.popTransform())}render(t,e){t.startObject(this.contentBBox),this.renderInternal(t),t.endObject(this.getLoadSaveData())}intersects(t){const e=this.transform.inverse(),n=e.transformVec2(t.p1),i=e.transformVec2(t.p2);t=new p(n,i);for(const e of this.textObjects)if("string"==typeof e){if(Pt.getTextDimens(e,this.style).getEdges().some((e=>null!==t.intersection(e))))return!0}else if(e.intersects(t))return!0;return!1}getBaselinePos(){return this.transform.transformVec2(l.zero)}getTextStyle(){return this.style}getTransform(){return this.transform}applyTransformation(t){this.transform=t.rightMul(this.transform),this.recomputeBBox()}createClone(){return new Pt(this.textObjects,this.transform,this.style)}getText(){const t=[];for(const e of this.textObjects)"string"==typeof e?t.push(e):t.push(e.getText());return t.join("\n")}description(t){return t.text(this.getText())}serializeToJSON(){const t=Object.assign(Object.assign({},this.style),{renderingStyle:ht(this.style.renderingStyle)});return{textObjects:this.textObjects.map((t=>"string"==typeof t?{text:t}:{json:t.serializeToJSON()})),transform:this.transform.toArray(),style:t}}static deserializeFromString(t){const e={renderingStyle:dt(t.style.renderingStyle),size:t.style.size,fontWeight:t.style.fontWeight,fontVariant:t.style.fontVariant,fontFamily:t.style.fontFamily},n=t.textObjects.map((t=>{var e;return null!==(null!==(e=t.text)&&void 0!==e?e:null)?t.text:Pt.deserializeFromString(t.json)}));if(t.transform=t.transform.filter((t=>"number"==typeof t)),9!==t.transform.length)throw new Error(`Unable to deserialize transform, ${t.transform}.`);const i=t.transform,r=new d(...i);return new Pt(n,r,e)}static fromLines(t,e,n){let i=null;const r=[];for(const e of t){let t=l.zero;if(i){const e=Math.floor(n.size);t=i.getBBox().bottomLeft.plus(l.unitY.times(e))}const o=new Pt([e],d.translation(t),n);r.push(o),i=o}return new Pt(r,e,n)}}Pt.textMeasuringCtx=null,u.registerComponent(kt,(t=>Pt.deserializeFromString(t)));const Et="unknown-svg-object";class zt extends u{constructor(t){super(Et),this.svgObject=t,this.contentBBox=m.of(t.getBoundingClientRect())}render(t,e){t instanceof Ot&&t.drawSVGElem(this.svgObject)}intersects(t){return this.contentBBox.getEdges().some((e=>null!==e.intersection(t)))}applyTransformation(t){}isSelectable(){return!1}createClone(){return new zt(this.svgObject.cloneNode(!0))}description(t){return t.svgObject}serializeToJSON(){return JSON.stringify({html:this.svgObject.outerHTML})}}u.registerComponent(Et,null);var Bt=function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{l(i.next(t))}catch(t){o(t)}}function a(t){try{l(i.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}l((i=i.apply(t,e||[])).next())}))};const Rt=new m(0,0,500,500),It=["stroke","fill","stroke-width"];class Lt{constructor(t,e,n=!0){this.source=t,this.onFinish=e,this.storeUnknown=n,this.onAddComponent=null,this.onProgress=null,this.onDetermineExportRect=null,this.processedCount=0,this.totalToProcess=0}getStyle(t){var e,n,i;const r={fill:lt.transparent},o=null!==(e=t.getAttribute("fill"))&&void 0!==e?e:t.style.fill;if(o)try{r.fill=lt.fromString(o)}catch(t){console.error("Unknown fill color,",o)}const s=null!==(n=t.getAttribute("stroke"))&&void 0!==n?n:t.style.stroke,a=null!==(i=t.getAttribute("stroke-width"))&&void 0!==i?i:t.style.strokeWidth;if(s)try{let t=parseFloat(null!=a?a:"1");isFinite(t)||(t=0),r.stroke={width:t,color:lt.fromString(s)}}catch(t){console.error("Error parsing stroke data:",t)}return r}strokeDataFromElem(t){var e;const n=[],i=null!==(e=t.getAttribute("d"))&&void 0!==e?e:"",r=this.getStyle(t),o=i.split("M");let s=!0;for(const t of o){const e=/^[0-9., \t\n]+$/.exec(t);if(""!==t&&!e){const e=s?t:`M${t}`,i=at.fromString(e).toRenderable(r);n.push(i)}s=!1}return n}attachUnrecognisedAttrs(t,e,n,i){if(this.storeUnknown){for(const r of e.getAttributeNames())n.has(r)||"style"===r&&i||t.attachLoadSaveData("svgAttrs",[r,e.getAttribute(r)]);if(i&&e.style)for(const n of e.style)""!==n&&n&&(i.has(n)||t.attachLoadSaveData("svgStyleAttrs",{key:n,value:e.style.getPropertyValue(n),priority:e.style.getPropertyPriority(n)}))}}addPath(t){var e;let n;try{const e=this.strokeDataFromElem(t);n=new ut(e),this.attachUnrecognisedAttrs(n,t,new Set([...It,"d"]),new Set(It))}catch(e){if(console.error("Invalid path in node",t,"\nError:",e,"\nAdding as an unknown object."),!this.storeUnknown)return;n=new zt(t)}null===(e=this.onAddComponent)||void 0===e||e.call(this,n)}getTransform(t,e,n){null!=n||(n=window.getComputedStyle(t));let i,r=n.transform;""!==r&&"none"!==r||(r=t.style.transform||"none");try{i=d.fromCSSMatrix(t.style.transform)}catch(t){i=d.fromCSSMatrix(r)}const o=t.getAttribute("x"),s=t.getAttribute("y");if(o||s){const t=parseFloat(null!=o?o:"0"),n=parseFloat(null!=s?s:"0");isNaN(t)||isNaN(n)||(null==e||e.push("x","y"),i=i.rightMul(d.translation(l.of(t,n))))}return i}makeText(t){var e;const n=[];for(const i of t.childNodes)if(i.nodeType===Node.TEXT_NODE)n.push(null!==(e=i.nodeValue)&&void 0!==e?e:"");else{if(i.nodeType!==Node.ELEMENT_NODE)throw new Error(`Unrecognized text child node: ${i}.`);{const t=i;if("tspan"!==t.tagName.toLowerCase())throw new Error(`Unrecognized text child element: ${t}`);n.push(this.makeText(t))}}const i=window.getComputedStyle(t),r=/^([-0-9.e]+)px/i.exec(i.fontSize),o=["fontFamily","transform",...It];let s=12;r&&(o.push("fontSize"),s=parseFloat(r[1]));const a={size:s,fontFamily:i.fontFamily||t.style.fontFamily||"sans-serif",renderingStyle:this.getStyle(t)},l=[],c=this.getTransform(t,l,i),h=new Pt(n,c,a);return this.attachUnrecognisedAttrs(h,t,new Set(l),new Set(o)),h}addText(t){var e;try{const n=this.makeText(t);null===(e=this.onAddComponent)||void 0===e||e.call(this,n)}catch(e){console.error("Invalid text object in node",t,". Continuing.... Error:",e),this.addUnknownNode(t)}}addImage(t){var e,n;return Bt(this,void 0,void 0,(function*(){const i=new Image;i.src=null!==(e=t.getAttribute("xlink:href"))&&void 0!==e?e:t.href.baseVal;try{const e=[],r=this.getTransform(t,e),o=yield Tt.fromImage(i,r);this.attachUnrecognisedAttrs(o,t,new Set(e),new Set(["transform"])),null===(n=this.onAddComponent)||void 0===n||n.call(this,o)}catch(e){console.error("Error loading image:",e,". Element: ",t,". Continuing..."),this.addUnknownNode(t)}}))}addUnknownNode(t){var e;if(this.storeUnknown){const n=new zt(t);null===(e=this.onAddComponent)||void 0===e||e.call(this,n)}}updateViewBox(t){var e;const n=t.getAttribute("viewBox");if(this.rootViewBox||!n)return;const i=n.split(/[ \t\n,]+/),r=parseFloat(i[0]),o=parseFloat(i[1]),s=parseFloat(i[2]),a=parseFloat(i[3]);isNaN(r)||isNaN(o)||isNaN(s)||isNaN(a)?console.warn(`node ${t} has an unparsable viewbox. Viewbox: ${n}. Match: ${i}.`):(this.rootViewBox=new m(r,o,s,a),null===(e=this.onDetermineExportRect)||void 0===e||e.call(this,this.rootViewBox))}updateSVGAttrs(t){var e;this.storeUnknown&&(null===(e=this.onAddComponent)||void 0===e||e.call(this,new Ct(this.getSourceAttrs(t))))}visit(t){var e;return Bt(this,void 0,void 0,(function*(){this.totalToProcess+=t.childElementCount;let n=!0;switch(t.tagName.toLowerCase()){case"g":break;case"path":this.addPath(t);break;case"text":this.addText(t),n=!1;break;case"image":yield this.addImage(t),n=!1;break;case"svg":this.updateViewBox(t),this.updateSVGAttrs(t);break;default:return console.warn("Unknown SVG element,",t),t instanceof SVGElement||console.warn("Element",t,"is not an SVGElement!",this.storeUnknown?"Continuing anyway.":"Skipping."),void this.addUnknownNode(t)}if(n)for(const e of t.children)yield this.visit(e);this.processedCount++,yield null===(e=this.onProgress)||void 0===e?void 0:e.call(this,this.processedCount,this.totalToProcess)}))}getSourceAttrs(t){return t.getAttributeNames().map((e=>[e,t.getAttribute(e)]))}start(t,e,n=null){var i,r;return Bt(this,void 0,void 0,(function*(){this.onAddComponent=t,this.onProgress=e,this.onDetermineExportRect=n,this.totalToProcess=this.source.childElementCount,this.processedCount=0,this.rootViewBox=null,yield this.visit(this.source),this.rootViewBox||null===(i=this.onDetermineExportRect)||void 0===i||i.call(this,Rt),null===(r=this.onFinish)||void 0===r||r.call(this)}))}static fromString(t,e=!1){var n,i;const r=document.createElement("iframe");if(r.src="about:blank",r.setAttribute("sandbox","allow-same-origin"),r.setAttribute("csp","default-src 'about:blank'"),r.style.display="none",document.body.appendChild(r),!r.hasAttribute("sandbox"))throw r.remove(),new Error("SVG loading iframe is not sandboxed.");const o=null!==(i=null===(n=r.contentWindow)||void 0===n?void 0:n.document)&&void 0!==i?i:r.contentDocument;if(null==o)throw new Error("Unable to open a sandboxed iframe!");o.open(),o.write("\n\t\t\t<!DOCTYPE html>\n\t\t\t<html>\n\t\t\t\t<head>\n\t\t\t\t\t<title>SVG Loading Sandbox</title>\n\t\t\t\t</head>\n\t\t\t\t<body>\n\t\t\t\t\t<script>\n\t\t\t\t\t\tconsole.error('JavaScript should not be able to run here!');\n\t\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t\t'The SVG sandbox is broken! Please double-check the sandboxing setting.'\n\t\t\t\t\t\t);\n\t\t\t\t\t<\/script>\n\t\t\t\t</body>\n\t\t\t</html>\n\t\t"),o.close();const s=o.createElementNS("http://www.w3.org/2000/svg","svg");return s.innerHTML=t,o.body.appendChild(s),new Lt(s,(()=>{s.remove(),r.remove()}),!e)}}class At{constructor(t){this.viewport=t,this.selfTransform=null,this.transformStack=[],this.objectLevel=0,this.currentPaths=null}getViewport(){return this.viewport}setDraftMode(t){}flushPath(){if(!this.currentPaths)return;let t=null;for(const e of this.currentPaths){const{startPoint:n,commands:i,style:r}=e;t&&ct(t,r)?this.moveTo(n):(t&&this.endPath(t),this.beginPath(n),t=r);for(const t of i)t.kind===st.LineTo?this.lineTo(t.point):t.kind===st.MoveTo?this.moveTo(t.point):t.kind===st.CubicBezierTo?this.traceCubicBezierCurve(t.controlPoint1,t.controlPoint2,t.endPoint):t.kind===st.QuadraticBezierTo&&this.traceQuadraticBezierCurve(t.controlPoint,t.endPoint)}t&&this.endPath(t)}drawPath(t){0===this.objectLevel?(this.currentPaths=[t],this.flushPath(),this.currentPaths=null):this.currentPaths.push(t)}drawRect(t,e,n){const i=at.fromRect(t,e);this.drawPath(i.toRenderable(n))}startObject(t,e){this.currentPaths=[],this.objectLevel++}endObject(t){if(this.flushPath(),this.currentPaths=null,this.objectLevel--,this.objectLevel<0)throw new Error("More objects have ended than have been started (negative object nesting level)!")}getNestingLevel(){return this.objectLevel}canRenderFromWithoutDataLoss(t){return!1}renderFromOtherOfSameType(t,e){throw new Error(`Unable to render from ${e}: Not implemented`)}setTransform(t){this.selfTransform=t}pushTransform(t){this.transformStack.push(this.selfTransform),this.setTransform(this.getCanvasToScreenTransform().rightMul(t))}popTransform(){var t;if(0===this.transformStack.length)throw new Error("Unable to pop more transforms than have been pushed!");this.setTransform(null!==(t=this.transformStack.pop())&&void 0!==t?t:null)}getCanvasToScreenTransform(){return this.selfTransform?this.selfTransform:this.viewport.canvasToScreenTransform}canvasToScreen(t){return this.getCanvasToScreenTransform().transformVec2(t)}getSizeOfCanvasPixelOnScreen(){return this.getCanvasToScreenTransform().transformVec3(l.unitX).length()}}const Mt="js-draw-style-sheet",Dt="http://www.w3.org/2000/svg";class Ot extends At{constructor(t,e,n=!1){super(e),this.elem=t,this.sanitize=n,this.lastPathStyle=null,this.lastPathString=[],this.objectElems=null,this.overwrittenAttrs={},this.textContainer=null,this.textContainerTransform=null,this.clear(),this.addStyleSheet()}addStyleSheet(){if(!this.elem.querySelector("#js-draw-style-sheet")){const t=document.createElementNS("http://www.w3.org/2000/svg","style");t.innerHTML="\n\t\t\t\tpath {\n\t\t\t\t\tstroke-linecap: round;\n\t\t\t\t\tstroke-linejoin: round;\n\t\t\t\t}\n\t\t\t".replace(/\s+/g,""),t.setAttribute("id",Mt),this.elem.appendChild(t)}}setRootSVGAttribute(t,e){this.sanitize||(t in this.overwrittenAttrs||(this.overwrittenAttrs[t]=this.elem.getAttribute(t)),null!==e?this.elem.setAttribute(t,e):this.elem.removeAttribute(t))}displaySize(){return l.of(this.elem.clientWidth,this.elem.clientHeight)}clear(){if(this.lastPathString=[],!this.sanitize){for(const t in this.overwrittenAttrs){const e=this.overwrittenAttrs[t];e?this.elem.setAttribute(t,e):this.elem.removeAttribute(t)}this.overwrittenAttrs={}}}addPathToSVG(){var t;if(!this.lastPathStyle||0===this.lastPathString.length)return;const e=document.createElementNS(Dt,"path");e.setAttribute("d",this.lastPathString.join(" "));const n=this.lastPathStyle;n.fill.a>0?e.setAttribute("fill",n.fill.toHexString()):e.setAttribute("fill","none"),n.stroke&&(e.setAttribute("stroke",n.stroke.color.toHexString()),e.setAttribute("stroke-width",nt(n.stroke.width))),this.elem.appendChild(e),null===(t=this.objectElems)||void 0===t||t.push(e)}drawPath(t){var e;const n=t.style,i=at.fromRenderable(t).transformedBy(this.getCanvasToScreenTransform());n.fill.eq(null===(e=this.lastPathStyle)||void 0===e?void 0:e.fill)&&0!==this.lastPathString.length||(this.addPathToSVG(),this.lastPathStyle=n,this.lastPathString=[]),this.lastPathString.push(i.toString())}transformFrom(t,e,n=!1,i=!0){let r=n?t:this.getCanvasToScreenTransform().rightMul(t);const o=r.transformVec2(l.zero);i&&(r=r.rightMul(d.translation(o.times(-1)))),r.eq(d.identity)?e.style.transform="":e.style.transform=`matrix(\n\t\t\t\t${r.a1}, ${r.b1},\n\t\t\t\t${r.a2}, ${r.b2},\n\t\t\t\t${r.a3}, ${r.b3}\n\t\t\t)`,i&&(e.setAttribute("x",`${nt(o.x)}`),e.setAttribute("y",`${nt(o.y)}`))}drawText(t,e,n){var i;const r=(t,e)=>{var n,i;if(t.style.fontFamily=e.fontFamily,t.style.fontVariant=null!==(n=e.fontVariant)&&void 0!==n?n:"",t.style.fontWeight=null!==(i=e.fontWeight)&&void 0!==i?i:"",t.style.fontSize=e.size+"px",t.style.fill=e.renderingStyle.fill.toHexString(),e.renderingStyle.stroke){const n=e.renderingStyle.stroke;t.style.stroke=n.color.toHexString(),t.style.strokeWidth=n.width+"px"}};if(e=this.getCanvasToScreenTransform().rightMul(e),this.textContainer){const i=document.createElementNS(Dt,"tspan");i.appendChild(document.createTextNode(t)),this.textContainer.appendChild(i);const o=(e=this.textContainerTransform.inverse().rightMul(e)).transformVec2(l.zero);i.setAttribute("x",`${nt(o.x)}`),i.setAttribute("y",`${nt(o.y)}`),r(i,n)}else{const o=document.createElementNS(Dt,"text");o.appendChild(document.createTextNode(t));const s=!1;this.transformFrom(e,o,!0,s),r(o,n),this.elem.appendChild(o),null===(i=this.objectElems)||void 0===i||i.push(o),this.objectLevel>0&&(this.textContainer=o,this.textContainerTransform=e)}}drawImage(t){var e,n,i,r,o;const s=document.createElementNS(Dt,"image");s.setAttribute("href",t.base64Url),s.setAttribute("width",null!==(e=t.image.getAttribute("width"))&&void 0!==e?e:""),s.setAttribute("height",null!==(n=t.image.getAttribute("height"))&&void 0!==n?n:""),s.setAttribute("aria-label",null!==(r=null!==(i=t.image.getAttribute("aria-label"))&&void 0!==i?i:t.image.getAttribute("alt"))&&void 0!==r?r:""),this.transformFrom(t.transform,s),this.elem.appendChild(s),null===(o=this.objectElems)||void 0===o||o.push(s)}startObject(t){super.startObject(t),this.lastPathString=[],this.lastPathStyle=null,this.textContainer=null,this.objectElems=[]}endObject(t){var e;if(super.endObject(t),this.addPathToSVG(),t&&!this.sanitize)for(const n of null!==(e=this.objectElems)&&void 0!==e?e:[]){const e=t.svgAttrs,i=t.svgStyleAttrs;if(e)for(const[t,i]of e)n.setAttribute(t,i);if(i)for(const t of i)n.style.setProperty(t.key,t.value,t.priority)}}unimplementedMessage(){throw new Error("Not implemenented!")}beginPath(t){this.unimplementedMessage()}endPath(t){this.unimplementedMessage()}lineTo(t){this.unimplementedMessage()}moveTo(t){this.unimplementedMessage()}traceCubicBezierCurve(t,e,n){this.unimplementedMessage()}traceQuadraticBezierCurve(t,e){this.unimplementedMessage()}drawPoints(...t){t.map((t=>{const e=document.createElementNS(Dt,"circle");e.setAttribute("cx",`${t.x}`),e.setAttribute("cy",`${t.y}`),e.setAttribute("r","15"),this.elem.appendChild(e)}))}drawSVGElem(t){this.sanitize||"style"===t.tagName.toLowerCase()&&t.getAttribute("id")===Mt||this.elem.appendChild(t.cloneNode(!0))}isTooSmallToRender(t){return!1}}var Ft,$t,Nt;!function(t){t[t.Circle=0]="Circle",t[t.Square=1]="Square"}(Ft||(Ft={}));class jt{constructor(t,e,n,i,r,o){switch(this.shape=t,this.parentSide=e,this.parent=n,this.onDragStart=i,this.onDragUpdate=r,this.onDragEnd=o,this.dragLastPos=null,this.element=document.createElement("div"),this.element.classList.add(`${Kt}handle`),t){case Ft.Circle:this.element.classList.add(`${Kt}circle`);break;case Ft.Square:this.element.classList.add(`${Kt}square`);break;default:(t=>{throw new Error(`Should be unreachable. Key: ${t}.`)})(t)}this.updatePosition()}addTo(t){t.appendChild(this.element)}updatePosition(){const t=this.parent.screenRegion,e=l.of(30,30),n=t.size.scale(this.parentSide).minus(e.times(.5));this.element.style.marginLeft=`${n.x}px`,this.element.style.marginTop=`${n.y}px`,this.element.style.width=`${e.x}px`,this.element.style.height=`${e.y}px`}isTarget(t){return t===this.element}handleDragStart(t){this.onDragStart(t.canvasPos),this.dragLastPos=t.canvasPos}handleDragUpdate(t){this.dragLastPos&&this.onDragUpdate(t.canvasPos)}handleDragEnd(){this.dragLastPos&&this.onDragEnd()}}class Ut extends s{constructor(t){super("duplicate"),this.toDuplicate=t,this.duplicates=t.map((t=>t.clone())),this.reverse=new bt(this.duplicates)}apply(t){this.reverse.unapply(t)}unapply(t){this.reverse.apply(t)}description(t,e){var n;return 0===this.duplicates.length?e.duplicatedNoElements:e.duplicateAction(null!==(n=xt(e,this.duplicates))&&void 0!==n?n:e.elements,this.duplicates.length)}serializeToJSON(){return this.toDuplicate.map((t=>t.getId()))}}s.register("duplicate",((t,e)=>{const n=t.map((t=>e.image.lookupElement(t)));return new Ut(n)})),function(t){t[t.Both=0]="Both",t[t.HorizontalOnly=1]="HorizontalOnly",t[t.VerticalOnly=2]="VerticalOnly"}($t||($t={})),function(t){t[t.Snap=0]="Snap",t[t.NoSnap=1]="NoSnap"}(Nt||(Nt={}));class Vt{constructor(t,e){this.editor=t,this.selection=e}onDragStart(t){this.selection.setTransform(d.identity),this.dragStartPoint=t}onDragUpdate(t){const e=this.editor.viewport.roundPoint(t.minus(this.dragStartPoint));this.selection.setTransform(d.translation(e))}onDragEnd(){this.selection.finalizeTransform()}}class Wt{constructor(t,e){this.editor=t,this.selection=e,this.mode=$t.Both}onDragStart(t,e){this.selection.setTransform(d.identity),this.mode=e,this.dragStartPoint=t}onDragUpdate(t){const e=t.minus(this.dragStartPoint),n=this.selection.preTransformRegion.width,i=this.selection.preTransformRegion.height;let r=l.of(1,1);if(this.mode===$t.HorizontalOnly){const t=n+e.x;r=l.of(t/n,r.y)}if(this.mode===$t.VerticalOnly){const t=i+e.y;r=l.of(r.x,t/i)}if(this.mode===$t.Both){const t=n+(Math.abs(e.x)>Math.abs(e.y)?e.x:e.y);r=l.of(t/n,t/n)}if(r=r.map((t=>P.roundScaleRatio(t,2))),r.x>0&&r.y>0){const t=this.editor.viewport.roundPoint(this.selection.preTransformRegion.topLeft);this.selection.setTransform(d.scaling2D(r,t))}}onDragEnd(){this.selection.finalizeTransform()}}class Ht{constructor(t,e){this.editor=t,this.selection=e,this.startAngle=0}getAngle(t){const e=this.selection.preTransformRegion.center;return t.minus(e).angle()}roundAngle(t){const e=8/Math.PI;return Math.round(t*e)/e}onDragStart(t){this.selection.setTransform(d.identity),this.startAngle=this.getAngle(t)}onDragUpdate(t){const e=this.roundAngle(this.getAngle(t)-this.startAngle),n=this.editor.viewport.roundPoint(this.selection.preTransformRegion.center),i=d.zRotation(e).mapEntries((t=>P.roundScaleRatio(t))),r=d.translation(n).rightMul(i).rightMul(d.translation(n.times(-1)));this.selection.setTransform(r)}onDragEnd(){this.selection.finalizeTransform()}}var Gt,_t=function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{l(i.next(t))}catch(t){o(t)}}function a(t){try{l(i.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}l((i=i.apply(t,e||[])).next())}))};class qt{constructor(t,e){this.editor=e,this.transform=d.identity,this.transformCommands=[],this.selectedElems=[],this.hasParent=!0,this.targetHandle=null,this.backgroundDragging=!1,this.originalRegion=new m(t.x,t.y,0,0),this.transformers={drag:new Vt(e,this),resize:new Wt(e,this),rotate:new Ht(e,this)},this.container=document.createElement("div"),this.backgroundElem=document.createElement("div"),this.backgroundElem.classList.add(`${Kt}selection-background`),this.container.appendChild(this.backgroundElem);const n=new jt(Ft.Square,l.of(1,.5),this,(t=>this.transformers.resize.onDragStart(t,$t.HorizontalOnly)),(t=>this.transformers.resize.onDragUpdate(t)),(()=>this.transformers.resize.onDragEnd())),i=new jt(Ft.Square,l.of(.5,1),this,(t=>this.transformers.resize.onDragStart(t,$t.VerticalOnly)),(t=>this.transformers.resize.onDragUpdate(t)),(()=>this.transformers.resize.onDragEnd())),r=new jt(Ft.Square,l.of(1,1),this,(t=>this.transformers.resize.onDragStart(t,$t.Both)),(t=>this.transformers.resize.onDragUpdate(t)),(()=>this.transformers.resize.onDragEnd())),o=new jt(Ft.Circle,l.of(.5,0),this,(t=>this.transformers.rotate.onDragStart(t)),(t=>this.transformers.rotate.onDragUpdate(t)),(()=>this.transformers.rotate.onDragEnd()));this.handles=[r,n,i,o];for(const t of this.handles)t.addTo(this.backgroundElem)}getTransform(){return this.transform}get preTransformRegion(){return this.originalRegion}get region(){const t=d.zRotation(this.regionRotation,this.originalRegion.center),e=this.transform.rightMul(t.inverse());return this.originalRegion.transformedBoundingBox(e)}get regionRotation(){return this.transform.transformVec3(l.unitX).angle()}get preTransformedScreenRegion(){const t=t=>this.editor.viewport.canvasToScreen(t);return m.fromCorners(t(this.preTransformRegion.topLeft),t(this.preTransformRegion.bottomRight))}get preTransformedScreenRegionRotation(){return this.editor.viewport.getRotationAngle()}get screenRegion(){const t=this.editor.viewport.canvasToScreenTransform,e=this.editor.viewport.getScaleFactor(),n=t.transformVec2(this.region.center);return new m(n.x,n.y,e*this.region.width,e*this.region.height).translatedBy(this.region.size.times(-e/2))}get screenRegionRotation(){return this.regionRotation+this.editor.viewport.getRotationAngle()}computeTransformCommands(){return this.selectedElems.map((t=>t.transformBy(this.transform)))}setTransform(t,e=!0){this.transform=t,e&&this.hasParent&&(this.previewTransformCmds(),this.scrollTo())}finalizeTransform(){this.transformCommands.forEach((t=>{t.unapply(this.editor)}));const t=this.transform,e=this.selectedElems;this.transformCommands=[],this.originalRegion=this.originalRegion.transformedBoundingBox(this.transform),this.transform=d.identity,this.editor.dispatch(new qt.ApplyTransformationCommand(this,e,t))}previewTransformCmds(){this.selectedElems.length>100||(this.transformCommands.forEach((t=>t.unapply(this.editor))),this.transformCommands=this.computeTransformCommands(),this.transformCommands.forEach((t=>t.apply(this.editor)))),this.updateUI()}resolveToObjects(){let t=!1;if(this.transform=d.identity,0===this.region.w||0===this.region.h){const e=this.editor.viewport.visibleRect.maxDimension/200;this.originalRegion=m.bboxOf(this.region.corners,e),t=!0}return this.selectedElems=this.editor.image.getElementsIntersectingRegion(this.region).filter((t=>{if(this.region.containsRect(t.getBBox()))return!0;const e=[];for(const t of this.region.divideIntoGrid(2,2))e.push(...t.getEdges());return e.some((e=>t.intersects(e)))})),t&&this.selectedElems.length>0&&(this.selectedElems=[this.selectedElems[this.selectedElems.length-1]]),!!this.recomputeRegion()&&(this.updateUI(),!0)}recomputeRegion(){const t=this.selectedElems.reduce(((t,e)=>(null!=t?t:e.getBBox()).union(e.getBBox())),null);if(!t)return this.cancelSelection(),!1;this.originalRegion=t;const e=this.getMinCanvasSize();if(this.originalRegion.w<e||this.originalRegion.h<e){const t=e/2;this.originalRegion=m.bboxOf(this.originalRegion.corners,t)}return!0}getMinCanvasSize(){return 30/this.editor.viewport.getScaleFactor()*2}getSelectedItemCount(){return this.selectedElems.length}updateUI(){if(!this.hasParent)return;this.backgroundElem.style.marginLeft=`${this.screenRegion.topLeft.x}px`,this.backgroundElem.style.marginTop=`${this.screenRegion.topLeft.y}px`,this.backgroundElem.style.width=`${this.screenRegion.width}px`,this.backgroundElem.style.height=`${this.screenRegion.height}px`;const t=180*this.screenRegionRotation/Math.PI;this.backgroundElem.style.transform=`rotate(${t}deg)`,this.backgroundElem.style.transformOrigin="center";for(const t of this.handles)t.updatePosition()}onDragStart(t,e){for(const n of this.handles)if(n.isTarget(e))return n.handleDragStart(t),this.targetHandle=n,!0;return this.backgroundElem===e&&(this.backgroundDragging=!0,this.transformers.drag.onDragStart(t.canvasPos),!0)}onDragUpdate(t){this.backgroundDragging&&this.transformers.drag.onDragUpdate(t.canvasPos),this.targetHandle&&this.targetHandle.handleDragUpdate(t),this.updateUI()}onDragEnd(){this.backgroundDragging?this.transformers.drag.onDragEnd():this.targetHandle&&this.targetHandle.handleDragEnd(),this.backgroundDragging=!1,this.targetHandle=null,this.updateUI()}onDragCancel(){this.backgroundDragging=!1,this.targetHandle=null,this.setTransform(d.identity)}scrollTo(){if(0===this.selectedElems.length)return;const t=new m(0,0,this.editor.display.width,this.editor.display.height);if(!t.containsPoint(this.screenRegion.center)){const e=t.getClosestPointOnBoundaryTo(this.screenRegion.center),n=this.screenRegion.center.minus(e),i=this.editor.viewport.screenToCanvasTransform.transformVec3(n);this.editor.dispatchNoAnnounce(P.transformBy(d.translation(i.times(-1))),!1)}}deleteSelectedObjects(){return new bt(this.selectedElems)}duplicateSelectedObjects(){return new Ut(this.selectedElems)}addTo(t){this.container.parentElement&&this.container.remove(),t.appendChild(this.container),this.hasParent=!0}setToPoint(t){this.originalRegion=this.originalRegion.grownToPoint(t),this.updateUI()}cancelSelection(){this.container.parentElement&&this.container.remove(),this.originalRegion=m.empty,this.hasParent=!1}setSelectedObjects(t,e){this.originalRegion=e,this.selectedElems=t.filter((t=>t.isSelectable())),this.updateUI()}getSelectedObjects(){return this.selectedElems}}Gt=qt,s.register("selection-tool-transform",((t,e)=>{var n;const i=new d(...t.transform),r=null!==(n=t.elems)&&void 0!==n?n:[];return new Gt.ApplyTransformationCommand(null,r,i)})),qt.ApplyTransformationCommand=class extends s{constructor(t,e,n){super("selection-tool-transform"),this.selection=t,this.fullTransform=n,"string"==typeof e[0]?this.selectedElemIds=e:(this.selectedElemIds=e.map((t=>t.getId())),this.transformCommands=e.map((t=>t.transformBy(this.fullTransform))))}resolveToElems(t){this.transformCommands||(this.transformCommands=this.selectedElemIds.map((e=>{const n=t.image.lookupElement(e);if(!n)throw new Error(`Unable to find element with ID, ${e}.`);return n.transformBy(this.fullTransform)})))}apply(t){var e,n,i,r,o;return _t(this,void 0,void 0,(function*(){this.resolveToElems(t),null===(e=this.selection)||void 0===e||e.setTransform(this.fullTransform,!1),null===(n=this.selection)||void 0===n||n.updateUI(),yield t.asyncApplyCommands(this.transformCommands,100),null===(i=this.selection)||void 0===i||i.setTransform(d.identity,!1),null===(r=this.selection)||void 0===r||r.recomputeRegion(),null===(o=this.selection)||void 0===o||o.updateUI()}))}unapply(t){var e,n,i,r,o;return _t(this,void 0,void 0,(function*(){this.resolveToElems(t),null===(e=this.selection)||void 0===e||e.setTransform(this.fullTransform.inverse(),!1),null===(n=this.selection)||void 0===n||n.updateUI(),yield t.asyncUnapplyCommands(this.transformCommands,100),null===(i=this.selection)||void 0===i||i.setTransform(d.identity),null===(r=this.selection)||void 0===r||r.recomputeRegion(),null===(o=this.selection)||void 0===o||o.updateUI()}))}serializeToJSON(){return{elems:this.selectedElemIds,transform:this.fullTransform.toArray()}}description(t,e){return e.transformedElements(this.selectedElemIds.length)}};const Kt="selection-tool-";class Zt extends E{constructor(t,e){super(t.notifier,e),this.editor=t,this.lastEvtTarget=null,this.expandingSelectionBox=!1,this.shiftKeyPressed=!1,this.selectionBoxHandlingEvt=!1,this.handleOverlay=document.createElement("div"),t.createHTMLOverlay(this.handleOverlay),this.handleOverlay.style.display="none",this.handleOverlay.classList.add("handleOverlay"),t.notifier.on(x.ViewportChanged,(t=>{var e;null===(e=this.selectionBox)||void 0===e||e.updateUI()})),this.editor.handleKeyEventsFrom(this.handleOverlay),this.editor.handlePointerEventsFrom(this.handleOverlay,((t,e)=>("pointerdown"===t&&(this.lastEvtTarget=e.target),!0)))}makeSelectionBox(t){var e;this.prevSelectionBox=this.selectionBox,this.selectionBox=new qt(t,this.editor),this.expandingSelectionBox||null===(e=this.prevSelectionBox)||void 0===e||e.cancelSelection(),this.selectionBox.addTo(this.handleOverlay)}onPointerDown(t){var e;return!(1!==t.allPointers.length||!t.current.isPrimary||(this.lastEvtTarget&&(null===(e=this.selectionBox)||void 0===e?void 0:e.onDragStart(t.current,this.lastEvtTarget))?(this.selectionBoxHandlingEvt=!0,this.expandingSelectionBox=!1):(this.expandingSelectionBox=this.shiftKeyPressed,this.makeSelectionBox(t.current.canvasPos)),0))}onPointerMove(t){this.selectionBox&&(this.selectionBoxHandlingEvt?this.selectionBox.onDragUpdate(t.current):this.selectionBox.setToPoint(t.current.canvasPos))}onSelectionUpdated(){var t,e;this.editor.notifier.dispatch(x.ToolUpdated,{kind:x.ToolUpdated,tool:this});const n=null!==(e=null===(t=this.selectionBox)||void 0===t?void 0:t.getSelectedItemCount())&&void 0!==e?e:0;n>0?(this.editor.announceForAccessibility(this.editor.localization.selectedElements(n)),this.zoomToSelection()):this.selectionBox&&(this.selectionBox.cancelSelection(),this.prevSelectionBox=this.selectionBox,this.selectionBox=null)}onGestureEnd(){this.lastEvtTarget=null,this.selectionBox&&(this.selectionBoxHandlingEvt?this.selectionBox.onDragEnd():(this.selectionBox.resolveToObjects(),this.onSelectionUpdated()),this.selectionBoxHandlingEvt=!1)}zoomToSelection(){if(this.selectionBox){const t=this.selectionBox.region;this.editor.dispatchNoAnnounce(this.editor.viewport.zoomTo(t,!1),!1)}}onPointerUp(t){this.selectionBox&&(this.selectionBox.setToPoint(t.current.canvasPos),this.expandingSelectionBox&&this.prevSelectionBox?(this.expandingSelectionBox=!1,this.selectionBox.resolveToObjects(),this.setSelection([...this.selectionBox.getSelectedObjects(),...this.prevSelectionBox.getSelectedObjects()])):this.onGestureEnd())}onGestureCancel(){var t,e,n;this.selectionBoxHandlingEvt?null===(t=this.selectionBox)||void 0===t||t.onDragCancel():(null===(e=this.selectionBox)||void 0===e||e.cancelSelection(),this.selectionBox=this.prevSelectionBox,null===(n=this.selectionBox)||void 0===n||n.addTo(this.handleOverlay)),this.expandingSelectionBox=!1}onKeyPress(t){if(this.selectionBox&&t.ctrlKey&&"d"===t.key)return!0;if("a"===t.key&&t.ctrlKey)return!0;if(t.ctrlKey)return!1;if("Shift"===t.key)return this.shiftKeyPressed=!0,!0;let e=0,n=0,i=0,r=0,o=0;switch(t.key){case"a":case"h":case"ArrowLeft":n-=1;break;case"d":case"l":case"ArrowRight":n+=1;break;case"q":case"k":case"ArrowUp":i-=1;break;case"e":case"j":case"ArrowDown":i+=1;break;case"r":e+=1;break;case"R":e-=1;break;case"i":r-=1;break;case"I":r+=1;break;case"o":o-=1;break;case"O":o+=1}let s=0!==n||0!==i||0!==e||0!==r||0!==o;if(this.selectionBox){if(s){const t=10*this.editor.viewport.getSizeOfPixelOnCanvas(),s=Math.PI/8,a=5/4,c=this.selectionBox.region,h=l.of(Math.pow(a,r),Math.pow(a,o)),u=d.zRotation(e*s).mapEntries((t=>P.roundScaleRatio(t))),p=this.editor.viewport.roundPoint(c.center),m=d.scaling2D(h,this.editor.viewport.roundPoint(c.topLeft)).rightMul(d.translation(p).rightMul(u).rightMul(d.translation(p.times(-1)))).rightMul(d.translation(this.editor.viewport.roundPoint(l.of(n,i).times(t)))),g=this.selectionBox.getTransform();this.selectionBox.setTransform(g.rightMul(m))}}else s=!1;return!this.selectionBox||s||"Delete"!==t.key&&"Backspace"!==t.key||(this.editor.dispatch(this.selectionBox.deleteSelectedObjects()),this.clearSelection(),s=!0),s}onKeyUp(t){if("Shift"===t.key)return this.shiftKeyPressed=!1,!0;if(t.ctrlKey){if(this.selectionBox&&"d"===t.key)return this.editor.dispatch(this.selectionBox.duplicateSelectedObjects()),!0;if("a"===t.key)return this.setSelection(this.editor.image.getAllElements()),!0}return!(!this.selectionBox||!Zt.handleableKeys.some((e=>e===t.key))||(this.selectionBox.finalizeTransform(),0))}onCopy(t){if(!this.selectionBox)return!1;const e=this.selectionBox.getSelectedObjects(),n=this.selectionBox.region;if(0===e.length)return!1;const i=new P(this.editor.notifier);i.updateScreenSize(l.of(n.w,n.h)),i.resetTransform(d.translation(n.topLeft));const r=document.createElementNS("http://www.w3.org/2000/svg","svg"),o=new Ot(r,i,!0),s=[];for(const t of e)t.render(o),t instanceof Pt&&s.push(t.getText());return t.setData("image/svg+xml",r.outerHTML),s.length>0&&t.setData("text/plain",s.join("\n")),!0}setEnabled(t){super.setEnabled(t),this.handleOverlay.replaceChildren(),this.selectionBox=null,this.handleOverlay.style.display=t?"block":"none",t?(this.handleOverlay.tabIndex=0,this.handleOverlay.setAttribute("aria-label",this.editor.localization.selectionToolKeyboardShortcuts)):this.handleOverlay.tabIndex=-1}getSelection(){return this.selectionBox}getSelectedObjects(){var t,e;return null!==(e=null===(t=this.selectionBox)||void 0===t?void 0:t.getSelectedObjects())&&void 0!==e?e:[]}setSelection(t){t=t.filter((t=>t.isSelectable()));let e=null;for(const n of t)e=e?e.union(n.getBBox()):n.getBBox();e&&(this.clearSelection(),this.selectionBox||this.makeSelectionBox(e.topLeft),this.selectionBox.setSelectedObjects(t,e),this.onSelectionUpdated())}clearSelection(){this.handleOverlay.replaceChildren(),this.prevSelectionBox=this.selectionBox,this.selectionBox=null,this.onSelectionUpdated()}}Zt.handleableKeys=["a","h","ArrowLeft","d","l","ArrowRight","q","k","ArrowUp","e","j","ArrowDown","r","R","i","I","o","O"];class Xt extends E{constructor(t){super(t.notifier,t.localization.undoRedoTool),this.editor=t}onKeyPress({key:t,ctrlKey:e}){if(e){if("z"===t)return this.editor.history.undo(),!0;if("Z"===t)return this.editor.history.redo(),!0}return!1}}class Yt extends o{constructor(t,e){super(),this.commands=t,this.applyChunkSize=e}static waitForAll(t){if(t.some((t=>t&&t.then)))return console.log("waiting..."),Promise.all(t).then((()=>{}))}apply(t){if(void 0===this.applyChunkSize){const e=this.commands.map((e=>e.apply(t)));return Yt.waitForAll(e)}return t.asyncApplyCommands(this.commands,this.applyChunkSize)}unapply(t){if(void 0===this.applyChunkSize){const e=this.commands.map((e=>e.unapply(t)));return Yt.waitForAll(e)}return t.asyncUnapplyCommands(this.commands,this.applyChunkSize)}description(t,e){const n=[];let i=null,r=0;for(const o of this.commands){const s=o.description(t,e);s!==i&&null!==i&&(n.push(e.unionOf(i,r)),i=null,r=0),r++,null!=i||(i=s)}return r>1?n.push(e.unionOf(i,r)):1===r&&n.push(i),n.join(", ")}}class Jt extends s{constructor(t,e){super("union"),this.commands=t,this.applyChunkSize=e,this.nonserializableCommand=new Yt(t,e)}serializeToJSON(){return{applyChunkSize:this.applyChunkSize,data:this.commands.map((t=>t.serialize()))}}apply(t){return this.nonserializableCommand.apply(t)}unapply(t){return this.nonserializableCommand.unapply(t)}description(t,e){return this.nonserializableCommand.description(t,e)}}const Qt=(t,e)=>{let n=!0;for(const e of t)if(!(e instanceof s)){n=!1;break}return n?new Jt(t,e):new Yt(t,e)};s.register("union",((t,e)=>{if("number"!=typeof t.data.length)throw new Error("Unions of commands must serialize to lists of serialization data.");const n=t.applyChunkSize;if("number"!=typeof n&&void 0!==n)throw new Error("serialized applyChunkSize is neither undefined nor a number.");const i=[];for(const n of t.data)i.push(s.deserialize(n,e));return Qt(i,n)}));const te=Qt;class ee extends E{constructor(t,e,n){super(t.notifier,e),this.editor=t,this.localizationTable=n,this.textInputElem=null,this.textTargetPosition=null,this.textMeasuringCtx=null,this.textScale=l.of(1,1),this.removeExistingCommand=null,this.textStyle={size:32,fontFamily:"sans-serif",renderingStyle:{fill:lt.purple}},this.textEditOverlay=document.createElement("div"),this.textEditOverlay.classList.add("textEditorOverlay"),this.editor.addStyleSheet("\n\t\t\t.textEditorOverlay {\n\t\t\t\theight: 0;\n\t\t\t\toverflow: visible;\n\t\t\t}\n\n\t\t\t.textEditorOverlay textarea {\n\t\t\t\tbackground-color: rgba(0, 0, 0, 0);\n\n\t\t\t\twhite-space: pre;\n\t\t\t\toverflow: hidden;\n\n\t\t\t\tpadding: 0;\n\t\t\t\tmargin: 0;\n\t\t\t\tborder: none;\n\t\t\t\tpadding: 0;\n\n\t\t\t\tmin-width: 100px;\n\t\t\t\tmin-height: 1.1em;\n\t\t\t}\n\t\t"),this.editor.createHTMLOverlay(this.textEditOverlay),this.editor.notifier.on(x.ViewportChanged,(()=>this.updateTextInput()))}getTextAscent(t,e){var n;return null!==(n=this.textMeasuringCtx)&&void 0!==n||(this.textMeasuringCtx=document.createElement("canvas").getContext("2d")),this.textMeasuringCtx?(Pt.applyTextStyles(this.textMeasuringCtx,e),this.textMeasuringCtx.measureText(t).actualBoundingBoxAscent):2*e.size/3}flushInput(){if(this.textInputElem&&this.textTargetPosition){const t=this.textInputElem.value.trimEnd();if(this.textInputElem.remove(),this.textInputElem=null,""===t)return;const e=d.translation(this.textTargetPosition).rightMul(this.getTextScaleMatrix()).rightMul(d.scaling2D(this.editor.viewport.getSizeOfPixelOnCanvas())).rightMul(d.zRotation(this.textRotation)),n=Pt.fromLines(t.split("\n"),e,this.textStyle),i=f.addElement(n);this.removeExistingCommand?(this.removeExistingCommand.unapply(this.editor),this.editor.dispatch(te([this.removeExistingCommand,i])),this.removeExistingCommand=null):this.editor.dispatch(i)}}getTextScaleMatrix(){return d.scaling2D(this.textScale.times(1/this.editor.viewport.getSizeOfPixelOnCanvas()))}updateTextInput(){var t,e,n;if(!this.textInputElem||!this.textTargetPosition)return void(null===(t=this.textInputElem)||void 0===t||t.remove());const i=this.editor.viewport,r=i.canvasToScreen(this.textTargetPosition);this.textInputElem.placeholder=this.localizationTable.enterTextToInsert,this.textInputElem.style.fontFamily=this.textStyle.fontFamily,this.textInputElem.style.fontVariant=null!==(e=this.textStyle.fontVariant)&&void 0!==e?e:"",this.textInputElem.style.fontWeight=null!==(n=this.textStyle.fontWeight)&&void 0!==n?n:"",this.textInputElem.style.fontSize=`${this.textStyle.size}px`,this.textInputElem.style.color=this.textStyle.renderingStyle.fill.toHexString(),this.textInputElem.style.position="relative",this.textInputElem.style.left=`${r.x}px`,this.textInputElem.style.top=`${r.y}px`,this.textInputElem.style.margin="0",this.textInputElem.style.width=`${this.textInputElem.scrollWidth}px`,this.textInputElem.style.height=`${this.textInputElem.scrollHeight}px`;const o=this.getTextAscent("⎢",this.textStyle),s=this.textRotation+i.getRotationAngle(),a=this.getTextScaleMatrix();this.textInputElem.style.transform=`${a.toCSSMatrix()} rotate(${180*s/Math.PI}deg) translate(0, ${-o}px)`,this.textInputElem.style.transformOrigin="top left"}startTextInput(t,e){this.flushInput(),this.textInputElem=document.createElement("textarea"),this.textInputElem.value=e,this.textInputElem.style.display="inline-block",this.textTargetPosition=this.editor.viewport.roundPoint(t),this.textRotation=-this.editor.viewport.getRotationAngle(),this.textScale=l.of(1,1).times(this.editor.viewport.getSizeOfPixelOnCanvas()),this.updateTextInput(),setTimeout((()=>this.updateTextInput()),0),this.textInputElem.oninput=()=>{this.textInputElem&&(this.textInputElem.style.width=`${this.textInputElem.scrollWidth}px`,this.textInputElem.style.height=`${this.textInputElem.scrollHeight}px`)},this.textInputElem.onblur=()=>{setTimeout((()=>this.flushInput()),0)},this.textInputElem.onkeyup=t=>{var e,n;"Enter"!==t.key||t.shiftKey?"Escape"===t.key&&(null===(e=this.textInputElem)||void 0===e||e.remove(),this.textInputElem=null,this.editor.focus(),null===(n=this.removeExistingCommand)||void 0===n||n.unapply(this.editor),this.removeExistingCommand=null):(this.flushInput(),this.editor.focus())},this.textEditOverlay.replaceChildren(this.textInputElem),setTimeout((()=>{var t;return null===(t=this.textInputElem)||void 0===t?void 0:t.focus()}),0)}setEnabled(t){super.setEnabled(t),t||this.flushInput(),this.textEditOverlay.style.display=t?"block":"none"}onPointerDown({current:t,allPointers:e}){if(t.device===b.Eraser)return!1;if(1===e.length){const e=t.canvasPos,n=l.of(2.5,2.5).times(this.editor.viewport.getSizeOfPixelOnCanvas()),i=m.fromCorners(e.minus(n),e.plus(n));let r=this.editor.image.getElementsIntersectingRegion(i).filter((t=>t instanceof Pt));const o=this.editor.viewport.visibleRect;if(r=r.filter((t=>!t.getBBox().containsRect(o))),this.flushInput(),r.length>0){const t=r[r.length-1];this.setTextStyle(t.getTextStyle()),this.removeExistingCommand=new bt([t]),this.removeExistingCommand.apply(this.editor),this.startTextInput(t.getBaselinePos(),t.getText());const e=t.getTransform();this.textRotation=e.transformVec3(l.unitX).angle();const n=e.transformVec3(l.unitX).magnitude();this.textScale=l.of(1,1).times(n),this.updateTextInput()}else this.removeExistingCommand=null,this.startTextInput(t.canvasPos,"");return!0}return!1}onGestureCancel(){this.flushInput(),this.editor.focus()}dispatchUpdateEvent(){this.updateTextInput(),this.editor.notifier.dispatch(x.ToolUpdated,{kind:x.ToolUpdated,tool:this})}setFontFamily(t){t!==this.textStyle.fontFamily&&(this.textStyle=Object.assign(Object.assign({},this.textStyle),{fontFamily:t}),this.dispatchUpdateEvent())}setColor(t){t.eq(this.textStyle.renderingStyle.fill)||(this.textStyle=Object.assign(Object.assign({},this.textStyle),{renderingStyle:Object.assign(Object.assign({},this.textStyle.renderingStyle),{fill:t})}),this.dispatchUpdateEvent())}setFontSize(t){t!==this.textStyle.size&&(this.textStyle=Object.assign(Object.assign({},this.textStyle),{size:t}),this.dispatchUpdateEvent())}getTextStyle(){return this.textStyle}setTextStyle(t){this.textStyle=Object.assign(Object.assign({},t),{renderingStyle:Object.assign({},t.renderingStyle)}),this.dispatchUpdateEvent()}}class ne extends E{constructor(t,e){super(t.notifier,e),this.editor=t,this.colorPreviewListener=null,this.colorSelectListener=null}setColorListener(t,e){this.colorPreviewListener=t,this.colorSelectListener=e}clearColorListener(){this.colorPreviewListener=null,this.colorSelectListener=null}onPointerDown({current:t,allPointers:e}){return!(!this.colorPreviewListener||1!==e.length||(this.colorPreviewListener(this.editor.display.getColorAt(t.screenPos)),0))}onPointerMove({current:t}){var e;null===(e=this.colorPreviewListener)||void 0===e||e.call(this,this.editor.display.getColorAt(t.screenPos))}onPointerUp({current:t}){var e;null===(e=this.colorSelectListener)||void 0===e||e.call(this,this.editor.display.getColorAt(t.screenPos))}onGestureCancel(){var t;null===(t=this.colorSelectListener)||void 0===t||t.call(this,null)}}class ie extends E{constructor(t){super(t.notifier,t.localization.changeTool),this.editor=t}onKeyPress({key:t}){const e=this.editor.toolController.getPrimaryTools(),n=/^[0-9]$/.exec(t);let i;return n&&(i=e[parseInt(n[0],10)-1]),!!i&&(i.setEnabled(!0),!0)}}const re=(t,e)=>{const n=3*e.getSizeOfPixelOnCanvas(),i=e.getSizeOfPixelOnCanvas();return new oe(t,i,n,e)};class oe{constructor(t,e,n,i){this.startPoint=t,this.minFitAllowed=e,this.viewport=i,this.isFirstSegment=!0,this.pathStartConnector=null,this.mostRecentConnector=null,this.lastUpperBezier=null,this.lastLowerBezier=null,this.parts=[],this.upperSegments=[],this.lowerSegments=[],this.curveFitter=new pt(t,e,n,(t=>this.addCurve(t))),this.curveStartWidth=t.width,this.bbox=new m(this.startPoint.pos.x,this.startPoint.pos.y,0,0)}getBBox(){return this.bbox}getRenderingStyle(){var t;return{fill:null!==(t=this.startPoint.color)&&void 0!==t?t:null}}previewCurrentPath(){var t;const e=this.upperSegments.slice(),n=this.lowerSegments.slice();let i,r;const o=this.curveFitter.preview();if(o){const{upperCurveCommand:s,lowerToUpperConnector:a,upperToLowerConnector:l,lowerCurveCommand:c}=this.segmentToPath(o);e.push(s),n.push(c),i=a,r=null!==(t=this.pathStartConnector)&&void 0!==t?t:l}else{if(null===this.mostRecentConnector||null===this.pathStartConnector)return null;i=this.mostRecentConnector,r=this.pathStartConnector}let s;const a=n[n.length-1];return s=a.kind===st.LineTo||a.kind===st.MoveTo?a.point:a.endPoint,{startPoint:s,commands:[i,...e.reverse(),r,...n],style:this.getRenderingStyle()}}previewFullPath(){const t=this.previewCurrentPath();return t?[...this.parts,t]:null}previewStroke(){const t=this.previewFullPath();return t?new ut(t):null}preview(t){const e=this.previewFullPath();if(e){const n=this.viewport.visibleRect;t.startObject(n);for(const n of e)t.drawPath(n);t.endObject()}}build(){return this.curveFitter.finalizeCurrentCurve(),this.isFirstSegment&&this.addCurve(null),this.previewStroke()}roundPoint(t){let e=Math.min(this.minFitAllowed,this.curveStartWidth/2);return e<1e-10&&(e=this.minFitAllowed),P.roundPoint(t,e)}shouldStartNewSegment(t,e){if(!this.lastLowerBezier||!this.lastUpperBezier)return!1;const n=(t,e)=>{const n=t.intersects(e);if(!n||0===n.length)return null;const i=n[0],r=/^([-0-9.eE]+)\/([-0-9.eE]+)$/.exec(i);if(!r)throw new Error(`Incorrect format returned by .intersects: ${n} should be array of "number/number"!`);const o=parseFloat(r[1]);return l.ofXY(t.get(o))},i=t=>l.ofXY(t.points[2]).minus(l.ofXY(t.points[1])).normalized(),r=t=>l.ofXY(t.points[1]).minus(l.ofXY(t.points[0])).normalized();if(r(e).dot(i(this.lastUpperBezier))<.3||r(t).dot(i(this.lastLowerBezier))<.3||r(e).dot(i(e))<0||r(t).dot(i(t))<0)return!0;const o=n(t,this.lastUpperBezier),s=n(e,this.lastLowerBezier);return!(!o&&!s)}addCurve(t){if(!t){if(!this.isFirstSegment)return;const t=P.roundPoint(this.startPoint.width/3.5,Math.min(this.minFitAllowed,this.startPoint.width/4)),e=this.roundPoint(this.startPoint.pos),n=this.startPoint.pos.plus(l.of(t,0));return this.lowerSegments.push({kind:st.QuadraticBezierTo,controlPoint:e.plus(l.of(t,t)),endPoint:e.plus(l.of(0,t))},{kind:st.QuadraticBezierTo,controlPoint:e.plus(l.of(-t,t)),endPoint:e.plus(l.of(-t,0))},{kind:st.QuadraticBezierTo,controlPoint:e.plus(l.of(-t,-t)),endPoint:e.plus(l.of(0,-t))},{kind:st.QuadraticBezierTo,controlPoint:e.plus(l.of(t,-t)),endPoint:e.plus(l.of(t,0))}),this.pathStartConnector={kind:st.LineTo,point:n},void(this.mostRecentConnector=this.pathStartConnector)}const{upperCurveCommand:e,lowerToUpperConnector:n,upperToLowerConnector:i,lowerCurveCommand:r,lowerCurve:o,upperCurve:s}=this.segmentToPath(t),a=this.shouldStartNewSegment(o,s);if(a){const t=this.previewCurrentPath();t&&(this.parts.push(t),this.upperSegments=[],this.lowerSegments=[])}(this.isFirstSegment||a)&&(this.pathStartConnector=i,this.isFirstSegment=!1),this.mostRecentConnector=n,this.lowerSegments.push(r),this.upperSegments.push(e),this.lastLowerBezier=o,this.lastUpperBezier=s,this.curveStartWidth=t.startWidth}segmentToPath(t){const e=new tt(t.startPoint.xy,t.controlPoint.xy,t.endPoint.xy);let n=l.ofXY(e.normal(0)).normalized(),i=l.ofXY(e.normal(1)).normalized();n=n.times(t.startWidth/2),i=i.times(t.endWidth/2),isFinite(n.magnitude())||(console.error("Warning: startVec is NaN or ∞",n,i,t),n=i);const r=t.startPoint,o=t.endPoint,s=t.controlPoint;let a=e.project(s.xy).t;a||(a=r.minus(s).magnitudeSquared()<o.minus(s).magnitudeSquared()?.1:.9);const c=a,h=l.ofXY(e.normal(c)).normalized().times(t.startWidth/2*c+t.endWidth/2*(1-c)),d=this.roundPoint(r.plus(n)),u=this.roundPoint(s.plus(h)),p=this.roundPoint(o.plus(i)),m=this.roundPoint(s.minus(h)),g=this.roundPoint(o.minus(i)),f=this.roundPoint(r.minus(n)),v={kind:st.QuadraticBezierTo,controlPoint:u,endPoint:p},y={kind:st.LineTo,point:d},x={kind:st.LineTo,point:g};return{upperCurveCommand:{kind:st.QuadraticBezierTo,controlPoint:m,endPoint:f},upperToLowerConnector:y,lowerToUpperConnector:x,lowerCurveCommand:v,upperCurve:new tt(g,m,f),lowerCurve:new tt(d,u,p)}}addPoint(t){this.curveFitter.addPoint(t)}}const se=t=>t instanceof s?new class extends s{serializeToJSON(){return t.serialize()}apply(e){t.unapply(e)}unapply(e){t.unapply(e)}description(e,n){return n.inverseOf(t.description(e,n))}}("inverse"):new class extends o{apply(e){t.unapply(e)}unapply(e){t.apply(e)}description(e,n){return n.inverseOf(t.description(e,n))}};s.register("inverse",((t,e)=>se(s.deserialize(t,e))));const ae=se;var le=function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{l(i.next(t))}catch(t){o(t)}}function a(t){try{l(i.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}l((i=i.apply(t,e||[])).next())}))};class ce extends E{constructor(t){super(t.notifier,t.localization.pasteHandler),this.editor=t}onPaste(t){const e=t.mime.toLowerCase();return"image/svg+xml"===e?(this.doSVGPaste(t.data),!0):"text/plain"===e?(this.doTextPaste(t.data),!0):("image/png"===e||"image/jpeg"===e)&&(this.doImagePaste(t.data),!0)}addComponentsFromPaste(t){return le(this,void 0,void 0,(function*(){let e=null;for(const n of t)e=e?e.union(n.getBBox()):n.getBBox();if(!e)return;const n=this.editor.viewport.visibleRect,i=n.width/e.width,r=n.height/e.height;let o=i;(e.width*o>n.width||e.height*o>n.height)&&(o=r),o*=2/3,o=P.roundScaleRatio(o);const s=d.translation(n.center.minus(e.center)).rightMul(d.scaling2D(o,e.center)),a=[];for(const e of t)a.push(f.addElement(e)),a.push(e.transformBy(s));this.editor.dispatch(te(a,100),!0);for(const e of this.editor.toolController.getMatchingTools(Zt))e.setEnabled(!0),e.setSelection(t)}))}doSVGPaste(t){return le(this,void 0,void 0,(function*(){const e=Lt.fromString(t,!0),n=[];yield e.start((t=>{n.push(t)}),((t,e)=>null)),yield this.addComponentsFromPaste(n)}))}doTextPaste(t){var e,n;return le(this,void 0,void 0,(function*(){const i=this.editor.toolController.getMatchingTools(ee);i.sort(((t,e)=>!t.isEnabled()&&e.isEnabled()?-1:!e.isEnabled()&&t.isEnabled()?1:0));const r={size:12,fontFamily:"sans",renderingStyle:{fill:lt.red}},o=null!==(n=null===(e=i[0])||void 0===e?void 0:e.getTextStyle())&&void 0!==n?n:r,s=t.split("\n");yield this.addComponentsFromPaste([Pt.fromLines(s,d.identity,o)])}))}doImagePaste(t){return le(this,void 0,void 0,(function*(){const e=new Image;e.src=t;const n=yield Tt.fromImage(e,d.identity);yield this.addComponentsFromPaste([n])}))}}class he extends E{constructor(t){super(t.notifier,t.localization.changeTool),this.listeners=new Set([])}registerListener(t){this.listeners.add(t)}removeListener(t){this.listeners.delete(t)}onKeyPress(t){for(const e of this.listeners)if(e(t))return!0;return!1}}class de extends E{constructor(t){super(t.notifier,t.localization.findLabel),this.editor=t,this.currentMatchIdx=0,this.overlay=document.createElement("div"),this.fillOverlay(),t.createHTMLOverlay(this.overlay),this.overlay.style.display="none",this.overlay.classList.add("find-tool-overlay")}getMatches(t){return t=t.toLocaleLowerCase(),this.editor.image.getAllElements().filter((t=>t instanceof Pt)).filter((e=>-1!==e.getText().toLocaleLowerCase().indexOf(t))).map((t=>t.getBBox()))}focusCurrentMatch(){const t=this.getMatches(this.searchInput.value);let e=this.currentMatchIdx%t.length;e<0&&(e=t.length+e),e<t.length&&(this.editor.dispatch(this.editor.viewport.zoomTo(t[e],!0,!0)),this.editor.announceForAccessibility(this.editor.localization.focusedFoundText(e+1,t.length)))}toNextMatch(){this.currentMatchIdx++,this.focusCurrentMatch()}toPrevMatch(){this.currentMatchIdx--,this.focusCurrentMatch()}fillOverlay(){const t=document.createElement("label");this.searchInput=document.createElement("input");const e=document.createElement("button"),n=document.createElement("button");this.searchInput.setAttribute("id",`find-tool-searchInput-${Math.random()}`),t.htmlFor=this.searchInput.getAttribute("id"),t.innerText=this.editor.localization.findLabel,e.innerText=this.editor.localization.toNextMatch,n.innerText=this.editor.localization.closeFindDialog,this.searchInput.onkeydown=t=>{"Enter"===t.key?t.shiftKey?this.toPrevMatch():this.toNextMatch():"Escape"===t.key?this.setVisible(!1):"f"===t.key&&t.ctrlKey&&(t.preventDefault(),this.toggleVisible())},e.onclick=()=>{this.toNextMatch()},n.onclick=()=>{this.setVisible(!1)},this.overlay.replaceChildren(t,this.searchInput,e,n)}isVisible(){return"none"!==this.overlay.style.display}setVisible(t){t!==this.isVisible()&&(this.overlay.style.display=t?"block":"none",t?(this.searchInput.focus(),this.editor.announceForAccessibility(this.editor.localization.findDialogShown)):(this.editor.focus(),this.editor.announceForAccessibility(this.editor.localization.findDialogHidden)))}toggleVisible(){this.setVisible(!this.isVisible())}onKeyPress(t){return!(!t.ctrlKey||"f"!==t.key||(this.toggleVisible(),0))}setEnabled(t){super.setEnabled(t),t&&this.setVisible(!1)}}class ue{constructor(t,e){this.activeTool=null;const n=new yt;this.primaryToolGroup=n;const i=new B(t,z.TwoFingerTouchGestures|z.RightClickDrags,e.touchPanTool),r=new B(t,z.Keyboard,e.keyboardPanZoom),o=new vt(t,e.penTool(1),{color:lt.purple,thickness:16}),s=[o,new vt(t,e.penTool(2),{color:lt.clay,thickness:4}),new vt(t,e.penTool(3),{color:lt.ofRGBA(1,1,0,.5),thickness:64},re),new wt(t,e.eraserTool),new Zt(t,e.selectionTool),new ee(t,e.textTool,e),new B(t,z.SinglePointerGestures,e.anyDevicePanning)];this.tools=[new ne(t,e.pipetteTool),i,...s,r,new Xt(t),new he(t),new ie(t),new de(t),new ce(t)],s.forEach((t=>t.setToolGroup(n))),i.setEnabled(!0),o.setEnabled(!0),t.notifier.on(x.ToolEnabled,(n=>{n.kind===x.ToolEnabled&&t.announceForAccessibility(e.toolEnabledAnnouncement(n.tool.description))})),t.notifier.on(x.ToolDisabled,(n=>{n.kind===x.ToolDisabled&&t.announceForAccessibility(e.toolDisabledAnnouncement(n.tool.description))})),this.activeTool=null}setTools(t,e){this.tools=t,this.primaryToolGroup=null!=e?e:new yt}addPrimaryTool(t){t.setToolGroup(this.primaryToolGroup),t.isEnabled()&&this.primaryToolGroup.notifyEnabled(t),this.addTool(t)}getPrimaryTools(){return this.tools.filter((t=>t.getToolGroup()===this.primaryToolGroup))}addTool(t){this.tools.push(t)}dispatchInputEvent(t){var e,n;let i=!1;if(t.kind===y.PointerDownEvt){for(const n of this.tools)if(n.isEnabled()&&n.onPointerDown(t)){this.activeTool!==n&&(null===(e=this.activeTool)||void 0===e||e.onGestureCancel()),this.activeTool=n,i=!0;break}}else if(t.kind===y.PointerUpEvt)null===(n=this.activeTool)||void 0===n||n.onPointerUp(t),this.activeTool=null,i=!0;else if(t.kind===y.PointerMoveEvt)null!==this.activeTool&&(this.activeTool.onPointerMove(t),i=!0);else if(t.kind===y.GestureCancelEvt)null!==this.activeTool&&(this.activeTool.onGestureCancel(),this.activeTool=null);else{let e;for(const n of this.tools)if(n.isEnabled()){switch(t.kind){case y.KeyPressEvent:i=n.onKeyPress(t);break;case y.KeyUpEvent:i=n.onKeyUp(t);break;case y.WheelEvt:i=n.onWheel(t);break;case y.CopyEvent:i=n.onCopy(t);break;case y.PasteEvent:i=n.onPaste(t);break;default:return e=t,e}if(i)break}}return i}getMatchingTools(t){return this.tools.filter((e=>e instanceof t))}}class pe{constructor(){this.listeners={}}dispatch(t,e){const n=this.listeners[t];if(n)for(let t=0;t<n.length;t++)n[t](e)}on(t,e){return this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e),{remove:()=>{const n=this.listeners[t];return this.off(t,e),n.length!==this.listeners[t].length}}}off(t,e){const n=this.listeners[t];n&&(this.listeners[t]=n.filter((t=>t!==e)))}}var me=function(t,e,n){var i,r,o,s,a,l,c,h,d,u,p,m,g,f,v,y=e.createElement("canvas").getContext("2d"),x={r:0,g:0,b:0,h:0,s:0,v:0,a:1},b={el:"[data-coloris]",parent:"body",theme:"default",themeMode:"light",wrap:!0,margin:2,format:"hex",formatToggle:!1,swatches:[],swatchesOnly:!1,alpha:!0,forceAlpha:!1,focusInput:!0,selectInput:!1,inline:!1,defaultColor:"#000000",clearButton:!1,clearLabel:"Clear",a11y:{open:"Open color picker",close:"Close color picker",marker:"Saturation: {s}. Brightness: {v}.",hueSlider:"Hue slider",alphaSlider:"Opacity slider",input:"Color value field",format:"Color format",swatch:"Color swatch",instruction:"Saturation and brightness selector. Use up, down, left and right arrow keys to select."}},w={},T="",S={},C=!1;function k(n){if("object"==typeof n)for(var s in n)switch(s){case"el":B(n.el),!1!==n.wrap&&I(n.el);break;case"parent":(i=e.querySelector(n.parent))&&(i.appendChild(r),b.parent=n.parent,i===e.body&&(i=null));break;case"themeMode":b.themeMode=n.themeMode,"auto"===n.themeMode&&t.matchMedia&&t.matchMedia("(prefers-color-scheme: dark)").matches&&(b.themeMode="dark");case"theme":n.theme&&(b.theme=n.theme),r.className="clr-picker clr-"+b.theme+" clr-"+b.themeMode,b.inline&&R();break;case"margin":n.margin*=1,b.margin=isNaN(n.margin)?b.margin:n.margin;break;case"wrap":n.el&&n.wrap&&I(n.el);break;case"formatToggle":b.formatToggle=!!n.formatToggle,H("clr-format").style.display=b.formatToggle?"block":"none",b.formatToggle&&(b.format="auto");break;case"swatches":Array.isArray(n.swatches)&&function(){var t=[];n.swatches.forEach((function(e,n){t.push('<button type="button" id="clr-swatch-'+n+'" aria-labelledby="clr-swatch-label clr-swatch-'+n+'" style="color: '+e+';">'+e+"</button>")})),H("clr-swatches").innerHTML=t.length?"<div>"+t.join("")+"</div>":"",b.swatches=n.swatches.slice()}();break;case"swatchesOnly":b.swatchesOnly=!!n.swatchesOnly,r.setAttribute("data-minimal",b.swatchesOnly);break;case"alpha":b.alpha=!!n.alpha,r.setAttribute("data-alpha",b.alpha);break;case"inline":if(b.inline=!!n.inline,r.setAttribute("data-inline",b.inline),b.inline){var a=n.defaultColor||b.defaultColor;f=M(a),R(),A(a)}break;case"clearButton":"object"==typeof n.clearButton&&(n.clearButton.label&&(b.clearLabel=n.clearButton.label,h.innerHTML=b.clearLabel),n.clearButton=n.clearButton.show),b.clearButton=!!n.clearButton,h.style.display=b.clearButton?"block":"none";break;case"clearLabel":b.clearLabel=n.clearLabel,h.innerHTML=b.clearLabel;break;case"a11y":var u=n.a11y,m=!1;if("object"==typeof u)for(var g in u)u[g]&&b.a11y[g]&&(b.a11y[g]=u[g],m=!0);if(m){var v=H("clr-open-label"),y=H("clr-swatch-label");v.innerHTML=b.a11y.open,y.innerHTML=b.a11y.swatch,l.setAttribute("aria-label",b.a11y.close),d.setAttribute("aria-label",b.a11y.hueSlider),p.setAttribute("aria-label",b.a11y.alphaSlider),c.setAttribute("aria-label",b.a11y.input),o.setAttribute("aria-label",b.a11y.instruction)}default:b[s]=n[s]}}function P(t,e){"string"==typeof t&&"object"==typeof e&&(w[t]=e,C=!0)}function E(t){delete w[t],0===Object.keys(w).length&&(C=!1,t===T&&z())}function z(){Object.keys(S).length>0&&(k(S),T="",S={})}function B(t){G(e,"click",t,(function(t){b.inline||(function(t){if(C){var e=["el","wrap","inline","defaultColor","a11y"],n=function(n){var i=w[n];if(t.matches(n)){for(var r in T=n,S={},e.forEach((function(t){return delete i[t]})),i)S[r]=Array.isArray(b[r])?b[r].slice():b[r];return k(i),"break"}};for(var i in w)if("break"===n(i))break}}(t.target),g=t.target,v=g.value,f=M(v),r.classList.add("clr-open"),R(),A(v),(b.focusInput||b.selectInput)&&c.focus({preventScroll:!0}),b.selectInput&&c.select(),g.dispatchEvent(new Event("open",{bubbles:!0})))})),G(e,"input",t,(function(t){var e=t.target.parentNode;e.classList.contains("clr-field")&&(e.style.color=t.target.value)}))}function R(){var n,a,l,c=i,h=t.scrollY,d=r.offsetWidth,u=r.offsetHeight,p={left:!1,top:!1},m={x:0,y:0};if(c&&(n=t.getComputedStyle(c),a=parseFloat(n.marginTop),l=parseFloat(n.borderTopWidth),(m=c.getBoundingClientRect()).y+=l+h),!b.inline){var f=g.getBoundingClientRect(),v=f.x,y=h+f.y+f.height+b.margin;c?(v-=m.x,y-=m.y,v+d>c.clientWidth&&(v+=f.width-d,p.left=!0),y+u>c.clientHeight-a&&u+b.margin<=f.top-(m.y-h)&&(y-=f.height+u+2*b.margin,p.top=!0),y+=c.scrollTop):(v+d>e.documentElement.clientWidth&&(v+=f.width-d,p.left=!0),y+u-h>e.documentElement.clientHeight&&u+b.margin<=f.top&&(y=h+f.y-u-b.margin,p.top=!0)),r.classList.toggle("clr-left",p.left),r.classList.toggle("clr-top",p.top),r.style.left=v+"px",r.style.top=y+"px"}s={width:o.offsetWidth,height:o.offsetHeight,x:r.offsetLeft+o.offsetLeft+m.x,y:r.offsetTop+o.offsetTop+m.y}}function I(t){e.querySelectorAll(t).forEach((function(t){var n=t.parentNode;if(!n.classList.contains("clr-field")){var i=e.createElement("div");i.innerHTML='<button type="button" aria-labelledby="clr-open-label"></button>',n.insertBefore(i,t),i.setAttribute("class","clr-field"),i.style.color=t.value,i.appendChild(t)}}))}function L(t){if(g&&!b.inline){var e=g;t&&(g=null,v!==e.value&&(e.value=v,e.dispatchEvent(new Event("input",{bubbles:!0})))),setTimeout((function(){v!==e.value&&e.dispatchEvent(new Event("change",{bubbles:!0}))})),r.classList.remove("clr-open"),C&&z(),e.dispatchEvent(new Event("close",{bubbles:!0})),b.focusInput&&e.focus({preventScroll:!0}),g=null}}function A(t){var e=function(t){var e,n;return y.fillStyle="#000",y.fillStyle=t,(e=/^((rgba)|rgb)[\D]+([\d.]+)[\D]+([\d.]+)[\D]+([\d.]+)[\D]*?([\d.]+|$)/i.exec(y.fillStyle))?(n={r:1*e[3],g:1*e[4],b:1*e[5],a:1*e[6]}).a=+n.a.toFixed(2):n={r:(e=y.fillStyle.replace("#","").match(/.{2}/g).map((function(t){return parseInt(t,16)})))[0],g:e[1],b:e[2],a:1},n}(t),i=function(t){var e=t.r/255,i=t.g/255,r=t.b/255,o=n.max(e,i,r),s=o-n.min(e,i,r),a=o,l=0,c=0;return s&&(o===e&&(l=(i-r)/s),o===i&&(l=2+(r-e)/s),o===r&&(l=4+(e-i)/s),o&&(c=s/o)),{h:(l=n.floor(60*l))<0?l+360:l,s:n.round(100*c),v:n.round(100*a),a:t.a}}(e);F(i.s,i.v),j(e,i),d.value=i.h,r.style.color="hsl("+i.h+", 100%, 50%)",u.style.left=i.h/360*100+"%",a.style.left=s.width*i.s/100+"px",a.style.top=s.height-s.height*i.v/100+"px",p.value=100*i.a,m.style.left=100*i.a+"%"}function M(t){var e=t.substring(0,3).toLowerCase();return"rgb"===e||"hsl"===e?e:"hex"}function D(t){t=void 0!==t?t:c.value,g&&(g.value=t,g.dispatchEvent(new Event("input",{bubbles:!0}))),e.dispatchEvent(new CustomEvent("coloris:pick",{detail:{color:t}}))}function O(t,e){var i={h:1*d.value,s:t/s.width*100,v:100-e/s.height*100,a:p.value/100},r=function(t){var e=t.v/100,i=t.s/100*e,r=t.h/60,o=i*(1-n.abs(r%2-1)),s=e-i;i+=s,o+=s;var a=n.floor(r)%6,l=[i,o,s,s,o,i][a],c=[o,i,i,o,s,s][a],h=[s,s,o,i,i,o][a];return{r:n.round(255*l),g:n.round(255*c),b:n.round(255*h),a:t.a}}(i);F(i.s,i.v),j(r,i),D()}function F(t,e){var n=b.a11y.marker;t=1*t.toFixed(1),e=1*e.toFixed(1),n=(n=n.replace("{s}",t)).replace("{v}",e),a.setAttribute("aria-label",n)}function $(t){var e=function(t){return{pageX:t.changedTouches?t.changedTouches[0].pageX:t.pageX,pageY:t.changedTouches?t.changedTouches[0].pageY:t.pageY}}(t),n=e.pageX-s.x,r=e.pageY-s.y;i&&(r+=i.scrollTop),n=n<0?0:n>s.width?s.width:n,r=r<0?0:r>s.height?s.height:r,a.style.left=n+"px",a.style.top=r+"px",O(n,r),t.preventDefault(),t.stopPropagation()}function N(t,e){var n=1*a.style.left.replace("px","")+t,i=1*a.style.top.replace("px","")+e;a.style.left=n+"px",a.style.top=i+"px",O(n,i)}function j(t,i){void 0===t&&(t={}),void 0===i&&(i={});var r=b.format;for(var s in t)x[s]=t[s];for(var h in i)x[h]=i[h];var d,u=function(t){var e=t.r.toString(16),n=t.g.toString(16),i=t.b.toString(16),r="";if(t.r<16&&(e="0"+e),t.g<16&&(n="0"+n),t.b<16&&(i="0"+i),b.alpha&&(t.a<1||b.forceAlpha)){var o=255*t.a|0;r=o.toString(16),o<16&&(r="0"+r)}return"#"+e+n+i+r}(x),p=u.substring(0,7);switch(a.style.color=p,m.parentNode.style.color=p,m.style.color=u,l.style.color=u,o.style.display="none",o.offsetHeight,o.style.display="",m.nextElementSibling.style.display="none",m.nextElementSibling.offsetHeight,m.nextElementSibling.style.display="","mixed"===r?r=1===x.a?"hex":"rgb":"auto"===r&&(r=f),r){case"hex":c.value=u;break;case"rgb":c.value=function(t){return!b.alpha||1===t.a&&!b.forceAlpha?"rgb("+t.r+", "+t.g+", "+t.b+")":"rgba("+t.r+", "+t.g+", "+t.b+", "+t.a+")"}(x);break;case"hsl":c.value=(d=function(t){var e,i=t.v/100,r=i*(1-t.s/100/2);return r>0&&r<1&&(e=n.round((i-r)/n.min(r,1-r)*100)),{h:t.h,s:e||0,l:n.round(100*r),a:t.a}}(x),!b.alpha||1===d.a&&!b.forceAlpha?"hsl("+d.h+", "+d.s+"%, "+d.l+"%)":"hsla("+d.h+", "+d.s+"%, "+d.l+"%, "+d.a+")")}e.querySelector('.clr-format [value="'+r+'"]').checked=!0}function U(){var t=1*d.value,e=1*a.style.left.replace("px",""),n=1*a.style.top.replace("px","");r.style.color="hsl("+t+", 100%, 50%)",u.style.left=t/360*100+"%",O(e,n)}function V(){var t=p.value/100;m.style.left=100*t+"%",j({a:t}),D()}function W(){i=null,(r=e.createElement("div")).setAttribute("id","clr-picker"),r.className="clr-picker",r.innerHTML='<input id="clr-color-value" class="clr-color" type="text" value="" spellcheck="false" aria-label="'+b.a11y.input+'"><div id="clr-color-area" class="clr-gradient" role="application" aria-label="'+b.a11y.instruction+'"><div id="clr-color-marker" class="clr-marker" tabindex="0"></div></div><div class="clr-hue"><input id="clr-hue-slider" type="range" min="0" max="360" step="1" aria-label="'+b.a11y.hueSlider+'"><div id="clr-hue-marker"></div></div><div class="clr-alpha"><input id="clr-alpha-slider" type="range" min="0" max="100" step="1" aria-label="'+b.a11y.alphaSlider+'"><div id="clr-alpha-marker"></div><span></span></div><div id="clr-format" class="clr-format"><fieldset class="clr-segmented"><legend>'+b.a11y.format+'</legend><input id="clr-f1" type="radio" name="clr-format" value="hex"><label for="clr-f1">Hex</label><input id="clr-f2" type="radio" name="clr-format" value="rgb"><label for="clr-f2">RGB</label><input id="clr-f3" type="radio" name="clr-format" value="hsl"><label for="clr-f3">HSL</label><span></span></fieldset></div><div id="clr-swatches" class="clr-swatches"></div><button type="button" id="clr-clear" class="clr-clear">'+b.clearLabel+'</button><button type="button" id="clr-color-preview" class="clr-preview" aria-label="'+b.a11y.close+'"></button><span id="clr-open-label" hidden>'+b.a11y.open+'</span><span id="clr-swatch-label" hidden>'+b.a11y.swatch+"</span>",e.body.appendChild(r),o=H("clr-color-area"),a=H("clr-color-marker"),h=H("clr-clear"),l=H("clr-color-preview"),c=H("clr-color-value"),d=H("clr-hue-slider"),u=H("clr-hue-marker"),p=H("clr-alpha-slider"),m=H("clr-alpha-marker"),B(b.el),I(b.el),G(r,"mousedown",(function(t){r.classList.remove("clr-keyboard-nav"),t.stopPropagation()})),G(o,"mousedown",(function(t){G(e,"mousemove",$)})),G(o,"touchstart",(function(t){e.addEventListener("touchmove",$,{passive:!1})})),G(a,"mousedown",(function(t){G(e,"mousemove",$)})),G(a,"touchstart",(function(t){e.addEventListener("touchmove",$,{passive:!1})})),G(c,"change",(function(t){g&&(A(c.value),D())})),G(h,"click",(function(t){D(""),L()})),G(l,"click",(function(t){D(),L()})),G(e,"click",".clr-format input",(function(t){f=t.target.value,j(),D()})),G(r,"click",".clr-swatches button",(function(t){A(t.target.textContent),D(),b.swatchesOnly&&L()})),G(e,"mouseup",(function(t){e.removeEventListener("mousemove",$)})),G(e,"touchend",(function(t){e.removeEventListener("touchmove",$)})),G(e,"mousedown",(function(t){r.classList.remove("clr-keyboard-nav"),L()})),G(e,"keydown",(function(t){"Escape"===t.key?L(!0):"Tab"===t.key&&r.classList.add("clr-keyboard-nav")})),G(e,"click",".clr-field button",(function(t){C&&z(),t.target.nextElementSibling.dispatchEvent(new Event("click",{bubbles:!0}))})),G(a,"keydown",(function(t){var e={ArrowUp:[0,-1],ArrowDown:[0,1],ArrowLeft:[-1,0],ArrowRight:[1,0]};-1!==Object.keys(e).indexOf(t.key)&&(N.apply(void 0,e[t.key]),t.preventDefault())})),G(o,"click",$),G(d,"input",U),G(p,"input",V)}function H(t){return e.getElementById(t)}function G(t,e,n,i){var r=Element.prototype.matches||Element.prototype.msMatchesSelector;"string"==typeof n?t.addEventListener(e,(function(t){r.call(t.target,n)&&i.call(t.target,t)})):(i=n,t.addEventListener(e,i))}function _(t,n){n=void 0!==n?n:[],"loading"!==e.readyState?t.apply(void 0,n):e.addEventListener("DOMContentLoaded",(function(){t.apply(void 0,n)}))}void 0!==NodeList&&NodeList.prototype&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=Array.prototype.forEach);var q=function(){var t={init:W,set:k,wrap:I,close:L,setInstance:P,removeInstance:E,updatePosition:R};function e(t){_((function(){t&&("string"==typeof t?B(t):k(t))}))}var n=function(n){e[n]=function(){for(var e=arguments.length,i=new Array(e),r=0;r<e;r++)i[r]=arguments[r];_(t[n],i)}};for(var i in t)n(i);return e}();return q.coloris=q,q}(window,document,Math),ge=me.coloris,fe=me.init;me.set,me.wrap,me.close;const ve={pen:"Pen",eraser:"Eraser",select:"Select",handTool:"Pan",zoom:"Zoom",resetView:"Reset view",thicknessLabel:"Thickness: ",colorLabel:"Color: ",fontLabel:"Font: ",textSize:"Size: ",resizeImageToSelection:"Resize image to selection",deleteSelection:"Delete selection",duplicateSelection:"Duplicate selection",undo:"Undo",redo:"Redo",selectObjectType:"Object type: ",pickColorFromScreen:"Pick color from screen",clickToPickColorAnnouncement:"Click on the screen to pick a color",selectionToolKeyboardShortcuts:"Selection tool: Use arrow keys to move selected items, lowercase/uppercase ‘i’ and ‘o’ to resize.",touchPanning:"Touchscreen panning",freehandPen:"Freehand",pressureSensitiveFreehandPen:"Freehand (pressure sensitive)",arrowPen:"Arrow",linePen:"Line",outlinedRectanglePen:"Outlined rectangle",filledRectanglePen:"Filled rectangle",lockRotation:"Lock rotation",dropdownShown:t=>`Dropdown for ${t} shown`,dropdownHidden:t=>`Dropdown for ${t} hidden`,zoomLevel:t=>`Zoom: ${t}%`,colorChangedAnnouncement:t=>`Color changed to ${t}`},ye=(t,e)=>new xe(t);class xe{constructor(t){this.startPoint=t,this.endPoint=t}getLineWidth(){return Math.max(this.endPoint.width,this.startPoint.width)}getBBox(){return this.buildPreview().getBBox()}buildPreview(){const t=this.startPoint.pos,e=this.endPoint.pos,n=e.minus(t).normalized(),i=e.minus(t).length(),r=Math.min(this.getLineWidth(),i/2),o=this.startPoint.width/2,s=this.endPoint.width/2,a=e.minus(n.times(r)),l=n.orthog(),c=l.times(o),h=l.times(s);return new ut([{startPoint:a.minus(h),commands:[{kind:st.LineTo,point:t.minus(c)},{kind:st.LineTo,point:t.plus(c)},{kind:st.LineTo,point:a.plus(h)},{kind:st.LineTo,point:a.plus(l.times(r).plus(h))},{kind:st.LineTo,point:e.plus(n.times(s))},{kind:st.LineTo,point:a.plus(l.times(-r).minus(h))},{kind:st.LineTo,point:a.minus(h)}],style:{fill:this.startPoint.color}}])}build(){return this.buildPreview()}preview(t){this.buildPreview().render(t)}addPoint(t){this.endPoint=t}}const be=(t,e)=>new we(t);class we{constructor(t){this.startPoint=t,this.endPoint=t}getBBox(){return this.buildPreview().getBBox()}buildPreview(){const t=this.startPoint.pos,e=this.endPoint.pos,n=e.minus(t).normalized(),i=this.startPoint.width/2,r=this.endPoint.width/2,o=n.orthog(),s=o.times(i),a=o.times(r);return new ut([{startPoint:t.minus(s),commands:[{kind:st.LineTo,point:t.plus(s)},{kind:st.LineTo,point:e.plus(a)},{kind:st.LineTo,point:e.minus(a)},{kind:st.LineTo,point:t.minus(s)}],style:{fill:this.startPoint.color}}])}build(){return this.buildPreview()}preview(t){this.buildPreview().render(t)}addPoint(t){this.endPoint=t}}const Te=(t,e)=>new Ce(t,!0,e),Se=(t,e)=>new Ce(t,!1,e);class Ce{constructor(t,e,n){this.startPoint=t,this.filled=e,this.viewport=n,this.endPoint=t}getBBox(){return this.buildPreview().getBBox()}buildPreview(){const t=this.viewport.getRotationAngle(),e=d.zRotation(-t),n=e.inverse().transformVec2(this.startPoint.pos),i=e.inverse().transformVec2(this.endPoint.pos),r=m.fromCorners(n,i),o=at.fromRect(r,this.filled?null:this.endPoint.width).transformedBy(e);return new ut([o.toRenderable({fill:this.endPoint.color})])}build(){return this.buildPreview()}preview(t){this.buildPreview().render(t)}addPoint(t){this.endPoint=t}}const ke=(t,e)=>{const n=document.createElement("span"),i=document.createElement("input");let r;i.type="button",i.classList.add("coloris_input"),n.classList.add("color-input-container"),n.appendChild(i),Pe(t,n,(t=>{i.value=t.toHexString(),s();const e=i.parentElement;e&&e.classList.contains("clr-field")&&(e.style.color=i.value)}));const o=()=>{r=lt.fromHex(i.value)},s=()=>{o(),r&&(t.announceForAccessibility(t.localization.colorChangedAnnouncement(r.toHexString())),e(r),t.notifier.dispatch(x.ColorPickerColorSelected,{kind:x.ColorPickerColorSelected,color:r}))};return i.oninput=o,i.addEventListener("open",(()=>{t.notifier.dispatch(x.ColorPickerToggled,{kind:x.ColorPickerToggled,open:!0})})),i.addEventListener("close",(()=>{t.notifier.dispatch(x.ColorPickerToggled,{kind:x.ColorPickerToggled,open:!1}),s()})),[i,n,t=>{"object"==typeof t&&(t=t.toHexString()),i.value=t,i.dispatchEvent(new Event("input",{bubbles:!0}))}]},Pe=(t,e,n)=>{const i=document.createElement("button");i.classList.add("pipetteButton"),i.title=t.localization.pickColorFromScreen,i.setAttribute("alt",i.title);const r=e=>{i.replaceChildren(t.icons.makePipetteIcon(e))};r();const o=t.toolController.getMatchingTools(ne)[0],s=()=>{null==o||o.clearColorListener(),r(),i.classList.remove("active")},a=t=>{s(),t&&n(t)},l=t=>{t?r(t):r()};i.onclick=()=>{i.classList.contains("active")?s():(null==o||o.setColorListener(l,a),o&&(i.classList.add("active"),t.announceForAccessibility(t.localization.clickToPickColorAnnouncement)))},e.appendChild(i)},Ee=ke;var ze,Be=function(t,e,n,i,r){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!r:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?r.call(t,n):r?r.value=n:e.set(t,n),n},Re=function(t,e,n,i){if("a"===n&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!i:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?i:"a"===n?i.call(t):i?i.value:e.get(t)};class Ie{constructor(t,e,n){this.editor=t,this.id=e,ze.set(this,void 0),this.disabled=!1,this.subWidgets={},this.toplevel=!0,this.localizationTable=null!=n?n:t.localization,this.icon=null,this.container=document.createElement("div"),this.container.classList.add(`${Ue}toolContainer`),this.dropdownContainer=document.createElement("div"),this.dropdownContainer.classList.add(`${Ue}dropdown`),this.dropdownContainer.classList.add("hidden"),Be(this,ze,!1,"f"),this.button=document.createElement("div"),this.button.classList.add(`${Ue}button`),this.label=document.createElement("label"),this.button.setAttribute("role","button"),this.button.tabIndex=0;const i=this.editor.toolController.getMatchingTools(he);i.length>0&&this.onKeyPress!==Ie.prototype.onKeyPress&&i[0].registerListener((t=>this.onKeyPress(t)))}getId(){return this.id}getUniqueIdIn(t){let e=this.getId(),n=0;for(;e in t&&t[e]!==this;)e=this.getId()+"-"+n.toString(),n++;return e}fillDropdown(t){if(0===Object.keys(this.subWidgets).length)return!1;for(const e in this.subWidgets){const n=this.subWidgets[e];n.addTo(t),n.setIsToplevel(!1)}return!0}setupActionBtnClickListener(t){const e={Enter:!0," ":!0};t.onkeydown=t=>{let n=!1;t.key in e&&(this.disabled||(this.handleClick(),n=!0)),n||this.editor.toolController.dispatchInputEvent({kind:y.KeyPressEvent,key:t.key,ctrlKey:t.ctrlKey,altKey:t.altKey})},t.onkeyup=t=>{t.key in e||this.editor.toolController.dispatchInputEvent({kind:y.KeyUpEvent,key:t.key,ctrlKey:t.ctrlKey,altKey:t.altKey})},t.onclick=()=>{this.disabled||this.handleClick()}}onKeyPress(t){return!1}get hasDropdown(){return Re(this,ze,"f")}addSubWidget(t){const e=t.getUniqueIdIn(this.subWidgets);this.subWidgets[e]=t}addTo(t){this.label.innerText=this.getTitle(),this.setupActionBtnClickListener(this.button),this.icon=null,this.updateIcon(),this.button.replaceChildren(this.icon,this.label),this.container.appendChild(this.button),Be(this,ze,this.fillDropdown(this.dropdownContainer),"f"),Re(this,ze,"f")&&(this.dropdownIcon=this.createDropdownIcon(),this.button.appendChild(this.dropdownIcon),this.container.appendChild(this.dropdownContainer),this.editor.notifier.on(x.ToolbarDropdownShown,(t=>{t.kind===x.ToolbarDropdownShown&&t.parentWidget!==this&&t.parentWidget.toplevel&&this.setDropdownVisible(!1)}))),this.setDropdownVisible(!1),t.appendChild(this.container)}updateIcon(){var t;const e=this.createIcon();null===(t=this.icon)||void 0===t||t.replaceWith(e),this.icon=e,this.icon.classList.add(`${Ue}icon`)}setDisabled(t){this.disabled=t,this.disabled?(this.button.classList.add("disabled"),this.button.setAttribute("aria-disabled","true")):(this.button.classList.remove("disabled"),this.button.removeAttribute("aria-disabled"))}setSelected(t){this.isSelected()!==t&&(t?(this.container.classList.add("selected"),this.button.ariaSelected="true"):(this.container.classList.remove("selected"),this.button.ariaSelected="false"))}setDropdownVisible(t){this.container.classList.contains("dropdownVisible")!==t&&(t?(this.dropdownContainer.classList.remove("hidden"),this.container.classList.add("dropdownVisible"),this.editor.announceForAccessibility(this.localizationTable.dropdownShown(this.getTitle())),this.editor.notifier.dispatch(x.ToolbarDropdownShown,{kind:x.ToolbarDropdownShown,parentWidget:this})):(this.dropdownContainer.classList.add("hidden"),this.container.classList.remove("dropdownVisible"),this.editor.announceForAccessibility(this.localizationTable.dropdownHidden(this.getTitle()))),this.repositionDropdown())}repositionDropdown(){const t=this.dropdownContainer.getBoundingClientRect(),e=document.body.clientWidth;t.left>e/2?(this.dropdownContainer.style.marginLeft=this.button.clientWidth+"px",this.dropdownContainer.style.transform="translate(-100%, 0)"):(this.dropdownContainer.style.marginLeft="",this.dropdownContainer.style.transform="")}setIsToplevel(t){this.toplevel=t}isDropdownVisible(){return!this.dropdownContainer.classList.contains("hidden")}isSelected(){return this.container.classList.contains("selected")}createDropdownIcon(){const t=this.editor.icons.makeDropdownIcon();return t.classList.add(`${Ue}showHideDropdownIcon`),t}serializeState(){const t={};for(const e in this.subWidgets)t[e]=this.subWidgets[e].serializeState();return{subwidgetState:t}}deserializeFrom(t){if(t.subwidgetState)for(const e in t.subwidgetState)e in this.subWidgets&&this.subWidgets[e].deserializeFrom(t.subwidgetState[e])}}ze=new WeakMap;class Le extends Ie{constructor(t,e,n,i){super(t,n,i),this.editor=t,this.targetTool=e,t.notifier.on(x.ToolEnabled,(t=>{if(t.kind!==x.ToolEnabled)throw new Error("Incorrect event type! (Expected ToolEnabled)");t.tool===e&&this.setSelected(!0)})),t.notifier.on(x.ToolDisabled,(t=>{if(t.kind!==x.ToolDisabled)throw new Error("Incorrect event type! (Expected ToolDisabled)");t.tool===e&&(this.setSelected(!1),this.setDropdownVisible(!1))}))}handleClick(){this.hasDropdown?this.targetTool.isEnabled()?this.setDropdownVisible(!this.isDropdownVisible()):this.targetTool.setEnabled(!0):this.targetTool.setEnabled(!this.targetTool.isEnabled())}addTo(t){super.addTo(t),this.setSelected(this.targetTool.isEnabled())}}class Ae extends Le{constructor(t,e,n){super(t,e,"pen",n),this.tool=e,this.updateInputs=()=>{},this.penTypes=[{name:this.localizationTable.pressureSensitiveFreehandPen,id:"pressure-sensitive-pen",factory:re},{name:this.localizationTable.freehandPen,id:"freehand-pen",factory:gt},{name:this.localizationTable.arrowPen,id:"arrow",factory:ye},{name:this.localizationTable.linePen,id:"line",factory:be},{name:this.localizationTable.filledRectanglePen,id:"filled-rectangle",factory:Te},{name:this.localizationTable.outlinedRectanglePen,id:"outlined-rectangle",factory:Se}],this.editor.notifier.on(x.ToolUpdated,(t=>{if(t.kind!==x.ToolUpdated)throw new Error("Invalid event type!");t.tool===this.tool&&(this.updateIcon(),this.updateInputs())}))}getTitle(){return this.targetTool.description}getCurrentPenTypeIdx(){const t=this.tool.getStrokeFactory();for(let e=0;e<this.penTypes.length;e++)if(this.penTypes[e].factory===t)return e;return-1}getCurrentPenType(){for(const t of this.penTypes)if(t.factory===this.tool.getStrokeFactory())return t;return null}createIcon(){const t=this.tool.getStrokeFactory();if(t===gt||t===re){const t=Math.round(4*Math.sqrt(this.tool.getThickness())),e=this.tool.getColor();return this.editor.icons.makePenIcon(t,e.toHexString())}{const t=this.tool.getStrokeFactory();return this.editor.icons.makeIconFromFactory(this.tool,t)}}fillDropdown(t){const e=document.createElement("div"),n=document.createElement("div"),i=document.createElement("div"),r=document.createElement("label"),o=document.createElement("input"),s=document.createElement("label"),a=document.createElement("select");o.id=`${Ue}thicknessInput${Ae.idCounter++}`,a.id=`${Ue}builderSelect${Ae.idCounter++}`,r.innerText=this.localizationTable.thicknessLabel,r.setAttribute("for",o.id),s.innerText=this.localizationTable.selectObjectType,s.setAttribute("for",a.id);const l=t=>Math.log10(t);o.type="range",o.min=`${l(2)}`,o.max=`${l(400)}`,o.step="0.1",o.oninput=()=>{this.tool.setThickness((t=>Math.pow(10,t))(parseFloat(o.value)))},n.appendChild(r),n.appendChild(o),a.oninput=()=>{const t=parseInt(a.value);t<0||t>=this.penTypes.length?console.error("Invalid pen type index",t):this.tool.setStrokeFactory(this.penTypes[t].factory)},i.appendChild(s),i.appendChild(a);const c=document.createElement("div"),h=document.createElement("label"),[d,u,p]=Ee(this.editor,(t=>{this.tool.setColor(t)}));return d.id=`${Ue}colorInput${Ae.idCounter++}`,h.innerText=this.localizationTable.colorLabel,h.setAttribute("for",d.id),c.appendChild(h),c.appendChild(u),this.updateInputs=()=>{p(this.tool.getColor()),o.value=l(this.tool.getThickness()).toString(),a.replaceChildren();for(let t=0;t<this.penTypes.length;t++){const e=this.penTypes[t],n=document.createElement("option");n.value=t.toString(),n.innerText=e.name,a.appendChild(n)}const t=this.getCurrentPenTypeIdx();a.value=-1===t?"":t.toString()},this.updateInputs(),e.replaceChildren(c,n,i),t.replaceChildren(e),!0}onKeyPress(t){if(!this.isSelected())return!1;if(/^[0-9]$/.exec(t.key)&&t.ctrlKey){const e=parseInt(t.key)-1;if(e>=0&&e<this.penTypes.length)return this.tool.setStrokeFactory(this.penTypes[e].factory),!0}return!1}serializeState(){var t;return Object.assign(Object.assign({},super.serializeState()),{color:this.tool.getColor().toHexString(),thickness:this.tool.getThickness(),strokeFactoryId:null===(t=this.getCurrentPenType())||void 0===t?void 0:t.id})}deserializeFrom(t){super.deserializeFrom(t);const e=(e,n)=>{const i=typeof t[e];if(i!==n)throw new Error(`Deserializing property ${e}: Invalid type. Expected ${n}, was ${i}.`)};if(t.color&&(e("color","string"),this.tool.setColor(lt.fromHex(t.color))),t.thickness&&(e("thickness","number"),this.tool.setThickness(t.thickness)),t.strokeFactoryId){e("strokeFactoryId","string");const n=t.strokeFactoryId;for(const t of this.penTypes)if(n===t.id){this.tool.setStrokeFactory(t.factory);break}}}}Ae.idCounter=0;class Me extends Le{constructor(t,e,n){super(t,e,"eraser-tool-widget",n)}getTitle(){return this.localizationTable.eraser}createIcon(){return this.editor.icons.makeEraserIcon()}fillDropdown(t){return!1}}class De extends Ie{constructor(t,e,n,i,r,o){super(t,e,o),this.makeIcon=n,this.title=i,this.clickAction=r}handleClick(){this.clickAction()}getTitle(){return this.title}createIcon(){return this.makeIcon()}fillDropdown(t){return!1}}class Oe extends Le{constructor(t,e,n){super(t,e,"selection-tool-widget",n),this.tool=e;const i=new De(t,"resize-btn",(()=>t.icons.makeResizeViewportIcon()),this.localizationTable.resizeImageToSelection,(()=>{this.resizeImageToSelection()}),n),r=new De(t,"delete-btn",(()=>t.icons.makeDeleteSelectionIcon()),this.localizationTable.deleteSelection,(()=>{const t=this.tool.getSelection();this.editor.dispatch(t.deleteSelectedObjects()),this.tool.clearSelection()}),n),o=new De(t,"duplicate-btn",(()=>t.icons.makeDuplicateSelectionIcon()),this.localizationTable.duplicateSelection,(()=>{const t=this.tool.getSelection();this.editor.dispatch(t.duplicateSelectedObjects())}),n);this.addSubWidget(i),this.addSubWidget(r),this.addSubWidget(o);const s=t=>{i.setDisabled(t),r.setDisabled(t),o.setDisabled(t)};s(!0),this.editor.notifier.on(x.ToolUpdated,(t=>{if(t.kind!==x.ToolUpdated)throw new Error("Invalid event type!");if(t.tool===this.tool){const t=this.tool.getSelection(),e=t&&t.region.area>0;s(!e)}}))}resizeImageToSelection(){const t=this.tool.getSelection();t&&this.editor.dispatch(this.editor.setImportExportRect(t.region))}onKeyPress(t){return!(!t.ctrlKey||"r"!==t.key||(this.resizeImageToSelection(),0))}getTitle(){return this.localizationTable.select}createIcon(){return this.editor.icons.makeSelectionIcon()}}class Fe extends Le{constructor(t,e,n){super(t,e,"text-tool-widget",n),this.tool=e,this.updateDropdownInputs=null,t.notifier.on(x.ToolUpdated,(t=>{var n;t.kind===x.ToolUpdated&&t.tool===e&&(this.updateIcon(),null===(n=this.updateDropdownInputs)||void 0===n||n.call(this))}))}getTitle(){return this.targetTool.description}createIcon(){const t=this.tool.getTextStyle();return this.editor.icons.makeTextIcon(t)}fillDropdown(t){const e=document.createElement("div"),n=document.createElement("div"),i=document.createElement("div"),r=document.createElement("select"),o=document.createElement("label"),s=document.createElement("input"),a=document.createElement("label"),[l,c,h]=Ee(this.editor,(t=>{this.tool.setColor(t)})),d=document.createElement("label"),u=new Set,p=t=>{const e=document.createElement("option");e.value=t,e.textContent=t,r.appendChild(e),u.add(t)};return s.setAttribute("type","number"),s.min="1",s.max="128",o.innerText=this.localizationTable.fontLabel,d.innerText=this.localizationTable.colorLabel,a.innerText=this.localizationTable.textSize,l.id=`${Ue}-text-color-input-${Fe.idCounter++}`,d.setAttribute("for",l.id),s.id=`${Ue}-text-size-input-${Fe.idCounter++}`,a.setAttribute("for",s.id),p("monospace"),p("serif"),p("sans-serif"),r.id=`${Ue}-text-font-input-${Fe.idCounter++}`,o.setAttribute("for",r.id),r.onchange=()=>{this.tool.setFontFamily(r.value)},s.onchange=()=>{const t=parseInt(s.value);!isNaN(t)&&t>0&&this.tool.setFontSize(t)},n.appendChild(d),n.appendChild(c),e.appendChild(o),e.appendChild(r),i.appendChild(a),i.appendChild(s),this.updateDropdownInputs=()=>{const t=this.tool.getTextStyle();h(t.renderingStyle.fill),u.has(t.fontFamily)||p(t.fontFamily),r.value=t.fontFamily,s.value=`${t.size}`},this.updateDropdownInputs(),t.replaceChildren(n,i,e),!0}serializeState(){const t=this.tool.getTextStyle();return Object.assign(Object.assign({},super.serializeState()),{fontFamily:t.fontFamily,textSize:t.size,color:t.renderingStyle.fill.toHexString()})}deserializeFrom(t){t.fontFamily&&"string"==typeof t.fontFamily&&this.tool.setFontFamily(t.fontFamily),t.color&&"string"==typeof t.color&&this.tool.setColor(lt.fromHex(t.color)),t.textSize&&"number"==typeof t.textSize&&this.tool.setFontSize(t.textSize),super.deserializeFrom(t)}}Fe.idCounter=0;class $e extends Ie{constructor(t,e){super(t,"zoom-widget",e),this.container.classList.add("dropdownShowable")}getTitle(){return this.localizationTable.zoom}createIcon(){return this.editor.icons.makeZoomIcon()}handleClick(){this.setDropdownVisible(!this.isDropdownVisible())}fillDropdown(t){return t.appendChild(((t,e)=>{const n=document.createElement("div"),i=document.createElement("button"),r=document.createElement("button"),o=document.createElement("button"),s=document.createElement("span");let a;i.innerText="+",r.innerText="-",o.innerText=t.resetView,n.replaceChildren(s,i,r,o),n.classList.add(`${Ue}zoomLevelEditor`),s.classList.add("zoomDisplay");const l=()=>{let n=100*e.viewport.getScaleFactor();n=n>.1?Math.round(10*n)/10:Math.round(1e3*n)/1e3,n!==a&&(s.innerText=t.zoomLevel(n),a=n)};l(),e.notifier.on(x.ViewportChanged,(t=>{t.kind===x.ViewportChanged&&(l(),o.disabled=t.newTransform.eq(d.identity))}));const c=t=>{const n=e.viewport.visibleRect.center,i=d.scaling2D(t,n);e.dispatch(P.transformBy(i),!1)};return i.onclick=()=>{c(5/4)},r.onclick=()=>{c(.8)},o.onclick=()=>{e.dispatch(P.transformBy(e.viewport.canvasToScreenTransform.inverse()),!0)},n})(this.localizationTable,this.editor)),!0}}class Ne extends Ie{constructor(t,e,n,i,r,o){super(t,`pan-mode-${n}`,o),this.tool=e,this.flag=n,this.makeIcon=i,this.title=r,t.notifier.on(x.ToolUpdated,(t=>{if(t.kind===x.ToolUpdated&&t.tool===e){const t=!!(e.getMode()&z.SinglePointerGestures);this.setSelected(!!(e.getMode()&n)||t),this.setDisabled(t&&n!==z.SinglePointerGestures)}})),this.setSelected(!1)}setModeFlag(t){this.tool.setModeEnabled(this.flag,t)}handleClick(){this.setModeFlag(!this.isSelected())}getTitle(){return this.title}createIcon(){return this.makeIcon()}fillDropdown(t){return!1}}class je extends Le{constructor(t,e,n){const i=je.getPrimaryHandTool(t.toolController);super(t,null!=i?i:e,"hand-tool-widget",n),this.overridePanZoomTool=e,this.allowTogglingBaseTool=null!==i,this.allowTogglingBaseTool||this.container.classList.add("dropdownShowable");const r=new Ne(t,e,z.OneFingerTouchGestures,(()=>this.editor.icons.makeTouchPanningIcon()),n.touchPanning,n),o=new Ne(t,e,z.RotationLocked,(()=>this.editor.icons.makeRotationLockIcon()),n.lockRotation,n);this.addSubWidget(r),this.addSubWidget(o),this.addSubWidget(new $e(t,n))}static getPrimaryHandTool(t){return t.getPrimaryTools().filter((t=>t instanceof B))[0]}getTitle(){return this.localizationTable.handTool}createIcon(){return this.editor.icons.makeHandToolIcon()}handleClick(){this.allowTogglingBaseTool?super.handleClick():this.setDropdownVisible(!this.isDropdownVisible())}setSelected(t){this.allowTogglingBaseTool&&super.setSelected(t)}serializeState(){const t=this.overridePanZoomTool.getMode();return Object.assign(Object.assign({},super.serializeState()),{touchPanning:t&z.OneFingerTouchGestures,rotationLocked:t&z.RotationLocked})}deserializeFrom(t){void 0!==t.touchPanning&&this.overridePanZoomTool.setModeEnabled(z.OneFingerTouchGestures,t.touchPanning),void 0!==t.rotationLocked&&this.overridePanZoomTool.setModeEnabled(z.RotationLocked,t.rotationLocked),super.deserializeFrom(t)}}const Ue="toolbar-";class Ve{constructor(t,e,n=ve){this.editor=t,this.localizationTable=n,this.widgets={},this.updateColoris=null,this.container=document.createElement("div"),this.container.classList.add(`${Ue}root`),this.container.setAttribute("role","toolbar"),e.appendChild(this.container),Ve.colorisStarted||(fe(),Ve.colorisStarted=!0),this.setupColorPickers()}setupColorPickers(){if(this.updateColoris)return void this.updateColoris();const t=document.createElement("div");t.className=`${Ue}closeColorPickerOverlay`,this.editor.createHTMLOverlay(t);const e=[lt.red.toHexString(),lt.purple.toHexString(),lt.blue.toHexString(),lt.clay.toHexString(),lt.black.toHexString(),lt.white.toHexString()],n=e.length,i=()=>{ge({el:".coloris_input",format:"hex",selectInput:!1,focusInput:!1,themeMode:"auto",swatches:e})};i(),this.updateColoris=i,this.editor.notifier.on(x.ColorPickerToggled,(e=>{e.kind===x.ColorPickerToggled&&(t.style.display=e.open?"block":"none")})),this.editor.notifier.on(x.ColorPickerColorSelected,(t=>{t.kind===x.ColorPickerColorSelected&&(t=>{let r=!1;for(const n of e)n===t&&(r=!0);r||(e.push(t),e.length>12&&e.splice(n,1),i())})(t.color.toHexString())}))}addWidget(t){const e=t.getUniqueIdIn(this.widgets);this.widgets[e]=t,t.addTo(this.container),this.setupColorPickers()}serializeState(){const t={};for(const e in this.widgets)t[e]=this.widgets[e].serializeState();return JSON.stringify(t)}deserializeState(t){const e=JSON.parse(t);for(const t in e)t in this.widgets||console.warn(`Unable to deserialize widget ${t} ­— no such widget.`),this.widgets[t].deserializeFrom(e[t])}addActionButton(t,e,n){const i=document.createElement("button");if(i.classList.add(`${Ue}button`),"string"==typeof t)i.innerText=t;else{const e=t.icon.cloneNode(!0),n=document.createElement("label");e.setAttribute("alt",""),n.innerText=t.label,e.classList.add("toolbar-icon"),i.replaceChildren(e,n)}return i.onclick=e,(null!=n?n:this.container).appendChild(i),i}addUndoRedoButtons(){const t=document.createElement("div");t.classList.add(`${Ue}buttonGroup`);const e=this.addActionButton({label:this.localizationTable.undo,icon:this.editor.icons.makeUndoIcon()},(()=>{this.editor.history.undo()}),t),n=this.addActionButton({label:this.localizationTable.redo,icon:this.editor.icons.makeRedoIcon()},(()=>{this.editor.history.redo()}),t);this.container.appendChild(t),e.disabled=!0,n.disabled=!0,this.editor.notifier.on(x.UndoRedoStackUpdated,(t=>{if(t.kind!==x.UndoRedoStackUpdated)throw new Error("Wrong event type!");e.disabled=0===t.undoStackSize,n.disabled=0===t.redoStackSize}))}addDefaultToolWidgets(){const t=this.editor.toolController;for(const e of t.getMatchingTools(vt)){const t=new Ae(this.editor,e,this.localizationTable);this.addWidget(t)}for(const e of t.getMatchingTools(wt))this.addWidget(new Me(this.editor,e,this.localizationTable));for(const e of t.getMatchingTools(Zt))this.addWidget(new Oe(this.editor,e,this.localizationTable));for(const e of t.getMatchingTools(ee))this.addWidget(new Fe(this.editor,e,this.localizationTable));const e=t.getMatchingTools(B)[0];e&&this.addWidget(new je(this.editor,e,this.localizationTable))}addDefaultActionButtons(){this.addUndoRedoButtons()}}Ve.colorisStarted=!1;class We extends At{constructor(t,e){super(e),this.ctx=t,this.ignoreObjectsAboveLevel=null,this.ignoringObject=!1,this.clipLevels=[],this.setDraftMode(!1)}transformBy(t){this.ctx.transform(t.a1,t.b1,t.a2,t.b2,t.a3,t.b3)}canRenderFromWithoutDataLoss(t){return t instanceof We}renderFromOtherOfSameType(t,e){if(!(e instanceof We))throw new Error(`${e} cannot be rendered onto ${this}`);t=this.getCanvasToScreenTransform().rightMul(t),this.ctx.save(),this.transformBy(t),this.ctx.drawImage(e.ctx.canvas,0,0),this.ctx.restore()}setDraftMode(t){t?(this.minSquareCurveApproxDist=9,this.minRenderSizeBothDimens=2,this.minRenderSizeAnyDimen=.5):(this.minSquareCurveApproxDist=.5,this.minRenderSizeBothDimens=.3,this.minRenderSizeAnyDimen=1e-5)}displaySize(){return l.of(this.ctx.canvas.clientWidth,this.ctx.canvas.clientHeight)}clear(){this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)}beginPath(t){t=this.canvasToScreen(t),this.ctx.beginPath(),this.ctx.moveTo(t.x,t.y)}endPath(t){this.ctx.fillStyle=t.fill.toHexString(),this.ctx.fill(),t.stroke&&(this.ctx.strokeStyle=t.stroke.color.toHexString(),this.ctx.lineWidth=this.getSizeOfCanvasPixelOnScreen()*t.stroke.width,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.ctx.stroke()),this.ctx.closePath()}lineTo(t){t=this.canvasToScreen(t),this.ctx.lineTo(t.x,t.y)}moveTo(t){t=this.canvasToScreen(t),this.ctx.moveTo(t.x,t.y)}traceCubicBezierCurve(t,e,n){t=this.canvasToScreen(t),e=this.canvasToScreen(e),n=this.canvasToScreen(n);const i=e.minus(t),r=n.minus(e);i.magnitudeSquared()<this.minSquareCurveApproxDist&&r.magnitudeSquared()<this.minSquareCurveApproxDist?this.ctx.lineTo(n.x,n.y):this.ctx.bezierCurveTo(t.x,t.y,e.x,e.y,n.x,n.y)}traceQuadraticBezierCurve(t,e){t=this.canvasToScreen(t),e=this.canvasToScreen(e),t.minus(e).magnitudeSquared()<this.minSquareCurveApproxDist?this.ctx.lineTo(e.x,e.y):this.ctx.quadraticCurveTo(t.x,t.y,e.x,e.y)}drawPath(t){this.ignoringObject||super.drawPath(t)}drawText(t,e,n){this.ctx.save(),e=this.getCanvasToScreenTransform().rightMul(e),this.transformBy(e),Pt.applyTextStyles(this.ctx,n),0!==n.renderingStyle.fill.a&&(this.ctx.fillStyle=n.renderingStyle.fill.toHexString(),this.ctx.fillText(t,0,0)),n.renderingStyle.stroke&&(this.ctx.strokeStyle=n.renderingStyle.stroke.color.toHexString(),this.ctx.lineWidth=n.renderingStyle.stroke.width,this.ctx.strokeText(t,0,0)),this.ctx.restore()}drawImage(t){this.ctx.save();const e=this.getCanvasToScreenTransform().rightMul(t.transform);this.transformBy(e),this.ctx.drawImage(t.image,0,0),this.ctx.restore()}startObject(t,e){if(this.isTooSmallToRender(t)&&(this.ignoreObjectsAboveLevel=this.getNestingLevel(),this.ignoringObject=!0),super.startObject(t),!this.ignoringObject&&e){this.clipLevels.push(this.objectLevel),this.ctx.save(),this.ctx.beginPath();for(const e of t.corners){const t=this.canvasToScreen(e);this.ctx.lineTo(t.x,t.y)}this.ctx.clip()}}endObject(){!this.ignoringObject&&this.clipLevels.length>0&&this.clipLevels[this.clipLevels.length-1]===this.objectLevel&&(this.ctx.restore(),this.clipLevels.pop()),super.endObject(),null!==this.ignoreObjectsAboveLevel&&this.getNestingLevel()<=this.ignoreObjectsAboveLevel&&(this.ignoreObjectsAboveLevel=null,this.ignoringObject=!1)}drawPoints(...t){for(let e=0;e<t.length;e++){const n=this.canvasToScreen(t[e]);this.ctx.beginPath(),this.ctx.arc(n.x,n.y,10,0,2*Math.PI),this.ctx.fillStyle=lt.ofRGBA(.5+Math.sin(e)/2,1,.5+Math.cos(.2*e)/4,.5).toHexString(),this.ctx.fill(),this.ctx.stroke(),this.ctx.closePath(),this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillStyle="black",this.ctx.fillText(`${e}`,n.x,n.y,20)}}isTooSmallToRender(t){const e=this.getCanvasToScreenTransform().transformVec3(t.size),n=this.minRenderSizeBothDimens,i=Math.abs(e.x)<n&&Math.abs(e.y)<n,r=this.minRenderSizeAnyDimen,o=Math.abs(e.x)<r||Math.abs(e.y)<r;return i||o}}class He extends At{constructor(t){super(t),this.clearedCount=0,this.renderedPathCount=0,this.lastFillStyle=null,this.lastPoint=null,this.objectNestingLevel=0,this.lastText=null,this.lastImage=null,this.pointBuffer=[]}displaySize(){const t=this.getViewport().getResolution();return 0===t.x||0===t.y?l.of(640,480):t}clear(){if(this.clearedCount++,this.renderedPathCount=0,this.pointBuffer=[],this.lastText=null,this.lastImage=null,this.objectNestingLevel>0)throw new Error(`Within an object while clearing! Nesting level: ${this.objectNestingLevel}`)}beginPath(t){this.lastPoint=t,this.pointBuffer.push(t)}endPath(t){this.renderedPathCount++,this.lastFillStyle=t}lineTo(t){t=this.canvasToScreen(t),this.lastPoint=t,this.pointBuffer.push(t)}moveTo(t){t=this.canvasToScreen(t),this.lastPoint=t,this.pointBuffer.push(t)}traceCubicBezierCurve(t,e,n){t=this.canvasToScreen(t),e=this.canvasToScreen(e),n=this.canvasToScreen(n),this.lastPoint=n,this.pointBuffer.push(t,e,n)}traceQuadraticBezierCurve(t,e){t=this.canvasToScreen(t),e=this.canvasToScreen(e),this.lastPoint=e,this.pointBuffer.push(t,e)}drawPoints(...t){}drawText(t,e,n){this.lastText=t}drawImage(t){this.lastImage=t}startObject(t,e){super.startObject(t),this.objectNestingLevel+=1}endObject(){super.endObject(),this.objectNestingLevel-=1}isTooSmallToRender(t){return!1}canRenderFromWithoutDataLoss(t){return t instanceof He}renderFromOtherOfSameType(t,e){if(!(e instanceof He))throw new Error(`${e} cannot be rendered onto ${this}`);this.renderedPathCount+=e.renderedPathCount,this.lastFillStyle=e.lastFillStyle,this.lastPoint=e.lastPoint,this.pointBuffer.push(...e.pointBuffer.map((e=>t.transformVec2(e))))}}class Ge{constructor(t,e){this.region=t,this.cacheState=e,this.instantiatedChildren=[],this.parent=null,this.cachedRenderer=null,this.renderedIds=[],this.renderedMaxZIndex=null}generateParent(){if(this.parent)return this.parent;const t=m.fromCorners(this.region.topLeft.minus(this.region.size),this.region.bottomRight.plus(this.region.size)),e=new Ge(t,this.cacheState);e.generateChildren();const n=this.region.maxDimension/100,i=(e.instantiatedChildren.length-1)/2;if(!e.instantiatedChildren[i].region.eq(this.region,n))throw console.error(e.instantiatedChildren[i].region,"≠",this.region),new Error("Logic error: [this] is not contained within its parent's center child");return e.instantiatedChildren[i]=this,this.parent=e,e}generateChildren(){if(0===this.instantiatedChildren.length){const t=this.region.divideIntoGrid(3,3);if(0===this.region.size.x||0===this.region.size.y)return void console.warn("Cache element has zero size! Not generating children.");for(const e of t){const t=new Ge(e,this.cacheState);t.parent=this,this.instantiatedChildren.push(t)}}this.checkRep()}getChildren(){return this.checkRep(),this.generateChildren(),this.instantiatedChildren}smallestChildContaining(t){var e;const n=t.maxDimension>this.region.maxDimension/3;if(!this.region.containsRect(t)||n)return null;for(const n of this.getChildren())if(n.region.containsRect(t))return null!==(e=n.smallestChildContaining(t))&&void 0!==e?e:n;return null}renderingWouldBeHighEnoughResolution(t){const e=this.region.w/this.cacheState.props.blockResolution.x;return!(t.getScaleFactor()*e>this.cacheState.props.maxScale)}allChildrenCanRender(t,e){if(0===this.instantiatedChildren.length)return!1;for(const n of this.instantiatedChildren)if(n.region.intersects(t.visibleRect)&&!n.renderingIsUpToDate(this.idsOfIntersecting(e)))return!1;return!0}computeSortedByLeafIds(t){const e=t.slice();return e.sort(((t,e)=>t.getId()-e.getId())),e}idsOfIntersecting(t){const e=[];for(const n of t)n.getBBox().intersects(this.region)&&e.push(n.getId());return e}allRenderedIdsIn(t){if(this.renderedIds.length>t.length)return!1;for(let e=0;e<this.renderedIds.length;e++)if(t[e]!==this.renderedIds[e])return!1;return!0}renderingIsUpToDate(t){return null!==this.cachedRenderer&&t.length===this.renderedIds.length&&this.allRenderedIdsIn(t)}renderItems(t,e,n){var i,r;if(!n.visibleRect.intersects(this.region)||0===e.length)return;const o=[];for(const t of e){const e=t.getBBox();e.intersects(this.region)&&(e.maxDimension>=this.region.maxDimension?o.push(...t.getChildrenOrSelfIntersectingRegion(this.region)):o.push(t))}if(e=o,this.cacheState.props.isOfCorrectType(t)){if(this.renderingWouldBeHighEnoughResolution(n)){const o=t=>t.w/this.region.w<1/this.cacheState.props.blockResolution.x,s=[];for(const t of e)s.push(...t.getLeavesIntersectingRegion(this.region,o));g(s);const a=this.computeSortedByLeafIds(s);if(0===a.length)return;const l=a.map((t=>t.getId()));let c;if(this.renderingIsUpToDate(l))c=this.cachedRenderer.startRender();else{if(this.allChildrenCanRender(n,a)){for(const i of this.getChildren())i.renderItems(t,e,n);return}if(a.length>this.cacheState.props.minComponentsPerCache){let t=!0;if(this.cachedRenderer){if(a.length>this.renderedIds.length&&this.allRenderedIdsIn(l)&&null!==this.renderedMaxZIndex){const e=[];let n=null;for(let t=0;t<a.length;t++){const i=a[t],r=i.getContent().getZIndex();(t>=this.renderedIds.length||i.getId()!==this.renderedIds[t])&&(e.push(i),(null===n||r<n)&&(n=r))}if(null!==n&&n>this.renderedMaxZIndex){t=!1,c=this.cachedRenderer.startRender();for(let t=0;t<s.length;t++){const e=s[t],n=e.getContent().getZIndex();n>this.renderedMaxZIndex&&(e.render(c,this.region),this.renderedMaxZIndex=n)}}}}else this.cachedRenderer=this.cacheState.recordManager.allocCanvas(this.region,(()=>this.onRegionDealloc()));if(t){c=this.cachedRenderer.startRender(),c.clear(),this.renderedMaxZIndex=null;for(const t of s){const e=t.getContent();null!==(i=this.renderedMaxZIndex)&&void 0!==i||(this.renderedMaxZIndex=e.getZIndex()),this.renderedMaxZIndex=Math.max(this.renderedMaxZIndex,e.getZIndex()),t.render(c,this.region)}}this.renderedIds=l}else{null===(r=this.cachedRenderer)||void 0===r||r.dealloc();const e=n.getSizeOfPixelOnCanvas(),i=new m(this.region.x,this.region.y,this.region.w+e,this.region.h+e),o=!0;t.startObject(i,o);for(const e of s)e.render(t,this.region.intersection(n.visibleRect));t.endObject()}}if(c){const e=this.cachedRenderer.getTransform(this.region).inverse();t.renderFromOtherOfSameType(e,c)}this.instantiatedChildren.every((t=>t.isEmpty()))&&(this.instantiatedChildren=[])}else for(const i of this.getChildren())i.renderItems(t,e.filter((t=>t.getBBox().intersects(i.region))),n);this.checkRep()}else e.forEach((e=>e.render(t,n.visibleRect)))}isEmpty(){return null===this.cachedRenderer&&this.instantiatedChildren.every((t=>t.isEmpty()))}onRegionDealloc(){this.cachedRenderer=null,this.isEmpty()&&(this.instantiatedChildren=[])}checkRep(){if(9!==this.instantiatedChildren.length&&0!==this.instantiatedChildren.length)throw new Error(`Repcheck: Wrong number of children. Got ${this.instantiatedChildren.length}`);if(void 0!==this.renderedIds[1]&&this.renderedIds[0]>=this.renderedIds[1])throw console.error(this.renderedIds),new Error("Repcheck: First two ids are not in ascending order!");for(const t of this.instantiatedChildren)if(t.parent!==this)throw new Error("Children should be linked to their parents!");if(this.cachedRenderer&&!this.cachedRenderer.isAllocd())throw new Error("this' cachedRenderer != null, but is dealloc'd")}}class _e{constructor(t,e){this.onBeforeDeallocCallback=t,this.cacheState=e,this.allocd=!1,this.allocCount=0,this.renderer=e.props.createRenderer(),this.lastUsedCycle=-1,this.allocd=!0}startRender(){if(this.lastUsedCycle=this.cacheState.currentRenderingCycle,!this.allocd)throw new Error("Only alloc'd canvases can be rendered to");return this.renderer}dealloc(){var t;null===(t=this.onBeforeDeallocCallback)||void 0===t||t.call(this),this.allocd=!1,this.onBeforeDeallocCallback=null,this.lastUsedCycle=0}isAllocd(){return this.allocd}realloc(t){this.allocd&&this.dealloc(),this.allocd=!0,this.onBeforeDeallocCallback=t,this.lastUsedCycle=this.cacheState.currentRenderingCycle,this.allocCount++}getLastUsedCycle(){return this.lastUsedCycle}getTransform(t){return d.scaling2D(this.cacheState.props.blockResolution.x/t.size.x).rightMul(d.translation(t.topLeft.times(-1)))}setRenderingRegion(t){this.renderer.setTransform(this.getTransform(t))}}class qe{constructor(t){this.cacheRecords=[],this.maxCanvases=Math.ceil(t.cacheSize/4/t.blockResolution.x/t.blockResolution.y)}setSharedState(t){this.cacheState=t}allocCanvas(t,e){if(this.cacheRecords.length<this.maxCanvases){const n=new _e(e,this.cacheState);return n.setRenderingRegion(t),this.cacheRecords.push(n),n}{const n=this.getLeastRecentlyUsedRecord();return n.realloc(e),n.setRenderingRegion(t),n}}getLeastRecentlyUsedRecord(){return this.cacheRecords.sort(((t,e)=>t.getLastUsedCycle()-e.getLastUsedCycle())),this.cacheRecords[0]}}class Ke{constructor(t){this.recordManager=new qe(t),this.sharedState={props:t,currentRenderingCycle:0,recordManager:this.recordManager},this.recordManager.setSharedState(this.sharedState)}render(t,e,n){var i;const r=n.visibleRect;if(this.sharedState.currentRenderingCycle++,this.sharedState.props.isOfCorrectType(t)){if(!this.rootNode){const t=this.sharedState.props.blockResolution,e=r.topLeft;this.rootNode=new Ge(new m(e.x,e.y,t.x,t.y),this.sharedState)}for(;!this.rootNode.region.containsRect(r);)this.rootNode=this.rootNode.generateParent();this.rootNode=null!==(i=this.rootNode.smallestChildContaining(r))&&void 0!==i?i:this.rootNode,e.getLeavesIntersectingRegion(n.visibleRect,(e=>t.isTooSmallToRender(e))).length>this.sharedState.props.minComponentsToUseCache?this.rootNode.renderItems(t,[e],n):e.render(t,r)}else e.render(t,r)}}class Ze extends At{constructor(t,e){super(t),this.localizationTable=e,this.descriptionBuilder=[],this.pathCount=0,this.textNodeCount=0,this.imageNodeCount=0}displaySize(){return l.of(500,500)}clear(){this.descriptionBuilder=[],this.pathCount=0,this.textNodeCount=0}getDescription(){return[this.localizationTable.pathNodeCount(this.pathCount),...this.textNodeCount>0?[this.localizationTable.textNodeCount(this.textNodeCount)]:[],...this.imageNodeCount>0?[this.localizationTable.imageNodeCount(this.imageNodeCount)]:[],...this.descriptionBuilder].join("\n")}beginPath(t){}endPath(t){this.pathCount++}lineTo(t){}moveTo(t){}traceCubicBezierCurve(t,e,n){}traceQuadraticBezierCurve(t,e){}drawText(t,e,n){this.descriptionBuilder.push(this.localizationTable.textNode(t)),this.textNodeCount++}drawImage(t){const e=t.label?this.localizationTable.imageNode(t.label):this.localizationTable.unlabeledImageNode;this.descriptionBuilder.push(e),this.imageNodeCount++}isTooSmallToRender(t){return t.maxDimension<15/this.getSizeOfCanvasPixelOnScreen()}drawPoints(...t){}}var Xe;!function(t){t[t.DummyRenderer=0]="DummyRenderer",t[t.CanvasRenderer=1]="CanvasRenderer"}(Xe||(Xe={}));class Ye{constructor(t,e,n){if(this.editor=t,this.parent=n,this.textRerenderOutput=null,this.getColorAt=t=>null,e===Xe.CanvasRenderer)this.initializeCanvasRendering();else{if(e!==Xe.DummyRenderer)throw new Error(`Unknown rendering mode, ${e}!`);this.dryInkRenderer=new He(t.viewport),this.wetInkRenderer=new He(t.viewport)}this.textRenderer=new Ze(t.viewport,t.localization),this.initializeTextRendering();const i=l.of(600,600);this.cache=new Ke({createRenderer:()=>{if(e===Xe.DummyRenderer)return new He(t.viewport);if(e!==Xe.CanvasRenderer)throw new Error("Unspported rendering mode");const n=document.createElement("canvas");n.width=i.x+1,n.height=i.y+1;const r=n.getContext("2d");return new We(r,t.viewport)},isOfCorrectType:t=>this.dryInkRenderer.canRenderFromWithoutDataLoss(t),blockResolution:i,cacheSize:1296e5,maxScale:1.4,minComponentsPerCache:20,minComponentsToUseCache:105}),this.editor.notifier.on(x.DisplayResized,(t=>{var e;if(t.kind!==x.DisplayResized)throw new Error("Mismatched event.kinds!");null===(e=this.resizeSurfacesCallback)||void 0===e||e.call(this)}))}get width(){return this.dryInkRenderer.displaySize().x}get height(){return this.dryInkRenderer.displaySize().y}getCache(){return this.cache}initializeCanvasRendering(){const t=document.createElement("canvas"),e=document.createElement("canvas"),n=t.getContext("2d"),i=e.getContext("2d");this.dryInkRenderer=new We(n,this.editor.viewport),this.wetInkRenderer=new We(i,this.editor.viewport),t.className="dryInkCanvas",e.className="wetInkCanvas",this.parent&&(this.parent.appendChild(t),this.parent.appendChild(e)),this.resizeSurfacesCallback=()=>{const n=t=>t.clientHeight!==t.height||t.clientWidth!==t.width;(n(t)||n(e))&&(t.width=t.clientWidth,t.height=t.clientHeight,e.width=e.clientWidth,e.height=e.clientHeight,this.editor.notifier.dispatch(x.DisplayResized,{kind:x.DisplayResized,newSize:l.of(this.width,this.height)}))},this.resizeSurfacesCallback(),this.flattenCallback=()=>{n.drawImage(e,0,0)},this.getColorAt=t=>{const e=n.getImageData(t.x,t.y,1,1),i=null==e?void 0:e.data;return i?lt.ofRGBA(i[0]/255,i[1]/255,i[2]/255,i[3]/255):null}}initializeTextRendering(){const t=document.createElement("div");t.classList.add("textRendererOutputContainer");const e=document.createElement("button");e.classList.add("rerenderButton"),e.innerText=this.editor.localization.rerenderAsText,this.textRerenderOutput=document.createElement("div"),this.textRerenderOutput.setAttribute("aria-live","polite"),e.onclick=()=>{this.rerenderAsText()},t.replaceChildren(e,this.textRerenderOutput),this.editor.createHTMLOverlay(t)}rerenderAsText(){this.textRenderer.clear(),this.editor.image.render(this.textRenderer,this.editor.viewport),this.textRerenderOutput&&(this.textRerenderOutput.innerText=this.textRenderer.getDescription())}startRerender(){var t;return null===(t=this.resizeSurfacesCallback)||void 0===t||t.call(this),this.wetInkRenderer.clear(),this.dryInkRenderer.clear(),this.dryInkRenderer}setDraftMode(t){this.dryInkRenderer.setDraftMode(t)}getDryInkRenderer(){return this.dryInkRenderer}getWetInkRenderer(){return this.wetInkRenderer}flatten(){var t;null===(t=this.flattenCallback)||void 0===t||t.call(this)}}const Je={updatedViewport:"Transformed Viewport",transformedElements:t=>`Transformed ${t} element${1===t?"":"s"}`,resizeOutputCommand:t=>`Resized image to ${t.w}x${t.h}`,addElementAction:t=>`Added ${t}`,eraseAction:(t,e)=>`Erased ${e} ${t}`,duplicateAction:(t,e)=>`Duplicated ${e} ${t}`,unionOf:(t,e)=>`Union: ${e} ${t}`,inverseOf:t=>`Inverse of ${t}`,elements:"Elements",erasedNoElements:"Erased nothing",duplicatedNoElements:"Duplicated nothing",rotatedBy:t=>`Rotated by ${Math.abs(t)} degrees ${t<0?"clockwise":"counter-clockwise"}`,movedLeft:"Moved left",movedUp:"Moved up",movedDown:"Moved down",movedRight:"Moved right",zoomedOut:"Zoomed out",zoomedIn:"Zoomed in",selectedElements:t=>`Selected ${t} element${1===t?"":"s"}`},Qe=Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},ve),{penTool:t=>`Pen ${t}`,selectionTool:"Selection",eraserTool:"Eraser",touchPanTool:"Touch panning",twoFingerPanZoomTool:"Panning and zooming",undoRedoTool:"Undo/Redo",rightClickDragPanTool:"Right-click drag",pipetteTool:"Pick color from screen",keyboardPanZoom:"Keyboard pan/zoom shortcuts",textTool:"Text",enterTextToInsert:"Text to insert",changeTool:"Change tool",pasteHandler:"Copy paste handler",findLabel:"Find",toNextMatch:"Next",closeFindDialog:"Close",findDialogShown:"Find dialog shown",findDialogHidden:"Find dialog hidden",focusedFoundText:(t,e)=>`Viewing match ${t} of ${e}`,anyDevicePanning:"Any device panning",copied:(t,e)=>`Copied ${t} ${e}`,pasted:(t,e)=>`Pasted ${t} ${e}`,toolEnabledAnnouncement:t=>`${t} enabled`,toolDisabledAnnouncement:t=>`${t} disabled`}),Je),{unlabeledImageNode:"Unlabeled image node",stroke:"Stroke",svgObject:"SVG Object",text:t=>`Text object: ${t}`,imageNode:t=>`Image: ${t}`}),{pathNodeCount:t=>`There are ${t} visible path objects.`,textNodeCount:t=>`There are ${t} visible text nodes.`,imageNodeCount:t=>`There are ${t} visible image nodes.`,textNode:t=>`Text: ${t}`,imageNode:t=>`Image: ${t}`,unlabeledImageNode:"Unlabeled image",rerenderAsText:"Re-render as text"}),{accessibilityInputInstructions:['Press "t" to read the contents of the viewport as text.',"Use the arrow keys to move the viewport, click and drag to draw strokes.",'Press "w" to zoom in and "s" to zoom out.'].join(" "),loading:t=>`Loading ${t}%...`,imageEditor:"Image Editor",doneLoading:"Done loading",undoAnnouncement:t=>`Undid ${t}`,redoAnnouncement:t=>`Redid ${t}`}),tn={de:Object.assign(Object.assign({},Qe),{pen:"Stift",eraser:"Radierer",select:"Auswahl",handTool:"Verschieben",zoom:"Vergrößerung",resetView:"Ansicht zurücksetzen",thicknessLabel:"Dicke: ",colorLabel:"Farbe: ",fontLabel:"Schriftart: ",resizeImageToSelection:"Bildgröße an Auswahl anpassen",deleteSelection:"Auswahl löschen",duplicateSelection:"Auswahl duplizieren",undo:"Rückgängig",redo:"Wiederholen",pickColorFromScreen:"Farbe von Bildschirm auswählen",clickToPickColorAnnouncement:"Klicke auf den Bildschirm, um eine Farbe auszuwählen",selectionToolKeyboardShortcuts:"Auswahl-Werkzeug: Verwende die Pfeiltasten, um ausgewählte Elemente zu verschieben und ‚i‘ und ‚o‘, um ihre Größe zu ändern.",touchPanning:"Ansicht mit Touchscreen verschieben",anyDevicePanning:"Ansicht mit jedem Eingabegerät verschieben",selectObjectType:"Objekt-Typ: ",freehandPen:"Freihand",arrowPen:"Pfeil",linePen:"Linie",outlinedRectanglePen:"Umrissenes Rechteck",filledRectanglePen:"Ausgefülltes Rechteck",dropdownShown:t=>`Dropdown-Menü für ${t} angezeigt`,dropdownHidden:t=>`Dropdown-Menü für ${t} versteckt`,zoomLevel:t=>`Vergößerung: ${t}%`,colorChangedAnnouncement:t=>`Farbe zu ${t} geändert`,penTool:t=>`Stift ${t}`,selectionTool:"Auswahl",eraserTool:"Radiergummi",touchPanTool:"Ansicht mit Touchscreen verschieben",twoFingerPanZoomTool:"Ansicht verschieben und vergrößern",undoRedoTool:"Rückgängig/Wiederholen",rightClickDragPanTool:"Rechtsklick-Ziehen",pipetteTool:"Farbe von Bildschirm auswählen",keyboardPanZoom:"Tastaturkürzel zum Verschieben/Vergrößern der Ansicht",textTool:"Text",enterTextToInsert:"Einzufügender Text",toolEnabledAnnouncement:t=>`${t} aktiviert`,toolDisabledAnnouncement:t=>`${t} deaktiviert`,updatedViewport:"Transformierte Ansicht",transformedElements:t=>`${t} Element${1===t?"":"e"} transformiert`,resizeOutputCommand:t=>`Bildgröße auf ${t.w}x${t.h} geändert`,addElementAction:t=>`${t} hinzugefügt`,eraseAction:(t,e)=>`${e} ${t} gelöscht`,duplicateAction:(t,e)=>`${e} ${t} dupliziert`,inverseOf:t=>`Umkehrung von ${t}`,elements:"Elemente",erasedNoElements:"Nichts entfernt",duplicatedNoElements:"Nichts dupliziert",rotatedBy:t=>`${Math.abs(t)} Grad ${t<0?"im Uhrzeigersinn":"gegen den Uhrzeigersinn"} gedreht`,movedLeft:"Nacht links bewegt",movedUp:"Nacht oben bewegt",movedDown:"Nacht unten bewegt",movedRight:"Nacht rechts bewegt",zoomedOut:"Ansicht verkleinert",zoomedIn:"Ansicht vergrößert",selectedElements:t=>`${t} Element${1===t?"":"e"} ausgewählt`,stroke:"Strich",svgObject:"SVG-Objekt",text:t=>`Text-Objekt: ${t}`,pathNodeCount:t=>`Es gibt ${t} sichtbare Pfad-Objekte.`,textNodeCount:t=>`Es gibt ${t} sichtbare Text-Knotenpunkte.`,textNode:t=>`Text: ${t}`,rerenderAsText:"Als Text darstellen",accessibilityInputInstructions:"Drücke ‚t‘, um den Inhalt des Ansichtsfensters als Text zu lesen. Verwende die Pfeiltasten, um die Ansicht zu verschieben, und klicke und ziehe, um Striche zu zeichnen. Drücke ‚w‘ zum Vergrößern und ‚s‘ zum Verkleinern der Ansicht.",loading:t=>`Laden ${t}%...`,doneLoading:"Laden fertig",imageEditor:"Bild-Editor",undoAnnouncement:t=>`Rückgangig gemacht ${t}`,redoAnnouncement:t=>`Wiederholt ${t}`}),en:Object.assign({},Qe),es:Object.assign(Object.assign({},Qe),{loading:t=>`Cargando: ${t}%...`,imageEditor:"Editor de dibujos",undoAnnouncement:t=>`${t} fue deshecho`,redoAnnouncement:t=>`${t} fue rehecho`,undo:"Deshace",redo:"Rehace",pen:"Lapiz",eraser:"Borrador",select:"Selecciona",thicknessLabel:"Tamaño: ",colorLabel:"Color: ",doneLoading:"El cargado terminó",fontLabel:"Fuente: ",anyDevicePanning:"Mover la pantalla con todo dispotivo",touchPanning:"Mover la pantalla con un dedo",touchPanTool:"Instrumento de mover la pantalla con un dedo",outlinedRectanglePen:"Rectángulo con nada más que un borde",filledRectanglePen:"Rectángulo sin borde",linePen:"Línea",arrowPen:"Flecha",freehandPen:"Dibuja sin restricción de forma",selectObjectType:"Forma de dibuja:",handTool:"Mover",zoom:"Zoom",resetView:"Reiniciar vista",resizeImageToSelection:"Redimensionar la imagen a lo que está seleccionado",deleteSelection:"Borra la selección",duplicateSelection:"Duplica la selección",pickColorFromScreen:"Selecciona un color de la pantalla",clickToPickColorAnnouncement:"Haga un clic en la pantalla para seleccionar un color",dropdownShown:t=>`Menú por ${t} es visible`,dropdownHidden:function(t){return`Menú por ${t} fue ocultado`},colorChangedAnnouncement:function(t){return`Color fue cambiado a ${t}`},keyboardPanZoom:"Mover la pantalla con el teclado",penTool:function(t){return`Lapiz ${t}`},selectionTool:"Selecciona",eraserTool:"Borrador",textTool:"Texto",enterTextToInsert:"Entra texto",rerenderAsText:"Redibuja la pantalla al texto"})},en=t=>{const e=/^(\w+)[_-](\w+)$/.exec(t);return e?e[1]:t},nn=t=>{let e;null!=t||(t=navigator.languages);for(const n of t){const t=en(n);if(e&&t!==e&&e in tn)return tn[e];if(n in tn)return tn[n];e=t}return e&&e in tn?tn[e]:Qe},rn="http://www.w3.org/2000/svg",on="\n\tstyle='fill: var(--icon-color);'\n",sn="\n\t<pattern\n\t\tid='checkerboard'\n\t\tviewBox='0,0,10,10'\n\t\twidth='20%'\n\t\theight='20%'\n\t\tpatternUnits='userSpaceOnUse'\n\t>\n\t\t<rect x=0 y=0 width=10 height=10 fill='white'/>\n\t\t<rect x=0 y=0 width=5 height=5 fill='gray'/>\n\t\t<rect x=5 y=5 width=5 height=5 fill='gray'/>\n\t</pattern>\n";class an{makeUndoIcon(){return this.makeRedoIcon(!0)}makeRedoIcon(t=!1){const e=document.createElementNS(rn,"svg");return e.innerHTML=`\n\t\t\t<style>\n\t\t\t\t.toolbar-svg-undo-redo-icon {\n\t\t\t\t\tstroke: var(--icon-color);\n\t\t\t\t\tstroke-width: 12;\n\t\t\t\t\tstroke-linejoin: round;\n\t\t\t\t\tstroke-linecap: round;\n\t\t\t\t\tfill: none;\n\t\n\t\t\t\t\ttransform-origin: center;\n\t\t\t\t}\n\t\t\t</style>\n\t\t\t<path\n\t\t\t\td='M20,20 A15,15 0 0 1 70,80 L80,90 L60,70 L65,90 L87,90 L65,80'\n\t\t\t\tclass='toolbar-svg-undo-redo-icon'\n\t\t\t\tstyle='${t?"transform: scale(-1, 1);":""}'/>\n\t\t`,e.setAttribute("viewBox","0 0 100 100"),e}makeDropdownIcon(){const t=document.createElementNS(rn,"svg");return t.innerHTML=`\n\t\t<g>\n\t\t\t<path\n\t\t\t\td='M5,10 L50,90 L95,10 Z'\n\t\t\t\t${on}\n\t\t\t/>\n\t\t</g>\n\t\t`,t.setAttribute("viewBox","0 0 100 100"),t}makeEraserIcon(){const t=document.createElementNS(rn,"svg");return t.innerHTML=`\n\t\t<g>\n\t\t\t<rect x=10 y=50 width=80 height=30 rx=10 fill='pink' />\n\t\t\t<rect\n\t\t\t\tx=10 y=10 width=80 height=50\n\t\t\t\t${on}\n\t\t\t/>\n\t\t</g>\n\t\t`,t.setAttribute("viewBox","0 0 100 100"),t}makeSelectionIcon(){const t=document.createElementNS(rn,"svg");return t.innerHTML="\n\t\t<g>\n\t\t\t<rect x=10 y=10 width=70 height=70 fill='pink' stroke='black'/>\n\t\t\t<rect x=75 y=75 width=10 height=10 fill='white' stroke='black'/>\n\t\t</g>\n\t\t",t.setAttribute("viewBox","0 0 100 100"),t}makeIconFromPath(t,e="var(--icon-color)",n="none",i="0px"){const r=document.createElementNS(rn,"svg"),o=document.createElementNS(rn,"path");return o.setAttribute("d",t),o.style.fill=e,o.style.stroke=n,o.style.strokeWidth=i,r.appendChild(o),r.setAttribute("viewBox","0 0 100 100"),r}makeHandToolIcon(){return this.makeIconFromPath("\n\t\t\tm 10,60\n\t\t\t\t5,30\n\t\t\tH 90\n\t\t\tV 30\n\t\t\tC 90,20 75,20 75,30\n\t\t\tV 60\n\t\t\t\t20\n\t\t\tC 75,10 60,10 60,20\n\t\t\tV 60\n\t\t\t\t15\n\t\t\tC 60,5 45,5 45,15\n\t\t\tV 60\n\t\t\t\t25\n\t\t\tC 45,15 30,15 30,25\n\t\t\tV 60\n\t\t\t\t75\n\t\t\tL 25,60\n\t\t\tC 20,45 10,50 10,60\n\t\t\tZ\n\t\t","none","var(--icon-color)","3")}makeTouchPanningIcon(){return this.makeIconFromPath("\n\t\t\tM 5,5.5\n\t\t\tV 17.2\n\t\t\tL 16.25,5.46\n\t\t\tZ\n\t\n\t\t\tm 33.75,0\n\t\t\tL 50,17\n\t\t\tV 5.5\n\t\t\tZ\n\t\n\t\t\tM 5,40.7\n\t\t\tv 11.7\n\t\t\th 11.25\n\t\t\tz\n\t\n\t\t\tM 26,19\n\t\t\tC 19.8,19.4 17.65,30.4 21.9,34.8\n\t\t\tL 50,70\n\t\t\tH 27.5\n\t\t\tc -11.25,0 -11.25,17.6 0,17.6\n\t\t\tH 61.25\n\t\t\tC 94.9,87.8 95,87.6 95,40.7 78.125,23 67,29 55.6,46.5\n\t\t\tL 33.1,23\n\t\t\tC 30.3125,20.128192 27.9,19 25.830078,19.119756\n\t\t\tZ\n\t\t","none","var(--icon-color)","3")}makeAllDevicePanningIcon(){return this.makeIconFromPath("\n\t\t\tM 5 5\n\t\t\tL 5 17.5\n\t\t\t\t17.5 5\n\t\t\t\t5 5\n\t\t\tz\n\t\n\t\t\tM 42.5 5\n\t\t\tL 55 17.5\n\t\t\t\t55 5\n\t\t\t\t42.5 5\n\t\t\tz\n\t\n\t\t\tM 70 10\n\t\t\tL 70 21\n\t\t\t\t61 15\n\t\t\t\t55.5 23\n\t\t\t\t66 30\n\t\t\t\t56 37\n\t\t\t\t61 45\n\t\t\t\t70 39\n\t\t\t\t70 50\n\t\t\t\t80 50\n\t\t\t\t80 39\n\t\t\t\t89 45\n\t\t\t\t95 36\n\t\t\t\t84 30\n\t\t\t\t95 23\n\t\t\t\t89 15\n\t\t\t\t80 21\n\t\t\t\t80 10\n\t\t\t\t70 10\n\t\t\tz\n\t\n\t\t\tM 27.5 26.25\n\t\t\tL 27.5 91.25\n\t\t\tL 43.75 83.125\n\t\t\tL 52 99\n\t\t\tL 68 91\n\t\t\tL 60 75\n\t\t\tL 76.25 66.875\n\t\t\tL 27.5 26.25\n\t\t\tz\n\t\n\t\t\tM 5 42.5\n\t\t\tL 5 55\n\t\t\tL 17.5 55\n\t\t\tL 5 42.5\n\t\t\tz\n\t\t","none","var(--icon-color)","3")}makeZoomIcon(){const t=document.createElementNS(rn,"svg");t.setAttribute("viewBox","0 0 100 100");const e=(e,n,i)=>{const r=document.createElementNS(rn,"text");r.appendChild(document.createTextNode(e)),r.setAttribute("x",n.toString()),r.setAttribute("y",i.toString()),r.style.textAlign="center",r.style.textAnchor="middle",r.style.fontSize="55px",r.style.fill="var(--icon-color)",r.style.fontFamily="monospace",t.appendChild(r)};return e("+",40,45),e("-",70,75),t}makeRotationLockIcon(){const t=this.makeIconFromPath("\n\t\t\tM 40.1 25.1 \n\t\t\tC 32.5 25 27.9 34.1 27.9 34.1 \n\t\t\tL 25.7 30 \n\t\t\tL 28 44.7 \n\t\t\tL 36.6 40.3 \n\t\t\tL 32.3 38.3 \n\t\t\tC 33.6 28 38.1 25.2 45.1 31.8 \n\t\t\tL 49.4 29.6 \n\t\t\tC 45.9 26.3 42.8 25.1 40.1 25.1 \n\t\t\tz\n\n\t\t\tM 51.7 34.2 \n\t\t\tL 43.5 39.1 \n\t\t\tL 48 40.8 \n\t\t\tC 47.4 51.1 43.1 54.3 35.7 48.2 \n\t\t\tL 31.6 50.7 \n\t\t\tC 45.5 62.1 52.6 44.6 52.6 44.6 \n\t\t\tL 55.1 48.6 \n\t\t\tL 51.7 34.2 \n\t\t\tz\n\n\t\t\tM 56.9 49.9 \n\t\t\tC 49.8 49.9 49.2 57.3 49.3 60.9 \n\t\t\tL 47.6 60.9 \n\t\t\tL 47.6 73.7 \n\t\t\tL 66.1 73.7 \n\t\t\tL 66.1 60.9 \n\t\t\tL 64.4 60.9 \n\t\t\tC 64.5 57.3 63.9 49.9 56.9 49.9 \n\t\t\tz\n\n\t\t\tM 56.9 53.5 \n\t\t\tC 60.8 53.5 61 58.2 60.8 60.9 \n\t\t\tL 52.9 60.9 \n\t\t\tC 52.7 58.2 52.9 53.5 56.9 53.5 \n\t\t\tz\n\t\t");return t.setAttribute("viewBox","10 10 70 70"),t}makeTextIcon(t){var e,n;const i=document.createElementNS(rn,"svg");i.setAttribute("viewBox","0 0 100 100");const r=document.createElementNS(rn,"text");return r.appendChild(document.createTextNode("T")),r.style.fontFamily=t.fontFamily,r.style.fontWeight=null!==(e=t.fontWeight)&&void 0!==e?e:"",r.style.fontVariant=null!==(n=t.fontVariant)&&void 0!==n?n:"",r.style.fill=t.renderingStyle.fill.toHexString(),r.style.textAnchor="middle",r.setAttribute("x","50"),r.setAttribute("y","75"),r.style.fontSize="65px",r.style.filter="drop-shadow(0px 0px 10px var(--primary-shadow-color))",i.appendChild(r),i}makePenIcon(t,e){e instanceof lt&&(e=e.toHexString());const n=document.createElementNS(rn,"svg");n.setAttribute("viewBox","0 0 100 100");const i=t/2,r=`M14,63 L${50-i},95 L${50+i},90 L88,60 Z`,o=`M14,63 L${50-i},85 L${50+i},83 L88,60 Z`;return n.innerHTML=`\n\t\t<defs>\n\t\t\t${sn}\n\t\t</defs>\n\t\t<g>\n\t\t\t\x3c!-- Pen grip --\x3e\n\t\t\t<path\n\t\t\t\td='M10,10 L90,10 L90,60 L${50+i},80 L${50-i},80 L10,60 Z'\n\t\t\t\t\n\tstyle='fill: var(--icon-color); stroke: var(--icon-color);'\n\n\t\t\t/>\n\t\t</g>\n\t\t<g>\n\t\t\t\x3c!-- Checkerboard background for slightly transparent pens --\x3e\n\t\t\t<path d='${o}' fill='url(#checkerboard)'/>\n\t\n\t\t\t\x3c!-- Actual pen tip --\x3e\n\t\t\t<path\n\t\t\t\td='${r}'\n\t\t\t\tfill='${e}'\n\t\t\t\tstroke='${e}'\n\t\t\t/>\n\t\t</g>\n\t\t`,n}makeIconFromFactory(t,e){const n=t.getThickness(),i=(new Date).getTime(),r={pos:l.of(10,10),width:n/5,color:t.getColor(),time:i-100},o={pos:l.of(90,90),width:n/5,color:t.getColor(),time:i},s=new P(new pe),a=e(r,s);a.addPoint(o);const c=document.createElementNS(rn,"svg");c.setAttribute("viewBox","0 0 100 100"),s.updateScreenSize(l.of(100,100));const h=new Ot(c,s);return a.preview(h),c}makePipetteIcon(t){const e=document.createElementNS(rn,"svg"),n=document.createElementNS(rn,"path");if(n.setAttribute("d","\n\t\t\tM 47,6\n\t\t\tC 35,5 25,15 35,30\n\t\t\tc -9.2,1.3 -15,0 -15,3\n\t\t\t\t0,2 5,5 15,7\n\t\t\tV 81\n\t\t\tL 40,90\n\t\t\th 6\n\t\t\tL 40,80\n\t\t\tV 40\n\t\t\th 15\n\t\t\tv 40\n\t\t\tl -6,10\n\t\t\th 6\n\t\t\tl 5,-9.2\n\t\t\tV 40\n\t\t\tC 70,38 75,35 75,33\n\t\t\t\t75,30 69.2,31.2 60,30\n\t\t\t\t65,15 65,5      47,6\n\t\t\tZ\n\t\t"),n.style.fill="var(--icon-color)",t){const n=document.createElementNS(rn,"defs");n.innerHTML=sn,e.appendChild(n);const i=document.createElementNS(rn,"path"),r=document.createElementNS(rn,"path"),o="\n\t\t\t\tm 40,50 c 5,5 10,0 15,-5 V 80 L 50,90 H 45 L 40,80 Z\n\t\t\t";r.setAttribute("d",o),i.setAttribute("d",o),r.style.fill=t.toHexString(),i.style.fill="url(#checkerboard)",e.appendChild(i),e.appendChild(r)}return e.appendChild(n),e.setAttribute("viewBox","0 0 100 100"),e}makeResizeViewportIcon(){return this.makeIconFromPath("\n\t\t\tM 75 5 75 10 90 10 90 25 95 25 95 5 75 5 z\n\t\t\tM 15 15 15 30 20 30 20 20 30 20 30 15 15 15 z\n\t\t\tM 84 15 82 17 81 16 81 20 85 20 84 19 86 17 84 15 z\n\t\t\tM 26 24 24 26 26 28 25 29 29 29 29 25 28 26 26 24 z\n\t\t\tM 25 71 26 72 24 74 26 76 28 74 29 75 29 71 25 71 z\n\t\t\tM 15 75 15 85 25 85 25 80 20 80 20 75 15 75 z\n\t\t\tM 90 75 90 90 75 90 75 95 95 95 95 75 90 75 z\n\t\t\tM 81 81 81 85 82 84 84 86 86 84 84 82 85 81 81 81 z\n\t\t")}makeDuplicateSelectionIcon(){return this.makeIconFromPath("\n\t\t\tM 45,10 45,55 90,55 90,10 45,10 z\n\t\t\tM 10,25 10,90 70,90 70,60 40,60 40,25 10,25 z \n\t\t")}makeDeleteSelectionIcon(){return this.makeIconFromPath("\n\t\t\tM 10,10 90,90\n\t\t\tM 10,90 90,10\n\t\t","none","var(--icon-color)","5px")}makeSaveIcon(){const t=document.createElementNS("http://www.w3.org/2000/svg","svg");return t.innerHTML="\n\t\t\t<style>\n\t\t\t\t.toolbar-save-icon {\n\t\t\t\t\tstroke: var(--icon-color);\n\t\t\t\t\tstroke-width: 10;\n\t\t\t\t\tstroke-linejoin: round;\n\t\t\t\t\tstroke-linecap: round;\n\t\t\t\t\tfill: none;\n\t\t\t\t}\n\t\t\t</style>\n\t\t\t<path\n\t\t\t\td='\n\t\t\t\t\tM 15,55 30,70 85,20\n\t\t\t\t'\n\t\t\t\tclass='toolbar-save-icon'\n\t\t\t/>\n\t\t",t.setAttribute("viewBox","0 0 100 100"),t}}var ln=function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{l(i.next(t))}catch(t){o(t)}}function a(t){try{l(i.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}l((i=i.apply(t,e||[])).next())}))};const cn=class{constructor(t,e={}){var n,i,r,o,s;this.eventListenerTargets=[],this.previousAccessibilityAnnouncement="",this.pointers={},this.announceUndoCallback=t=>{this.announceForAccessibility(this.localization.undoAnnouncement(t.description(this,this.localization)))},this.announceRedoCallback=t=>{this.announceForAccessibility(this.localization.redoAnnouncement(t.description(this,this.localization)))},this.rerenderQueued=!1,this.localization=Object.assign(Object.assign({},nn()),e.localization),this.settings={wheelEventsEnabled:null===(n=e.wheelEventsEnabled)||void 0===n||n,renderingMode:null!==(i=e.renderingMode)&&void 0!==i?i:Xe.CanvasRenderer,localization:this.localization,minZoom:null!==(r=e.minZoom)&&void 0!==r?r:2e-10,maxZoom:null!==(o=e.maxZoom)&&void 0!==o?o:1e12,iconProvider:null!==(s=e.iconProvider)&&void 0!==s?s:new an},this.icons=this.settings.iconProvider,this.container=document.createElement("div"),this.renderingRegion=document.createElement("div"),this.container.appendChild(this.renderingRegion),this.container.className="imageEditorContainer",this.loadingWarning=document.createElement("div"),this.loadingWarning.classList.add("loadingMessage"),this.loadingWarning.ariaLive="polite",this.container.appendChild(this.loadingWarning),this.accessibilityControlArea=document.createElement("textarea"),this.accessibilityControlArea.setAttribute("placeholder",this.localization.accessibilityInputInstructions),this.accessibilityControlArea.style.opacity="0",this.accessibilityControlArea.style.width="0",this.accessibilityControlArea.style.height="0",this.accessibilityControlArea.style.position="absolute",this.accessibilityAnnounceArea=document.createElement("div"),this.accessibilityAnnounceArea.setAttribute("aria-live","assertive"),this.accessibilityAnnounceArea.className="accessibilityAnnouncement",this.container.appendChild(this.accessibilityAnnounceArea),this.renderingRegion.style.touchAction="none",this.renderingRegion.className="imageEditorRenderArea",this.renderingRegion.appendChild(this.accessibilityControlArea),this.renderingRegion.setAttribute("tabIndex","0"),this.renderingRegion.setAttribute("alt",""),this.notifier=new pe,this.importExportViewport=new P(this.notifier),this.viewport=new P(this.notifier),this.display=new Ye(this,this.settings.renderingMode,this.renderingRegion),this.image=new f,this.history=new class{constructor(t,e,n){this.editor=t,this.announceRedoCallback=e,this.announceUndoCallback=n,this.maxUndoRedoStackSize=700,this.undoStack=[],this.redoStack=[]}fireUpdateEvent(){this.editor.notifier.dispatch(x.UndoRedoStackUpdated,{kind:x.UndoRedoStackUpdated,undoStackSize:this.undoStack.length,redoStackSize:this.redoStack.length})}push(t,e=!0){e&&t.apply(this.editor),this.undoStack.push(t);for(const t of this.redoStack)t.onDrop(this.editor);if(this.redoStack=[],this.undoStack.length>this.maxUndoRedoStackSize){const t=10;this.undoStack.splice(0,t).forEach((t=>t.onDrop(this.editor)))}this.fireUpdateEvent(),this.editor.notifier.dispatch(x.CommandDone,{kind:x.CommandDone,command:t})}undo(){const t=this.undoStack.pop();t&&(this.redoStack.push(t),t.unapply(this.editor),this.announceUndoCallback(t),this.fireUpdateEvent(),this.editor.notifier.dispatch(x.CommandUndone,{kind:x.CommandUndone,command:t}))}redo(){const t=this.redoStack.pop();t&&(this.undoStack.push(t),t.apply(this.editor),this.announceRedoCallback(t),this.fireUpdateEvent(),this.editor.notifier.dispatch(x.CommandDone,{kind:x.CommandDone,command:t}))}get undoStackSize(){return this.undoStack.length}get redoStackSize(){return this.redoStack.length}}(this,this.announceRedoCallback,this.announceUndoCallback),this.toolController=new ue(this,this.localization),t.appendChild(this.container),this.importExportViewport.updateScreenSize(l.of(500,500)),this.viewport.updateScreenSize(l.of(this.display.width,this.display.height)),this.registerListeners(),this.queueRerender(),this.hideLoadingWarning(),this.notifier.on(x.ViewportChanged,(t=>{if(t.kind===x.ViewportChanged){const e=t.newTransform.transformVec3(l.unitX).length();if(e>this.settings.maxZoom||e<this.settings.minZoom){const e=t.oldTransform.transformVec3(l.unitX).length();let n=d.identity;e<=this.settings.maxZoom&&e>=this.settings.minZoom&&(n=t.oldTransform),this.viewport.resetTransform(n)}}}))}getRootElement(){return this.container}showLoadingWarning(t){const e=Math.round(100*t);this.loadingWarning.innerText=this.localization.loading(e),this.loadingWarning.style.display="block"}hideLoadingWarning(){this.loadingWarning.style.display="none",this.announceForAccessibility(this.localization.doneLoading)}announceForAccessibility(t){t===this.previousAccessibilityAnnouncement&&(t+=". "),this.accessibilityAnnounceArea.innerText=t,this.previousAccessibilityAnnouncement=t}addToolbar(t=!0){const e=new Ve(this,this.container,this.localization);return t&&(e.addDefaultToolWidgets(),e.addDefaultActionButtons()),e}registerListeners(){this.handlePointerEventsFrom(this.renderingRegion),this.handleKeyEventsFrom(this.renderingRegion),this.container.addEventListener("wheel",(t=>{let e=a.of(t.deltaX,t.deltaY,t.deltaZ);if(!t.ctrlKey){if(!this.settings.wheelEventsEnabled)return;if("only-if-focused"===this.settings.wheelEventsEnabled&&!this.container.querySelector(":focus"))return}t.deltaMode===WheelEvent.DOM_DELTA_LINE?e=e.times(15):t.deltaMode===WheelEvent.DOM_DELTA_PAGE&&(e=e.times(100)),t.ctrlKey&&(e=a.of(0,0,t.deltaY));const n=this.container.getBoundingClientRect(),i=l.of(t.clientX,t.clientY).minus(l.of(n.left,n.top));return!!this.toolController.dispatchInputEvent({kind:y.WheelEvt,delta:e,screenPos:i})&&(t.preventDefault(),!0)})),this.notifier.on(x.DisplayResized,(t=>{this.viewport.updateScreenSize(l.of(this.display.width,this.display.height))})),window.addEventListener("resize",(()=>{this.notifier.dispatch(x.DisplayResized,{kind:x.DisplayResized,newSize:l.of(this.display.width,this.display.height)}),this.queueRerender()})),this.accessibilityControlArea.addEventListener("input",(()=>{this.accessibilityControlArea.value=""})),document.addEventListener("copy",(t=>{if(!this.isEventSink(document.querySelector(":focus")))return;const e=t.clipboardData;this.toolController.dispatchInputEvent({kind:y.CopyEvent,setData:(t,n)=>{null==e||e.setData(t,n)}})&&t.preventDefault()})),document.addEventListener("paste",(t=>{this.handlePaste(t)}))}getPointerList(){const t=(new Date).getTime(),e=[];for(const n in this.pointers){const i=2e3;this.pointers[n]&&t-this.pointers[n].timeStamp<i&&e.push(this.pointers[n])}return e}handleHTMLPointerEvent(t,e){var n,i,r;const o=this.renderingRegion,s=null!==(n=e.target)&&void 0!==n?n:this.renderingRegion;if("pointerdown"===t){const t=w.ofEvent(e,!0,this.viewport,o);this.pointers[t.id]=t,s.setPointerCapture(t.id);const n={kind:y.PointerDownEvt,current:t,allPointers:this.getPointerList()};return this.toolController.dispatchInputEvent(n),!0}if("pointermove"===t){const t=w.ofEvent(e,null!==(r=null===(i=this.pointers[e.pointerId])||void 0===i?void 0:i.down)&&void 0!==r&&r,this.viewport,o);if(t.down){const n=this.pointers[t.id];if(n&&t.screenPos.minus(n.screenPos).magnitude()<2)return!1;this.pointers[t.id]=t,this.toolController.dispatchInputEvent({kind:y.PointerMoveEvt,current:t,allPointers:this.getPointerList()})&&e.preventDefault()}return!0}if("pointercancel"===t||"pointerup"===t){const t=w.ofEvent(e,!1,this.viewport,o);return!!this.pointers[t.id]&&(this.pointers[t.id]=t,s.releasePointerCapture(t.id),this.toolController.dispatchInputEvent({kind:y.PointerUpEvt,current:t,allPointers:this.getPointerList()})&&e.preventDefault(),delete this.pointers[t.id],!0)}return t}isEventSink(t){let e=t;for(;null!==e;){for(const t of this.eventListenerTargets)if(t===e)return!0;e=e.parentElement}return!1}handlePaste(t){var e,n;return ln(this,void 0,void 0,(function*(){const i=null!==(e=document.querySelector(":focus"))&&void 0!==e?e:t.target;if(!this.isEventSink(i))return;const r=null!==(n=t.dataTransfer)&&void 0!==n?n:t.clipboardData;if(!r)return;for(const e of r.files)if("image/svg+xml"===e.type.toLowerCase()){const n=yield e.text();if(this.toolController.dispatchInputEvent({kind:y.PasteEvent,mime:e.type,data:n}))return void t.preventDefault()}for(const e of r.files){const n=e.type.toLowerCase();if("image/png"===n||"image/jpg"===n){const i=new FileReader;this.showLoadingWarning(0);try{const r=yield new Promise(((t,n)=>{i.onload=()=>t(i.result),i.onerror=n,i.onabort=n,i.onprogress=t=>{this.showLoadingWarning(t.loaded/t.total)},i.readAsDataURL(e)}));if(r&&this.toolController.dispatchInputEvent({kind:y.PasteEvent,mime:n,data:r}))return t.preventDefault(),void this.hideLoadingWarning()}catch(t){console.error("Error reading image:",t)}this.hideLoadingWarning()}}const o=["image/svg+xml","text/plain"];for(const e of o){const n=r.getData(e);if(n&&this.toolController.dispatchInputEvent({kind:y.PasteEvent,mime:e,data:n}))return void t.preventDefault()}}))}handlePointerEventsFrom(t,e){t.addEventListener("touchstart",(t=>t.preventDefault())),t.addEventListener("contextmenu",(t=>{t.preventDefault()}));const n=["pointerdown","pointermove","pointerup","pointercancel"];for(const i of n)t.addEventListener(i,(t=>!(!e||e(i,t))||this.handleHTMLPointerEvent(i,t)))}handleKeyEventsFrom(t){t.addEventListener("keydown",(t=>{"t"===t.key||"T"===t.key?(t.preventDefault(),this.display.rerenderAsText()):this.toolController.dispatchInputEvent({kind:y.KeyPressEvent,key:t.key,ctrlKey:t.ctrlKey,altKey:t.altKey})?t.preventDefault():"Escape"===t.key&&this.renderingRegion.blur()})),t.addEventListener("keyup",(t=>{this.toolController.dispatchInputEvent({kind:y.KeyUpEvent,key:t.key,ctrlKey:t.ctrlKey,altKey:t.altKey})&&t.preventDefault()})),t.ondragover=t=>{t.preventDefault()},t.ondrop=t=>{t.preventDefault(),this.handlePaste(t)},this.eventListenerTargets.push(t)}dispatch(t,e=!0){e?this.history.push(t):t.apply(this),this.announceForAccessibility(t.description(this,this.localization))}dispatchNoAnnounce(t,e=!1){e?this.history.push(t):t.apply(this)}asyncApplyOrUnapplyCommands(t,e,n){return ln(this,void 0,void 0,(function*(){console.assert(n>0),this.display.setDraftMode(!0);for(let i=0;i<t.length;i+=n){this.showLoadingWarning(i/t.length);for(let r=i;r<t.length&&r<i+n;r++){const n=t[r];e?n.apply(this):n.unapply(this)}i+n<t.length&&(yield new Promise((t=>{this.rerender(),requestAnimationFrame(t)})))}this.display.setDraftMode(!1),this.hideLoadingWarning()}))}asyncApplyCommands(t,e){return this.asyncApplyOrUnapplyCommands(t,!0,e)}asyncUnapplyCommands(t,e){return this.asyncApplyOrUnapplyCommands(t,!1,e)}queueRerender(){this.rerenderQueued||(this.rerenderQueued=!0,requestAnimationFrame((()=>{this.rerender(),this.rerenderQueued=!1})))}rerender(t=!0){if(this.display.startRerender(),0===this.display.width||0===this.display.height)return;const e=this.display.getDryInkRenderer();if(this.image.renderWithCache(e,this.display.getCache(),this.viewport),t){const t={fill:lt.fromHex("#44444455")},n=5*this.viewport.getSizeOfPixelOnCanvas();e.drawRect(this.importExportViewport.visibleRect,n,t)}this.rerenderQueued=!1}drawWetInk(...t){for(const e of t)this.display.getWetInkRenderer().drawPath(e)}clearWetInk(){this.display.getWetInkRenderer().clear()}focus(){this.renderingRegion.focus()}createHTMLOverlay(t){return t.classList.add("overlay"),this.container.appendChild(t),{remove:()=>t.remove()}}addStyleSheet(t){const e=document.createElement("style");return e.innerText=t,this.container.appendChild(e),e}sendKeyboardEvent(t,e,n=!1,i=!1){this.toolController.dispatchInputEvent({kind:t,key:e,ctrlKey:n,altKey:i})}sendPenEvent(t,e,n){const i=w.ofCanvasPoint(e,t!==y.PointerUpEvt,this.viewport);this.toolController.dispatchInputEvent({kind:t,allPointers:null!=n?n:[i],current:i})}toDataURL(t="image/png"){const e=document.createElement("canvas"),n=this.importExportViewport.getResolution();e.width=n.x,e.height=n.y;const i=e.getContext("2d"),r=new We(i,this.importExportViewport);return this.image.renderAll(r),e.toDataURL(t)}toSVG(){const t=this.importExportViewport,e="http://www.w3.org/2000/svg",n=document.createElementNS(e,"svg"),i=new Ot(n,t),r=this.importExportViewport.canvasToScreenTransform;t.resetTransform(d.identity),this.image.renderAll(i),t.resetTransform(r);const o=t.visibleRect;return n.setAttribute("viewBox",[o.x,o.y,o.w,o.h].map((t=>nt(t))).join(" ")),n.setAttribute("width",nt(o.w)),n.setAttribute("height",nt(o.h)),n.setAttribute("version","1.1"),n.setAttribute("baseProfile","full"),n.setAttribute("xmlns",e),n}loadFrom(t){return ln(this,void 0,void 0,(function*(){this.showLoadingWarning(0),this.display.setDraftMode(!0),yield t.start((t=>{this.dispatchNoAnnounce(f.addElement(t))}),((t,e)=>t%500==0?(this.showLoadingWarning(t/e),this.rerender(),new Promise((t=>{requestAnimationFrame((()=>t()))}))):null),(t=>{this.dispatchNoAnnounce(this.setImportExportRect(t),!1),this.dispatchNoAnnounce(this.viewport.zoomTo(t),!1)})),this.hideLoadingWarning(),this.display.setDraftMode(!1),this.queueRerender()}))}getImportExportRect(){return this.importExportViewport.visibleRect}setImportExportRect(t){const e=this.importExportViewport.visibleRect.size,n=this.importExportViewport.canvasToScreenTransform;return new class extends o{apply(e){const n=e.importExportViewport;n.updateScreenSize(t.size),n.resetTransform(d.translation(t.topLeft.times(-1))),e.queueRerender()}unapply(t){const i=t.importExportViewport;i.updateScreenSize(e),i.resetTransform(n),t.queueRerender()}description(e,n){return n.resizeOutputCommand(t)}}}loadFromSVG(t,e=!1){return ln(this,void 0,void 0,(function*(){const n=Lt.fromString(t,e);yield this.loadFrom(n)}))}},hn=cn},854:function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{l(i.next(t))}catch(t){o(t)}}function a(t){try{l(i.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}l((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(729);n(518);const o=n(843),s=n(341);let a=!1;const l=new r.default(document.body),c=l.addToolbar();l.focus(),c.addActionButton({label:o.default.close,icon:(()=>{const t=document.createElementNS("http://www.w3.org/2000/svg","svg");return t.innerHTML="\n\t\t<style>\n\t\t\t.toolbar-close-icon {\n\t\t\t\tstroke: var(--icon-color);\n\t\t\t\tstroke-width: 10;\n\t\t\t\tstroke-linejoin: round;\n\t\t\t\tstroke-linecap: round;\n\t\t\t\tfill: none;\n\t\t\t}\n\t\t</style>\n\t\t<path\n\t\t\td='\n\t\t\t\tM 15,15 85,85\n\t\t\t\tM 15,85 85,15\n\t\t\t'\n\t\t\tclass='toolbar-close-icon'\n\t\t/>\n\t",t.setAttribute("viewBox","0 0 100 100"),t})()},(()=>{webviewApi.postMessage({type:"showCloseUnsavedBtn"});const t=l.getRootElement().style.display;l.getRootElement().style.display="none";const e=document.createElement("div");e.className="exitOptionsDialog";const n=document.createElement("div");n.innerText=o.default.discardUnsavedChanges;const i=document.createElement("button");i.innerText=o.default.resumeEditing,i.onclick=()=>{webviewApi.postMessage({type:"hideCloseUnsavedBtn"}),l.getRootElement().style.display=t,e.remove()},e.replaceChildren(n,i),document.body.appendChild(e)}));const h=()=>{const t=l.toSVG(),e=["<svg"];for(const n of t.getAttributeNames())e.push(` ${n}="${(0,s.escapeHtml)(t.getAttribute(n))}"`);return e.push(">"),e.push(t.innerHTML),e.push("</svg>"),e.join("")};c.addActionButton({label:o.default.save,icon:l.icons.makeSaveIcon()},(()=>{const t={type:"saveSVG",data:h()};webviewApi.postMessage(t),l.getRootElement().remove();const e=document.createElement("form");e.className="exitOptionsDialog",e.name="saveOptions";const n=document.createElement("div");let i=0;const r=(t,e,r=!1)=>{const o=document.createElement("div"),s=document.createElement("label"),a=document.createElement("input");a.name="saveOption",a.value=e,a.type="radio",a.id="saveOption-"+i++,s.setAttribute("for",a.id),a.checked=r,s.innerText=t,o.replaceChildren(a,s),n.appendChild(o)};a&&(r(o.default.overwriteExisting,"overwrite",!0),r(o.default.saveAsNewDrawing,"saveAsCopy"));const s=document.createElement("div");s.innerText=o.default.clickOkToContinue,e.replaceChildren(s,n),document.body.appendChild(e)})),webviewApi.onMessage((t=>{"resumeEditing"===t.type?l.getRootElement().style.visibility="unset":console.log("unknown message",t)})),webviewApi.postMessage({type:"getInitialData"}).then((t=>{t&&!a&&(a=!0,l.loadFromSVG(t))})),setInterval((()=>i(void 0,void 0,void 0,(function*(){console.log("autosaving...");const t={type:"autosave",data:h()};yield webviewApi.postMessage(t),console.log("Done autosaving.")}))),12e4),(()=>{const t="jsdraw-toolbarState";l.notifier.on(r.EditorEventType.ToolUpdated,(()=>{localStorage.setItem(t,c.serializeState())}));try{const e=localStorage.getItem(t);c.deserializeState(e)}catch(t){console.warn("Error restoring toolbar state!",t)}})()},341:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.escapeHtml=void 0,e.escapeHtml=t=>t.replace(/[&]/g,"&amp;").replace(/[<]/g,"&lt;").replace(/[>]/g,"&gt;").replace(/["]/g,"&quot;").replace(/[']/g,"&#39;")},843:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0});const n={insertDrawing:"Insert Drawing",restoreFromAutosave:"Restore from autosaved drawing",deleteAutosave:"Delete all autosaved drawings",noSuchAutosaveExists:"No autosave exists",discardChanges:"Discard changes",defaultImageTitle:"Freehand Drawing",edit:"Edit",close:"Close",save:"Save",overwriteExisting:"Overwrite existing",saveAsNewDrawing:"Save as a new drawing",clickOkToContinue:"Done! Click “Ok” to continue.",discardUnsavedChanges:"Discard unsaved changes?",resumeEditing:"Resume editing"},i={de:Object.assign(Object.assign({},n),{insertDrawing:"Zeichnung einfügen",restoreFromAutosave:"Automatische Sicherung wiederherstellen",deleteAutosave:"Alle automatischen Sicherungen löschen",noSuchAutosaveExists:"Keine automatischen Sicherungen vorhanden",discardChanges:"Änderungen verwerfen",defaultImageTitle:"Freihand-Zeichnen",edit:"Bearbeiten",close:"Schließen",save:"Speichern",overwriteExisting:"Existierende Zeichnung überschreiben",saveAsNewDrawing:"Als neue Zeichnung speichern",clickOkToContinue:"Fertig! Klicke auf „Ok“ um fortzufahen.",discardUnsavedChanges:"Ungespeicherte Änderungen verwerfen?",resumeEditing:"Bearbeiten fortfahren"}),en:n,es:Object.assign(Object.assign({},n),{insertDrawing:"Añada dibujo",restoreFromAutosave:"Resturar al autoguardado",deleteAutosave:"Borrar el autoguardado",noSuchAutosaveExists:"No autoguardado existe",discardChanges:"Descartar cambios",defaultImageTitle:"Dibujo",edit:"Editar",close:"Cerrar",save:"Guardar",overwriteExisting:"Sobrescribir existente",saveAsNewDrawing:"Guardar como dibujo nuevo",clickOkToContinue:"Guardado. Ponga «ok» para continuar.",discardUnsavedChanges:"¿Descartar cambios no guardados?",resumeEditing:"Continuar editando"})};let r;const o=[...navigator.languages];for(const t of navigator.languages){const e=t.indexOf("-");-1!==e&&o.push(t.substring(0,e))}for(const t of o)if(t in i){r=i[t];break}r||(console.log("No supported localization found. Falling back to default."),r=n),e.default=r}},n={};function i(t){var r=n[t];if(void 0!==r)return r.exports;var o=n[t]={exports:{}};return e[t].call(o.exports,o,o.exports,i),o.exports}i.d=(t,e)=>{for(var n in e)i.o(e,n)&&!i.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),i.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var r=i(854);exports.default=r.default})();